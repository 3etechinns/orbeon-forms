<!--
    Copyright (C) 2008 Orbeon, Inc.

    This program is free software; you can redistribute it and/or modify it under the terms of the
    GNU Lesser General Public License as published by the Free Software Foundation; either version
    2.1 of the License, or (at your option) any later version.

    This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
    without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
    See the GNU Lesser General Public License for more details.

    The full text of the license is available at http://www.gnu.org/copyleft/lesser.html
-->
<xhtml:html xmlns:xforms="http://www.w3.org/2002/xforms"
        xmlns:xhtml="http://www.w3.org/1999/xhtml"
        xmlns:xxforms="http://orbeon.org/oxf/xml/xforms"
        xmlns:ev="http://www.w3.org/2001/xml-events"
        xmlns:xs="http://www.w3.org/2001/XMLSchema"
        xmlns:xi="http://www.w3.org/2001/XInclude"
        xmlns:xxi="http://orbeon.org/oxf/xml/xinclude"
        xmlns:xbl="http://www.w3.org/ns/xbl"
        xmlns:fr="http://orbeon.org/oxf/xml/form-runner">

    <xhtml:head>
        <xhtml:title>XForms Controls</xhtml:title>
        <xforms:model>
            <xforms:instance id="main-instance">
                <instance repeat-shown="true" readonly="" relevant="true">
                    <date>
                        <value>2009-03-19</value>
                    </date>
                    <time>
                        <value>15:00:00</value>
                    </time>
                    <output-file>
                        <uri>file:///tmp/dummy</uri>
                    </output-file>
                </instance>
            </xforms:instance>
            <!-- Global MIPS that apply to all the controls -->
            <xforms:bind nodeset="*" readonly="context()/@readonly = 'true'" relevant="context()/@relevant = 'true'"/>
            <xforms:bind nodeset="@*" type="xs:boolean"/>
            <xforms:bind nodeset="date">
                <xforms:bind nodeset="value" type="xs:date"/>
            </xforms:bind>
            <xforms:bind nodeset="time">
                <xforms:bind nodeset="value" type="xs:time"/>
            </xforms:bind>
            <xforms:bind nodeset="output-file">
                <xforms:bind nodeset="uri" type="xs:anyURI"/>
            </xforms:bind>
        </xforms:model>
        <xhtml:link type="text/css" rel="stylesheet" href="/ops/yui/logger/assets/logger.css"/>
        <xhtml:script type="text/javascript" src="/ops/yui/logger/logger.js"/>
        <xhtml:script type="text/javascript" src="/ops/yui/yuitest/yuitest.js"/>
        <xhtml:script type="text/javascript">
            <![CDATA[
                YAHOO.tool.TestRunner.add(new YAHOO.tool.TestCase({

                    name: "xforms:input type xs:date",

                    dateValueInputId: "date-value" + XFORMS_SEPARATOR_1 + "1$xforms-input-1",

                    testOpenHideCalendar: function() {
                        // Click on text field
                        YAHOO.util.UserAction.click(this.dateValueInputId);
                        // Check calendar div shown
                        YAHOO.util.Assert.areEqual("block", document.getElementById("orbeon-calendar-div").style.display);
                        // Click on body
                        YAHOO.util.UserAction.click(document.body);
                        // Check calendar div is hidden
                        YAHOO.util.Assert.areEqual("none", document.getElementById("orbeon-calendar-div").style.display);
                    },

                    testCantOpenReadonly: function() {
                        ORBEON.util.Test.executeCausingAjaxRequest(this, function() {
                            ORBEON.xforms.Document.setValue("readonly", "true");
                        }, function() {
                            // Check input field has been disabled
                            YAHOO.util.Assert.areEqual(true, document.getElementById(this.dateValueInputId).disabled);
                            // Click on text field
                            YAHOO.util.UserAction.click(this.dateValueInputId);
                            // Check that the div is still hidden
                            YAHOO.util.Assert.areEqual("none", document.getElementById("orbeon-calendar-div").style.display);
                            // Restore read-only = false
                            ORBEON.util.Test.executeCausingAjaxRequest(this, function() {
                                ORBEON.xforms.Document.setValue("readonly", "false");
                            }, function() {});
                        });
                    }
                }));

                YAHOO.tool.TestRunner.add(new YAHOO.tool.TestCase({

                    name: "xforms:input type xs:time",

                    timeValueId: "time-value" + XFORMS_SEPARATOR_1 + "1",
                    timeValueInputId: "time-value" + XFORMS_SEPARATOR_1 + "1$xforms-input-1",

                    // Test for: Regression: dateTime field is always invalid when "p.m." is entered
                    // http://forge.objectweb.org/tracker/?func=detail&atid=350207&aid=313427&group_id=168
                    testParsing: function() {
                        var parsedTime = ORBEON.util.DateTime.magicTimeToJSDate("6:00:00 p");
                        YAHOO.util.Assert.isNotNull(parsedTime);
                    }
                }));

                YAHOO.tool.TestRunner.add(new YAHOO.tool.TestCase({

                    name: "xforms:outout appearance=\"xxforms:download\"",

                    outputFileId: "output-file-value" + XFORMS_SEPARATOR_1 + "1",

                    // Test that the control is correctly restored when the iteration is recreated
                    // http://forge.objectweb.org/tracker/index.php?func=detail&aid=313369&group_id=168&atid=350207
                    testRepeatCreate: function() {
                        ORBEON.util.Test.executeCausingAjaxRequest(this, function() {
                            ORBEON.xforms.Document.setValue("repeat-shown", "false");
                        }, function() {
                            ORBEON.util.Test.executeCausingAjaxRequest(this, function() {
                                ORBEON.xforms.Document.setValue("repeat-shown", "true");
                            }, function() {
                                var control = document.getElementById(this.outputFileId);
                                var children = YAHOO.util.Dom.getChildren(control);
                                // Check we still have the link
                                YAHOO.util.Assert.areEqual(1, children.length);
                                var a = children[0];
                                // The link points to a dynamic resource
                                YAHOO.util.Assert.areNotEqual(-1, a.href.indexOf("/orbeon/xforms-server/dynamic/"));
                                // The text for the link is still the same
                                YAHOO.util.Assert.areEqual("Download file", ORBEON.util.Dom.getStringValue(a));
                            });
                        });
                    }
                }));

                ORBEON.xforms.Events.orbeonLoadedEvent.subscribe(function() {
                    if (parent && parent.TestManager) {
                        parent.TestManager.load();
                    } else {
                        new YAHOO.tool.TestLogger();
                        YAHOO.tool.TestRunner.run();
                    }
                });
            ]]>
        </xhtml:script>
    </xhtml:head>
    <xhtml:body>

        <xhtml:h2>Global properties</xhtml:h2>
        <xhtml:p>
            <xforms:input ref="@repeat-shown" id="repeat-shown">
                <xforms:label>Repeat shown: </xforms:label>
            </xforms:input>
        </xhtml:p>
        <xhtml:p>
            <xforms:input ref="@readonly" id="readonly">
                <xforms:label>Readonly: </xforms:label>
            </xforms:input>
        </xhtml:p>
        <xhtml:p>
            <xforms:input ref="@relevant" id="relevant">
                <xforms:label>Relevant: </xforms:label>
            </xforms:input>
        </xhtml:p>
        <xhtml:p>
            <xforms:trigger appearance="minimal" id="focus-trigger">
                <xforms:label>(focus trigger)</xforms:label>
            </xforms:trigger>
        </xhtml:p>

        <xforms:repeat nodeset=".[@repeat-shown = 'true']">

            <!-- Date -->
            <xhtml:h2>xforms:input type xs:date</xhtml:h2>
            <xforms:group ref="date">
                <xhtml:p>
                    <xforms:input ref="value" id="date-value">
                        <xforms:label>Date: </xforms:label>
                    </xforms:input>
                </xhtml:p>
            </xforms:group>

            <!-- Time -->
            <xhtml:h2>xforms:input type xs:date</xhtml:h2>
            <xforms:group ref="time">
                <xhtml:p>
                    <xforms:input ref="value" id="time-value">
                        <xforms:label>Time: </xforms:label>
                    </xforms:input>
                </xhtml:p>
            </xforms:group>

            <!-- Download -->
            <xhtml:h2>xforms:output type xs:anyURI</xhtml:h2>
            <xforms:group ref="output-file">
                <xhtml:p>
                    <xforms:output ref="uri" appearance="xxforms:download" id="output-file-value">
                        <xforms:label>Download file</xforms:label>
                    </xforms:output>
                </xhtml:p>
            </xforms:group>
        </xforms:repeat>

        <!--<widget:xforms-instance-inspector xmlns:widget="http://orbeon.org/oxf/xml/widget"/>-->
    </xhtml:body>
</xhtml:html>

