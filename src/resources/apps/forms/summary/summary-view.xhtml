<!--
    Copyright (C) 2006 Orbeon, Inc.

    This program is free software; you can redistribute it and/or modify it under the terms of the
    GNU Lesser General Public License as published by the Free Software Foundation; either version
    2.1 of the License, or (at your option) any later version.

    This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
    without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
    See the GNU Lesser General Public License for more details.

    The full text of the license is available at http://www.gnu.org/copyleft/lesser.html
-->
<html xmlns:xs="http://www.w3.org/2001/XMLSchema"
      xmlns:xforms="http://www.w3.org/2002/xforms"
      xmlns:ev="http://www.w3.org/2001/xml-events"
      xmlns:xxforms="http://orbeon.org/oxf/xml/xforms"
      xmlns:xi="http://www.w3.org/2001/XInclude"
      xmlns:f="http://orbeon.org/oxf/xml/formatting"
      xmlns:xhtml="http://www.w3.org/1999/xhtml"
      xmlns:dmv="http://orbeon.org/oxf/examples/dmv"
      xmlns:xxi="http://orbeon.org/oxf/xml/xinclude"
      xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
      xmlns="http://www.w3.org/1999/xhtml"
      xsl:version="2.0">

    <head>
        <title>Orbeon Forms - Summary Page</title>
        <link rel="stylesheet" type="text/css" href="/apps/forms/style.css"/>
        <!-- Main XForms model -->
        <xforms:model id="common-model">
            
            <xforms:action ev:event="xforms-ready">
                <!-- Set summary query -->
                <xforms:insert nodeset="xxforms:instance('list-documents-query')"
                               origin="doc(concat('oxf:/apps/forms/forms/', instance('control-instance')/form-id, '/summary-query.xml'))"/>
                <!-- Query list of documents -->
                <xforms:send submission="list-documents-submission"/>
                <!--<xforms:setindex repeat="documents-repeat" index="1"/>-->
            </xforms:action>

            <xforms:instance id="documents-instance">
                <document/>
            </xforms:instance>

            <xforms:bind nodeset="instance('documents-instance')">
                <xforms:bind nodeset="documents/document/document-date" type="xs:dateTime"/>
                <xforms:bind nodeset="//dmv:birth-date" type="xs:date"/>
            </xforms:bind>

            <xforms:instance id="control-instance">
                <control xmlns="">
                    <form-id>DMV-14</form-id>
                    <detail-uri/>
                    <readonly-uri/>
                    <xml-detail-uri/>
                    <pdf-detail-uri/>
                    <non-empty-triggers/>
                    <empty-triggers/>
                    <non-empty/>
                    <empty/>
                    <error/>
                </control>
            </xforms:instance>

            <xforms:bind nodeset="instance('control-instance')">
                <xforms:bind nodeset="detail-uri"
                             calculate="concat('/forms/detail/', instance('control-instance')/form-id, '/', instance('documents-instance')/documents/document[index('documents-repeat')]/id)"/>
                <xforms:bind nodeset="readonly-uri"
                             calculate="concat('/forms/detail/', instance('control-instance')/form-id, '/', instance('documents-instance')/documents/document[index('documents-repeat')]/id, '&amp;readonly=true')"/>
                <xforms:bind nodeset="xml-detail-uri"
                             calculate="concat('/exist/rest/db/orbeon/forms/', instance('control-instance')/form-id, '/', instance('documents-instance')/documents/document[index('documents-repeat')]/id)"/>
                <xforms:bind nodeset="pdf-detail-uri"
                             calculate="concat('/forms/pdf-detail/', instance('control-instance')/form-id, '/', instance('documents-instance')/documents/document[index('documents-repeat')]/id)"/>

                <xforms:bind nodeset="non-empty" relevant="count(instance('documents-instance')/documents/document) > 0"/>
                <xforms:bind nodeset="empty" relevant="count(instance('documents-instance')/documents/document) = 0"/>

                <xforms:bind nodeset="non-empty-triggers" readonly="not(count(instance('documents-instance')/documents/document) > 0)"/>
                <xforms:bind nodeset="empty-triggers" readonly="not(count(instance('documents-instance')/documents/document) = 0)"/>
            </xforms:bind>

        </xforms:model>
        <!-- Model to handle persistence -->
        <xi:include href="oxf:/apps/forms/common/persistence-model.xml" xxi:omit-xml-base="true"/>
        <!-- Model to handle resources -->
        <xi:include href="oxf:/apps/forms/common/resources-model.xml" xxi:omit-xml-base="true"/>
    </head>
    <body>

        <!--<xforms:output ref="instance('control-instance')/error[. != '']" mediatype="text/html"/>-->

        <!--<table class="forms-title-table">-->
            <!--<tr>-->
                <!--<td>-->
                    <!--<img src="/apps/forms/images/dmv-logo.png" alt="DMV"/>-->
                <!--</td>-->
                <!--<td>-->
                    <!--<xforms:output model="resources-model" value="instance('resources-instance')/titles/summary-title"/>-->
                <!--</td>-->
            <!--</tr>-->
        <!--</table>-->

        <table class="forms-main-table">
            <tr>
                <td>
                    <table class="forms-action-table">
                        <tr>
                            <td>
                                <xforms:group>
                                    <xforms:load ev:event="DOMActivate" resource="/forms/detail"/>
                                    <xforms:trigger appearance="xxforms:image">
                                        <xforms:label model="resources-model" ref="instance('resources-instance')/labels/new-form"/>
                                        <xxforms:img src="/apps/forms/images/add.gif"/>
                                    </xforms:trigger>
                                    <xforms:trigger appearance="xxforms:link">
                                        <xforms:label model="resources-model" ref="instance('resources-instance')/labels/new-form"/>
                                    </xforms:trigger>
                                </xforms:group>
                            </td>
                            <td>
                                <xforms:group ref="instance('control-instance')/empty-triggers">
                                    <xforms:action ev:event="DOMActivate">
                                        <xforms:send submission="import-documents-submission"/>
                                        <xforms:send submission="list-documents-submission"/>
                                    </xforms:action>
                                    <xforms:trigger appearance="xxforms:image">
                                        <xforms:label model="resources-model" ref="instance('resources-instance')/labels/import-forms"/>
                                        <xxforms:img src="/apps/forms/images/add-all.gif"/>
                                    </xforms:trigger>
                                    <xforms:trigger appearance="xxforms:link">
                                        <xforms:label model="resources-model" ref="instance('resources-instance')/labels/import-forms"/>
                                    </xforms:trigger>
                                </xforms:group>
                            </td>
                            <td>
                                <xforms:group ref="instance('control-instance')/non-empty-triggers">
                                    <xforms:action ev:event="DOMActivate">
                                        <xforms:recalculate/>
                                        <xforms:load ref="instance('control-instance')/detail-uri"/>
                                    </xforms:action>
                                    <xforms:trigger appearance="xxforms:image">
                                        <xforms:label model="resources-model" ref="instance('resources-instance')/labels/edit-form"/>
                                        <xxforms:img src="/apps/forms/images/edit.gif"/>
                                    </xforms:trigger>
                                    <xforms:trigger appearance="xxforms:link">
                                        <xforms:label model="resources-model" ref="instance('resources-instance')/labels/edit-form"/>
                                    </xforms:trigger>
                                </xforms:group>
                            </td>
                            <td>
                                <xforms:group ref="instance('control-instance')/non-empty-triggers">
                                    <xforms:action ev:event="DOMActivate">
                                        <xforms:send submission="delete-document-submission"/>
                                        <xforms:send submission="list-documents-submission"/>
                                    </xforms:action>
                                    <xforms:trigger appearance="xxforms:image">
                                        <xforms:label model="resources-model" ref="instance('resources-instance')/labels/delete-form"/>
                                        <xxforms:img src="/apps/forms/images/remove.gif"/>
                                    </xforms:trigger>
                                    <xforms:trigger appearance="xxforms:link">
                                        <xforms:label model="resources-model" ref="instance('resources-instance')/labels/delete-form"/>
                                    </xforms:trigger>
                                </xforms:group>
                            </td>
                            <td>
                                <xforms:group ref="instance('control-instance')/non-empty-triggers">
                                    <xforms:action ev:event="DOMActivate">
                                        <xforms:recalculate/>
                                        <xforms:load ref="instance('control-instance')/readonly-uri"/>
                                    </xforms:action>
                                    <xforms:trigger appearance="xxforms:image">
                                        <xforms:label model="resources-model" ref="instance('resources-instance')/labels/view-readonly"/>
                                        <xxforms:img src="/apps/forms/images/lockedstate.gif"/>
                                    </xforms:trigger>
                                    <xforms:trigger appearance="xxforms:link">
                                        <xforms:label model="resources-model" ref="instance('resources-instance')/labels/view-readonly"/>
                                    </xforms:trigger>
                                </xforms:group>
                            </td>
                            <td>
                                <xforms:group ref="instance('control-instance')/non-empty-triggers">
                                    <xforms:action ev:event="DOMActivate">
                                        <xforms:recalculate/>
                                        <xforms:load ref="instance('control-instance')/xml-detail-uri" f:url-type="resource"/>
                                    </xforms:action>
                                    <xforms:trigger appearance="xxforms:image">
                                        <xforms:label model="resources-model" ref="instance('resources-instance')/labels/view-xml"/>
                                        <xxforms:img src="/apps/forms/images/view-xml.gif"/>
                                    </xforms:trigger>
                                    <xforms:trigger appearance="xxforms:link">
                                        <xforms:label model="resources-model" ref="instance('resources-instance')/labels/view-xml"/>
                                    </xforms:trigger>
                                </xforms:group>
                            </td>
                            <td>
                                <xforms:group ref="instance('control-instance')/non-empty-triggers">
                                    <xforms:action ev:event="DOMActivate">
                                        <xforms:recalculate/>
                                        <xforms:load ref="instance('control-instance')/pdf-detail-uri" f:url-type="resource" xxforms:show-progress="false"/>
                                    </xforms:action>
                                    <xforms:trigger appearance="xxforms:image">
                                        <xforms:label model="resources-model" ref="instance('resources-instance')/labels/view-pdf"/>
                                        <xxforms:img src="/apps/forms/images/pdf.png"/>
                                    </xforms:trigger>
                                    <xforms:trigger appearance="xxforms:link">
                                        <xforms:label model="resources-model" ref="instance('resources-instance')/labels/view-pdf"/>
                                    </xforms:trigger>
                                </xforms:group>
                            </td>
                        </tr>
                    </table>

                    <p>
                        <xforms:select1 ref="instance('control-instance')/form-id">
                            <xforms:label model="resources-model" ref="instance('resources-instance')/labels/form-choice"/>
                            <xforms:item>
                                <xforms:label>DMV-14</xforms:label>
                                <xforms:value>DMV-14</xforms:value>
                            </xforms:item>
                            <xforms:item>
                                <xforms:label>G-325A</xforms:label>
                                <xforms:value>G-325A</xforms:value>
                            </xforms:item>
                            <xforms:action ev:event="xforms-value-changed">
                                <!-- Set summary query -->
                                <xforms:insert nodeset="xxforms:instance('list-documents-query')"
                                               origin="doc(concat('oxf:/apps/forms/forms/', instance('control-instance')/form-id, '/summary-query.xml'))"/>
                                <!-- Query list of documents -->
                                <xforms:send submission="list-documents-submission"/>
                                <xforms:setindex repeat="documents-repeat" index="1"/>
                            </xforms:action>
                        </xforms:select1>

                        <xforms:select1 model="resources-model" ref="instance('language-instance')">
                            <xforms:label ref="instance('resources-instance')/labels/language-choice"/>
                            <xforms:item>
                                <xforms:label>en</xforms:label>
                                <xforms:value>en</xforms:value>
                            </xforms:item>
                            <xforms:item>
                                <xforms:label>fr</xforms:label>
                                <xforms:value>fr</xforms:value>
                            </xforms:item>
                            <xforms:send ev:event="xforms-value-changed" submission="update-language-submission"/>
                        </xforms:select1>
                    </p>


                    <xforms:group ref="instance('control-instance')/non-empty">
                        <p>
                            <i><xforms:output model="resources-model" value="instance('resources-instance')/messages/intro"/></i>
                        </p>
                        <table class="forms-gridtable">
                            <tr>
                                <th><xforms:output model="resources-model" value="instance('resources-instance')/titles/row-number"/></th>
                                <th><xforms:output model="resources-model" value="instance('resources-instance')/titles/save-date"/></th>
                                <th><xforms:output model="resources-model" value="instance('resources-instance')/titles/*[name() = xxforms:instance('documents-instance')/documents/headers/header[1]]"/></th>
                                <th><xforms:output model="resources-model" value="instance('resources-instance')/titles/*[name() = xxforms:instance('documents-instance')/documents/headers/header[2]]"/></th>
                                <th><xforms:output model="resources-model" value="instance('resources-instance')/titles/*[name() = xxforms:instance('documents-instance')/documents/headers/header[3]]"/></th>
                                <th><xforms:output model="resources-model" value="instance('resources-instance')/titles/*[name() = xxforms:instance('documents-instance')/documents/headers/header[4]]"/></th>
                            </tr>
                            <xforms:repeat nodeset="instance('documents-instance')/documents/document" id="documents-repeat">
                                <tr>
                                    <td>
                                        <xforms:output value="count(preceding-sibling::document) + 1"/>
                                    </td>
                                    <td>
                                        <xforms:group ref="date">
                                            <xforms:output value="if (. castable as xs:dateTime) then format-dateTime(xs:dateTime(.), xxforms:instance('resources-instance')/formats/save-datetime, xxforms:instance('language-instance'), (), ()) else ."/>
                                        </xforms:group>
                                    </td>
                                    <td>
                                        <xforms:group ref="details/detail[1]">
                                            <xforms:output value="if (. castable as xs:date) then format-date(xs:date(.), xxforms:instance('resources-instance')/formats/birth-date, xxforms:instance('language-instance'), (), ()) else ."/>
                                        </xforms:group>
                                    </td>
                                    <td>
                                        <xforms:group ref="details/detail[2]">
                                            <xforms:output value="if (. castable as xs:date) then format-date(xs:date(.), xxforms:instance('resources-instance')/formats/birth-date, xxforms:instance('language-instance'), (), ()) else ."/>
                                        </xforms:group>
                                    </td>
                                    <td>
                                        <xforms:group ref="details/detail[3]">
                                            <xforms:output value="if (. castable as xs:date) then format-date(xs:date(.), xxforms:instance('resources-instance')/formats/birth-date, xxforms:instance('language-instance'), (), ()) else ."/>
                                        </xforms:group>
                                    </td>
                                    <td>
                                        <xforms:group ref="details/detail[4]">
                                            <xforms:output value="if (. castable as xs:date) then format-date(xs:date(.), xxforms:instance('resources-instance')/formats/birth-date, xxforms:instance('language-instance'), (), ()) else ."/>
                                        </xforms:group>
                                    </td>
                                </tr>
                            </xforms:repeat>
                            <tr/><!-- This is to work around a bug in IE -->
                        </table>

                        <p>
                            <xforms:output model="resources-model" value="instance('resources-instance')/titles/selected"/>:
                            <xforms:output value="index('documents-repeat')"/>
                            <xforms:output model="resources-model" value="instance('resources-instance')/titles/of"/>
                            <xforms:output value="count(instance('documents-instance')/documents/document)"/>
                        </p>

                    </xforms:group>

                    <xforms:group ref="instance('control-instance')/empty">
                        <table class="forms-gridtable">
                            <tr>
                                <th><xforms:output model="resources-model" value="instance('resources-instance')/titles/row-number"/></th>
                                <th><xforms:output model="resources-model" value="instance('resources-instance')/titles/save-date"/></th>
                                <th><xforms:output model="resources-model" value="instance('resources-instance')/titles/name"/></th>
                                <th><xforms:output model="resources-model" value="instance('resources-instance')/titles/birth-date"/></th>
                                <th><xforms:output model="resources-model" value="instance('resources-instance')/titles/id-number"/></th>
                                <th><xforms:output model="resources-model" value="instance('resources-instance')/titles/vehicle"/></th>
                            </tr>
                            <tr>
                                <td colspan="6">
                                    <i><xforms:output model="resources-model" value="instance('resources-instance')/messages/no-form-found" mediatype="text/html"/></i>
                                </td>
                            </tr>
                        </table>
                    </xforms:group>
                </td>
            </tr>
        </table>
    </body>
</html>
