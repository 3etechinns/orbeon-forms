<?xml version="1.0" encoding="utf-8"?>
<!--
    Copyright (C) 2008 Orbeon, Inc.

    This program is free software; you can redistribute it and/or modify it under the terms of the
    GNU Lesser General Public License as published by the Free Software Foundation; either version
    2.1 of the License, or (at your option) any later version.

    This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
    without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
    See the GNU Lesser General Public License for ËœXPath Cahce details.

    The full text of the license is available at http://www.gnu.org/copyleft/lesser.html
-->
<!-- This is the Orbeon Forms Form Runner standard summary page -->
<html xmlns:xs="http://www.w3.org/2001/XMLSchema"
      xmlns:xforms="http://www.w3.org/2002/xforms"
      xmlns:ev="http://www.w3.org/2001/xml-events"
      xmlns:xxforms="http://orbeon.org/oxf/xml/xforms"
      xmlns:xi="http://www.w3.org/2001/XInclude"
      xmlns:f="http://orbeon.org/oxf/xml/formatting"
      xmlns:xhtml="http://www.w3.org/1999/xhtml"
      xmlns:xxi="http://orbeon.org/oxf/xml/xinclude"
      xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
      xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
      xmlns="http://www.w3.org/1999/xhtml">

    <head>
        <title>Orbeon Form Runner</title>
        <xhtml:link rel="stylesheet" href="/ops/css/yui/reset-fonts-grids.css" type="text/css"/>
        <xhtml:link rel="stylesheet" href="/ops/css/yui/base-min.css" type="text/css"/>
        <xhtml:link rel="stylesheet" href="/apps/fr/style/form-runner.css" type="text/css"/>
        <!-- Summary page XForms model -->
        <xforms:model id="fr-form-model">

            <xforms:instance id="fr-form-instance">
                <dummy/>
            </xforms:instance>

            <xforms:action ev:event="xforms-ready">
                <!-- Query list of documents -->
                <xforms:send submission="search-submission"/>
            </xforms:action>

        </xforms:model>
        <!-- Model to handle resources -->
        <xforms:model id="fr-resources-model">

            <xforms:action ev:event="xforms-ready">
                <xforms:send submission="update-fr-form-resources-submission"/>
            </xforms:action>

            <!-- XForms instance containing the current language -->
            <xforms:instance id="fr-language-instance">
                <language xmlns="">en</language>
            </xforms:instance>

            <!-- XForms instance containing generic resources -->
            <xforms:instance id="fr-common-resources"
                             src="oxf:/apps/fr/resources_en.xml"
                             xxforms:readonly="true"/>

            <!-- XForms instance containing text resources -->
            <xforms:instance id="fr-form-resources">
                <resources xmlns=""/>
            </xforms:instance>

            <!-- Submissions to update the language -->
            <xforms:submission id="update-fr-common-resources-submission" serialization="none"
                               action="oxf:/apps/fr/resources_{instance('fr-language-instance')}.xml"
                               method="get" replace="instance" instance="fr-common-resources"
                               xxforms:readonly="true"/>


            <xforms:submission id="update-fr-form-resources-submission" serialization="none"
                               action="/fr/service/resources/{
                                    xxforms:instance('fr-parameters-instance')/app}/{
                                    xxforms:instance('fr-parameters-instance')/form}/{instance('fr-language-instance')}"
                               method="get" replace="instance" instance="fr-form-resources"
                               xxforms:readonly="true"/>

            <!-- Respond to orbeon-update-language event -->
            <xforms:action ev:event="orbeon-update-language">
                <xforms:send submission="update-fr-common-resources-submission"/>
                <xforms:send submission="update-fr-form-resources-submission"/>
            </xforms:action>

        </xforms:model>
    </head>
    <body>
        <fr:view>
            <xforms:label>Orbeon Form Runner</xforms:label>
            <xhtml:img src="/apps/fr/style/orbeon-logo-trimmed-transparent-42.png"/> 
            <fr:body>
                <h2>
                    <xforms:output model="fr-persistence-model" value="instance('fr-source-form-instance')/xhtml:head/xhtml:title"/>
                </h2>

                <xforms:group appearance="xxforms:internal">

                    <!-- Free-text search -->
                    <xforms:input model="fr-persistence-model" ref="instance('fr-search-instance')/query" incremental="true" class="fr-search-input">
                        <xforms:label model="fr-resources-model" ref="instance('fr-common-resources')/summary/labels/free-search"/>
                    </xforms:input>

                    <!-- Structured search -->
                    <table>
                        <tr>
                            <xforms:repeat model="fr-persistence-model" nodeset="instance('fr-search-instance')/query[@path]" id="search-repeat">
                                <td>
                                    <!-- input field -->
                                    <xforms:input ref=".[@control = 'input']" incremental="true" >
                                        <xforms:label>
                                            <xforms:output model="fr-resources-model" value="instance('fr-form-resources')/summary/titles/*[local-name() = context()/@name]"/>
                                        </xforms:label>
                                    </xforms:input>
                                    <!-- select1 field -->
                                    <xforms:select1 ref=".[@control = 'select1']">
                                        <xforms:label>
                                            <xforms:output model="fr-resources-model" value="instance('fr-form-resources')/summary/titles/*[local-name() = context()/@name]"/>
                                        </xforms:label>
                                        <xforms:item>
                                            <xforms:label>[Any]</xforms:label>
                                            <xforms:value/>
                                        </xforms:item>
                                        <xforms:itemset nodeset="instance('fr-source-form-instance')/xhtml:head/xforms:model/xforms:instance[@id = concat(context()/@name, 's-itemset')]/*/*">
                                            <xforms:label ref="name"/>
                                            <xforms:value ref="value"/>
                                        </xforms:itemset>
                                    </xforms:select1>
                                </td>
                            </xforms:repeat>
                        </tr>
                    </table>
                    
                    <!-- Send search when values change -->
                    <xforms:send ev:event="xforms-value-changed" submission="search-submission"/>
                </xforms:group>

                <xforms:group model="fr-persistence-model" ref="instance('fr-summary-instance')[document]">

                    <!-- Display welcome message -->
                    <xforms:output model="fr-resources-model" mediatype="text/html"
                                   value="saxon:serialize(instance('fr-common-resources')/summary/messages/intro/node(), 'html')"
                                   class="fr-summary-welcome-message"/>

                    <table class="fr-tabular fr-summary-table">
                        <thead>
                            <tr>
                                <th><xforms:output model="fr-resources-model" value="instance('fr-common-resources')/summary/titles/row-number"/></th>
                                <th><xforms:output model="fr-resources-model" value="instance('fr-common-resources')/summary/titles/created"/></th>
                                <th><xforms:output model="fr-resources-model" value="instance('fr-common-resources')/summary/titles/last-modified"/></th>
                                <xforms:repeat nodeset="instance('fr-configuration-instance')/xforms:*[tokenize(@class, ' ') = 'fr-summary']">
                                    <th>
                                        <!-- Iterate through specially marked controls and derive resource id then resource -->
                                        <xforms:output model="fr-resources-model"
                                                       value="for $id in substring-before(context()/@id, '-control')
                                                              return for $resource in (instance('fr-form-resources')/summary/titles/*[local-name() = $id], '')
                                                                     return if ($resource != '') then $resource else concat('[', $id, ']')"/>
                                    </th>
                                </xforms:repeat>
                            </tr>
                        </thead>
                        <tbody>
                            <xforms:repeat nodeset="document" id="documents-repeat">
                                <tr>
                                    <td>
                                        <xforms:output value="instance('fr-paging-instance')/from + count(preceding-sibling::document)"/>
                                    </td>
                                    <td>
                                        <xforms:group ref="@created">
                                            <xforms:output value="if (. castable as xs:dateTime) then format-dateTime(xs:dateTime(.), xxforms:instance('fr-common-resources')/summary/formats/save-datetime, xxforms:instance('fr-language-instance'), (), ()) else ."/>
                                        </xforms:group>
                                    </td>
                                    <td>
                                        <xforms:group ref="@last-modified">
                                            <xforms:output value="if (. castable as xs:dateTime) then format-dateTime(xs:dateTime(.), xxforms:instance('fr-common-resources')/summary/formats/save-datetime, xxforms:instance('fr-language-instance'), (), ()) else ."/>
                                        </xforms:group>
                                    </td>
                                    <xforms:repeat nodeset="details/detail">
                                        <td>
                                            <!-- Input control -->
                                            <xforms:group ref=".[instance('fr-search-instance')/query[count(context()/preceding-sibling::detail) + 2]/@control = 'input']">
                                                <xforms:output value="if (. castable as xs:date) then format-date(xs:date(.), xxforms:instance('fr-common-resources')/summary/formats/date, xxforms:instance('fr-language-instance'), (), ()) else ."/>
                                            </xforms:group>

                                            <!-- Selection control -->
                                            <xforms:group ref=".[instance('fr-search-instance')/query[count(context()/preceding-sibling::detail) + 2]/@control = 'select1']">
                                                <xforms:output value="."/>
                                                <!-- TODO: Obtain value from itemset -->
                                                <!--instance('fr-source-form-instance')/xhtml:head/xforms:model/xforms:instance[@id = concat(xxforms:context('documents-repeat')/@name, 's-itemset')]/*/*-->
                                            </xforms:group>
                                        </td>
                                    </xforms:repeat>
                                </tr>
                            </xforms:repeat>
                        </tbody>
                    </table>

                    <!--<p>-->
                        <!--<xforms:output model="fr-resources-model" value="instance('fr-common-resources')/summary/titles/selected"/>:-->
                        <!--<xforms:output value="instance('fr-paging-instance')/from + index('documents-repeat') - 1"/>-->
                        <!--<xforms:output model="fr-resources-model" value="instance('fr-common-resources')/summary/titles/of"/>-->
                        <!--<xforms:output value="instance('fr-paging-instance')/total"/>-->
                    <!--</p>-->

                    <div class="fr-paging-buttons">
                        <xforms:trigger ref="instance('fr-paging-instance')/prev-trigger" class="xxx">
                            <xforms:label>
                                <xhtml:img src="../../apps/fr/style/previous.gif" alt="Previous" title="Previous"/>
                                <xhtml:span><xforms:output model="fr-resources-model" value="instance('fr-common-resources')/summary/labels/previous"/></xhtml:span>
                            </xforms:label>
                            <xforms:action ev:event="DOMActivate">
                                <xforms:setvalue ref="instance('fr-search-instance')/page-number" value=". - 1"/>
                                <xforms:send submission="search-submission"/>
                            </xforms:action>
                        </xforms:trigger>

                        <span class="fr-paging-numbers">
                            <xforms:output value="instance('fr-paging-instance')/from + index('documents-repeat') - 1"/>
                            <xforms:output model="fr-resources-model" value="instance('fr-common-resources')/summary/titles/of"/>
                            <xforms:output value="instance('fr-paging-instance')/total"/>
                        </span>

                        <xforms:trigger ref="instance('fr-paging-instance')/next-trigger">
                            <xforms:label>
                                <xhtml:span><xforms:output model="fr-resources-model" value="instance('fr-common-resources')/summary/labels/next"/></xhtml:span>
                                <xhtml:img src="../../apps/fr/style/next.gif" alt="Next" title="Next"/>
                            </xforms:label>
                            <xforms:action ev:event="DOMActivate">
                                <xforms:setvalue ref="instance('fr-search-instance')/page-number" value=". + 1"/>
                                <xforms:send submission="search-submission"/>
                            </xforms:action>
                        </xforms:trigger>
                    </div>

                </xforms:group>

                <!-- Display this when no form is found -->
                <xforms:group model="fr-persistence-model" ref="instance('fr-summary-instance')[not(document)]">
                    <xforms:output model="fr-resources-model" mediatype="text/html" value="saxon:serialize(instance('fr-common-resources')/summary/messages/no-form-found/node(), 'html')"/>
                </xforms:group>

                <!--<widget:xforms-instance-inspector xmlns:widget="http://orbeon.org/oxf/xml/widget"/>-->

            </fr:body>
            <fr:buttons>
                <xhtml:div class="fr-buttons fr-summary-buttons">
                    <xforms:trigger>
                        <xforms:label>
                            <xhtml:img src="../../apps/fr/style/add.gif" alt="Create"/>
                            <xhtml:span><xforms:output model="fr-resources-model" ref="instance('fr-common-resources')/summary/labels/new-form"/></xhtml:span>
                        </xforms:label>
                        <xforms:dispatch ev:event="DOMActivate" target="fr-persistence-model" name="orbeon-create"/>
                    </xforms:trigger>
                    <xforms:trigger>
                        <xforms:label>
                            <xhtml:img src="../../apps/fr/style/run.gif" alt="Edit"/>
                            <xhtml:span><xforms:output model="fr-resources-model" ref="instance('fr-common-resources')/summary/labels/edit-form"/></xhtml:span>
                        </xforms:label>
                        <xforms:dispatch ev:event="DOMActivate" target="fr-persistence-model" name="orbeon-edit"/>
                    </xforms:trigger>
                    <xforms:trigger>
                        <xforms:label>
                            <xhtml:img src="../../apps/fr/style/lockedstate.gif" alt="Delete"/>
                            <xhtml:span><xforms:output model="fr-resources-model" ref="instance('fr-common-resources')/summary/labels/view-readonly"/></xhtml:span>
                        </xforms:label>
                        <xforms:dispatch ev:event="DOMActivate" target="fr-persistence-model" name="orbeon-view"/>
                    </xforms:trigger>
                    <xforms:trigger>
                        <xforms:label>
                            <xhtml:img src="../../apps/fr/style/delete.gif" alt="Delete"/>
                            <xhtml:span><xforms:output model="fr-resources-model" ref="instance('fr-common-resources')/summary/labels/delete-form"/></xhtml:span>
                        </xforms:label>
                        <xforms:dispatch ev:event="DOMActivate" target="fr-persistence-model" name="orbeon-delete"/>
                    </xforms:trigger>

                    <!--
                    <xforms:trigger>
                        <xforms:label>
                            <xhtml:img src="../../apps/fr/style/lockedstate.gif" alt="View"/>
                            <xforms:output model="fr-resources-model" ref="instance('fr-common-resources')/summary/labels/view-readonly"/>
                        </xforms:label>
                        <xforms:dispatch ev:event="DOMActivate" target="fr-persistence-model" name="orbeon-view"/>
                    </xforms:trigger>
                    <xforms:trigger>
                        <xforms:label>
                            <xhtml:img src="../../apps/fr/style/view-xml.gif" alt="XML"/>
                            <xforms:output model="fr-resources-model" ref="instance('fr-common-resources')/summary/labels/view-xml"/>
                        </xforms:label>
                        <xforms:dispatch ev:event="DOMActivate" target="fr-persistence-model" name="orbeon-xml"/>
                    </xforms:trigger>
                    <xforms:trigger>
                        <xforms:label>
                            <xhtml:img src="../../apps/fr/style/pdf.png" alt="PDF"/>
                            <xforms:output model="fr-resources-model" ref="instance('fr-common-resources')/summary/labels/view-pdf"/>
                        </xforms:label>
                        <xforms:dispatch ev:event="DOMActivate" target="fr-persistence-model" name="orbeon-pdf"/>
                    </xforms:trigger>
                    -->
                </xhtml:div>
                <xhtml:div class="fr-summary-language-choice">
                    <!-- Switch languages -->
                    <!-- TODO: get list of languages through service -->
                    <xforms:select1 model="fr-resources-model" ref="instance('fr-language-instance')">
                        <xforms:label ref="instance('fr-common-resources')/summary/labels/language-choice"/>
                        <xforms:item>
                            <xforms:label>en</xforms:label>
                            <xforms:value>en</xforms:value>
                        </xforms:item>
                        <xforms:item>
                            <xforms:label>fr</xforms:label>
                            <xforms:value>fr</xforms:value>
                        </xforms:item>
                        <xforms:dispatch ev:event="xforms-value-changed" name="orbeon-update-language" target="fr-resources-model"/>
                    </xforms:select1>
                </xhtml:div>
            </fr:buttons>

        </fr:view>

        <!--<table class="forms-action-table">-->
            <!--<tr>-->
                <!--<td>-->
                    <!--<xforms:group ref="instance('control-instance')/empty-triggers">-->
                        <!--<xforms:action ev:event="DOMActivate">-->
                            <!--<xforms:send submission="import-documents-submission"/>-->
                            <!--<xforms:send submission="list-documents-submission"/>-->
                        <!--</xforms:action>-->
                        <!--<xforms:trigger appearance="minimal" ref=".">-->
                            <!--<xforms:label>-->
                                <!--<xhtml:img src="../apps/forms/images/add-all.gif" alt="Import Forms"/>-->
                                <!--<xforms:output model="fr-resources-model" ref="instance('fr-common-resources')/summary/labels/import-forms"/>-->
                            <!--</xforms:label>-->
                        <!--</xforms:trigger>-->
                    <!--</xforms:group>-->
                <!--</td>-->
            <!--</tr>-->
        <!--</table>-->

    </body>
</html>