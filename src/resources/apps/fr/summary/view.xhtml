<!--
  Copyright (C) 2010 Orbeon, Inc.

  This program is free software; you can redistribute it and/or modify it under the terms of the
  GNU Lesser General Public License as published by the Free Software Foundation; either version
  2.1 of the License, or (at your option) any later version.

  This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
  without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
  See the GNU Lesser General Public License for more details.

  The full text of the license is available at http://www.gnu.org/copyleft/lesser.html
  -->
<!-- This is the Orbeon Forms Form Runner standard summary page -->
<html xmlns:xs="http://www.w3.org/2001/XMLSchema"
      xmlns:xf="http://www.w3.org/2002/xforms"
      xmlns:ev="http://www.w3.org/2001/xml-events"
      xmlns:xxf="http://orbeon.org/oxf/xml/xforms"
      xmlns:xi="http://www.w3.org/2001/XInclude"
      xmlns:f="http://orbeon.org/oxf/xml/formatting"
      xmlns:xh="http://www.w3.org/1999/xhtml"
      xmlns:xxi="http://orbeon.org/oxf/xml/xinclude"
      xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
      xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
      xmlns:saxon="http://saxon.sf.net/"
      xmlns:frf="java:org.orbeon.oxf.fr.FormRunner"
      xmlns:index="org.orbeon.oxf.fr.relational.Index"
      xmlns:indexedControl="org.orbeon.oxf.fr.relational.Index$IndexedControl"
      xmlns="http://www.w3.org/1999/xhtml">

    <head>
        <!-- Make sure to use the source form's title -->
        <xh:title><xf:output value="$source-form-metadata/title[@xml:lang = xxf:instance('fr-language-instance')], $source-form-metadata/title"/></xh:title>
        <xh:link rel="stylesheet" href="/apps/fr/style/form-runner-summary.css" type="text/css" media="all"/>
        <!-- Summary page XForms model -->
        <xf:model id="fr-form-model" xxf:xpath-analysis="true">

            <xf:var name="parameters" value="xxf:instance('fr-parameters-instance')"/>

            <xf:var name="app" as="xs:string" value="xxf:instance('fr-parameters-instance')/app"/>
            <xf:var name="form" as="xs:string" value="xxf:instance('fr-parameters-instance')/form"/>

            <!-- NOTE: This test is duplicated in other places -->
            <xf:var name="is-form-builder" value="$app = 'orbeon' and $form = 'builder'"/>

            <xf:var name="has-roles" value="xxf:instance('fr-permissions')/@has-roles = 'true'" as="xs:boolean"/>
            <xf:var name="app-query" value="if ($is-form-builder and $has-roles) then instance('fr-search-instance')/query[contains(@path, 'application-name') and @search-field = 'true'] else ()" as="element(query)?"/>
            <xf:var name="form-query" value="if ($app-query) then instance('fr-search-instance')/query[contains(@path, 'form-name') and @search-field = 'true'] else ()" as="element(query)?"/>
            <xf:var name="initial-app-value" value="if ($app-query) then xxf:instance('fr-permissions')/app[1][not(@name = '*')]/@name else ()" as="xs:string?"/>

            <!-- Source form -->
            <xf:instance id="fr-source-form-instance" xxf:readonly="false"><!-- Set to false so that xf:insert works -->
                <form xmlns=""/>
            </xf:instance>

            <xf:var
                name="source-form-metadata"
                value="instance('fr-source-form-instance')/xh:head/xf:model/xf:instance[@id = 'fr-form-metadata']/*"/>

            <xf:var
                name="source-form-attachments"
                value="instance('fr-source-form-instance')/xh:head/xf:model/xf:instance[@id = 'fr-form-attachments']/*"/>

            <xf:var
                name="has-pdf-template"
                value="normalize-space($source-form-attachments/pdf)"/>

            <!-- NOTE: use xxf:cache="false" otherwise updates to the form won't work in the summary page -->
            <!-- A solution for this might be for read-form.xpl, which is able to use conditional GET, to run always, or to
                 improve submissions to handle conditional GET as well when using caching. -->
            <xf:submission id="get-source-form-submission"
                    method="get" serialization="none"
                    resource="/fr/service/persistence/crud/{$app}/{$form}/form/form.xhtml"
                    replace="instance" instance="fr-source-form-instance" xxf:readonly="true" xxf:cache="false" xxf:xinclude="true"/>

            <!-- Standard Form Runner data instance -->
            <xf:instance id="fr-form-instance">
                <dummy/>
            </xf:instance>

            <!-- Standard Form Runner resources instance -->
            <xf:instance id="fr-form-resources">
                <resources xmlns=""/>
            </xf:instance>

            <!-- Instance to control the triggers' appearance -->
            <xf:instance id="fr-summary-triggers-instance">
                <triggers xmlns="">
                    <enabled/>
                    <disabled/>
                </triggers>
            </xf:instance>

            <xf:bind ref="instance('fr-summary-triggers-instance')/disabled" readonly="true()"/>

            <xf:var name="parameters" value="xxf:instance('fr-parameters-instance')"/>

            <xf:action ev:event="fr-summary-create">
                <xf:load resource="/fr/{$app}/{$form}/new{if (property('xxf:noscript')) then '?fr-noscript=true' else ''}"/>
            </xf:action>

            <xf:action ev:event="fr-summary-view" if="count(xxf:split(instance('fr-selection-instance'))) = 1">
                <xf:load resource="/fr/{$app}/{$form}/view/{normalize-space(instance('fr-selection-instance'))}{if (property('xxf:noscript')) then '?fr-noscript=true' else ''}"/>
            </xf:action>

            <!-- Instance to track search results and paging -->
            <!-- NOTE: As of 2011-11-28, `app` and `form` are not set by us. We leave them in for now because the
                 built-in eXist, Oracle and MySQL implementations rely on them in the Form Runner page flow. -->
            <xf:instance id="fr-search-instance">
                <search xmlns="">
                    <query/>
                    <page-size>5</page-size>
                    <page-number>1</page-number>
                    <lang/>
                </search>
            </xf:instance>

            <xf:bind ref="instance('fr-search-instance')">
                <!-- Don't send this to the server -->
                <xf:bind ref="query/(@search-field | @summary-field)" relevant=". = 'true'"/>
                <!-- Set types so the search fields display the proper controls -->
                <xf:bind ref="query[ends-with(@type, ':date')]" type="xf:date"/>
                <xf:bind ref="query[ends-with(@type, ':time')]" type="xf:time"/>
                <xf:bind ref="query[ends-with(@type, ':dateTime')]" type="xf:dateTime"/>

                <!-- Set default value for app and form if needed -->
                <!-- Do this declaratively so we don't depend on order of execution of submissions -->
                <xf:bind ref="$app-query" readonly="false()"
                             calculate="if (normalize-space() = '' and $initial-app-value) then $initial-app-value else ."/>
                <!-- Adjust value for form if there is an app constraint and a form constraint -->
                <xf:bind ref="$form-query" readonly="false()"
                             calculate="(for $a in xxf:instance('fr-permissions')/app[@name = $app-query]
                                             return for $current in . return if ($a/form[@name = ($current, '*')]) then .
                                                 else $a/form[1]/@name, .)[1]"/>
                <!-- Force exact query match if there is an app constraint -->
                <xf:bind ref="$app-query/@match" readonly="false()" calculate="if ($initial-app-value) then 'exact' else ."/>
                <!-- Force exact query match if there is a form constraint -->
                <xf:bind ref="$form-query/@match" readonly="false()" calculate="if (xxf:instance('fr-permissions')/app[@name = $app-query]/form[1][not(@name = '*')]) then 'exact' else ."/>

            </xf:bind>

            <xf:instance id="fr-search-template" xxf:readonly="true">
                <query xmlns="" name="" path="" type="" control="" search-field="" summary-field="" match="substring"/>
            </xf:instance>

            <!-- Paging information -->
            <xf:instance id="fr-paging-instance">
                <search xmlns="">
                    <total/>
                    <search-total/>
                    <page-size/>
                    <page-number/>
                    <page-count/>
                    <from>0</from>
                    <to>0</to>
                    <prev-trigger/>
                    <next-trigger/>
                </search>
            </xf:instance>

            <!-- Calculations for page navigation -->
            <xf:bind ref="instance('fr-paging-instance')">
                <xf:bind ref="total"        calculate="(instance('fr-summary-instance')/@total, 0)[1]"/>
                <xf:bind ref="search-total" calculate="(instance('fr-summary-instance')/@search-total, 0)[1]"/>
                <xf:bind ref="page-size"    calculate="instance('fr-search-instance')/page-size"/>
                <xf:bind ref="page-number"  calculate="instance('fr-search-instance')/page-number"/>
                <xf:bind ref="page-count"   calculate="(../search-total + ../page-size - 1) idiv ../page-size"/>
                <xf:bind ref="from"         calculate="if (../search-total = 0) then 0 else (../page-number - 1) * ../page-size + 1"/>
                <xf:bind ref="to"           calculate="min((../page-number * ../page-size, ../search-total))"/>
                <xf:bind ref="prev-trigger" readonly="../search-total = 0 or xs:integer(../page-number) le 1"/>
                <xf:bind ref="next-trigger" readonly="../search-total = 0 or xs:integer(../search-total) le xs:integer(../to)"/>
            </xf:bind>

            <xf:instance id="fr-selection-instance">
                <selection xmlns=""/>
            </xf:instance>

            <!-- 1. Load source form -->
            <xf:action ev:event="xforms-model-construct-done">
                <xf:var name="source-form" value="xxf:get-request-attribute('fr-form-definition')"/>
                <xf:action if="exists($source-form)">
                    <!-- Got it from the request -->
                    <xf:message level="xxf:log-debug">Got source form from request.</xf:message>
                    <xf:insert ref="instance('fr-source-form-instance')" origin="$source-form"/>
                </xf:action>
                <xf:action if="not(exists($source-form))">
                    <!-- Try submission -->
                    <xf:message level="xxf:log-debug">Could not get source form from request. Trying submission instead.</xf:message>
                    <xf:send submission="get-source-form-submission"/>
                </xf:action>

                <!-- Send a "Not Found" error if the form definition is not found -->
                <xf:action if="empty(instance('fr-source-form-instance')/xh:head/xf:model)" type="xpath">
                    frf:sendError(404)
                </xf:action>
            </xf:action>

            <!-- 2. Check for authorized operations -->
            <xf:action ev:event="xforms-model-construct-done">

                <!-- Send a "Not Found" error if the for is not available -->
                <xf:action if="$source-form-metadata/available = 'false'" type="xpath">frf:sendError(404)</xf:action>

                <xf:var name="ops" value="frf:javaAuthorizedOperationsBasedOnRoles($source-form-metadata/permissions)"/>
                <xf:setvalue ref="xxf:instance('fr-authorized-operations')" value="string-join($ops, ' ')"/>
                <!-- Send an "Unauthorized" error if the user is unauthorized -->
                <xf:action if="not(xxf:property('oxf.fr.support-owner-group')) and not($ops = ('*', 'read', 'update', 'delete'))" type="xpath">frf:sendError(403)</xf:action>
            </xf:action>

            <!-- 3. Rest of initialization -->
            <xf:action ev:event="xforms-model-construct-done">

                <!-- Load resources -->
                <xf:var name="resources-instance" as="element(xf:instance)"
                        value="instance('fr-source-form-instance')/xh:head/xf:model/xf:instance[@id = 'fr-form-resources']"/>

                <xf:action if="not($resources-instance/@src)">
                    <!-- Copy inline instance -->
                    <xf:insert ref="instance('fr-form-resources')" origin="$resources-instance/*"/>
                </xf:action>
                <xf:action if="$resources-instance/@src">
                    <!-- Dereference @src -->
                    <xf:insert ref="instance('fr-form-resources')" origin="doc($resources-instance/@src)"/>
                </xf:action>
                <!-- Update to current language -->
                <xf:dispatch name="fr-update-language" targetid="fr-resources-model"/>

                <!-- Set page size -->
                <xf:var name="page-size" value="instance('fr-search-instance')/page-size" as="element(page-size)"/>
                <xf:setvalue ref="$page-size" model="fr-persistence-model"
                             value="xxf:property(string-join(('oxf.fr.summary.page-size', $app, $form), '.'))"/>

                <!-- Rebuild resource variables after source form has been loaded, because resources model variables
                     (e.g. $fr-form-resources) are used right after we are called. If you don't rebuild, control labels
                     in structured search are not found. -->
                <xf:rebuild model="fr-resources-model"/>

                <xf:var name="summary-elements" as="element()*"
                        value="instance('fr-source-form-instance')/xh:body//*[(@ref or @bind) and @class and xxf:classes() = ('fr-summary', 'fr-search')]"/>

                <xf:var name="form-resources" model="fr-resources-model" value="$fr-form-resources" as="element(resource)?"/>

                <!-- Create elements holding structured search data -->
                <xf:action iterate="index:jFindIndexedControls(instance('fr-source-form-instance')/root())">
                    <xf:insert context="instance('fr-search-instance')" ref="query" origin="instance('fr-search-template')"/>
                    <xf:var name="query" value="instance('fr-search-instance')/query[last()]"/>
                    <xf:setvalue ref="$query/@name"          value="indexedControl:name     (context())"/>
                    <xf:setvalue ref="$query/@path"          value="indexedControl:xpath    (context())"/>
                    <xf:setvalue ref="$query/@type"          value="indexedControl:xsType   (context())"/>
                    <xf:setvalue ref="$query/@summary-field" value="indexedControl:inSummary(context())"/>
                    <xf:setvalue ref="$query/@search-field"  value="indexedControl:inSearch (context())"/>
                    <xf:setvalue ref="$query/@control"       value="indexedControl:control  (context())"/>
                </xf:action>

                <!-- Query initial list of documents -->
                <xf:send submission="search-submission"/>

            </xf:action>

            <!-- Summary data -->
            <xf:instance id="fr-summary-instance">
                <documents xmlns="" total="0" search-total="0">
                    <!-- Content will be like this -->
                    <!--
                    <document name="" created="" last-modified="">
                        <id/>
                        <details>
                            <detail/>
                            <detail/>
                        </details>
                    </document>
                    -->
                </documents>
            </xf:instance>

            <!-- This submission doesn't validate as we allow sending incomplete date, time and dateTime -->
            <xf:submission id="search-submission"
                    ref="instance('fr-search-instance')" validate="false"
                    method="post" resource="/fr/service/persistence/search/{$app}/{$form}"
                    replace="instance" instance="fr-summary-instance">
                <!-- Set language upon submitting -->
                <xf:action ev:event="xforms-submit">
                    <!-- This works now that #122 is fixed https://github.com/orbeon/orbeon-forms/issues/122 -->
                    <xf:setvalue ref="lang" value="xxf:instance('fr-language-instance')"/>
                </xf:action>
                <xf:action ev:event="xforms-submit-error">
                    <xf:message>Error performing search.</xf:message>
                </xf:action>
            </xf:submission>

        </xf:model>
    </head>
    <body>
        <fr:navbar/>
        <xh:div class="container">
            <fr:row>
                <!-- Whether this is the summary page for the form builder -->
                <xf:var name="is-form-builder" value="$app = 'orbeon' and $form = 'builder'"/>
                <!--<fr:header>-->
                    <!--&lt;!&ndash; Make sure to use the source form's logo &ndash;&gt;-->
                    <!--<fr:logo paths="$source-form-metadata/logo[@xml:lang = xxf:instance('fr-language-instance')], $source-form-metadata/logo"/>-->
                    <!--<fr:title/>-->
                    <!--<fr:language-selector/>-->
                    <!--<fr:noscript-selector/>-->
                    <!--<fr:form-builder-doc/>-->
                    <!--<fr:goto-content/>-->
                <!--</fr:header>-->
                <!--<fr:description paths="$source-form-metadata/description[@xml:lang = xxf:instance('fr-language-instance')], $source-form-metadata/description"/>-->
                <fr:body>
                    <xf:group class="fr-summary-search">

                        <!-- Search also when user presses "enter" in a field -->
                        <xf:action ev:event="DOMActivate">
                            <!-- Reset search selection and navigation -->
                            <xf:setvalue ref="instance('fr-selection-instance')" value="''"/>
                            <xf:setindex repeat="documents-repeat" index="1"/>
                            <xf:setvalue ref="instance('fr-search-instance')/page-number" value="1"/>

                            <xf:send submission="search-submission"/>
                        </xf:action>

                        <xf:switch id="search-switch">
                            <!-- Free-text search -->
                            <xf:case id="search-free">
                                <xh:div class="fr-search-free">
                                    <xf:input ref="instance('fr-search-instance')/query"/>
                                </xh:div>
                            </xf:case>
                            <!-- Search options -->
                            <xf:case id="search-options">
                                <xh:div class="fr-search-options">
                                    <!-- Special form builder search: use input or select1 for app/form name -->

                                    <!-- Application -->
                                    <xf:group ref="$app-query[$is-form-builder and $has-roles]" class="fr-summary-search-item">
                                        <xf:var name="label" value="frf:summaryLanguage(@name, $form-resources)"/>
                                        <!-- Use an input if app name is a wildcard -->
                                        <xf:var name="is-input" value="xxf:instance('fr-permissions')/app[@name = '*']" as="xs:boolean"/>
                                        <xf:input ref=".[$is-input]">
                                            <xf:label>
                                                <xf:output value="$label"/>
                                            </xf:label>
                                        </xf:input>
                                        <xf:select1 ref=".[not($is-input)]">
                                            <xf:label>
                                                <xf:output value="$label"/>
                                            </xf:label>
                                            <xf:itemset model="fr-roles-model" ref="instance('fr-permissions')/app">
                                                <xf:label ref="@name"/>
                                                <xf:value ref="@name"/>
                                            </xf:itemset>

                                            <xf:action ev:event="xforms-value-changed">
                                                <!-- Clear dependent form, actual value is recalculated just before submission if needed -->
                                                <xf:setvalue ref="$form-query"/>

                                                <!-- Reset search selection and navigation -->
                                                <xf:setvalue ref="instance('fr-selection-instance')" value="''"/>
                                                <xf:setindex repeat="documents-repeat" index="1"/>
                                                <xf:setvalue ref="instance('fr-search-instance')/page-number" value="1"/>

                                                <xf:send submission="search-submission"/>
                                            </xf:action>
                                        </xf:select1>
                                    </xf:group>
                                    <!-- Form -->
                                    <xf:group ref="$form-query" class="fr-summary-search-item">
                                        <xf:var name="label" value="frf:summaryLanguage(@name, $form-resources)"/>
                                        <xf:var name="current-app" value="xxf:instance('fr-permissions')/app[@name = $app-query]"/>
                                        <!-- Use an input if app name or form name is a wildcard -->
                                        <xf:var name="is-input" value="xxf:instance('fr-permissions')/app/@name = '*' or $current-app/form[@name = '*']" as="xs:boolean"/>
                                        <xf:input ref=".[$is-input]">
                                            <xf:label>
                                                <xf:output value="$label"/>
                                            </xf:label>
                                        </xf:input>
                                        <xf:select1 ref=".[not($is-input)]">
                                            <xf:label>
                                                <xf:output value="$label"/>
                                            </xf:label>
                                            <xf:itemset ref="$current-app/form">
                                                <xf:label ref="@name"/>
                                                <xf:value ref="@name"/>
                                            </xf:itemset>

                                            <!-- Update search results when selection changes -->
                                            <xf:action ev:event="xforms-value-changed">
                                                <!-- Reset search selection and navigation -->
                                                <xf:setvalue ref="instance('fr-selection-instance')" value="''"/>
                                                <xf:setindex repeat="documents-repeat" index="1"/>
                                                <xf:setvalue ref="instance('fr-search-instance')/page-number" value="1"/>

                                                <xf:send submission="search-submission"/>
                                            </xf:action>
                                        </xf:select1>
                                    </xf:group>
                                    <!-- Structured search over query terms that have search-field set to 'true' -->
                                    <xf:repeat ref="instance('fr-search-instance')/query[@path and @search-field = 'true']" id="search-repeat">
                                        <xf:var name="control-name" value="@name"/>
                                        <xf:var name="label" value="frf:summaryLanguage(@name, $form-resources)"/>

                                        <xf:group ref=".[not($is-form-builder and $has-roles and (contains(@path, 'application-name') or contains(@path, 'form-name')))]" class="fr-summary-search-item">
                                            <!-- Regular search field (exclude app/form name if we are Form Builder and we have roles) -->

                                            <!-- input -->
                                            <xf:input ref=".[@control = ('input', 'inplace-input', 'output')]">
                                                <xf:label value="$label"/>
                                            </xf:input>
                                            <!-- textarea -->
                                            <xf:input ref=".[@control = 'textarea']">
                                                <xf:label value="$label"/>
                                            </xf:input>
                                            <!-- select1 -->
                                            <xf:select1 ref=".[@control = 'select1']">
                                                <xf:label value="$label"/>
                                                <xf:item>
                                                    <xf:label ref="$fr-resources/summary/labels/any"/>
                                                    <xf:value/>
                                                </xf:item>
                                                <xf:itemset model="fr-persistence-model"
                                                                ref="$form-resources/*[local-name() = $control-name]/item">
                                                    <xf:label ref="label"/>
                                                    <xf:value ref="value"/>
                                                </xf:itemset>
                                            </xf:select1>
                                        </xf:group>
                                    </xf:repeat>
                                </xh:div>
                            </xf:case>
                        </xf:switch>

                        <xh:div class="fr-search-buttons">
                            <xf:trigger>
                                <xf:label mediatype="text/html" value="$fr-resources/summary/search/search-forms"/>
                            </xf:trigger>
                            <!-- Don't allow showing search options if there are no search fields specified -->
                            <xf:trigger appearance="minimal" ref=".[instance('fr-search-instance')/query[@path and @search-field = 'true']]">
                                <!-- Switch label depending on which case is shown -->
                                <xf:label ref="$fr-resources/summary/search/(if (xxf:case('search-switch') = 'search-free') then show-options else close-options)"/>
                                <xf:action ev:event="DOMActivate">
                                    <!-- Clear all queries when switching -->
                                    <xf:setvalue iterate="instance('fr-search-instance')/query" ref="."/>
                                    <!-- Switch the other case -->
                                    <xf:toggle case="search-{if (xxf:case('search-switch') = 'search-free') then 'options' else 'free'}"/>
                                    <xf:setfocus control="search-switch"/>
                                </xf:action>
                            </xf:trigger>
                        </xh:div>
                    </xf:group>

                    <xf:group ref="instance('fr-summary-instance')" xxf:update="full">

                        <xf:group ref="instance('fr-paging-instance')[search-total != total]" class="fr-summary-search-count">
                            <xf:output value="$fr-resources/summary/search/returned-1"/>
                            <xf:output value="instance('fr-paging-instance')/search-total"/>
                            <xf:output value="$fr-resources/summary/paging/of"/>
                            <xf:output value="instance('fr-paging-instance')/total"/>
                            <xf:output value="$fr-resources/summary/search/returned-2"/>
                        </xf:group>

                        <xf:var name="show-created" value="xxf:property(string-join(('oxf.fr.summary.show-created', $app, $form), '.'))"/>
                        <xf:var name="show-last-modified" value="xxf:property(string-join(('oxf.fr.summary.show-last-modified', $app, $form), '.'))"/>

                        <div class="fr-summary-table-div">
                            <xf:var name="have-drafts" value="exists(document[@draft = 'Y'])"/>
                            <xf:var name="drafts-class" value="string-join(('fr-summary-repeat-draft', if ($have-drafts) then () else 'xforms-hidden'), ' ')"/>
                            <xh:table width="940px" class="table table-bordered table-condensed">
                                <!-- scrollable="horizontal" width="940px" -->
                                <xh:thead>
                                    <xh:tr>
                                        <xh:th class="fr-summary-repeat-selection-checkbox"/>
                                        <xh:th class="{$drafts-class}"/>
                                        <xf:repeat ref="if ($show-created) then '' else ()">
                                            <xh:th fr:sortable="false" fr:resizeable="true">
                                                <xf:output value="$fr-resources/summary/titles/created"/>
                                            </xh:th>
                                        </xf:repeat>
                                        <xf:repeat ref="if ($show-last-modified) then '' else ()">
                                            <xh:th fr:sortable="false" fr:resizeable="true">
                                                <xf:output value="$fr-resources/summary/titles/last-modified"/>
                                            </xh:th>
                                        </xf:repeat>
                                        <!-- Iterate through specially marked controls and derive resource id then resource -->
                                        <xf:repeat ref="instance('fr-search-instance')/query[@summary-field = 'true']" id="fr-summary-repeat-column-number">
                                            <xh:th fr:sortable="false" fr:resizeable="true">
                                                <!-- Output showing as the header of the column -->
                                                <xf:output value="frf:summaryLanguage(@name, $form-resources)"/>
                                            </xh:th>
                                        </xf:repeat>
                                    </xh:tr>
                                </xh:thead>
                                <xh:tbody>
                                    <xf:repeat ref="1 to count(document)" id="documents-repeat"><!-- iterate over positions so that repeat iterations are not recreated  -->
                                        <!-- 1-based position in the current page -->
                                        <xf:var name="position" value="position()"/>
                                        <!-- Set context to current document -->
                                        <xf:group context="instance('fr-summary-instance')/document[$position]" appearance="xxf:internal">
                                            <xf:var name="document" value="."/>

                                            <!-- Document name and href for edition -->
                                            <xf:var name="current-document-name" value="@name" as="xs:string"/>
                                            <!-- TODO: remove this once we can assume that all the persistence API implementations return @operations -->
                                            <xf:var name="global-operations" value="xxf:split(xxf:instance('fr-authorized-operations'))"/>
                                            <xf:var name="current-document-operations" value="if (exists(@operations)) then xxf:split(@operations) else $global-operations" as="xs:string*"/>
                                            <xf:var name="edit-view" value="if ($current-document-operations = ('*', 'update')) then 'edit' else if ($current-document-operations = 'read') then 'view' else ''"/>
                                            <xf:var name="req-parameters" value="(
                                                    if (property('xxf:noscript')) then 'fr-noscript=true' else (),
                                                    if ($document/@draft = 'Y') then 'draft=1' else ()
                                                )"/>
                                            <xf:var name="current-document-href" value="concat('/fr/', $app, '/', $form, '/', $edit-view, '/', $current-document-name,
                                                    if (exists($req-parameters)) then concat('?', string-join($req-parameters, '&amp;')) else '')"/>
                                            <xh:tr class="{if (xxf:split(instance('fr-selection-instance')) = $current-document-name) then 'fr-summary-row-selected' else 'fr-summary-row-not-selected'}">
                                                <xh:td class="fr-summary-repeat-selection-checkbox">
                                                    <xf:select appearance="full" ref="instance('fr-selection-instance')" id="document-selection">
                                                        <xf:item>
                                                            <xf:label/>
                                                            <xf:value value="$current-document-name"/>
                                                        </xf:item>
                                                    </xf:select>
                                                </xh:td>
                                                <xh:td class="{$drafts-class}">
                                                    <xf:output ref="if ($document/@draft = 'Y') then . else ()" value="$fr-resources/summary/labels/draft" class="label"/>
                                                </xh:td>
                                                <!-- Why repeat and not group? -->
                                                <xf:repeat ref="if ($show-created) then '' else ()">
                                                    <xf:var name="created"
                                                                value="if ($document/@created castable as xs:dateTime)
                                                                       then format-dateTime(xs:dateTime($document/@created), $fr-resources/summary/formats/save-datetime, xxf:instance('fr-language-instance'), (), ())
                                                                       else ."/>
                                                    <xh:td>
                                                        <xf:group ref=".[$edit-view != '']">
                                                            <xh:a href="{$current-document-href}" target="_blank">
                                                                <xf:output value="$created"/>
                                                            </xh:a>
                                                        </xf:group>
                                                        <xf:group ref=".[$edit-view = '']">
                                                            <xf:output value="$created"/>
                                                        </xf:group>
                                                    </xh:td>
                                                </xf:repeat>
                                                <!-- Why repeat and not group? -->
                                                <xf:repeat ref="if ($show-last-modified) then '' else ()">
                                                    <xf:var name="last-modified"
                                                                value="if ($document/@last-modified castable as xs:dateTime)
                                                                       then format-dateTime(xs:dateTime($document/@last-modified), $fr-resources/summary/formats/save-datetime, xxf:instance('fr-language-instance'), (), ())
                                                                       else ."/>
                                                    <xh:td>
                                                        <xf:group ref=".[$edit-view != '']">
                                                            <xh:a href="{$current-document-href}" target="_blank">
                                                                <xf:output value="$last-modified"/>
                                                            </xh:a>
                                                        </xf:group>
                                                        <xf:group ref=".[$edit-view = '']">
                                                            <xf:output value="$last-modified"/>
                                                        </xf:group>
                                                    </xh:td>
                                                </xf:repeat>
                                                <!-- One column for each detail -->
                                                <xf:var name="positions" value="instance('fr-search-instance')/query[@name and @summary-field = 'true']/(count(preceding-sibling::query[@name]) + 1)"/>
                                                <!-- Iterate over positions so that repeat iterations are not recreated  -->
                                                <xf:repeat ref="$positions" id="document-details-repeat">
                                                    <!-- 1-based position in the current document-->
                                                    <xf:var name="position" value="position()"/>
                                                    <!-- Set context to current detail -->
                                                    <xf:group context="$document/details/detail[$positions[$position]]" appearance="xxf:internal">
                                                        <xh:td>
                                                            <!-- NOTE: Doing everything in a single big output XPath expression has the benefit of producing much less markup -->
                                                            <xf:var name="detail" value="
                                                                for $detail-position in $position return
                                                                    for $query in instance('fr-search-instance')/query[$detail-position + 1] return
                                                                        for $control in $query/@control return
                                                                            if ($control = 'textarea') then
                                                                                if (string-length(.) > 20) then concat(substring(., 1, 20), '...') else .
                                                                            else if ($control = 'select') then
                                                                                string-join(for $v in xxf:split() return $form-resources/*[local-name() = $query/@name]/item[value = $v]/label, ', ')
                                                                            else if ($control = 'select1') then
                                                                                for $v in . return $form-resources/*[local-name() = $query/@name]/item[value = $v]/label
                                                                            else
                                                                                for $type in substring-after($query/@type, ':') return
                                                                                    if ($type = 'date') then
                                                                                        (if (. castable as xs:date) then format-date(xs:date(.), $fr-resources/summary/formats/date, xxf:instance('fr-language-instance'), (), ()) else .)
                                                                                    else if ($type = 'time') then
                                                                                        (if (. castable as xs:time) then format-time(xs:time(.), $fr-resources/summary/formats/time, xxf:instance('fr-language-instance'), (), ()) else .)
                                                                                    else if ($type = 'dateTime') then
                                                                                        (if (. castable as xs:dateTime) then format-dateTime(xs:dateTime(.), $fr-resources/summary/formats/dateTime, xxf:instance('fr-language-instance'), (), ()) else .)
                                                                                    else if ($type = 'dayTimeDuration') then
                                                                                        (
                                                                                            if (. castable as xs:dayTimeDuration) then
                                                                                                string-join(
                                                                                                    (
                                                                                                        if (days-from-duration(.) = 0) then () else concat(days-from-duration(.), ' d'),
                                                                                                        if (hours-from-duration(.) = 0) then () else concat(hours-from-duration(.), ' h'),
                                                                                                        if (minutes-from-duration(.) = 0) then () else concat(minutes-from-duration(.), ' min'),
                                                                                                        if (seconds-from-duration(.) = 0) then () else concat(seconds-from-duration(.), ' sec')
                                                                                                     ), ' '
                                                                                                )
                                                                                            else .
                                                                                        )
                                                                                    else ."/>
                                                            <xf:group ref=".[$edit-view != '']">
                                                                <xh:a href="{$current-document-href}" target="_blank">
                                                                    <xf:output value="$detail"/>
                                                                </xh:a>
                                                            </xf:group>
                                                            <xf:group ref=".[$edit-view = '']">
                                                                <xf:output value="$detail"/>
                                                            </xf:group>
                                                        </xh:td>
                                                    </xf:group>
                                                </xf:repeat>
                                            </xh:tr>
                                        </xf:group>
                                    </xf:repeat>
                                    <xf:group ref=".[not(document)]">
                                        <xh:tr>
                                            <xh:td colspan="{4 + count(instance('fr-search-instance')/*[@summary-field = 'true'])}">
                                                <xf:output id="fr-no-form-data" mediatype="text/html" value="saxon:serialize($fr-resources/summary/messages/no-form-found/node(), 'html')"/>
                                            </xh:td>
                                        </xh:tr>
                                    </xf:group>
                                </xh:tbody>
                            </xh:table>
                        </div>
                    </xf:group>
                </fr:body>
            </fr:row>
            <fr:row>
                <div class="pagination pagination-left">
                    <ul>
                        <li class="{if (xxf:readonly(instance('fr-paging-instance')/prev-trigger)) then 'disabled' else ''}">
                            <xf:trigger ref="instance('fr-paging-instance')/prev-trigger" appearance="minimal" class="fr-navigate-first">
                                <xf:label>
                                    <xh:i class="icon-step-backward"/>
                                </xf:label>
                                <xf:action ev:event="DOMActivate">
                                    <xf:setvalue ref="instance('fr-search-instance')/page-number" value="1"/>
                                    <xf:setindex repeat="documents-repeat" index="1"/>
                                    <xf:send submission="search-submission"/>
                                </xf:action>
                            </xf:trigger>
                        </li>
                        <li class="{if (xxf:readonly(instance('fr-paging-instance')/prev-trigger)) then 'disabled' else ''}">
                            <xf:trigger ref="instance('fr-paging-instance')/prev-trigger" appearance="minimal" class="fr-navigate-prev">
                                <xf:label>
                                    <xh:i class="icon-chevron-left"/>
                                </xf:label>
                                <xf:action ev:event="DOMActivate">
                                    <xf:setvalue ref="instance('fr-search-instance')/page-number" value=". - 1"/>
                                    <xf:setindex repeat="documents-repeat" index="1"/>
                                    <xf:send submission="search-submission"/>
                                </xf:action>
                            </xf:trigger>
                        </li>
                        <!-- Some results -->
                        <xf:group class="fr-paging-numbers" ref=".[xs:integer(instance('fr-paging-instance')/search-total) gt 0]">
                            <li>
                                <span>
                                    <xf:output value="max((instance('fr-paging-instance')/from, 0))"/>
                                    <xf:output value="$fr-resources/summary/paging/to"/>
                                    <xf:output value="max((instance('fr-paging-instance')/to, 0))"/>
                                    <xf:output value="$fr-resources/summary/paging/of"/>
                                    <xf:output value="instance('fr-paging-instance')/search-total"/>
                                </span>
                            </li>
                        </xf:group>
                        <xf:group class="fr-paging-numbers" ref=".[xs:integer(instance('fr-paging-instance')/search-total) = 0]">
                            <!-- No results -->
                        </xf:group>
                        <li class="{if (xxf:readonly(instance('fr-paging-instance')/next-trigger)) then 'disabled' else ''}">
                            <xf:trigger ref="instance('fr-paging-instance')/next-trigger" appearance="minimal" class="fr-navigate-next">
                                <xf:label>
                                    <xh:i class="icon-chevron-right"/>
                                </xf:label>
                                <xf:action ev:event="DOMActivate">
                                    <xf:setvalue ref="instance('fr-search-instance')/page-number" value=". + 1"/>
                                    <xf:setindex repeat="documents-repeat" index="1"/>
                                    <xf:send submission="search-submission"/>
                                </xf:action>
                            </xf:trigger>
                        </li>
                        <li class="{if (xxf:readonly(instance('fr-paging-instance')/next-trigger)) then 'disabled' else ''}">
                            <xf:trigger ref="instance('fr-paging-instance')/next-trigger" appearance="minimal" class="fr-navigate-last">
                                <xf:label>
                                    <xh:i class="icon-step-forward"/>
                                </xf:label>
                                <xf:action ev:event="DOMActivate">
                                    <xf:setvalue ref="instance('fr-search-instance')/page-number" value="instance('fr-paging-instance')/page-count"/>
                                    <xf:setindex repeat="documents-repeat" index="1"/>
                                    <xf:send submission="search-submission"/>
                                </xf:action>
                            </xf:trigger>
                        </li>
                    </ul>
                </div>

                <xf:group model="fr-form-model" class="fr-buttons">

                    <xf:var name="global-operations"    value="xxf:split(xxf:instance('fr-authorized-operations'))"/>
                    <xf:var name="documents-selected"   value="xxf:split(instance('fr-selection-instance'))"/>
                    <xf:var name="documents-operations" value="instance('fr-summary-instance')/document[@name = $documents-selected]/@operations"/>
                    <xf:var name="documents-can-view"   value="empty($documents-operations[not(xxf:split() = ('*', 'read'))])"/>
                    <xf:var name="documents-can-delete" value="empty($documents-operations[not(xxf:split() = ('*', 'delete'))])"/>

                    <xf:var name="new-visible"          value="$global-operations = ('*', 'create')"/>
                    <xf:var name="view-enabled"         value="property('xxf:noscript') or (count($documents-selected)  = 1 and $documents-can-view)"/>
                    <xf:var name="delete-enabled"       value="property('xxf:noscript') or (count($documents-selected) != 0 and $documents-can-delete)"/>

                    <xf:var name="enabled"              value="instance('fr-summary-triggers-instance')/enabled"/>
                    <xf:var name="disabled"             value="instance('fr-summary-triggers-instance')/disabled"/>

                    <!-- Directly iterate over the tokenized property -->
                    <xf:repeat ref="xxf:split(xxf:property(string-join(('oxf.fr.summary.buttons', $app, $form), '.')))">
                        <xh:span class="fr-button">
                            <!-- Print/review button -->
                            <xf:group ref="if (. = ('print', 'review')) then if ($view-enabled) then $enabled else $disabled else ()">
                                <xf:trigger ref=".">
                                    <xf:label mediatype="text/html" value="$fr-resources/summary/buttons/review"/>
                                    <xf:action ev:event="DOMActivate">
                                        <!-- FIXME: assert(only one document selected) -->
                                        <xf:dispatch targetid="fr-form-model" name="fr-summary-view"/>
                                    </xf:action>
                                </xf:trigger>
                            </xf:group>
                            <!-- PDF button -->
                            <!-- Don't show the PDF template button in CE (also on detail page) -->
                            <xf:group ref="if (. = 'pdf' and not($has-pdf-template and not(version:isPE()))) then if ($view-enabled) then $enabled else $disabled else ()"
                                    xmlns:version="java:org.orbeon.oxf.common.Version">
                                <fr:href-button
                                        ref="."
                                        href="/fr/{$app}/{$form}/pdf/{xxf:split(normalize-space(instance('fr-selection-instance')))[1]}?fr-language={xxf:instance('fr-language-instance')}">
                                    <xf:label mediatype="text/html" value="$fr-resources/summary/buttons/pdf"/>
                                </fr:href-button>
                            </xf:group>
                            <!-- Test button -->
                            <xf:group ref="if (. = 'test') then if ($view-enabled) then $enabled else $disabled else ()">
                                <fr:href-button
                                        ref="."
                                        href="/fr/{$app}/{$form}/test/{normalize-space(instance('fr-selection-instance'))}{if (property('xxf:noscript')) then '?fr-noscript=true' else ''}">
                                    <xf:label mediatype="text/html" value="'Test'"/><!-- TODO: i18n -->
                                </fr:href-button>
                            </xf:group>
                            <!-- Delete button -->
                            <xf:group ref="if (. = 'delete') then if ($delete-enabled) then $enabled else $disabled else ()">
                                <xf:trigger ref=".">
                                    <xf:label mediatype="text/html" value="$fr-resources/summary/buttons/delete"/>
                                    <!-- Open delete confirmation dialog -->
                                    <xf:dispatch ev:event="DOMActivate" name="fr-show" targetid="delete-confirmation-dialog"/>
                                </xf:trigger>
                            </xf:group>
                            <!-- Import button -->
                            <xf:group ref="if (. = 'import' and $new-visible) then $enabled else ()">
                                <xf:trigger ref=".">
                                    <xf:label mediatype="text/html" value="$fr-resources/summary/buttons/import"/>
                                    <xf:load ev:event="DOMActivate" resource="/fr/{$app}/{$form}/import"/>
                                </xf:trigger>
                            </xf:group>
                            <!-- New button -->
                            <xf:group ref="if (. = 'new' and $new-visible) then $enabled else ()">
                                <xf:trigger ref="." appearance="xxf:primary">
                                    <xf:label mediatype="text/html" value="$fr-resources/summary/buttons/new"/>
                                    <xf:dispatch ev:event="DOMActivate" targetid="fr-form-model" name="fr-summary-create"/>
                                </xf:trigger>
                            </xf:group>
                        </xh:span>
                    </xf:repeat>
                </xf:group>
            </fr:row>
            <fr:row>
                <fr:version/>
            </fr:row>
        </xh:div>

        <!-- Delete confirmation dialog -->
        <fr:alert-dialog id="delete-confirmation-dialog" close="true">
            <fr:label ref="$fr-resources/summary/titles/delete-confirmation"/>
            <fr:message value="$fr-resources/summary/messages/delete-confirmation"/>
            <fr:negative-choice/>
            <fr:positive-choice>
                <xf:action ev:event="DOMActivate">
                    <!-- Parse the selected rows -->
                    <xf:action iterate="xxf:split(instance('fr-selection-instance'))">
                        <xf:var name="document-name" value="." as="xs:string"/>
                        <xf:dispatch name="fr-delete-data" targetid="fr-persistence-model">
                            <xf:property name="document-id" value="$document-name"/>
                        </xf:dispatch>
                    </xf:action>
                    <!-- Reset search selection and navigation -->
                    <xf:setvalue ref="instance('fr-selection-instance')" value="''"/>
                    <xf:setindex repeat="documents-repeat" index="1"/>
                    <xf:setvalue ref="instance('fr-search-instance')/page-number" value="1"/>
                    <!-- Update search -->
                    <xf:send submission="search-submission"/>
                </xf:action>
            </fr:positive-choice>
        </fr:alert-dialog>
    </body>
</html>
