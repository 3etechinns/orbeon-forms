<?xml version="1.0" encoding="utf-8"?>
<!--
    Copyright (C) 2008 Orbeon, Inc.

    This program is free software; you can redistribute it and/or modify it under the terms of the
    GNU Lesser General Public License as published by the Free Software Foundation; either version
    2.1 of the License, or (at your option) any later version.

    This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
    without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
    See the GNU Lesser General Public License for ËœXPath Cahce details.

    The full text of the license is available at http://www.gnu.org/copyleft/lesser.html
-->
<!-- This is the Orbeon Forms Form Runner standard summary page -->
<html xmlns:xs="http://www.w3.org/2001/XMLSchema"
      xmlns:xforms="http://www.w3.org/2002/xforms"
      xmlns:ev="http://www.w3.org/2001/xml-events"
      xmlns:xxforms="http://orbeon.org/oxf/xml/xforms"
      xmlns:xi="http://www.w3.org/2001/XInclude"
      xmlns:f="http://orbeon.org/oxf/xml/formatting"
      xmlns:xhtml="http://www.w3.org/1999/xhtml"
      xmlns:xxi="http://orbeon.org/oxf/xml/xinclude"
      xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
      xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
      xmlns="http://www.w3.org/1999/xhtml">

    <head>
        <title>Orbeon Form Runner</title>
        <xhtml:link rel="stylesheet" href="/ops/css/yui/reset-fonts-grids.css" type="text/css"/>
        <xhtml:link rel="stylesheet" href="/ops/css/yui/base-min.css" type="text/css"/>
        <xhtml:link rel="stylesheet" href="/apps/fr/style/form-runner.css" type="text/css"/>
        <!-- Summary page XForms model -->
        <xforms:model id="fr-form-model">

            <!-- Model initialization -->
            <xforms:action ev:event="xforms-model-construct-done">
                <!-- Get configuration for the current form -->
                <xforms:send submission="get-configuration-submission"/>

                <!-- Query list of documents -->
                <xforms:send submission="search-submission"/>
                <!-- Store resources from configuration instance -->
                <xforms:insert nodeset="instance('fr-form-resources')"
                               origin="instance('fr-source-form-instance')/xhtml:head/xforms:model/xforms:instance[@id = 'fr-form-resources']/*"/>
                <!-- Update to current language -->
                <xforms:dispatch name="fr-update-language" target="fr-resources-model"/>
            </xforms:action>

            <!-- Standard Form Runner data instance -->
            <xforms:instance id="fr-form-instance">
                <dummy/>
            </xforms:instance>

            <!-- Standard Form Runner resources instance -->
            <xforms:instance id="fr-form-resources">
                <resources xmlns=""/>
            </xforms:instance>

            <!-- Instance to control the triggers' appearance -->
            <xforms:instance id="fr-summary-triggers-instance">
                <triggers xmlns="">
                    <new/>
                    <edit/>
                    <view/>
                    <delete/>
                </triggers>
            </xforms:instance>

            <xforms:bind nodeset="instance('fr-summary-triggers-instance')">
                <!-- Operations on a given entry are disabled if there are no entries -->
                <xforms:bind nodeset="edit | view| delete" readonly="count(instance('fr-summary-instance')/document) = 0"/>
            </xforms:bind>

            <xxforms:variable name="parameters" select="xxforms:instance('fr-parameters-instance')"/>

            <xforms:action ev:event="orbeon-create">
                <xforms:recalculate/>
                <xforms:load resource="/fr/{$parameters/app}/{$parameters/form}/new/"/>
            </xforms:action>

            <xforms:action ev:event="orbeon-edit">
                <xforms:recalculate/>
                <xforms:load resource="/fr/{$parameters/app}/{$parameters/form}/{instance('fr-summary-instance')/document[index('documents-repeat')]/@name}/edit"/>
            </xforms:action>

            <xforms:action ev:event="orbeon-view">
                <xforms:recalculate/>
                <xforms:load resource="/fr/{$parameters/app}/{$parameters/form}/{instance('fr-summary-instance')/document[index('documents-repeat')]/@name}/view"/>
            </xforms:action>

            <xforms:action ev:event="orbeon-xml">
                <xforms:recalculate/>
                <!-- TODO -->
                <!--<xforms:load resource="xxx" f:url-type="resource"/>-->
            </xforms:action>

            <xforms:action ev:event="orbeon-pdf">
                <xforms:recalculate/>
                <!-- TODO -->
                <!--<xforms:load resource="xxx" f:url-type="resource" xxforms:show-progress="false"/>-->
            </xforms:action>

            <!-- Instance to track search results and paging -->
            <xforms:instance id="fr-search-instance">
                <search xmlns="">
                    <app/>
                    <form/>
                    <!-- Search query to execute -->
                    <query/>
                    <!-- Paging -->
                    <page-size>10</page-size>
                    <page-number>1</page-number>
                    <!-- Sorting -->
                    <sort-key/>
                </search>
            </xforms:instance>

            <xforms:instance id="fr-search-template" xxforms:readonly="true">
                <query xmlns="" name="" path="" type="" control=""/>
            </xforms:instance>

            <!-- Paging information -->
            <xforms:instance id="fr-paging-instance">
                <search xmlns="">
                    <total/>
                    <page-size/>
                    <page-number/>
                    <from>0</from>
                    <to>0</to>
                    <prev-trigger/>
                    <next-trigger/>
                </search>
            </xforms:instance>

            <!-- Calculations for page navigation -->
            <xforms:bind nodeset="instance('fr-paging-instance')">
                <xforms:bind nodeset="total" calculate="(instance('fr-summary-instance')/@total, 0)[1]"/>
                <xforms:bind nodeset="page-size" calculate="instance('fr-search-instance')/page-size"/>
                <xforms:bind nodeset="page-number" calculate="instance('fr-search-instance')/page-number"/>
                <xforms:bind nodeset="from" calculate="if (../total = 0) then 0 else (../page-number - 1)* ../page-size + 1"/>
                <xforms:bind nodeset="to" calculate="min((../page-number * ../page-size, ../total))"/>
                <xforms:bind nodeset="prev-trigger" readonly="../total = 0 or xs:integer(../page-number) le 1"/>
                <xforms:bind nodeset="next-trigger" readonly="../total = 0 or ../total le ../to"/>
            </xforms:bind>

            <xforms:instance id="fr-source-form-instance">
                <dummy xmlns=""/>
            </xforms:instance>

            <xforms:instance id="fr-summary-headers-instance">
                <dummy xmlns=""/>
            </xforms:instance>

            <xforms:instance id="fr-configuration-instance">
                <configuration xmlns=""/>
            </xforms:instance>

            <!-- TODO: Refactor this to persistence model -->
            <xforms:submission id="get-configuration-submission"
                    method="get" serialization="none"
                    resource="{xxforms:instance('fr-uris-instance')/form-collection}/crud/{$parameters/app}/{$parameters/form}/form/form.xhtml"
                    replace="instance" instance="fr-source-form-instance" xxforms:readonly="true">

                <!-- Extract summary configuration information from the XHTML document -->
                <xforms:action ev:event="xforms-submit-done">
                    <!--<xforms:insert context="instance('fr-search-instance')" nodeset="query"-->
                        <!--origin="instance('fr-source-form-instance')/search"/>-->

                    <!-- Extract fields which must appear in the summary -->
                    <xforms:insert context="instance('fr-configuration-instance')" nodeset="*"
                        origin="instance('fr-source-form-instance')/xhtml:body//xforms:*[@class and tokenize(@class, ' ') = ('fr-summary', 'fr-search')]"/>

                    <!-- Create elements holding structured search data -->
                    <xforms:action xxforms:iterate="instance('fr-source-form-instance')/xhtml:body//xforms:*[@class and tokenize(@class, ' ') = ('fr-search')]">
                        <!-- Insert empty template -->
                        <xforms:insert context="instance('fr-search-instance')" nodeset="query" origin="instance('fr-search-template')"/>
                        <!-- Add control information to template -->
                        <xforms:setvalue ref="instance('fr-search-instance')/query[last()]/@control" value="context()/local-name()"/>
                        <!-- Add meta-information to template -->
                        <xforms:action if="context()/@bind">
                            <xforms:action context="instance('fr-source-form-instance')/xhtml:head/xforms:model//xforms:bind[@id = context()/@bind]">
                                <xforms:setvalue ref="instance('fr-search-instance')/query[last()]/@name" value="substring-before(context()/@id, '-bind')"/>
                                <xforms:setvalue ref="instance('fr-search-instance')/query[last()]/@path" value="string-join(context()/ancestor-or-self::xforms:bind/@nodeset, '/')"/>
                                <xforms:setvalue ref="instance('fr-search-instance')/query[last()]/@type" value="if (context()/@type) then context()/@type else 'xs:string'"/>
                            </xforms:action>
                        </xforms:action>
                        <xforms:action if="context()/@ref">
                            <xforms:setvalue ref="instance('fr-search-instance')/query[last()]/@name" value="context()/@ref"/>
                            <xforms:setvalue ref="instance('fr-search-instance')/query[last()]/@path" value="string-join((context()/ancestor-or-self::*/(@ref | @context))[position() gt 1], '/')"/>
                        </xforms:action>
                    </xforms:action>

                    <!-- xxx TODO extract other information -->

                </xforms:action>
            </xforms:submission>

            <!-- Summary data -->
            <xforms:instance id="fr-summary-instance">
                <documents xmlns="" total="0">
                    <!-- Content will be like this -->
                    <!--<document name="" created="" last-modified="">-->
                        <!--<id/>-->
                        <!--<details>-->
                            <!--<detail/>-->
                            <!--<detail/>-->
                        <!--</details>-->
                    <!--</document>-->
                </documents>
            </xforms:instance>

            <xforms:submission id="search-submission"
                    ref="instance('fr-search-instance')" method="post"
                    resource="{xxforms:instance('fr-uris-instance')/data-collection}/search/{$parameters/app}/{$parameters/form}"
                    replace="instance" instance="fr-summary-instance"/>

        </xforms:model>
    </head>
    <body>
        <fr:view>
            <xforms:label>Orbeon Form Runner</xforms:label>
            <xhtml:img src="/apps/fr/style/orbeon-logo-trimmed-transparent-42.png"/> 
            <fr:body>
                <h2>
                    <xforms:output value="instance('fr-source-form-instance')/xhtml:head/xhtml:title"/>
                </h2>

                <xforms:group appearance="xxforms:internal">

                    <!-- Free-text search -->
                    <xforms:input ref="instance('fr-search-instance')/query" incremental="true" class="fr-search-input">
                        <xforms:label ref="$fr-resources/summary/labels/free-search"/>
                    </xforms:input>

                    <!-- Structured search -->
                    <table>
                        <tr>
                            <xforms:repeat nodeset="instance('fr-search-instance')/query[@path]" id="search-repeat">
                                <td>
                                    <!-- input -->
                                    <xforms:input ref=".[@control = 'input']" incremental="true" >
                                        <xforms:label>
                                            <xforms:output value="$form-resources/*[local-name() = context()/@name]"/>
                                        </xforms:label>
                                    </xforms:input>
                                    <!-- textarea -->
                                    <xforms:input ref=".[@control = 'textarea']" incremental="true" >
                                        <xforms:label>
                                            <xforms:output value="$form-resources/*[local-name() = context()/@name]"/>
                                        </xforms:label>
                                    </xforms:input>
                                    <!-- select1 -->
                                    <xforms:select1 ref=".[@control = 'select1']">
                                        <xforms:label>
                                            <xforms:output value="$form-resources/*[local-name() = context()/@name]"/>
                                        </xforms:label>
                                        <xforms:item>
                                            <xforms:label>[Any]</xforms:label>
                                            <xforms:value/>
                                        </xforms:item>
                                        <xforms:itemset nodeset="instance('fr-source-form-instance')/xhtml:head/xforms:model/xforms:instance[@id = concat(context()/@name, 's-itemset')]/*/*">
                                            <xforms:label ref="name"/>
                                            <xforms:value ref="value"/>
                                        </xforms:itemset>
                                    </xforms:select1>
                                </td>
                            </xforms:repeat>
                        </tr>
                    </table>
                    
                    <!-- Send search when values change -->
                    <xforms:send ev:event="xforms-value-changed" submission="search-submission"/>
                </xforms:group>

                <xforms:group ref="instance('fr-summary-instance')[document]">

                    <!-- Display welcome message -->
                    <xforms:output mediatype="text/html"
                                   value="saxon:serialize($fr-resources/summary/messages/intro/node(), 'html')"
                                   class="fr-summary-welcome-message"/>

                    <table class="fr-tabular fr-summary-table">
                        <thead>
                            <tr>
                                <th><xforms:output value="$fr-resources/summary/titles/row-number"/></th>
                                <th><xforms:output value="$fr-resources/summary/titles/created"/></th>
                                <th><xforms:output value="$fr-resources/summary/titles/last-modified"/></th>
                                <!-- Iterate through specially marked controls and derive resource id then resource -->
                                <xforms:repeat nodeset="instance('fr-configuration-instance')/xforms:*[tokenize(@class, ' ') = 'fr-summary']">
                                    <th>
                                        <xforms:output value="for $id in substring-before(context()/@id, '-control')
                                                              return for $resource in ($form-resources/*[local-name() = $id], '')
                                                                     return if ($resource != '') then $resource else concat('[', $id, ']')"/>

                                    </th>
                                </xforms:repeat>
                            </tr>
                        </thead>
                        <tbody>
                            <xforms:repeat nodeset="document" id="documents-repeat">
                                <tr>
                                    <td>
                                        <xforms:output value="instance('fr-paging-instance')/from + count(preceding-sibling::document)"/>
                                    </td>
                                    <td>
                                        <xforms:group ref="@created">
                                            <xforms:output value="if (. castable as xs:dateTime) then format-dateTime(xs:dateTime(.), $fr-resources/summary/formats/save-datetime, xxforms:instance('fr-language-instance'), (), ()) else ."/>
                                        </xforms:group>
                                    </td>
                                    <td>
                                        <xforms:group ref="@last-modified">
                                            <xforms:output value="if (. castable as xs:dateTime) then format-dateTime(xs:dateTime(.), $fr-resources/summary/formats/save-datetime, xxforms:instance('fr-language-instance'), (), ()) else ."/>
                                        </xforms:group>
                                    </td>
                                    <xforms:repeat nodeset="details/detail">
                                        <td>
                                            <!-- input -->
                                            <xforms:group ref=".[instance('fr-search-instance')/query[count(context()/preceding-sibling::detail) + 2]/@control = 'input']">
                                                <xforms:output value="if (. castable as xs:date) then format-date(xs:date(.), $fr-resources/summary/formats/date, xxforms:instance('fr-language-instance'), (), ()) else ."/>
                                            </xforms:group>

                                            <!-- textarea -->
                                            <xforms:group ref=".[instance('fr-search-instance')/query[count(context()/preceding-sibling::detail) + 2]/@control = 'textarea']">
                                                <xforms:output value="if (string-length(context()) > 20) then concat(substring(context(), 1, 20), '...') else context()"/>
                                            </xforms:group>

                                            <!-- select1 -->
                                            <xforms:group ref=".[instance('fr-search-instance')/query[count(context()/preceding-sibling::detail) + 2]/@control = 'select1']">
                                                <xforms:output value="."/>
                                                <!-- TODO: Obtain value from itemset -->
                                                <!--instance('fr-source-form-instance')/xhtml:head/xforms:model/xforms:instance[@id = concat(xxforms:context('documents-repeat')/@name, 's-itemset')]/*/*-->
                                            </xforms:group>
                                        </td>
                                    </xforms:repeat>
                                </tr>
                            </xforms:repeat>
                        </tbody>
                    </table>

                    <!--<p>-->
                        <!--<xforms:output value="$fr-resources/summary/titles/selected"/>:-->
                        <!--<xforms:output value="instance('fr-paging-instance')/from + index('documents-repeat') - 1"/>-->
                        <!--<xforms:output value="$fr-resources/summary/titles/of"/>-->
                        <!--<xforms:output value="instance('fr-paging-instance')/total"/>-->
                    <!--</p>-->

                    <div class="fr-paging-buttons">
                        <xforms:trigger ref="instance('fr-paging-instance')/prev-trigger" class="fr-form-model">
                            <xforms:label>
                                <xhtml:img src="../../apps/fr/style/previous.gif" alt="Previous" title="Previous"/>
                                <xhtml:span><xforms:output value="$fr-resources/summary/labels/previous"/></xhtml:span>
                            </xforms:label>
                            <xforms:action ev:event="DOMActivate">
                                <xforms:setvalue ref="instance('fr-search-instance')/page-number" value=". - 1"/>
                                <xforms:setindex repeat="documents-repeat" index="1"/>
                                <xforms:send submission="search-submission"/>
                            </xforms:action>
                        </xforms:trigger>

                        <span class="fr-paging-numbers">
                            <xforms:output value="instance('fr-paging-instance')/from + index('documents-repeat') - 1"/>
                            <xforms:output value="$fr-resources/summary/titles/of"/>
                            <xforms:output value="instance('fr-paging-instance')/total"/>
                        </span>

                        <xforms:trigger ref="instance('fr-paging-instance')/next-trigger">
                            <xforms:label>
                                <xhtml:span><xforms:output value="$fr-resources/summary/labels/next"/></xhtml:span>
                                <xhtml:img src="../../apps/fr/style/next.gif" alt="Next" title="Next"/>
                            </xforms:label>
                            <xforms:action ev:event="DOMActivate">
                                <xforms:setvalue ref="instance('fr-search-instance')/page-number" value=". + 1"/>
                                <xforms:setindex repeat="documents-repeat" index="1"/>
                                <xforms:send submission="search-submission"/>
                            </xforms:action>
                        </xforms:trigger>
                    </div>

                </xforms:group>

                <!-- Display this when no form is found -->
                <xforms:group ref="instance('fr-summary-instance')[not(document)]">
                    <xforms:output mediatype="text/html" value="saxon:serialize($fr-resources/summary/messages/no-form-found/node(), 'html')"/>
                </xforms:group>

                <!--<widget:xforms-instance-inspector xmlns:widget="http://orbeon.org/oxf/xml/widget"/>-->

            </fr:body>
            <fr:buttons>
                <!-- Custom buttons for the summary page -->

                <xhtml:div class="fr-buttons fr-summary-buttons">
                    <xforms:group model="fr-form-model" appearance="xxforms:internal">
                        <xforms:trigger ref="instance('fr-summary-triggers-instance')/new">
                            <xforms:label>
                                <xhtml:img src="../../apps/fr/style/add.gif" alt="Create"/>
                                <xhtml:span><xforms:output ref="$fr-resources/summary/labels/new-form"/></xhtml:span>
                            </xforms:label>
                            <xforms:dispatch ev:event="DOMActivate" target="fr-form-model" name="orbeon-create"/>
                        </xforms:trigger>
                        <xforms:trigger ref="instance('fr-summary-triggers-instance')/edit">
                            <xforms:label>
                                <xhtml:img src="../../apps/fr/style/run.gif" alt="Edit"/>
                                <xhtml:span><xforms:output ref="$fr-resources/summary/labels/edit-form"/></xhtml:span>
                            </xforms:label>
                            <xforms:dispatch ev:event="DOMActivate" target="fr-form-model" name="orbeon-edit"/>
                        </xforms:trigger>
                        <xforms:trigger ref="instance('fr-summary-triggers-instance')/edit">
                            <xforms:label>
                                <xhtml:img src="../../apps/fr/style/lockedstate.gif" alt="Delete"/>
                                <xhtml:span><xforms:output ref="$fr-resources/summary/labels/view-readonly"/></xhtml:span>
                            </xforms:label>
                            <xforms:dispatch ev:event="DOMActivate" target="fr-form-model" name="orbeon-view"/>
                        </xforms:trigger>
                        <xforms:trigger ref="instance('fr-summary-triggers-instance')/delete">
                            <xforms:label>
                                <xhtml:img src="../../apps/fr/style/delete.gif" alt="Delete"/>
                                <xhtml:span><xforms:output ref="$fr-resources/summary/labels/delete-form"/></xhtml:span>
                            </xforms:label>
                            <xforms:action ev:event="DOMActivate">
                                <xforms:dispatch name="fr-delete-data" target="fr-persistence-model">
                                    <xxforms:context name="document-id" select="instance('fr-summary-instance')/document[index('documents-repeat')]/@name"/>
                                </xforms:dispatch>
                                <xforms:send submission="search-submission"/>
                            </xforms:action>
                        </xforms:trigger>
                    </xforms:group>

                    <!-- TODO
                    <xforms:trigger>
                        <xforms:label>
                            <xhtml:img src="../../apps/fr/style/view-xml.gif" alt="XML"/>
                            <xforms:output ref="$fr-resources/summary/labels/view-xml"/>
                        </xforms:label>
                        <xforms:dispatch ev:event="DOMActivate" target="fr-persistence-model" name="orbeon-xml"/>
                    </xforms:trigger>
                    <xforms:trigger>
                        <xforms:label>
                            <xhtml:img src="../../apps/fr/style/pdf.png" alt="PDF"/>
                            <xforms:output ref="$fr-resources/summary/labels/view-pdf"/>
                        </xforms:label>
                        <xforms:dispatch ev:event="DOMActivate" target="fr-persistence-model" name="orbeon-pdf"/>
                    </xforms:trigger>
                    -->
                </xhtml:div>
            </fr:buttons>

        </fr:view>
    </body>
</html>
