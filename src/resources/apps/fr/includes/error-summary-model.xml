<?xml version="1.0" encoding="utf-8"?>
<!--
    Copyright (C) 2007 Orbeon, Inc.

    This program is free software; you can redistribute it and/or modify it under the terms of the
    GNU Lesser General Public License as published by the Free Software Foundation; either version
    2.1 of the License, or (at your option) any later version.

    This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
    without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
    See the GNU Lesser General Public License for more details.

    The full text of the license is available at http://www.gnu.org/copyleft/lesser.html
-->
<!--
    This XForms model implements the error summary data structures.
-->
<xforms:model id="fr-error-summary-model"
        xmlns:xforms="http://www.w3.org/2002/xforms"
        xmlns:xxforms="http://orbeon.org/oxf/xml/xforms"
        xmlns:exforms="http://www.exforms.org/exf/1-0"
        xmlns:ev="http://www.w3.org/2001/xml-events"
        xmlns:xi="http://www.w3.org/2001/XInclude"
        xmlns:xxi="http://orbeon.org/oxf/xml/xinclude"
        xmlns:xs="http://www.w3.org/2001/XMLSchema"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns:xdt="http://www.w3.org/2005/xpath-datatypes"
        xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">

    <xforms:action ev:event="xforms-model-construct-done">
        <xforms:delete xxforms:iterate="instance('fr-errors-instance')/*" nodeset="."/>
        <xforms:delete xxforms:iterate="instance('fr-visited-instance')/*" nodeset="."/>
    </xforms:action>

    <!-- Instance containing the current errors -->
    <xforms:instance id="fr-errors-instance">
        <errors xmlns=""/>
    </xforms:instance>

    <!-- Template for error information -->
    <xforms:instance id="fr-error-template" xxforms:readonly="true">
        <error xmlns="" id="" indexes="" label="" alert=""/>
    </xforms:instance>

    <!-- Instance containing visited controls -->
    <xforms:instance id="fr-visited-instance">
        <controls xmlns=""/>
    </xforms:instance>

    <!-- Template for visited controls information -->
    <xforms:instance id="fr-visited-template" xxforms:readonly="true">
        <control xmlns="" id="" indexes=""/>
    </xforms:instance>

    <!-- Whether the form is valid or invalid -->
    <xforms:instance id="fr-form-valid-instance">
        <valid xmlns=""/>
    </xforms:instance>

    <!-- Keep track of whether the form is valid or invalid -->
    <xforms:setvalue ev:event="xxforms-invalid" ev:observer="fr-form-instance" ref="instance('fr-form-valid-instance')">false</xforms:setvalue>
    <xforms:setvalue ev:event="xxforms-valid" ev:observer="fr-form-instance" ref="instance('fr-form-valid-instance')">true</xforms:setvalue>

    <!-- Handle "control visited" events on #fr-form-group -->
    <!-- NOTE: Only handle events coming from controls bound to "fr-form-instance" instance -->
    <xforms:action ev:observer="fr-form-group fb-metadata-group" ev:event="DOMFocusOut xforms-value-changed"
                   if="event('xxforms:binding')/root()/* is xxforms:instance('fr-form-instance')"
                   context="instance('fr-visited-instance')">
        <xxforms:variable name="target" select="event('xxforms:target')"/>
        <xxforms:variable name="indexes" select="string-join(event('xxforms:repeat-indexes'), '-')"/>
        <!-- Do the insertion only if we don't know already that this control has been visited -->
        <xforms:action if="empty(control[@id = $target and @indexes = $indexes])">
            <xforms:insert context="." nodeset="control" origin="instance('fr-visited-template')"/>
            <xforms:action context="control[last()]">
                <xforms:setvalue ref="@id" value="$target"/>
                <xforms:setvalue ref="@indexes" value="$indexes"/>
            </xforms:action>
        </xforms:action>
    </xforms:action>

    <!-- Handle xforms-invalid and xforms-value-changed events on #fr-form-group -->
    <!-- NOTE: Only handle events coming from controls bound to "fr-form-instance" instance -->
    <xforms:action ev:observer="fr-form-group fb-metadata-group" ev:event="xforms-invalid"
                   if="event('xxforms:binding')/root()/* is xxforms:instance('fr-form-instance') and normalize-space(event('xxforms:label'))"
                   context="instance('fr-errors-instance')">

        <!-- Insert if the value is invalid or if it is required but empty -->
        <xxforms:variable name="current-error" select="error[@id = event('xxforms:target') and @indexes = string-join(event('xxforms:repeat-indexes'), '-')]"/>
        <!-- Just update the label and alert if it already exists -->
        <xforms:action if="exists($current-error)" context="$current-error">
            <xforms:setvalue ref="$current-error/@alert" value="event('xxforms:alert')"/>
            <xforms:setvalue ref="$current-error/@label" value="event('xxforms:label')"/>
        </xforms:action>
        <!-- Otherwise insert new element and sets its values -->
        <xforms:action if="not(exists($current-error))">
            <xforms:insert context="." nodeset="error" origin="instance('fr-error-template')"/>
            <xforms:action context="error[last()]">
                <xforms:setvalue ref="@id" value="event('xxforms:target')"/>
                <xforms:setvalue ref="@indexes" value="string-join(event('xxforms:repeat-indexes'), '-')"/>
                <xforms:setvalue ref="@alert" value="event('xxforms:alert')"/>
                <xforms:setvalue ref="@label" value="event('xxforms:label')"/>
            </xforms:action>
        </xforms:action>
    </xforms:action>

    <!-- Handle xforms-valid event on #fr-form-group -->
    <!-- NOTE: Only handle events coming from controls bound to "fr-form-instance" instance -->
    <xforms:action ev:observer="fr-form-group fb-metadata-group" ev:event="xforms-valid"
                   if="event('xxforms:binding')/root()/* is xxforms:instance('fr-form-instance') and instance('fr-errors-instance')/error[@id = event('xxforms:target') and @indexes = string-join(event('xxforms:repeat-indexes'), '-')]"
                   context="instance('fr-errors-instance')">
        <!-- Don't remove error if the value is required but empty -->
        <xforms:delete nodeset="error[@id = event('xxforms:target') and @indexes = string-join(event('xxforms:repeat-indexes'), '-')]"/>
    </xforms:action>

    <!-- Only count errors for controls that have been visited -->
    <xxforms:variable name="visible-errors" select="
        for $e in xxforms:instance('fr-errors-instance')/error
        return if (exists(xxforms:instance('fr-visited-instance')/control[@id = $e/@id and @indexes = $e/@indexes])) then $e else () " as="element(error)*"/>

</xforms:model>
