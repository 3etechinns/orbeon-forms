<?xml version="1.0" encoding="UTF-8"?>
<!--
    Copyright (C) 2008 Orbeon, Inc.

    This program is free software; you can redistribute it and/or modify it under the terms of the
    GNU Lesser General Public License as published by the Free Software Foundation; either version
    2.1 of the License, or (at your option) any later version.

    This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
    without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
    See the GNU Lesser General Public License for more details.

    The full text of the license is available at http://www.gnu.org/copyleft/lesser.html
-->
<xhtml:html xmlns:xhtml="http://www.w3.org/1999/xhtml"
      xmlns:xforms="http://www.w3.org/2002/xforms"
      xmlns:xs="http://www.w3.org/2001/XMLSchema"
      xmlns:ev="http://www.w3.org/2001/xml-events"
      xmlns:xi="http://www.w3.org/2001/XInclude"
      xmlns:xxi="http://orbeon.org/oxf/xml/xinclude"
      xmlns:xxforms="http://orbeon.org/oxf/xml/xforms"
      xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
      xmlns:saxon="http://saxon.sf.net/">
    <xhtml:head>
        <xhtml:title>Orbeon Form Builder</xhtml:title>
        <xhtml:link rel="stylesheet" href="/ops/css/yui/reset-fonts-grids.css" type="text/css"/>
        <xhtml:link rel="stylesheet" href="/ops/css/yui/base-min.css" type="text/css"/>
        <xhtml:link rel="stylesheet" href="/apps/fr/style/form-runner.css" type="text/css"/>
        
        <xhtml:style type="text/css">

            #doc4 { margin-left: 15.5em }
            .xforms-select table { margin-bottom: 0 }

            .fb-section-title { display: block; margin-bottom: .5em}

            .fb-section-title div {
                background: white url(../../../../apps/fr/style/separator.gif) repeat-x scroll left center
            }

            <!-- Itemset editor -->
            #fb-itemset-editor-dialog { width: 35em }
            #fb-itemset-editor-dialog .fr-grid-2-columns .xforms-input input { width: 13em }
            #fb-itemset-editor-dialog .fr-repeat { margin: 0; background-color: transparent }
            #fb-itemset-editor-dialog .fb-dialog-body { }

            <!-- Language toolbar -->
            .fb-language-choice { display: block; float: right; }
            .fb-language-choice .xforms-select1 { width: 100% }
            .fb-language-choice .fb-language-triggers { display: block; witdh: 100%; text-align: right }

            <!-- Toolbox -->
            .fb-toolbox { margin: .5em; padding: .5em; width: auto; background-color: #3598D4; text-align: center }
            .fb-toolbox .fb-tool { display: block }
            .fb-toolbox .fb-tool button { width: 100%; text-align: left }

            .fb-clear { clear: both }
            .fb-xforms-disabled { display:none }

            .section-container { border-top: 1px solid #3598D4; margin-top: .5em }
            .fb-grid-table { margin-top: .5em; margin-left: 1px }
            .fb-grid-td { border: 1px dotted gray; padding: .2em }

            .fb-toolbar button { width: 12em }
            .fb-section-toolbar { margin-top: .5em }

            <!-- Set width of dialog (otherwise becomes too wide) -->
            #fb-confirmation-dialog { width: 400px; }
            #fb-schema-upload-dialog { width: 400px; }
            #fb-schema-upload-dialog .xforms-hint { width: 100% }
            #fb-schema-upload-dialog .xforms-select1 { height: 10em; width: 100% }
            #fb-schema-upload-dialog .fb-dialog-h2 { font-size: larger }
            #fb-schema-upload-dialog .fb-dialog-section { display: block; margin-left: 1em }
            #fb-toolbox-dialog { width: 180px; }
            #fb-xml-dialog .fb-xml-dialog-view { width: 57.69em; *width:56.301em; min-width:750px; height: 400px; overflow: scroll }
            #fb-edit-source-dialog .fb-xml-dialog-view { width: 57.69em; *width:56.301em; min-width:750px; height: 400px }
            #fb-edit-source-dialog .fb-xml-dialog-view textarea.xforms-textarea { width: 99%; height: 29em }
            #fb-toolbox-dialog .yui-panel .hd { background-color: #3598d4 }

            .dialog-icon { float: left; margin-right: 2em; margin-left: 1em; padding-bottom: 1em; }
            .dialog-message { margin-top: 1em; padding-top: 0.5em; }
            .dialog-button { text-align: right; padding-right: 2em; padding-top: 2em; padding-bottom: 1em; }

            <!-- In-place editing for regular fields -->

            .fr-section-container .fr-inplace-buttons { display: block; margin-top: .5em; margin-bottom: .5em }
            .fr-section-container .fr-inplace-input input {
                border: 1px inset rgb(233, 233, 174); padding: 0; background-color: #FFFF88; background-image: none
            }

            .fr-section-container .fr-inplace-textarea textarea.xforms-textarea {
                border: 1px inset rgb(233, 233, 174); padding: 0; background-color: #FFFF88; background-image: none
            }

            <!-- Highlighting of in-place outputs depending on hovering -->
            <!--.fr-inplace-content .xforms-output { background-color: #FFFFDD }-->
            .fr-section-container .fr-inplace-content .xforms-output:hover { background-color: #FFFF88 }
            #fb-metadata-section:hover .fr-inplace-content .xforms-output { background-color: #FFFFDD }
            #fb-details-section .fb-top-level-content:hover .fb-section-title .fr-inplace-content .xforms-output { background-color: #FFFFDD }
            #fb-details-section .fb-grid-td:hover .fr-inplace-content .xforms-output { background-color: #FFFFDD }

            <!-- In-place editing for metadata section -->
            #fb-metadata-section .fr-inplace-input .xforms-input input { width: 68em }
            #fb-metadata-section .fr-inplace-textarea textarea.xforms-textarea { width: 68em }
            #fb-metadata-section .fr-inplace-view .fr-inplace-buttons { display: none }

            <!-- In-place editing for section titles -->
            .fb-section-title .fr-inplace-content .xforms-output { background: white }
            #fb-details-section .fb-section-title .fr-inplace-buttons { display:inline; padding-left: .5em; padding-right: .5em; margin-left: .5em; margin-right: .5em; background: white }
            #fb-details-section .fb-section-title .fr-inplace-buttons button { vertical-align: middle  }
            #fb-details-section .fb-section-title .fr-inplace-content { font-size: 160%; vertical-align: middle }
            #fb-details-section .fb-section-title .fr-inplace-content .xforms-output { margin-left: 1em; padding-left: .5em; padding-right: .5em }
            #fb-details-section .fb-section-title .fr-inplace-content .xforms-input input { margin-left: 1em; padding-left: .5em; padding-right: .5em }
            #fb-details-section .fb-section-title .fr-inplace-content .xforms-label { display: none }
            #fb-details-section .fb-section-title .fr-inplace-delete img { padding: 0 }
            #fb-details-section .fb-section-title .fr-inplace-delete { display: inline }
            #fb-details-section .fb-section-title .xforms-input input { width: 20em }

            <!-- Highlighting of top-level blocks (sections, ...) -->
            .fb-top-level-content { display: block; padding-left: .5em; margin-bottom: .5em; border-left: 4px solid transparent }
            .fb-top-level-content:hover { border-left: 4px solid #ccc }
            .fr-section-container .xforms-repeat-selected-item-1 { border-left: 4px solid #3598D4}

            <!-- Highlighting of section content (grids, ...) -->
            .fb-section-content { display: block; padding-left: .5em; margin-bottom: .5em; border-left: 4px solid transparent }
            .fb-section-content:hover { border-left: 4px solid #ccc}
            .fr-section-container .xforms-repeat-selected-item-2 { border-left: 4px solid #3598D4}

            <!-- Control editor -->
            .fb-control-label .xforms-label { display: none }
            .fb-control-label .fr-inplace-content { font-weight: bold }
            .fb-control-label .fr-inplace-edit .xforms-alert { display: none }
            .fb-control-label .fr-inplace-view .fr-inplace-buttons { display: none }
            .fb-control-control .xforms-label { display: none }
            .fb-control-control .xforms-alert { display: none }
            .fb-control-help {
                display: -moz-inline-box;
                display: inline-block;
                margin-left: .2em;
                vertical-align: middle;
            }

            .fb-control-hint .fr-inplace-content {
                font-size: smaller;
                font-style: italic;
                margin-left: .5em;
                width: 22em;
                color: gray
            }
            .fb-control-hint .fr-inplace-view .fr-inplace-buttons { display: none }

            <!-- Grid -->

            <!-- Set min height of table using CSS hack for IE -->
            .fb-grid-cell-icons { min-height: 4em; height: auto !important; height: 4em; text-align: center }

            .fb-grid-control-icons { display: block; text-align: center; float: right }
            .fb-grid-control-icons .xforms-trigger { display: block }

            .fb-grid-table { width: 68em }
            .fb-grid-td { width: auto; vertical-align: top }
            #fb-details-section .fb-grid-td .xforms-input input { width: 63.5em }
            #fb-details-section .fb-grid-td textarea.xforms-textarea { width: 64em }
            #fb-details-section .fb-grid-td .xforms-select1-appearance-minimal { width: 62em }
            #fb-details-section .fb-grid-td .xforms-select1-appearance-full { width: 62em; display: block }
            #fb-details-section .fb-grid-td .xforms-select1-appearance-full span { white-space: nowrap; display: block }
            #fb-details-section .fb-grid-td .xforms-select1-appearance-compact { width: 62em; height: 6em }
            <!--#fb-details-section .fb-grid-td .fr-inplace-edit .xforms-input input { width: 63em; }-->
            .xforms-select-appearance-compact { width: 62em; height: 6em }

            .fb-grid-2-columns .fb-grid-td { width: 50%; }
            #fb-details-section .fb-grid-2-columns .fb-grid-td .xforms-input input { width: 30em; }
            #fb-details-section .fb-grid-2-columns .fb-grid-td textarea.xforms-textarea { width: 30em; }
            #fb-details-section .fb-grid-2-columns .fb-grid-td .xforms-select1-appearance-minimal { width: 28em }
            #fb-details-section .fb-grid-2-columns .fb-grid-td .xforms-select1-appearance-full { width: 28em; display: block }
            #fb-details-section .fb-grid-2-columns .fb-grid-td .xforms-select1-appearance-compact { width: 28em; height: 6em }
            #fb-details-section .fb-grid-2-columns .fb-grid-td .xforms-select-appearance-compact { width: 28em; height: 6em }
            <!--#fb-details-section .fb-grid-2-columns .fb-grid-td .fr-inplace-edit .xforms-input input { width: 29em; }-->

            .fb-grid-3-columns .fb-grid-td { width: 33.3%; }
            #fb-details-section .fb-grid-3-columns .fb-grid-td .xforms-input input { width: 18em; }
            #fb-details-section .fb-grid-3-columns .fb-grid-td textarea.xforms-textarea { width: 19em; }
            #fb-details-section .fb-grid-3-columns .fb-grid-td .xforms-select1-appearance-minimal { width: 17em }
            #fb-details-section .fb-grid-3-columns .fb-grid-td .xforms-select1-appearance-full { width: 17em; display: block }
            #fb-details-section .fb-grid-3-columns .fb-grid-td .xforms-select1-appearance-compact { width: 17em; height: 6em }
            #fb-details-section .fb-grid-3-columns .fb-grid-td .xforms-select-appearance-compact { width: 17em; height: 6em }
            <!--#fb-details-section .fb-grid-3-columns .fb-grid-td .fr-inplace-edit .xforms-input input { width: 18em; }-->

            .fb-grid-4-columns .fb-grid-td { width: 25%; }
            #fb-details-section .fb-grid-4-columns .fb-grid-td .xforms-input input { width: 13em; }
            #fb-details-section .fb-grid-4-columns .fb-grid-td textarea.xforms-textarea { width: 13em; }
            #fb-details-section .fb-grid-4-columns .fb-grid-td .xforms-select1-appearance-minimal { width: 11em }
            #fb-details-section .fb-grid-4-columns .fb-grid-td .xforms-select1-appearance-full { width: 11em; display: block }
            #fb-details-section .fb-grid-4-columns .fb-grid-td .xforms-select1-appearance-compact { width: 11em; height: 6em }
            #fb-details-section .fb-grid-4-columns .fb-grid-td .xforms-select-appearance-compact { width: 11em; height: 6em }
            <!--#fb-details-section .fb-grid-4-columns .fb-grid-td .fr-inplace-edit .xforms-input input { width: 12em; }-->

            .fb-grid-cell-icons { width: 1em; text-align: center; margin-right: .2em; float: left }
            .fb-grid-cell-icons img { margin-bottom: .5em; padding: 0 }

            .fb-grid-content { float: left }

            .xforms-repeat-selected-item-4 {
                background-color: #F8F8F8;
                background-image: url(../../../../apps/fr/style/logo-bg.gif);
                background-repeat: repeat-x;
            }

            .fb-grid td .fb-grid-cell-icons img { display: none }
            .fb-grid td:hover .fb-grid-cell-icons img { display: block }

            .fb-grid td .fb-grid-control-icons img { display: none }
            .fb-grid td:hover .fb-grid-control-icons img { display: block }

            .fb-hide-alert .xforms-alert { display: none }

            <!--.fb-section-title-content { background: #eee }-->
        </xhtml:style>
        <xforms:model id="fr-form-model">

            <xforms:action ev:event="xforms-ready">
                <xxforms:script>
                    <!-- Position toolbox to the left upon loading -->
                    ORBEON.xforms.Globals.dialogs["fb-toolbox-dialog"].cfg.setProperty("x", 0);
                </xxforms:script>
            </xforms:action>

            <!-- Main instance -->
            <xforms:instance id="fr-form-instance" src="oxf:/forms/orbeon/builder/example-1.xml"/>

            <!-- Binds on main instance -->
            <xforms:bind nodeset=".">
                <!-- Constrain form ids -->
                <xforms:bind nodeset="xhtml:head/xforms:model/xforms:instance[@id = 'fr-form-metadata']/*/(form-id, project-id)"
                             type="xs:NCName" readonly="false()"
                             calculate="if (normalize-space() = '') then concat('ID', digest(string(random(true)), 'MD5', 'hex')) else ."/>

                <!-- Metadata information -->
                <xforms:bind nodeset="xhtml:head/xforms:model[@id = 'fr-form-model']/xforms:instance[@id = 'fr-form-metadata']/*">
                    <xforms:bind id="project-id-bind" nodeset="project-id" required="true()"/>
                    <xforms:bind id="form-id-bind" nodeset="form-id" required="true()"/>
                    <xforms:bind id="title-bind" nodeset="title" required="true()"/>
                    <xforms:bind id="description-bind" nodeset="description"/>
                </xforms:bind>
            </xforms:bind>

            <!-- All form resources -->
            <xforms:instance id="fr-form-resources" xxforms:readonly="true">
                <resources>
                    <resource xml:lang="en">
                        <project-id>
                            <label>Project Identifier</label>
                        </project-id>
                        <form-id>
                            <label>Form Identifier</label>
                        </form-id>
                        <title>
                            <label>Form Title</label>
                        </title>
                        <description>
                            <label>Form Description</label>
                        </description>
                        <!-- TODO: i18n whole Form Builder -->
                    </resource>
                    <resource xml:lang="fr">
                        <project-id>
                            <label>Identifiant du Projet</label>
                        </project-id>
                        <form-id>
                            <label>Identifiant du formulaire</label>
                        </form-id>
                        <title>
                            <label>Titre du formulaire</label>
                        </title>
                        <description>
                            <label>Description du formulaire</label>
                        </description>
                    </resource>
                </resources>
            </xforms:instance>

            <!-- Instance containing the current language -->
            <xforms:instance id="fb-language-instance">
                <language>en</language>
            </xforms:instance>

            <!-- Variable pointing to the current language -->
            <xxforms:variable name="lang" select="instance('fb-language-instance')"/>

            <!-- Other variables -->
            <xxforms:variable name="model" select="xhtml:head/xforms:model[@id = 'fr-form-model']"/>
            <xxforms:variable name="form-instance" select="$model/xforms:instance[@id = 'fr-form-instance']/*"/>
            <xxforms:variable name="metadata-instance" select="$model/xforms:instance[@id = 'fr-form-metadata']/*"/>
            <xxforms:variable name="resources" select="$model/xforms:instance[@id = 'fr-form-resources']/*"/>
            <xxforms:variable name="current-resources" select="$resources/resource[@xml:lang = $lang]"/>
            <xxforms:variable name="body" select="xhtml:body/fr:view/fr:body"/>

            <!-- Configuration for Saxon serialization -->
            <xforms:instance id="fb-xsl-output-instance">
                <xsl:output xmlns:xsl="http://www.w3.org/1999/XSL/Transform" method="xml" omit-xml-declaration="yes" indent="yes" saxon:indent-spaces="4"/>
            </xforms:instance>

            <!-- Submission to test the form -->
            <xforms:submission id="fb-test-form-submission"
                    ref="instance('fr-form-instance')" method="post" replace="all"
                    resource="/fr/orbeon/test/test/" xxforms:target="_blank" xxforms:show-progress="false"/>

            <xforms:instance id="fb-variables">
                <variables>
                    <!-- TODO: check where local variable can be used instead -->
                    <done/>

                    <!-- Confirmation dialog -->
                    <confirmation-message/>
                    <confirmation-target/>

                    <!-- Itemset editor dialog -->
                    <itemset-resource-id/>
                    <itemset-lang/>


                    <result-node/>

                    <next-section-id/>
                    <next-control-id/>

                    <new-language/>
                    <new-language-trigger/>

                    <new-text/>

                    <new-source/>
                    <new-source-trigger/>

                    <xml-view/>
                </variables>
            </xforms:instance>

            <!-- Details dialog -->
            <xforms:instance id="fb-details-editor-instance">
                <details>
                    <control-id/>
                    <control/>
                    <instance-holder/>
                    <change-trigger/>
                </details>
            </xforms:instance>

            <xforms:bind nodeset="instance('fb-details-editor-instance')">
                <xforms:bind nodeset="control-id" constraint="not(concat(normalize-space(), '-control') = $body//xforms:*/@id)"/>
                <xforms:bind nodeset="change-trigger" readonly="concat(normalize-space(../control-id), '-control') = $body//xforms:*/@id"/>
            </xforms:bind>

            <!-- Validation dialog -->
            <xforms:instance id="fb-validation-editor-instance">
                <validation>
                    <resource/>
                    <builtin-type/>
                    <allow-empty>false</allow-empty>
                    <schema-type/>
                    <alert/>
                </validation>
            </xforms:instance>

            <xforms:bind nodeset="instance('fb-validation-editor-instance')">
                <xforms:bind nodeset="allow-empty" readonly="../schema-type != ''"/>
            </xforms:bind>

            <xforms:instance id="fb-validation-types-instance" xxforms:readonly="true">
                <choices>
                    <choices>
                        <label>String Types</label>
                        <type>string</type>
                        <type>normalizedString</type>
                        <type>token</type>
                        <type>language</type>
                        <type>Name</type>
                        <type>NCName</type>
                        <type>ID</type>
                        <type>IDREF</type>
                        <type>IDREFS</type>
                        <type>ENTITY</type>
                        <type>ENTITIES</type>
                        <type>NMTOKEN</type>
                        <type>NMTOKENS</type>
                    </choices>
                    <choices>
                        <label>Number Types</label>
                        <type>float</type>
                        <type>double</type>
                        <type>decimal</type>
                        <type>integer</type>
                        <type>long</type>
                        <type>int</type>
                        <type>short</type>
                        <type>byte</type>
                        <type>positiveInteger</type>
                        <type>nonPositiveInteger</type>
                        <type>negativeInteger</type>
                        <type>nonNegativeInteger</type>
                        <type>unsignedLong</type>
                        <type>unsignedInt</type>
                        <type>unsignedShort</type>
                        <type>unsignedByte</type>
                    </choices>
                    <choices>
                        <label>Time Types</label>
                        <type>duration</type>
                        <type>dateTime</type>
                        <type>time</type>
                        <type>date</type>
                        <type>gYearMonth</type>
                        <type>gYear</type>
                        <type>gMonthDay</type>
                        <type>gDay</type>
                        <type>gMonth</type>
                    </choices>
                    <choices>
                        <label>Other Types</label>
                        <type>boolean</type>
                        <type>hexBinary</type>
                        <type>base64Binary</type>
                        <type>anyURI</type>
                        <type>QName</type>
                        <type>NOTATION</type>
                    </choices>
                </choices>
            </xforms:instance>

            <!-- Schema upload dialog -->
            <xforms:instance id="fb-schema-upload-instance">
                <validation>
                    <schema-uri filename="" mediatype="" size=""/>
                    <schema>
                        <!-- Content will be like this -->
                        <!--<xs:schema>-->
                            <!--...-->
                        <!--</xs:schema>-->
                    </schema>
                    <temp-type/>
                </validation>
            </xforms:instance>

            <xforms:bind nodeset="instance('fb-schema-upload-instance')">
                <xforms:bind nodeset="temp-type" readonly="true()"/>
            </xforms:bind>

            <!-- Submission to upload the schema -->
            <xforms:submission id="fb-schema-upload-submission" ref="instance('fb-schema-upload-instance')"
                               method="post" replace="none" resource="test:"/>

            <!-- Instance for the itemset editor -->
            <xforms:instance id="fb-itemset-instance">
                <itemset>
                    <!-- Content will be like this -->
                    <!--<item>-->
                        <!--<label xml:lang="en"/>-->
                        <!--<label xml:lang="fr"/>-->
                        <!--<value/>-->
                    <!--</item>-->
                </itemset>
            </xforms:instance>

            <!-- Item template for the itemset editor -->
            <xforms:instance id="fb-item-template">
                <item>
                    <!-- Content will be like this -->
                    <!--<label xml:lang="en"/>-->
                    <!--<label xml:lang="fr"/>-->
                    <!--<value/>-->
                </item>
            </xforms:instance>

            <xforms:bind nodeset="instance('fb-variables')">
                <xforms:bind nodeset="new-language-trigger" readonly="normalize-space(../new-language) = ''"/>
            </xforms:bind>

            <xxforms:variable name="variables" select="instance('fb-variables')"/>
            <xxforms:variable name="next-section-id" select="$variables/next-section-id"/>
            <xxforms:variable name="next-control-id" select="$variables/next-control-id"/>

            <!-- Compute the next section id -->
            <xforms:action ev:event="fb-compute-section-id">
                <!-- Initialize with count of existing sections (we could as well start from 1) -->
                <xforms:setvalue if="$next-section-id = ''" ref="$next-section-id" value="count($body//fr:section)"/>
                <!-- Increment number until the id doesn't clash with the control id OR the element name -->
                <xforms:action while="$body//fr:section[@id = concat('section-', $next-section-id, '-section')]
                                        or $form-instance/*[name() = concat('section-', $next-section-id)]">
                    <xforms:setvalue ref="$next-section-id" value=". + 1"/>
                </xforms:action>
            </xforms:action>

            <!-- Compute the next control id -->
            <xforms:action ev:event="fb-compute-control-id">
                <!-- Initialize with count of existing controls (we could as well start from 1) -->
                <xforms:setvalue if="$next-control-id = ''" ref="$next-control-id" value="count($body//xforms:*[ends-with(@id, '-control')]) + 1"/>
                <!-- Increment number until the id doesn't clash with the control id OR the element name -->
                <xforms:action while="$body//xforms:*[@id = concat('control-', $next-control-id, '-control')]
                                        or $form-instance/*/*[name() = concat('control-', $next-control-id)]">
                    <xforms:setvalue ref="$next-control-id" value=". + 1"/>
                </xforms:action>
            </xforms:action>

            <xforms:instance id="fb-section-template" xxforms:readonly="true">
                <fr:section id="" context="">
                    <xforms:label ref=""/>
                    <fr:grid columns="1">
                        <xhtml:tr>
                            <xhtml:td/>
                        </xhtml:tr>
                    </fr:grid>
                </fr:section>
            </xforms:instance>

            <xforms:instance id="fb-resource-template" xxforms:readonly="true">
                <template>
                    <label>[Please modify the label]</label>
                    <hint>[Please modify the hint]</hint>
                    <help>[Please modify the help]</help>
                    <alert>[Please modify the alert]</alert>
                </template>
            </xforms:instance>

            <xforms:instance id="fb-grid-1-template" xxforms:readonly="true">
                <fr:grid columns="1">
                    <xhtml:tr>
                        <xhtml:td/>
                    </xhtml:tr>
                </fr:grid>
            </xforms:instance>

            <xforms:instance id="fb-grid-2-template" xxforms:readonly="true">
                <fr:grid columns="2">
                    <xhtml:tr>
                        <xhtml:td/>
                        <xhtml:td/>
                    </xhtml:tr>
                </fr:grid>
            </xforms:instance>

            <xforms:instance id="fb-grid-3-template" xxforms:readonly="true">
                <fr:grid columns="3">
                    <xhtml:tr>
                        <xhtml:td/>
                        <xhtml:td/>
                        <xhtml:td/>
                    </xhtml:tr>
                </fr:grid>
            </xforms:instance>

            <xforms:instance id="fb-grid-4-template" xxforms:readonly="true">
                <fr:grid columns="4">
                    <xhtml:tr>
                        <xhtml:td/>
                        <xhtml:td/>
                        <xhtml:td/>
                        <xhtml:td/>
                    </xhtml:tr>
                </fr:grid>
            </xforms:instance>

            <xforms:instance id="fb-controls-template" xxforms:readonly="true">
                <templates xmlns="">
                    <template label="Text Line">
                        <xhtml:div class="input">
                            <xforms:input id="" ref="">
                                <xforms:label ref=""/>
                                <xforms:hint ref=""/>
                                <xforms:help ref=""/>
                                <xforms:alert ref=""/>
                            </xforms:input>
                        </xhtml:div>
                    </template>
                    <template label="Date Picker" image="/ops/images/xforms/calendar.gif">
                        <xhtml:div class="date-input">
                            <xforms:input id="" ref="">
                                <xforms:label ref=""/>
                                <xforms:hint ref=""/>
                                <xforms:help ref=""/>
                                <xforms:alert ref=""/>
                            </xforms:input>
                        </xhtml:div>
                    </template>
                    <template label="Time" image="/forms/orbeon/builder/images/clock.png">
                        <xhtml:div class="time-input">
                            <xforms:input id="" ref="">
                                <xforms:label ref=""/>
                                <xforms:hint ref=""/>
                                <xforms:help ref=""/>
                                <xforms:alert ref=""/>
                            </xforms:input>
                        </xhtml:div>
                    </template>
                    <template label="Date and Time" image="/ops/images/xforms/calendar.gif">
                        <xhtml:div class="dateTime-input">
                            <xforms:input id="" ref="">
                                <xforms:label ref=""/>
                                <xforms:hint ref=""/>
                                <xforms:help ref=""/>
                                <xforms:alert ref=""/>
                            </xforms:input>
                        </xhtml:div>
                    </template>
                    <template label="Text Area">
                        <xhtml:div id="" class="textarea">
                            <xforms:textarea id="" ref="">
                                <xforms:label ref=""/>
                                <xforms:hint ref=""/>
                                <xforms:help ref=""/>
                                <xforms:alert ref=""/>
                            </xforms:textarea>
                        </xhtml:div>
                    </template>
                    <template label="Dropdown">
                        <xhtml:div class="dropdown">
                            <xforms:select1 id="" appearance="minimal" ref="">
                                <xforms:label ref=""/>
                                <xforms:hint ref=""/>
                                <xforms:help ref=""/>
                                <xforms:alert ref=""/>
                                <xforms:item>
                                    <xforms:label>[Select...]</xforms:label>
                                    <xforms:value/>
                                </xforms:item>
                                <xforms:itemset nodeset="">
                                    <xforms:label ref="label"/>
                                    <xforms:value ref="value"/>
                                </xforms:itemset>
                            </xforms:select1>
                        </xhtml:div>
                    </template>
                    <template label="Radio Buttons">
                        <xhtml:div class="radio">
                            <xforms:select1 id="" appearance="full" ref="">
                                <xforms:label ref=""/>
                                <xforms:hint ref=""/>
                                <xforms:help ref=""/>
                                <xforms:alert ref=""/>
                                <xforms:itemset nodeset="">
                                    <xforms:label ref="label"/>
                                    <xforms:value ref="value"/>
                                </xforms:itemset>
                            </xforms:select1>
                        </xhtml:div>
                    </template>
                    <template label="List box (single)">
                        <xhtml:div class="listbox">
                            <xforms:select1 id="" appearance="compact" ref="">
                                <xforms:label ref=""/>
                                <xforms:hint ref=""/>
                                <xforms:help ref=""/>
                                <xforms:alert ref=""/>
                                <xforms:itemset nodeset="">
                                    <xforms:label ref="label"/>
                                    <xforms:value ref="value"/>
                                </xforms:itemset>
                            </xforms:select1>
                        </xhtml:div>
                    </template>
                    <template label="Checkboxes">
                        <xhtml:div class="checkbox">
                            <xforms:select id="" appearance="full" ref="">
                                <xforms:label ref=""/>
                                <xforms:hint ref=""/>
                                <xforms:help ref=""/>
                                <xforms:alert ref=""/>
                                <xforms:itemset nodeset="">
                                    <xforms:label ref="label"/>
                                    <xforms:value ref="value"/>
                                </xforms:itemset>
                            </xforms:select>
                        </xhtml:div>
                    </template>
                    <template label="List box (mult.)" image="/forms/orbeon/builder/images/listbox.png">
                        <xhtml:div class="listbox-multiple">
                            <xforms:select id="" appearance="compact" ref="">
                                <xforms:label ref=""/>
                                <xforms:hint ref=""/>
                                <xforms:help ref=""/>
                                <xforms:alert ref=""/>
                                <xforms:itemset nodeset="">
                                    <xforms:label ref="label"/>
                                    <xforms:value ref="value"/>
                                </xforms:itemset>
                            </xforms:select>
                        </xhtml:div>
                    </template>
                    <template label="Output">
                        <xhtml:div class="output">
                            <xforms:output id="" ref="">
                                <xforms:label ref=""/>
                                <xforms:help ref=""/>
                                <xforms:alert ref=""/>
                            </xforms:output>
                        </xhtml:div>
                    </template>
                    <template label="Button">
                        <xhtml:div class="button">
                            <xforms:trigger id="" ref="">
                                <xforms:label ref=""/>
                                <xforms:help ref=""/>
                                <xforms:alert ref=""/>
                            </xforms:trigger>
                        </xhtml:div>
                    </template>
                    <template label="Image">
                        <xhtml:div class="image">
                            <!-- TODO -->
                        </xhtml:div>
                    </template>
                    <template label="Upload">
                        <xhtml:div class="upload">
                            <xforms:upload id="" ref="">
                                <xforms:label ref=""/>
                                <xforms:hint ref=""/>
                                <xforms:help ref=""/>
                                <xforms:alert ref=""/>
                            </xforms:upload>
                        </xhtml:div>
                    </template>
                </templates>
            </xforms:instance>

        </xforms:model>
    </xhtml:head>
    <xhtml:body>

        <fr:view>
            <xforms:label>Orbeon Form Builder</xforms:label>
            <xhtml:img src="/apps/fr/style/orbeon-logo-trimmed-transparent-42.png"/>
            <fr:body>

                <xxforms:variable name="current-top-level-block" select="$body/fr:*[index('fb-top-level-repeat')]"/>
                <xxforms:variable name="current-section-content-block" select="$current-top-level-block/fr:*[index('fb-section-content-repeat')]"/>

                <!--

                    Here is how a page is organized:

                    doc     := block*
                    block   := grid | repeat | section
                    section := block*
                    repeat  := tabularRepeat | gridRepeat | blockRepeat


                    NOTE: section and repeat can have some properties, such as a label.  

                -->

                <xforms:group class="fb-language-choice fb-hide-alert">
                    <xforms:select1 appearance="minimal" ref="$lang" id="fb-resources-language-select">
                        <xforms:label>Resources Language</xforms:label>
                        <xforms:itemset nodeset="$resources/resource">
                            <xforms:label value="xxforms:instance('fr-languages-instance')/language[@code = context()/@xml:lang]/(if (@native-name != @english-name) then concat(@native-name, ' (', @english-name, ')') else @native-name)"/>
                            <xforms:value ref="@xml:lang"/>
                        </xforms:itemset>
                    </xforms:select1>
                    <xforms:group class="fb-language-triggers">
                        <xforms:trigger appearance="minimal">
                            <xforms:label>Add</xforms:label>
                            <xxforms:show ev:event="DOMActivate" dialog="fb-add-language-dialog" neighbor="fb-resources-language-select"/>
                        </xforms:trigger>
                        <xforms:trigger appearance="minimal" id="fb-language-remove" ref=".[count($resources/resource) gt 1]">
                            <xforms:label>Remove</xforms:label>
                            <xforms:action ev:event="DOMActivate">
                                <!-- Ask confirmation -->
                                <xforms:setvalue ref="$variables/confirmation-message"
                                                 value="concat('Are you sure you want to delete all resources for language ''',
                                                 xxforms:instance('fr-languages-instance')/language[@code = $lang]/(if (@native-name != @english-name) then concat(@native-name, ' (', @english-name, ')') else @native-name),
                                                 '''?')"/>
                                <xforms:setvalue ref="$variables/confirmation-target">fb-language-remove</xforms:setvalue>
                                <xxforms:show dialog="fb-confirmation-dialog"/>
                            </xforms:action>
                            <xforms:action ev:event="fb-confirmation-yes">
                                <!-- Delete resources for this language -->
                                <xforms:delete nodeset="$resources/resource[@xml:lang = $lang]"/>
                                <xforms:setvalue ref="$lang" value="$resources/resource[1]/@xml:lang"/>
                            </xforms:action>
                        </xforms:trigger>
                    </xforms:group>
                </xforms:group>

                <!-- Section about form metadata -->
                <fr:section id="fb-metadata-section" class="fb-metadata-section">
                    <xforms:label>Form Metadata</xforms:label>

                    <xforms:input id="project-id-control" bind="project-id-bind" appearance="fr:in-place" class="fr-summary fr-search">
                        <xforms:label ref="$form-resources/project-id"/>
                    </xforms:input>

                    <xforms:input id="form-id-control" bind="form-id-bind" appearance="fr:in-place" class="fr-summary fr-search">
                        <xforms:label ref="$form-resources/form-id"/>
                    </xforms:input>

                    <xforms:input id="title-control" bind="title-bind" appearance="fr:in-place" class="fr-summary fr-search">
                        <xforms:label ref="$form-resources/title"/>
                    </xforms:input>

                    <xforms:textarea id="description-control" bind="description-bind" appearance="fr:in-place" class="fr-summary fr-search">
                        <xforms:label ref="$form-resources/description"/>
                    </xforms:textarea>
                </fr:section>

                <!-- Form details -->
                <fr:section id="fb-details-section" context="$body">
                    <xforms:label>Form Details</xforms:label>

                    <xhtml:div style="clear: both">

                        <!-- Handle top-level blocks -->
                        <xforms:repeat nodeset="fr:section | fr:repeat | fr:grid" id="fb-top-level-repeat">

                            <xxforms:variable name="top-level-position" select="position()"/>
                            <xxforms:variable name="is-top-level-current" select="$top-level-position = index('fb-top-level-repeat')"/>

                            <xhtml:div class="fb-top-level-content">
                                <!-- Top-level section -->
                                <xforms:group ref=".[local-name() = 'section']">

                                    <!-- Section id -->
                                    <xxforms:variable name="section-id" select="substring-before(@id, '-section')"/>
                                    <!-- Holder element for the section -->
                                    <xxforms:variable name="section-holder" select="$form-instance/*[name() = $section-id]"/>

                                    <!--<xhtml:img src="/apps/fr/style/minus.png" alt="Close section" title="Close section"/>-->

                                    <!-- Editable section title -->
                                    <xforms:group appearance="xxforms:internal" id="fb-section-title-input-container">
                                        <xforms:input id="fb-section-title-input"
                                                      ref="$current-resources/*[name() = $section-id]/label"
                                                      appearance="fr:in-place" class="fb-section-title">
                                            <xforms:label>Section</xforms:label>
                                        </xforms:input>

                                        <!-- Respond to fr-delete event to delete the current section -->
                                        <xforms:action ev:event="fr-delete">
                                            <xforms:setvalue ref="$variables/confirmation-message"
                                                             value="concat('Are you sure you want to delete the current section? ',
                                                                    count(context()/*/xhtml:tr/xhtml:td[xforms:*]),
                                                                    ' controls will be deleted.')"/>

                                            <xforms:setvalue ref="$variables/confirmation-target">fb-section-title-input-container</xforms:setvalue>
                                            <xxforms:show dialog="fb-confirmation-dialog"/>
                                        </xforms:action>
                                        <!-- Respond to confirmation -->
                                        <xforms:action ev:event="fb-confirmation-yes">
                                            <!-- Delete holder element for section -->
                                            <xforms:delete nodeset="$form-instance/*[name() = context()/@context]"/>
                                            <!-- Delete resources for section -->
                                            <xforms:delete xxforms:iterate="$resources/resource/*[name() = context()/@context]" nodeset="."/>

                                            <xforms:action xxforms:iterate="*/xhtml:tr/xhtml:td">
                                                <!-- Delete holder element and resources for control -->
                                                <xforms:action if="exists(xforms:*)">
                                                    <xforms:delete nodeset="$form-instance/*[index('fb-top-level-repeat')]/*[name() = context()/xforms:*/@ref]"/>
                                                    <xforms:delete xxforms:iterate="$resources/resource/*[name() = context()/xforms:*/@ref]" nodeset="."/>
                                                </xforms:action>
                                            </xforms:action>

                                            <!-- Delete section including all controls -->
                                            <xforms:delete nodeset="."/>
                                        </xforms:action>

                                    </xforms:group>

                                    <!-- Section content -->
                                    <xforms:repeat nodeset="fr:section | fr:repeat | fr:grid" id="fb-section-content-repeat">

                                        <xxforms:variable name="section-content-position" select="position()"/>
                                        <xxforms:variable name="is-section-content-current"
                                                          select="$is-top-level-current and $section-content-position = index('fb-section-content-repeat')"/>

                                        <xhtml:div class="fb-section-content">
                                            <!-- Grid within top-level section -->
                                            <xforms:group ref=".[local-name() = 'grid']">

                                                <xhtml:div class="fb-grid-toolbar fb-toolbar">
                                                    <xforms:trigger appearance="minimal" id="fb-delete-grid-trigger">
                                                        <xforms:label>
                                                            <xforms:label><xhtml:img src="../../../../apps/fr/style/trash.gif" alt="Delete Grid" title="Delete Grid"/></xforms:label>
                                                            <!--<xhtml:span>Delete Grid</xhtml:span>-->
                                                        </xforms:label>
                                                        <xforms:action ev:event="DOMActivate">
                                                            <!-- Ask confirmation -->
                                                            <xforms:setvalue ref="$variables/confirmation-message"
                                                                             value="concat('Are you sure you want to delete the current grid? ',
                                                                                    count(context()/xhtml:tr/xhtml:td[xforms:*]),
                                                                                    ' controls will be deleted.')"/>
                                                            <xforms:setvalue ref="$variables/confirmation-target">fb-delete-grid-trigger</xforms:setvalue>
                                                            <xxforms:show dialog="fb-confirmation-dialog"/>
                                                        </xforms:action>
                                                        <xforms:action ev:event="fb-confirmation-yes">
                                                            <!-- Context is on current grid -->

                                                            <xforms:action xxforms:iterate="xhtml:tr/xhtml:td">
                                                                <!-- Delete holder element and resources -->
                                                                <xforms:action if="exists(xforms:*)">
                                                                    <xforms:delete nodeset="$form-instance/*[index('fb-top-level-repeat')]/*[name() = context()/xforms:*/@ref]"/>
                                                                    <xforms:delete xxforms:iterate="$resources/resource/*[name() = context()/xforms:*/@ref]" nodeset="."/>
                                                                </xforms:action>
                                                            </xforms:action>

                                                            <!-- Delete whole grid element -->
                                                            <xforms:delete nodeset="."/>
                                                        </xforms:action>
                                                    </xforms:trigger>

                                                    <xforms:trigger appearance="full">                                                        <xforms:label>
                                                            <xhtml:span>Insert Row</xhtml:span>
                                                        </xforms:label>
                                                        <xforms:action ev:event="DOMActivate">
                                                            <xforms:action context="$current-section-content-block">
                                                                <!-- Pointing to current grid element -->
                                                                <xforms:insert context="." nodeset="xhtml:tr"
                                                                               at="index('fb-section-content-grid-tr-repeat')"
                                                                               origin="instance(concat('fb-grid-', context()/@columns, '-template'))/xhtml:tr"/>

                                                            </xforms:action>
                                                        </xforms:action>
                                                    </xforms:trigger>
                                                    <xforms:trigger appearance="full" ref=".[xs:integer(@columns) lt 4]">
                                                        <xforms:label>
                                                            <xhtml:span>Insert Column</xhtml:span>
                                                        </xforms:label>
                                                        <xforms:action ev:event="DOMActivate">
                                                            <!-- Context is on current grid -->
                                                            <xforms:setvalue ref="@columns" value=". + 1"/>

                                                            <!-- Save column index -->
                                                            <xxforms:variable name="column-number" select="index('fb-section-content-grid-td-repeat')"/>

                                                            <xforms:action xxforms:iterate="xhtml:tr">
                                                                <xforms:insert nodeset="xhtml:td" origin="xxforms:element('xhtml:td')" at="$column-number"/>
                                                            </xforms:action>
                                                        </xforms:action>
                                                    </xforms:trigger>
                                                    <xforms:trigger appearance="full" ref=".[$is-section-content-current and count(xhtml:tr) gt 1]" id="fb-delete-row-trigger">
                                                        <xforms:label>
                                                            <xhtml:span>Delete Row</xhtml:span>
                                                        </xforms:label>
                                                        <xforms:action ev:event="DOMActivate">

                                                            <xxforms:variable name="count" select="count(xhtml:tr[index('fb-section-content-grid-tr-repeat')]/xhtml:td[xforms:*])"/>

                                                            <xforms:action if="$count > 0">
                                                                <!-- Ask confirmation -->
                                                                <xforms:setvalue ref="$variables/confirmation-message"
                                                                                 value="concat('Are you sure you want to delete the current row? ',
                                                                                        $count, ' controls will be deleted.')"/>
                                                                <xforms:setvalue ref="$variables/confirmation-target">fb-delete-row-trigger</xforms:setvalue>
                                                                <xxforms:show dialog="fb-confirmation-dialog"/>
                                                            </xforms:action>
                                                            <xforms:action if="$count = 0">
                                                                <!-- We are automatically confirmed-->
                                                                <xforms:dispatch name="fb-confirmation-yes" target="fb-delete-row-trigger"/>
                                                            </xforms:action>

                                                        </xforms:action>
                                                        <xforms:action ev:event="fb-confirmation-yes">
                                                            <!-- Context is on current grid -->

                                                            <!-- Delete holder elements and resources -->
                                                            <xforms:action xxforms:iterate="xhtml:tr[index('fb-section-content-grid-tr-repeat')]/xhtml:td">
                                                                <xforms:action if="exists(xforms:*)">
                                                                    <xforms:delete nodeset="$form-instance/*[index('fb-top-level-repeat')]/*[name() = context()/xforms:*/@ref]"/>
                                                                    <xforms:delete xxforms:iterate="$resources/resource/*[name() = context()/xforms:*/@ref]" nodeset="."/>
                                                                </xforms:action>
                                                            </xforms:action>

                                                            <!-- Delete whole row including nested controls -->
                                                            <xforms:delete nodeset="xhtml:tr" at="index('fb-section-content-grid-tr-repeat')"/>
                                                        </xforms:action>
                                                    </xforms:trigger>
                                                    <xforms:trigger appearance="full" ref=".[$is-section-content-current and xs:integer(@columns) gt 1]" id="fb-delete-column-trigger">
                                                        <xforms:label>
                                                            <xhtml:span>Delete Column</xhtml:span>
                                                        </xforms:label>
                                                        <xforms:action ev:event="DOMActivate">

                                                            <xxforms:variable name="column-number" select="index('fb-section-content-grid-td-repeat')"/>
                                                            <xxforms:variable name="count" select="count(xhtml:tr/xhtml:td[xs:integer($column-number)][xforms:*])"/>

                                                            <xforms:action if="$count > 0">
                                                                <!-- Ask confirmation -->
                                                                <xforms:setvalue ref="$variables/confirmation-message"
                                                                                 value="concat('Are you sure you want to delete the current column? ',
                                                                                        $count,
                                                                                        ' controls will be deleted.')"/>
                                                                <xforms:setvalue ref="$variables/confirmation-target">fb-delete-column-trigger</xforms:setvalue>
                                                                <xxforms:show dialog="fb-confirmation-dialog"/>
                                                            </xforms:action>
                                                            <xforms:action if="$count = 0">
                                                                <!-- We are automatically confirmed-->
                                                                <xforms:dispatch name="fb-confirmation-yes" target="fb-delete-column-trigger"/>
                                                            </xforms:action>
                                                        </xforms:action>
                                                        <xforms:action ev:event="fb-confirmation-yes">
                                                            <!-- Context is on current grid -->
                                                            <xforms:setvalue ref="@columns" value=". - 1"/>

                                                            <xxforms:variable name="column-number" select="index('fb-section-content-grid-td-repeat')"/>

                                                            <!-- Iterate over rows and in each delete the appropriate column -->
                                                            <xforms:action xxforms:iterate="xhtml:tr">
                                                                <xforms:action context="xhtml:td[xs:integer($column-number)]">
                                                                    <!-- Delete holder element, resources, and control -->
                                                                    <xforms:action if="exists(xforms:*)">
                                                                        <xforms:delete nodeset="$form-instance/*[index('fb-top-level-repeat')]/*[name() = context()/xforms:*/@ref]"/>
                                                                        <xforms:delete xxforms:iterate="$resources/resource/*[name() = context()/xforms:*/@ref]" nodeset="."/>
                                                                    </xforms:action>
                                                                    <xforms:delete nodeset="."/>
                                                                </xforms:action>
                                                            </xforms:action>
                                                        </xforms:action>
                                                    </xforms:trigger>
                                                </xhtml:div>

                                                <!-- Use AVTs to set the style on the div depending on the number of columns -->
                                                <xhtml:div class="fb-grid fb-grid-{count(xhtml:tr[1]/xhtml:td)}-columns">
                                                    <!-- Grid table -->
                                                    <xhtml:table class="fb-grid-table">
                                                        <xhtml:tbody>
                                                            <!-- Repeat over table rows -->
                                                            <xforms:repeat nodeset="xhtml:tr" id="fb-section-content-grid-tr-repeat" xxforms:dnd="true">
                                                                <xhtml:tr class="fb-grid-tr">
                                                                    <!-- Repeat over table columns -->
                                                                    <xforms:repeat nodeset="xhtml:td" id="fb-section-content-grid-td-repeat" xxforms:dnd="true">

                                                                        <xxforms:variable name="control" select="xforms:*[1]"/>
                                                                        <xxforms:variable name="control-id" select="substring-before($control/@id, '-control')"/>
                                                                        <xxforms:variable name="instance-holder" select="$section-holder/*[name() = $control-id]"/>
                                                                        <xxforms:variable name="resource-holder" select="$current-resources/*[name() = $control-id]"/>

                                                                        <xhtml:td class="fb-grid-td">
                                                                            <xhtml:div class="fb-grid-cell-icons">
                                                                                <!-- TODO: For now put here, but move once dnd is there and clicking on cell is enough -->
                                                                                <xforms:trigger appearance="minimal">
                                                                                    <xforms:label><xhtml:img src="../../../../apps/fr/style/drag_handle.gif" alt="Drag" title="Drag"/></xforms:label>
                                                                                </xforms:trigger>
                                                                                <xforms:group ref=".[$control]">

                                                                                    <xforms:trigger appearance="minimal">
                                                                                        <xforms:label><xhtml:img src="../../../../apps/fr/style/trash.gif" alt="Delete Control" title="Delete Control"/></xforms:label>
                                                                                        <xforms:action ev:event="DOMActivate">
                                                                                            <!-- Delete holder element, resources, and control -->
                                                                                            <xforms:delete nodeset="$form-instance/*[index('fb-top-level-repeat')]/*[name() = $control-id]"/>
                                                                                            <xforms:delete xxforms:iterate="$resources/resource/*[name() = $control-id]" nodeset="."/>
                                                                                            <xforms:delete nodeset="$control"/>
                                                                                        </xforms:action>
                                                                                    </xforms:trigger>
                                                                                </xforms:group>
                                                                            </xhtml:div>
                                                                            <xforms:group ref=".[$control]" class="fb-grid-control-icons">
                                                                                <!-- Edit details for any control -->
                                                                                <xforms:trigger appearance="minimal" id="fb-edit-details-trigger">
                                                                                    <xforms:label><xhtml:img class="fb-control-help" alt="Details" title="" src="../../../../apps/fr/style/edit.gif"/></xforms:label>
                                                                                    <xforms:action ev:event="DOMActivate" context="instance('fb-details-editor-instance')">
                                                                                        <xforms:setvalue ref="control-id" value="$control-id"/>
                                                                                        <xforms:setvalue ref="control" value="$control/saxon:path()"/>
                                                                                        <xforms:setvalue ref="instance-holder" value="$instance-holder/saxon:path()"/>
                                                                                        <xxforms:show dialog="fb-edit-details-dialog" neighbor="fb-edit-details-trigger"/>
                                                                                    </xforms:action>
                                                                                </xforms:trigger>

                                                                                <!-- Edit help for any control -->
                                                                                <xforms:trigger appearance="minimal" id="fb-edit-help-trigger">
                                                                                    <xforms:label><xhtml:img class="fb-control-help" alt="Help" title="" src="../../../../ops/images/xforms/help.gif"/></xforms:label>
                                                                                    <xforms:action ev:event="DOMActivate">
                                                                                        <xforms:setvalue ref="$variables/result-node" value="$resource-holder/help/saxon:path()"/>
                                                                                        <xxforms:show dialog="fb-edit-help-dialog" neighbor="fb-edit-help-trigger"/>
                                                                                    </xforms:action>
                                                                                </xforms:trigger>

                                                                                <!-- Edit Alert for any control -->
                                                                                <xforms:trigger appearance="minimal" id="fb-edit-alert-trigger">
                                                                                    <xforms:label><xhtml:img class="fb-control-alert" alt="Alert" title="" src="../../../../ops/images/xforms/error.gif"/></xforms:label>
                                                                                    <xforms:action ev:event="DOMActivate">
                                                                                        <xforms:setvalue ref="instance('fb-validation-editor-instance')/resource" value="$resource-holder/saxon:path()"/>
                                                                                        <xxforms:show dialog="fb-edit-validation-dialog" neighbor="fb-edit-alert-trigger"/>
                                                                                    </xforms:action>
                                                                                </xforms:trigger>

                                                                                <!-- Change appearance for selection controls -->
                                                                                <xforms:group ref=".[xforms:select1 | xforms:select]">
                                                                                    <xforms:trigger appearance="minimal">
                                                                                        <xforms:label>
                                                                                            <xhtml:img src="../../../../apps/fr/style/update.gif" alt="Switch Appearance" title="Switch Appearance"/>
                                                                                        </xforms:label>
                                                                                        <xforms:action ev:event="DOMActivate">

                                                                                            <!-- select1 minimal -> compact -> full -> select compact -> full -->

                                                                                            <xforms:setvalue ref="$variables/done">false</xforms:setvalue>
                                                                                            <xforms:action if="xforms:select1 and xforms:select1/@appearance = 'full'">
                                                                                                <!-- Switch to xforms:select -->

                                                                                                <!-- Create xforms:select, copy all attributes and children elements, and delete xforms:select1 -->
                                                                                                <xforms:insert nodeset="xforms:select1" origin="xxforms:element('xforms:select')"/>
                                                                                                <xforms:insert context="xforms:select" origin="../xforms:select1/(@*, *)"/>
                                                                                                <xforms:delete nodeset="xforms:select1"/>
                                                                                                <xforms:setvalue ref="xforms:select/@appearance" value="'compact'"/>

                                                                                                <xforms:setvalue ref="$variables/done">true</xforms:setvalue>
                                                                                            </xforms:action>
                                                                                            <xforms:action if="$variables/done != 'true' and xforms:select and xforms:select/@appearance = 'full'">
                                                                                                <!-- Switch to xforms:select1 -->

                                                                                                <!-- Create xforms:select1, copy all attributes and children elements, and delete xforms:select -->
                                                                                                <xforms:insert nodeset="xforms:select" origin="xxforms:element('xforms:select1')"/>
                                                                                                <xforms:insert context="xforms:select1" origin="../xforms:select/(@*, *)"/>
                                                                                                <xforms:delete nodeset="xforms:select"/>
                                                                                                <xforms:setvalue ref="xforms:select1/@appearance" value="'minimal'"/>

                                                                                                <xforms:setvalue ref="$variables/done">true</xforms:setvalue>
                                                                                            </xforms:action>
                                                                                            <xforms:action if="$variables/done != 'true' and xforms:select1">
                                                                                                <!-- Simply update the appearance of xforms:select1 -->
                                                                                                <xforms:setvalue ref="xforms:select1/@appearance"
                                                                                                                 value="if (. = 'minimal') then 'compact' else if (. = 'compact') then 'full' else ."/>
                                                                                            </xforms:action>
                                                                                            <xforms:action if="$variables/done != 'true' and xforms:select">
                                                                                                <!-- Simply update the appearance of xforms:select -->
                                                                                                <xforms:setvalue ref="xforms:select/@appearance"
                                                                                                                 value="if (. = 'compact') then 'full' else ."/>
                                                                                            </xforms:action>

                                                                                        </xforms:action>
                                                                                    </xforms:trigger>
                                                                                </xforms:group>

                                                                            </xforms:group>


                                                                            <xhtml:div class="fb-grid-content">

                                                                                <xforms:group ref=".[$control]">

                                                                                    <!-- Set label for any control -->
                                                                                    <xhtml:span>
                                                                                        <xforms:input id="fb-control-label-control" ref="$resource-holder/label"
                                                                                                      appearance="fr:in-place" class="fb-control-label">
                                                                                            <xforms:label class="fb-xforms-disabled"/>
                                                                                        </xforms:input>
                                                                                    </xhtml:span>

                                                                                    <!-- Edit control type -->
                                                                                    <!--zzzz-->
                                                                                    <!--<xhtml:span>-->
                                                                                        <!--<xforms:input id="fb-control-label-control"-->
                                                                                                      <!--ref="$resource-holder/label"-->
                                                                                                      <!--appearance="fr:in-place" class="fb-control-label">-->
                                                                                            <!--<xforms:label class="fb-xforms-disabled"/>-->
                                                                                        <!--</xforms:input>-->
                                                                                    <!--</xhtml:span>-->

                                                                                    <!-- Display representation of the control -->
                                                                                    <xhtml:div class="fb-control-control">

                                                                                        <xforms:group ref="xforms:input">
                                                                                            <xforms:input ref="$instance-holder">
                                                                                                <xforms:label class="fb-xforms-disabled"/>
                                                                                                <!--<xforms:hint value="$control-id"/>-->
                                                                                            </xforms:input>
                                                                                        </xforms:group>
                                                                                        <xforms:group ref="xforms:textarea">
                                                                                            <xforms:textarea ref="$instance-holder">
                                                                                                <xforms:label class="fb-xforms-disabled"/>
                                                                                            </xforms:textarea>
                                                                                        </xforms:group>
                                                                                        <xforms:group ref="xforms:select1[@appearance = 'minimal']">
                                                                                            <xforms:select1 appearance="minimal" ref="$instance-holder" id="fb-edit-select1-minimal-control">
                                                                                                <xforms:label class="fb-xforms-disabled"/>
                                                                                                <xforms:item>
                                                                                                    <xforms:label>[Choose...]</xforms:label>
                                                                                                    <xforms:value/>
                                                                                                </xforms:item>
                                                                                                <xforms:itemset nodeset="$resource-holder/item">
                                                                                                    <xforms:label ref="label"/>
                                                                                                    <xforms:value ref="value"/>
                                                                                                </xforms:itemset>
                                                                                            </xforms:select1>
                                                                                            <xforms:trigger appearance="minimal">
                                                                                                <xforms:label>Edit</xforms:label>
                                                                                                <xforms:action ev:event="DOMActivate">
                                                                                                    <xforms:setvalue ref="$variables/itemset-resource-id" value="name($resource-holder)"/>
                                                                                                    <xxforms:show dialog="fb-itemset-editor-dialog" neighbor="fb-edit-select1-minimal-control"/>
                                                                                                </xforms:action>
                                                                                            </xforms:trigger>
                                                                                        </xforms:group>
                                                                                        <xforms:group ref="xforms:select1[@appearance = 'full']">
                                                                                            <xforms:select1 appearance="full" ref="$instance-holder" id="fb-edit-select1-full-control">
                                                                                                <xforms:label class="fb-xforms-disabled"/>
                                                                                                <xforms:itemset nodeset="$resource-holder/item">
                                                                                                    <xforms:label ref="label"/>
                                                                                                    <xforms:value ref="value"/>
                                                                                                </xforms:itemset>
                                                                                            </xforms:select1>
                                                                                            <xforms:trigger appearance="minimal">
                                                                                                <xforms:label>Edit</xforms:label>
                                                                                                <xforms:action ev:event="DOMActivate">
                                                                                                    <xforms:setvalue ref="$variables/itemset-resource-id" value="name($resource-holder)"/>
                                                                                                    <xxforms:show dialog="fb-itemset-editor-dialog" neighbor="fb-edit-select1-full-control"/>
                                                                                                </xforms:action>
                                                                                            </xforms:trigger>
                                                                                        </xforms:group>
                                                                                        <xforms:group ref="xforms:select1[@appearance = 'compact']">
                                                                                            <xforms:select1 appearance="compact" ref="$instance-holder" id="fb-edit-select1-compact-control">
                                                                                                <xforms:label class="fb-xforms-disabled"/>
                                                                                                <xforms:itemset nodeset="$resource-holder/item">
                                                                                                    <xforms:label ref="label"/>
                                                                                                    <xforms:value ref="value"/>
                                                                                                </xforms:itemset>
                                                                                            </xforms:select1>
                                                                                            <xforms:trigger appearance="minimal">
                                                                                                <xforms:label>Edit</xforms:label>
                                                                                                <xforms:action ev:event="DOMActivate">
                                                                                                    <xforms:setvalue ref="$variables/itemset-resource-id" value="name($resource-holder)"/>
                                                                                                    <xxforms:show dialog="fb-itemset-editor-dialog" neighbor="fb-edit-select1-compact-control"/>
                                                                                                </xforms:action>
                                                                                            </xforms:trigger>
                                                                                        </xforms:group>
                                                                                        <xforms:group ref="xforms:select[@appearance = 'full']">
                                                                                            <xforms:select appearance="full" ref="$instance-holder" id="fb-edit-select-full-control">
                                                                                                <xforms:label class="fb-xforms-disabled"/>
                                                                                                <xforms:itemset nodeset="$resource-holder/item">
                                                                                                    <xforms:label ref="label"/>
                                                                                                    <xforms:value ref="value"/>
                                                                                                </xforms:itemset>
                                                                                            </xforms:select>
                                                                                            <xforms:trigger appearance="minimal">
                                                                                                <xforms:label>Edit</xforms:label>
                                                                                                <xforms:action ev:event="DOMActivate">
                                                                                                    <xforms:setvalue ref="$variables/itemset-resource-id" value="name($resource-holder)"/>
                                                                                                    <xxforms:show dialog="fb-itemset-editor-dialog" neighbor="fb-edit-select-full-control"/>
                                                                                                </xforms:action>
                                                                                            </xforms:trigger>
                                                                                        </xforms:group>
                                                                                        <xforms:group ref="xforms:select[@appearance = 'compact']">
                                                                                            <xforms:select appearance="compact" ref="$instance-holder" id="fb-edit-select-compact-control">
                                                                                                <xforms:label class="fb-xforms-disabled"/>
                                                                                                <xforms:itemset nodeset="$resource-holder/item">
                                                                                                    <xforms:label ref="label"/>
                                                                                                    <xforms:value ref="value"/>
                                                                                                </xforms:itemset>
                                                                                            </xforms:select>
                                                                                            <xforms:trigger appearance="minimal">
                                                                                                <xforms:label>Edit</xforms:label>
                                                                                                <xforms:action ev:event="DOMActivate">
                                                                                                    <xforms:setvalue ref="$variables/itemset-resource-id" value="name($resource-holder)"/>
                                                                                                    <xxforms:show dialog="fb-itemset-editor-dialog" neighbor="fb-edit-select-compact-control"/>
                                                                                                </xforms:action>
                                                                                            </xforms:trigger>
                                                                                        </xforms:group>
                                                                                        <xforms:group ref="xforms:output">
                                                                                            <xforms:output ref="$instance-holder" id="fb-edit-output-control">
                                                                                                <xforms:label class="fb-xforms-disabled"/>
                                                                                            </xforms:output>
                                                                                        </xforms:group>
                                                                                        <xforms:group ref="xforms:trigger">
                                                                                            <xforms:trigger ref="$instance-holder" id="fb-edit-trigger-control">
                                                                                                <xforms:label class="fb-xforms-disabled"/>
                                                                                            </xforms:trigger>
                                                                                        </xforms:group>
                                                                                        <xforms:group ref="xforms:upload">
                                                                                            <xforms:upload ref="$instance-holder" id="fb-edit-upload-control">
                                                                                                <xforms:label class="fb-xforms-disabled"/>
                                                                                            </xforms:upload>
                                                                                        </xforms:group>
                                                                                    </xhtml:div>

                                                                                    <!-- Edit hint for any control -->
                                                                                    <xhtml:span>
                                                                                        <xforms:input id="fb-control-hint-control" ref="$resource-holder/hint"
                                                                                                      appearance="fr:in-place" class="fb-control-hint">
                                                                                            <xforms:label class="fb-xforms-disabled"/>
                                                                                        </xforms:input>
                                                                                    </xhtml:span>
                                                                                </xforms:group>
                                                                            </xhtml:div>
                                                                        </xhtml:td>
                                                                    </xforms:repeat>
                                                                </xhtml:tr>
                                                            </xforms:repeat>
                                                        </xhtml:tbody>
                                                    </xhtml:table>
                                                </xhtml:div>
                                            </xforms:group>
                                            <!-- Repeat within top-level section -->
                                            <xforms:group ref=".[local-name() = 'repeat']">

                                                <!-- TODO: Handle nested repeat -->

                                            </xforms:group>
                                            <!-- Section within top-level section -->
                                            <xforms:group ref=".[local-name() = 'section']">

                                                <!-- TODO: Handle nested section-->

                                            </xforms:group>
                                        </xhtml:div>
                                    </xforms:repeat>

                                </xforms:group>

                                <!-- Top-level grid -->
                                <xforms:group ref=".[local-name() = 'grid']">
                                    <xforms:label ref="."/>

                                    <!-- TODO: Handle top-level grid -->

                                </xforms:group>

                                <!-- Top-level repeat -->
                                <xforms:group ref=".[local-name() = 'repeat']">

                                    <!-- TODO: Handle top-level repeat -->

                                </xforms:group>
                            </xhtml:div>
                        </xforms:repeat>
                    </xhtml:div>
                </fr:section>

                <xhtml:div class="fb-toolbar fb-form-toolbar">
                    <!-- Test form -->
                    <xforms:trigger>
                        <xforms:label>
                            <xhtml:img src="../../../../forms/orbeon/builder/images/play.png" alt="Test Form" title="Test Form"/>
                            <xhtml:span>Test Form</xhtml:span>
                        </xforms:label>
                        <xforms:send ev:event="DOMActivate" submission="fb-test-form-submission"/>
                    </xforms:trigger>

                    <!-- Show XML -->
                    <xforms:trigger>
                        <xforms:label>
                            <xhtml:img src="../../../../apps/fr/style/view-xml.gif" alt="Show XML" title="Show XML"/>
                            <xhtml:span>Show XML</xhtml:span>
                        </xforms:label>
                        <xxforms:show ev:event="DOMActivate" dialog="fb-xml-dialog"/>
                    </xforms:trigger>

                    <!-- Edit Source -->
                    <xforms:trigger>
                        <xforms:label>
                            <xhtml:img src="../../../../apps/fr/style/edit.gif" alt="Edit Source" title="Edit Source"/>
                            <xhtml:span>Edit Source</xhtml:span>
                        </xforms:label>
                        <xxforms:show ev:event="DOMActivate" dialog="fb-edit-source-dialog"/>
                    </xforms:trigger>

                    <!-- Upload XML Schema -->
                    <xforms:trigger>
                        <xforms:label>
                            <xhtml:img src="../../../../forms/orbeon/builder/images/upload.png" alt="Upload XML Schema" title="Upload XML Schema"/>
                            <xhtml:span>XML Schema</xhtml:span>
                        </xforms:label>
                        <xxforms:show ev:event="DOMActivate" dialog="fb-schema-upload-dialog"/>
                    </xforms:trigger>

                    <!-- Upload PDF Template -->
                    <xforms:trigger>
                        <xforms:label>
                            <xhtml:img src="../../../../apps/fr/style/pdf.png" alt="Upload PDF" title="Upload PDF"/>
                            <xhtml:span>Upload PDF</xhtml:span>
                        </xforms:label>
                        <!-- TODO -->
                        <!--<xxforms:show ev:event="DOMActivate" dialog="fb-xml-dialog"/>-->
                    </xforms:trigger>
                </xhtml:div>

                <!-- Toolbox -->
                <xxforms:dialog id="fb-toolbox-dialog" level="modeless" draggable="true" visible="true" close="false" class="fb-toolbox-dialog" neighbor="switch-fb-details-section">
                    <xforms:label>Toolbox</xforms:label>
                        <xhtml:div class="fb-toolbox">
                            <!-- Add new section -->
                            <xhtml:div class="fb-tool">
                                <xforms:trigger>
                                    <xforms:label>
                                        <xhtml:img src="../../../../apps/fr/style/plus.png" alt="Open section" title="Open section"/>
                                        <xhtml:span>Section</xhtml:span>
                                    </xforms:label>
                                    <xforms:action ev:event="DOMActivate" context="$body">
                                        <!-- Insert section -->

                                        <!-- Insert section template in the UI -->
                                        <xforms:insert context="." nodeset="fr:section | fr:repeat | fr:grid"
                                                       at="index('fb-top-level-repeat')" position="after"
                                                       origin="instance('fb-section-template')"/>

                                        <!-- Compute next section id -->
                                        <xforms:dispatch target="fr-form-model" name="fb-compute-section-id"/>

                                        <!-- Set xforms:label @ref value -->
                                        <xforms:setvalue ref="*[index('fb-top-level-repeat')]/xforms:label/@ref" value="concat('$form-resources/section-', $next-section-id, '/label')"/>

                                        <!-- Set @id value -->
                                        <xforms:setvalue ref="*[index('fb-top-level-repeat')]/@id" value="concat('section-', $next-section-id, '-section')"/>

                                        <!-- Set @context value -->
                                        <xforms:setvalue ref="*[index('fb-top-level-repeat')]/@context" value="concat('section-', $next-section-id)"/>

                                        <!-- Insert container in the instance -->
                                        <xforms:action context="$form-instance">
                                            <!-- TODO: for now assume a top-level section containing a grid -->
                                            <xforms:insert context="." nodeset="*"
                                                           at="index('fb-top-level-repeat')" position="after"
                                                           origin="xxforms:element(concat('section-', $next-section-id))"/>

                                        </xforms:action>

                                        <!-- Insert resources placeholders for all languages -->
                                        <xforms:action xxforms:iterate="$resources/resource">
                                            <xforms:insert context="." nodeset="*"
                                                           origin="xxforms:element(concat('section-', $next-section-id))"/>

                                            <xforms:insert context="*[last()]" origin="instance('fb-resource-template')/*"/>
                                        </xforms:action>

                                        <!-- Insert a first component into the section -->
                                        <!--<xforms:setindex repeat="fb-controls-template-repeat" index="1"/>-->
                                        <!--<xforms:dispatch name="DOMActivate" target="fb-add-control-trigger"/>-->

                                    </xforms:action>
                                </xforms:trigger>
                            </xhtml:div>
                            <!-- Add grids -->
                            <xforms:group context="$current-top-level-block" appearance="xxforms:internal">
                                <xhtml:div class="fb-tool">
                                    <xforms:trigger appearance="full">
                                        <xforms:label>
                                            <xhtml:img src="../../../../forms/orbeon/builder/images/action1.gif" alt="New 1-Column Grid" title="New 1-Column Grid"/>
                                            <xhtml:span>1-Column Grid</xhtml:span>
                                        </xforms:label>
                                        <xforms:action ev:event="DOMActivate">
                                            <xforms:insert context="." nodeset="fr:section | fr:repeat | fr:grid"
                                                           at="index('fb-section-content-repeat')" position="after"
                                                           origin="instance('fb-grid-1-template')"/>
                                        </xforms:action>
                                    </xforms:trigger>
                                </xhtml:div>
                                <xhtml:div class="fb-tool">
                                    <xforms:trigger appearance="full">
                                        <xforms:label>
                                            <xhtml:img src="../../../../forms/orbeon/builder/images/action2.gif" alt="New 2-Column Grid" title="New 2-Column Grid"/>
                                            <xhtml:span>2-Column Grid</xhtml:span>
                                        </xforms:label>
                                        <xforms:action ev:event="DOMActivate">
                                            <xforms:insert context="." nodeset="fr:section | fr:repeat | fr:grid"
                                                           at="index('fb-section-content-repeat')" position="after"
                                                           origin="instance('fb-grid-2-template')"/>
                                        </xforms:action>
                                    </xforms:trigger>
                                </xhtml:div>
                                <xhtml:div class="fb-tool">
                                    <xforms:trigger appearance="full">
                                        <xforms:label>
                                            <xhtml:img src="../../../../forms/orbeon/builder/images/action3.gif" alt="New 3-Column Grid" title="New 3-Column Grid"/>
                                            <xhtml:span>3-Column Grid</xhtml:span>
                                        </xforms:label>
                                        <xforms:action ev:event="DOMActivate">
                                            <xforms:insert context="." nodeset="fr:section | fr:repeat | fr:grid"
                                                           at="index('fb-section-content-repeat')" position="after"
                                                           origin="instance('fb-grid-3-template')"/>
                                        </xforms:action>
                                    </xforms:trigger>
                                </xhtml:div>
                                <xhtml:div class="fb-tool">
                                    <xforms:trigger appearance="full">
                                        <xforms:label>
                                            <xhtml:img src="../../../../forms/orbeon/builder/images/action3.gif" alt="New 4-Column Grid" title="New 4-Column Grid"/>
                                            <xhtml:span>4-Column Grid</xhtml:span>
                                        </xforms:label>
                                        <xforms:action ev:event="DOMActivate">
                                            <xforms:insert context="." nodeset="fr:section | fr:repeat | fr:grid"
                                                           at="index('fb-section-content-repeat')" position="after"
                                                           origin="instance('fb-grid-4-template')"/>
                                        </xforms:action>
                                    </xforms:trigger>
                                </xhtml:div>
                            </xforms:group>
                        </xhtml:div>
                        <xhtml:div class="fb-toolbox">
                            <xforms:repeat nodeset="instance('fb-controls-template')/template" id="fb-controls-template-repeat">

                                <xxforms:variable name="control-template" select="xhtml:div/xforms:*"/>

                                <xhtml:div class="fb-tool">
                                    <xforms:trigger id="fb-add-control-trigger" xmlns:f="http://orbeon.org/oxf/xml/formatting">
                                        <xforms:label>
                                            <xforms:output value="concat('&lt;img width=''16'' height=''16'' src=''', if (@image) then @image else concat('../../../../forms/orbeon/builder/images/', xhtml:div/@class, '.png'), '''/>')" mediatype="text/html" f:url-norewrite="true"/>
                                            <xforms:output ref="@label"/>
                                        </xforms:label>
                                        <xforms:action ev:event="DOMActivate">
                                            <!-- Insert a new control -->

                                            <!-- TODO: for now assume a top-level section containing one or more grids; later add repeats and top-level grids -->

                                            <!-- Compute next control id -->
                                            <xforms:dispatch target="fr-form-model" name="fb-compute-control-id"/>
                                            <xxforms:variable name="new-control-id" select="concat('control-', $next-control-id)"/>

                                            <!-- Pointing to the current xhtml:td -->
                                            <xxforms:variable name="current-td"
                                                              select="$current-section-content-block/xhtml:tr[index('fb-section-content-grid-tr-repeat')]
                                                                        /xhtml:td[index('fb-section-content-grid-td-repeat')]"/>

                                            <!-- All the xhtml:td elements up to and including the current one -->
                                            <xxforms:variable name="tds" select="($current-td/../preceding-sibling::xhtml:tr/xhtml:td, $current-td/preceding-sibling::xhtml:td, $current-td)"/>

                                            <!-- Name of the preceding control id -->
                                            <xxforms:variable name="preceding-control-id" select="($tds/xforms:*)[last()]/@ref"/>

                                            <!--<xforms:message>-->
                                                <!--<xforms:output value="$preceding-control-id"/>-->
                                            <!--</xforms:message>-->

                                            <!-- Insert new holder element into the instance just after the previous control -->
                                            <xforms:insert context="$form-instance/*[index('fb-top-level-repeat')]"
                                                           nodeset="*[name() = $preceding-control-id]"
                                                           origin="xxforms:element($new-control-id)"/>

                                            <!-- Insert new control into the grid -->
                                            <xforms:action context="$current-section-content-block">
                                                <!-- Pointing to current grid element -->

                                                <xforms:action context="$current-td">
                                                    <!-- Context is now on td, and it is not empty -->

                                                    <!-- Hack: use the "done" variable to simulate if/else -->
                                                    <xforms:setvalue ref="$variables/done">false</xforms:setvalue>

                                                    <xforms:action if="not(exists(xforms:*))">
                                                        <!-- There is no xforms:* element in the current td, don't change anything -->
                                                        <xforms:setvalue ref="$variables/done">true</xforms:setvalue>
                                                    </xforms:action>
                                                    <xforms:action if="$variables/done = 'false' and exists(xforms:*)">
                                                        <!-- There is an xforms:* element in the current td, figure out what to do -->
                                                        <xforms:action if="following-sibling::xhtml:td[1][not(xforms:*)]">
                                                            <!-- Next cell is empty, move to that one -->
                                                            <xforms:setindex repeat="fb-section-content-grid-td-repeat" index="index('fb-section-content-grid-td-repeat') + 1"/>
                                                            <xforms:setvalue ref="$variables/done">true</xforms:setvalue>
                                                        </xforms:action>
                                                        <xforms:action if="$variables/done = 'false' and not(following-sibling::xhtml:td)">
                                                            <!-- We are the last cell of the row -->
                                                            <xforms:action if="exists(../following-sibling::xhtml:tr[1]/xhtml:td[1]/xforms:*) or not(exists(../following-sibling::xhtml:tr[1]))">
                                                                <!-- The first cell of the next row is occupied, or there is no next row: insert new row -->
                                                                <xforms:insert context="self::xhtml:td" nodeset="parent::xhtml:tr"
                                                                               origin="instance(concat('fb-grid-', count(../xhtml:td), '-template'))/xhtml:tr"/>
                                                                <!-- Make sure the first cell is selected -->
                                                                <xforms:setindex repeat="fb-section-content-grid-td-repeat" index="1"/>
                                                                <xforms:setvalue ref="$variables/done">true</xforms:setvalue>
                                                            </xforms:action>
                                                            <xforms:action if="$variables/done = 'false'">
                                                                <!-- There is a next row, and its first cell is empty, move to that one -->
                                                                <xforms:setindex repeat="fb-section-content-grid-tr-repeat" index="index('fb-section-content-grid-tr-repeat') + 1"/>
                                                                <xforms:setindex repeat="fb-section-content-grid-td-repeat" index="1"/>
                                                                <xforms:setvalue ref="$variables/done">true</xforms:setvalue>
                                                            </xforms:action>
                                                        </xforms:action>
                                                    </xforms:action>

                                                </xforms:action>

                                                <!-- This ensures the context is recomputed -->
                                                <xforms:action if="$variables/done = 'true'" context="xhtml:tr[index('fb-section-content-grid-tr-repeat')]/xhtml:td[index('fb-section-content-grid-td-repeat')]">
                                                    <!-- Context is now on td -->

                                                    <!-- Insert control into td -->
                                                    <xforms:insert context="." origin="$control-template"/>

                                                    <xforms:action context="xforms:*">
                                                        <!-- Set @id value -->
                                                        <xforms:setvalue ref="@id" value="concat($new-control-id, '-control')"/>

                                                        <!-- Set @ref value -->
                                                        <xforms:setvalue ref="@ref" value="$new-control-id"/>

                                                        <!-- Set xforms:label, xforms:hint, xforms:help and xforms:alert @ref -->
                                                        <xforms:setvalue ref="xforms:label/@ref" value="concat('$form-resources/', $new-control-id, '/label')"/>
                                                        <xforms:setvalue ref="xforms:hint/@ref" value="concat('$form-resources/', $new-control-id, '/hint')"/>
                                                        <xforms:setvalue ref="xforms:help/@ref" value="concat('$form-resources/', $new-control-id, '/help')"/>
                                                        <xforms:setvalue ref="xforms:alert/@ref" value="concat('$form-resources/', $new-control-id, '/alert')"/>

                                                        <!-- Set xforms:itemset/@nodeset value -->
                                                        <xforms:setvalue ref="xforms:itemset/@nodeset" value="concat('$form-resources/', $new-control-id, '/item')"/>
                                                    </xforms:action>
                                                </xforms:action>

                                            </xforms:action>

                                            <!-- Insert resources placeholders for all languages -->
                                            <xforms:action xxforms:iterate="$resources/resource">
                                                <xforms:insert context="." nodeset="*[name() = $preceding-control-id]"
                                                               origin="xxforms:element($new-control-id)"/>

                                                <xforms:insert context="*[name() = $new-control-id]" origin="instance('fb-resource-template')/*"/>
                                            </xforms:action>

                                        </xforms:action>
                                    </xforms:trigger>
                                </xhtml:div>
                            </xforms:repeat>
                        <xhtml:div class="fb-clear"/>
                    </xhtml:div>
                </xxforms:dialog>

                <!-- Edit help -->
                <xxforms:dialog id="fb-edit-help-dialog" appearance="minimal">
                    <xforms:label>Edit Help</xforms:label>
                    <xhtml:div>
                        <xforms:group class="fb-hide-alert">
                            <xforms:textarea ref="$variables/new-text">
                                <xforms:label>Help Message:</xforms:label>
                            </xforms:textarea>
                            <xhtml:div>
                                <xforms:trigger class="fr-inplace-rename">
                                    <xforms:label>Change</xforms:label>
                                    <xforms:setvalue ev:event="DOMActivate" ref="$form-instance/root()/saxon:evaluate($variables/result-node)" value="$variables/new-text"/>
                                </xforms:trigger>
                                or
                                <xforms:trigger appearance="minimal" class="fr-inplace-cancel">
                                    <xforms:label>Cancel</xforms:label>
                                </xforms:trigger>
                            </xhtml:div>
                        </xforms:group>
                    </xhtml:div>
                    <!-- Hide dialog -->
                    <xxforms:hide ev:event="DOMActivate" dialog="fb-edit-help-dialog"/>
                    <!-- Copy help value when the dialog opens -->
                    <xforms:setvalue ev:event="xxforms-dialog-open" ref="$variables/new-text" value="$form-instance/root()/saxon:evaluate($variables/result-node)"/>
                </xxforms:dialog>

                <!-- Dialog to show the XML -->
                <xxforms:dialog id="fb-xml-dialog" level="modeless" close="true" draggable="true">
                    <xforms:label>View XML</xforms:label>
                    <xhtml:div class="fb-xml-dialog-view">
                        <xforms:output mediatype="text/html" value="$variables/xml-view"/>
                    </xhtml:div>
                    <xhtml:div class="dialog-button">
                        <xforms:trigger>
                            <xforms:label><xhtml:img src="/apps/fr/style/close.gif" alt=""/> <xhtml:span>Close</xhtml:span></xforms:label>
                        </xforms:trigger>
                    </xhtml:div>
                    <!-- Hide dialog -->
                    <xxforms:hide ev:event="DOMActivate" dialog="fb-xml-dialog"/>
                    <!-- Serialize XML when the dialog opens-->
                    <xforms:setvalue ev:event="xxforms-dialog-open" ref="$variables/xml-view"
                                     value="xxforms:serialize(xxforms:call-xpl(
                                         'oxf:/ops/utils/formatting/format.xpl', 'data', instance('fr-form-instance'), 'data')/*, 'html')"/>
                    <!-- Clear XML when the dialog closes-->
                    <xforms:setvalue ev:event="xxforms-dialog-close" ref="$variables/xml-view"/>
                </xxforms:dialog>

                <!-- Dialog to edit the source -->
                <xxforms:dialog id="fb-edit-source-dialog" level="modeless" close="true" draggable="true">
                    <xforms:label>Edit source</xforms:label>
                    <xhtml:div class="fb-xml-dialog-view">
                        <xforms:textarea ref="$variables/new-source"/>
                    </xhtml:div>
                    <xhtml:div class="dialog-button">
                        <xhtml:span class="fr-inplace-buttons">
                            <xforms:trigger class="fr-inplace-rename" ref="$variables/new-source-trigger">
                                <xforms:label>Save</xforms:label>
                                <!-- TODO: At the very least, should make sure the XML is well-formed. Even better would be to validate it. -->
                                <xforms:action ev:event="DOMActivate">

                                    <!-- Parse the XML and insert it -->

                                    <!-- TODO: extra line breaks are added as you edit and save the XML -->
                                    <xforms:message level="xxforms:log-debug">
                                        <xforms:output value="replace($variables/new-source, '&#x0d;', '&#x0d;xxx')"/>
                                    </xforms:message>

                                    <xforms:insert nodeset="instance('fr-form-instance')" origin="saxon:parse($variables/new-source)"/>
                                    <!-- Saxon serialization adds an extra meta element -->
                                    <xforms:delete nodeset="instance('fr-form-instance')/xhtml:head/meta[@http-equiv = 'Content-Type']"/>

                                </xforms:action>
                            </xforms:trigger>
                            or
                            <xforms:trigger appearance="minimal" class="fr-inplace-cancel">
                                <xforms:label>Cancel</xforms:label>
                            </xforms:trigger>
                        </xhtml:span>
                    </xhtml:div>
                    <!-- Hide dialog -->
                    <xxforms:hide ev:event="DOMActivate" dialog="fb-edit-source-dialog"/>
                    <!-- Serialize XML when the dialog opens -->
                    <xforms:setvalue ev:event="xxforms-dialog-open" ref="$variables/new-source"
                                     value="saxon:serialize(instance('fr-form-instance'), xxforms:instance('fb-xsl-output-instance'))"/>
                </xxforms:dialog>

                <!-- Add language dialog -->
                <xxforms:dialog id="fb-add-language-dialog" appearance="minimal">
                    <xforms:label>Add Language</xforms:label>
                    <xhtml:div>
                        <xforms:group>
                            <xforms:group class="fb-hide-alert">
                                <xforms:select1 ref="$variables/new-language" id="fb-add-language-select1">
                                    <xforms:label>Add the following language:</xforms:label>
                                    <xforms:item>
                                        <xforms:label>[Select...]</xforms:label>
                                        <xforms:value/>
                                    </xforms:item>
                                    <xforms:itemset model="fr-resources-model"
                                                    nodeset="instance('fr-languages-instance')/language[not(@exclude = 'true') and not(@code = $resources/resource/@xml:lang)]">
                                        <xforms:label value="if (@native-name != @english-name) then concat(@native-name, ' (', @english-name, ')') else @native-name"/>
                                        <xforms:value ref="@code"/>
                                    </xforms:itemset>
                                </xforms:select1>
                            </xforms:group>
                            <xhtml:span class="fr-inplace-buttons">
                                <xforms:trigger class="fr-inplace-rename" ref="$variables/new-language-trigger">
                                    <xforms:label>Add</xforms:label>
                                    <xforms:action ev:event="DOMActivate">
                                        <xforms:insert context="$resources" nodeset="resource" origin="resource[1]"/>
                                        <xforms:setvalue ref="$resources/resource[last()]/@xml:lang" value="$variables/new-language"/>
                                        <xforms:setvalue ref="$lang" value="$variables/new-language"/>
                                    </xforms:action>
                                </xforms:trigger>
                                or
                                <xforms:trigger appearance="minimal" class="fr-inplace-cancel">
                                    <xforms:label>Cancel</xforms:label>
                                </xforms:trigger>
                            </xhtml:span>
                        </xforms:group>
                    </xhtml:div>
                    <!-- Hide dialog -->
                    <xxforms:hide ev:event="DOMActivate" dialog="fb-add-language-dialog"/>
                    <!-- Clear selection list when the dialog opens -->
                    <xforms:action ev:event="xxforms-dialog-open">
                        <xforms:setvalue ref="$variables/new-language"/>
                        <xforms:setfocus control="fb-add-language-select1"/>
                    </xforms:action>
                </xxforms:dialog>

                <!-- Generic confirmation dialog -->
                <xxforms:dialog id="fb-confirmation-dialog" level="modal" close="false" draggable="true">
                    <xforms:label>Confirm</xforms:label>
                    <xhtml:div>
                        <xhtml:img src="/apps/fr/style/question-large.gif" alt="Question" class="dialog-icon"/>
                        <xhtml:div class="dialog-message">
                            <xforms:output value="$variables/confirmation-message"/>
                        </xhtml:div>
                    </xhtml:div>
                    <xhtml:div class="dialog-button">
                        <xforms:group>
                            <xforms:trigger>
                                <xforms:label><xhtml:img src="/apps/fr/style/clear.gif" alt=""/> <xhtml:span>Delete</xhtml:span></xforms:label>
                                <xforms:dispatch ev:event="DOMActivate" name="fb-confirmation-yes" target="{$variables/confirmation-target}"/>
                            </xforms:trigger>
                            <xforms:trigger id="fb-confirmation-dialog-cancel-trigger">
                                <xforms:label><xhtml:img src="/apps/fr/style/close.gif" alt=""/> <xhtml:span>Cancel</xhtml:span></xforms:label>
                                <xforms:dispatch ev:event="DOMActivate" name="fb-confirmation-no" target="{$variables/confirmation-target}"/>
                            </xforms:trigger>
                        </xforms:group>
                    </xhtml:div>
                    <!-- Hide dialog -->
                    <xxforms:hide ev:event="DOMActivate" dialog="fb-confirmation-dialog"/>
                    <!-- Set focus when the dialog open  -->
                    <xforms:setfocus ev:event="xxforms-dialog-open" control="fb-confirmation-dialog-cancel-trigger"/>
                </xxforms:dialog>

                <!-- Dialog to edit itemsets -->
                <xxforms:dialog id="fb-itemset-editor-dialog" appearance="minimal">
                    <xforms:label>Itemset Editor</xforms:label>

                    <xhtml:div class="fb-dialog-body">
                        
                        <xforms:group class="fb-language-choice fb-hide-alert">
                            <xforms:select1 appearance="minimal" ref="$variables/itemset-lang">
                                <xforms:label class="xforms-disabled">Resources Language</xforms:label>
                                <xforms:itemset nodeset="$resources/resource">
                                    <xforms:label value="xxforms:instance('fr-languages-instance')/language[@code = context()/@xml:lang]/(if (@native-name != @english-name) then concat(@native-name, ' (', @english-name, ')') else @native-name)"/>
                                    <xforms:value ref="@xml:lang"/>
                                </xforms:itemset>
                            </xforms:select1>
                        </xforms:group>

                        <xforms:group context="instance('fb-itemset-instance')" appearance="xxforms:internal">
                            <fr:repeat nodeset="item" id="fb-itemset-repeat" origin="instance('fb-item-template')" columns="2">
                                <xhtml:tr>
                                    <xhtml:td>
                                        <xforms:input ref="label[@xml:lang = $variables/itemset-lang]" id="fb-itemset-label-input">
                                            <xforms:action ev:event="DOMActivate">
                                                <xforms:insert origin="instance('fb-item-template')" nodeset=".."/>
                                                <xforms:setfocus control="fb-itemset-label-input"/>
                                            </xforms:action>
                                        </xforms:input>
                                    </xhtml:td>
                                    <xhtml:td>
                                        <xforms:input ref="value">
                                            <xforms:action ev:event="DOMActivate">
                                                <xforms:insert origin="instance('fb-item-template')" nodeset=".."/>
                                                <xforms:setfocus control="fb-itemset-label-input"/>
                                            </xforms:action>
                                        </xforms:input>
                                    </xhtml:td>
                                </xhtml:tr>
                            </fr:repeat>
                        </xforms:group>
                    </xhtml:div>

                    <xforms:action ev:event="xxforms-dialog-open">

                        <!-- Build itemset with all languages -->

                        <!-- Clear itemset instance -->
                        <xforms:delete context="instance('fb-itemset-instance')" while="*" nodeset="*"/>

                        <!-- Iterate over all of the current language's items -->
                        <xxforms:variable name="resource-id" select="$variables/itemset-resource-id"/>
                        <xforms:action xxforms:iterate="$current-resources/*[name() = $resource-id]/item">
                            <xxforms:variable name="item" select="."/>
                            <!-- Insert the current language's item and add xml:lang attribute on label -->
                            <xforms:insert context="instance('fb-itemset-instance')" nodeset="item" origin="$item"/>
                            <xforms:insert context="instance('fb-itemset-instance')/item[last()]/label" origin="$current-resources/@xml:lang"/>
                            <!-- Iterate over all the other languages  -->
                            <xforms:action xxforms:iterate="$resources/resource[@xml:lang != $lang]">
                                <xxforms:variable name="other-resource" select="."/>
                                <xxforms:variable name="other-item" select="*[name() = $resource-id]/item[value = $item/value]"/>

                                <!-- Insert the label for the other language and add xml:lang attribute -->
                                <xforms:action if="exists($other-item/label)">
                                    <xforms:insert nodeset="instance('fb-itemset-instance')/item[last()]/label" origin="$other-item/label"/>
                                    <xforms:insert context="instance('fb-itemset-instance')/item[last()]/label[last()]" origin="$other-resource/@xml:lang"/>
                                </xforms:action>
                            </xforms:action>
                        </xforms:action>

                        <!-- Prepare insert template -->
                        <xforms:delete context="instance('fb-item-template')" while="*" nodeset="*"/>
                        <xforms:action xxforms:iterate="$resources/resource">
                            <xxforms:variable name="current-lang" select="@xml:lang"/>
                            <xforms:insert context="instance('fb-item-template')" nodeset="label" origin="xxforms:element('label')"/>
                            <xforms:insert context="instance('fb-item-template')/label[last()]" origin="$current-lang"/>
                        </xforms:action>
                        <xforms:insert context="instance('fb-item-template')" nodeset="label" origin="xxforms:element('value')"/>

                        <!-- Start with current language -->
                        <xforms:setvalue ref="$variables/itemset-lang" value="$lang"/>

                        <!-- Set focus when the dialog open  -->
                        <xforms:setfocus control="fb-itemset-label-input"/>
                    </xforms:action>

                    <xforms:action ev:event="xxforms-dialog-close">

                        <!-- Copy back the items to all languages -->

                        <xxforms:variable name="resource-id" select="$variables/itemset-resource-id"/>
                        <xforms:action xxforms:iterate="$resources/resource">
                            <xxforms:variable name="current-lang" select="@xml:lang"/>
                            <xxforms:variable name="current-resource" select="*[name() = $resource-id]"/>

                            <xforms:action context="$current-resource">
                                <!-- Delete all the existing items -->
                                <xforms:delete while="item" nodeset="item"/>

                                <!-- Copy all the new items (after existing elements if any) -->
                                <xforms:insert context="." nodeset="*" origin="instance('fb-itemset-instance')/item"/>

                                <!-- Delete all labels with a different language -->
                                <xforms:delete xxforms:iterate="item/label[@xml:lang != $current-lang]" nodeset="."/>

                                <!-- Delete all xml:lang attributes -->
                                <xforms:delete xxforms:iterate="item/label/@xml:lang" nodeset="."/>
                            </xforms:action>

                        </xforms:action>

                        <!-- Clear itemset instance -->
                        <xforms:delete context="instance('fb-itemset-instance')" while="*" nodeset="*"/>
                    </xforms:action>

                </xxforms:dialog>

                <!-- Edit details -->
                <xxforms:dialog id="fb-edit-details-dialog" appearance="minimal">
                    <xforms:label>Edit Control Details</xforms:label>
                    
                    <xhtml:div>
                        <xxforms:variable name="instance" select="instance('fb-details-editor-instance')"/>
                        <xforms:group context="$instance">
                            <xforms:input ref="control-id" incremental="true" id="fb-edit-details-control-id-input">
                                <xforms:label>Control Id:</xforms:label>
                            </xforms:input>
                            <xhtml:div>
                                <xforms:trigger class="fr-inplace-rename" ref="change-trigger" id="fb-edit-details-control-id-trigger">
                                    <xforms:label>Change</xforms:label>
                                </xforms:trigger>
                                or
                                <xforms:trigger appearance="minimal" class="fr-inplace-cancel">
                                    <xforms:label>Cancel</xforms:label>
                                </xforms:trigger>
                            </xhtml:div>
                        </xforms:group>
                    </xhtml:div>

                    <!-- Rename the control instance holder and resource holder -->
                    <xforms:action ev:event="DOMActivate" ev:observer="fb-edit-details-control-id-input fb-edit-details-control-id-trigger">

                        <xxforms:variable name="instance" select="instance('fb-details-editor-instance')"/>

                        <xxforms:variable name="control" select="$form-instance/root()/saxon:evaluate($instance/control)"/>
                        <xxforms:variable name="instance-holder" select="$form-instance/root()/saxon:evaluate($instance/instance-holder)"/>

                        <xxforms:variable name="old-name" select="name($instance-holder)"/>
                        <xxforms:variable name="new-name" select="$instance/control-id"/>

                        <!-- Iterate through instance holder and all resources -->
                        <xforms:action xxforms:iterate="($instance-holder, $resources/resource/*[name() = $old-name])">
                            <xxforms:variable name="current-holder" select="."/>

                            <!-- Insert new placeholder after existing one -->
                            <xforms:insert nodeset="$current-holder" origin="xxforms:element($new-name)"/>
                            <!-- Copy existing content into new element -->
                            <xforms:insert context="$current-holder/../*[name() = $new-name]" origin="$current-holder/node()"/>
                            <!-- Delete old element -->
                            <xforms:delete nodeset="$current-holder"/>
                        </xforms:action>

                        <!-- Update control id and bindings -->
                        <xforms:setvalue ref="$control/@id" value="concat($new-name, '-control')"/>
                        <xforms:setvalue ref="$control/@ref" value="$new-name"/>
                        <xforms:action xxforms:iterate="$control/(xforms:label, xforms:hint, xforms:help, xforms:alert)">
                            <xxforms:variable name="local-name" select="local-name()"/>
                            <xforms:setvalue ref="@ref" value="concat('$form-resources/', $new-name, '/', $local-name)"/>
                        </xforms:action>
                        <xforms:setvalue ref="$control/xforms:itemset/@nodeset" value="concat('$form-resources/', $new-name, '/item')"/>

                    </xforms:action>

                    <!-- Hide dialog -->
                    <xxforms:hide ev:event="DOMActivate" dialog="fb-edit-details-dialog"/>
                    <!-- Set focus when the dialog open  -->
                    <xforms:setfocus ev:event="xxforms-dialog-open" control="fb-edit-details-control-id-input"/>
                </xxforms:dialog>

                <!-- Edit validation -->
                <xxforms:dialog id="fb-edit-validation-dialog" appearance="minimal">
                    <xforms:label>Edit Validation Properties</xforms:label>
                    <xxforms:variable name="instance" select="instance('fb-validation-editor-instance')"/>
                    <xhtml:div>
                        <xforms:group class="fb-hide-alert">
                            <!--<xhtml:table>-->
                                <!--<xhtml:tr>-->
                                    <!--<xhtml:td>-->
                                        <!-- Built-in type selection -->
                                        <xforms:select1 ref="$instance/builtin-type">
                                            <xforms:label>Built-in Type</xforms:label>
                                            <xforms:item>
                                                <xforms:label>[Select...]</xforms:label>
                                                <xforms:value/>
                                            </xforms:item>
                                            <xforms:itemset nodeset="instance('fb-validation-types-instance')/root()//(choices | type)">
                                                <xforms:label ref="if (self::choices) then label else ."/>
                                                <xforms:value ref="if (self::choices) then () else ."/>
                                            </xforms:itemset>
                                            <xforms:setvalue ev:event="xforms-value-changed" if=". != ''" ref="../schema-type"/>
                                        </xforms:select1>
                                    <!--</xhtml:td>-->
                                    <!--<xhtml:td>-->
                                        <xforms:select1 ref="$instance/allow-empty" appearance="full">
                                            <xforms:label>Allow Empty Content</xforms:label>
                                            <xforms:item>
                                                <xforms:label>Yes</xforms:label>
                                                <xforms:value>true</xforms:value>
                                            </xforms:item>
                                            <xforms:item>
                                                <xforms:label>No</xforms:label>
                                                <xforms:value>false</xforms:value>
                                            </xforms:item>
                                        </xforms:select1>
                                    <!--</xhtml:td>-->
                                <!--</xhtml:tr>-->
                            <!--</xhtml:table>-->

                            <!-- Schema type selection if applicable -->
                            <xforms:select1 ref="$instance/schema-type[$model/xs:schema]">
                                <xforms:label>Schema Type</xforms:label>
                                <xforms:item>
                                    <xforms:label>[Select...]</xforms:label>
                                    <xforms:value/>
                                </xforms:item>
                                <xforms:itemset nodeset="$model/xs:schema/xs:simpleType">
                                    <xforms:label ref="@name"/>
                                    <xforms:value ref="@name"/>
                                </xforms:itemset>
                                <xforms:setvalue ev:event="xforms-value-changed" if=". != ''" ref="../builtin-type"/>
                            </xforms:select1>

                            <!-- Alert message -->
                            <xforms:textarea ref="$instance/alert">
                                <xforms:label>Alert Message</xforms:label>
                            </xforms:textarea>

                            <xhtml:div class="dialog-button">
                                <xforms:trigger class="fr-inplace-rename" id="fb-edit-validation-trigger">
                                    <xforms:label>Change</xforms:label>
                                </xforms:trigger>
                                or
                                <xforms:trigger appearance="minimal" class="fr-inplace-cancel">
                                    <xforms:label>Cancel</xforms:label>
                                </xforms:trigger>
                            </xhtml:div>
                        </xforms:group>
                    </xhtml:div>

                    <!-- Copy back information -->
                    <xforms:action ev:event="DOMActivate" ev:observer="fb-edit-validation-trigger">
                        <xxforms:variable name="instance" select="instance('fb-validation-editor-instance')"/>
                        <xforms:setvalue ref="$form-instance/root()/saxon:evaluate($instance/resource)/alert" value="$instance/alert"/>
                    </xforms:action>

                    <!-- Hide dialog -->
                    <xxforms:hide ev:event="DOMActivate" dialog="fb-edit-validation-dialog"/>

                    <!-- Copy help value when the dialog opens -->
                    <xforms:action ev:event="xxforms-dialog-open">
                        <xxforms:variable name="instance" select="instance('fb-validation-editor-instance')"/>
                        <xforms:setvalue ref="$instance/alert" value="$form-instance/root()/saxon:evaluate($instance/resource)/alert"/>
                    </xforms:action>
                </xxforms:dialog>

                <!-- Schema upload -->
                <xxforms:dialog id="fb-schema-upload-dialog" level="modal">
                    <xforms:label>XML Schema Upload</xforms:label>

                    <xxforms:variable name="instance" select="instance('fb-schema-upload-instance')"/>
                    <xhtml:div>
                        <xforms:group>

                            <!-- Schema information -->
                            <xxforms:variable name="schema-element" select="($instance/schema/xs:schema, $model/xs:schema)[1]"/>
                            <xxforms:variable name="is-existing-schema" select="exists($model/xs:schema)"/>
                            <xxforms:variable name="is-new-schema" select="exists($instance/schema/xs:schema)"/>

                            <xforms:group ref="$schema-element" class="fb-hide-alert">
                                <xforms:label class="fb-dialog-h2" value="if ($is-new-schema) then 'New Schema Information' else 'Existing Schema Information'"/>

                                <xhtml:div class="fb-dialog-section">
                                    <xforms:group ref=".[xs:simpleType]">
                                        <!-- Schema types -->
                                        <xforms:select1 ref="$instance/temp-type" appearance="compact">
                                            <xforms:label>Available Schema Types</xforms:label>
                                            <xforms:hint>This lists the simple types available in the uploaded schema</xforms:hint>
                                            <!--<xforms:item>-->
                                                <!--<xforms:label>[Select...]</xforms:label>-->
                                                <!--<xforms:value/>-->
                                            <!--</xforms:item>-->
                                            <xforms:itemset nodeset="$schema-element/xs:simpleType">
                                                <xforms:label ref="@name"/>
                                                <xforms:value ref="@name"/>
                                            </xforms:itemset>
                                        </xforms:select1>
                                    </xforms:group>
                                    <xforms:group ref=".[not(xs:simpleType)]">
                                        <xforms:label>Available Schema Types</xforms:label>
                                        Your schema does not seem to contain simple types. You won't be able to select types
                                        from this schema for validation.
                                    </xforms:group>
                                    <xforms:group ref=".[@targetNamespace]">
                                        <xforms:output value="@targetNamespace">
                                            <xforms:label>Schema Namespace URI</xforms:label>
                                            <xforms:hint>This is the namespace URI of the uploaded schema</xforms:hint>
                                        </xforms:output>
                                    </xforms:group>
                                </xhtml:div>

                            </xforms:group>
                            <xforms:group class="fb-hide-alert">
                                <xforms:label class="fb-dialog-h2">Operations</xforms:label>

                                <xhtml:div class="fb-dialog-section">
                                    <xforms:trigger ref=".[not($is-new-schema) and $model/xs:schema]">
                                        <xforms:label>Delete Existing XML Schema</xforms:label>

                                        <xforms:action ev:event="DOMActivate">
                                            <!-- Delete XML Schema -->
                                            <xforms:delete nodeset="$model/xs:schema"/>
                                            <!-- TODO: Ask for confirmation, esp. if some types are in use -->
                                            <!-- TODO: Check and adjust types that could be in use -->
                                        </xforms:action>

                                    </xforms:trigger>

                                    <!-- Upload a schema-->
                                    <xforms:upload ref="$instance/schema-uri">
                                        <xforms:label value="if ($is-new-schema) then 'Change XML Schema' else if ($is-existing-schema) then 'Replace XML Schema' else 'Upload XML Schema'"/>
                                        <xforms:filename ref="@filename"/>
                                        <xforms:mediatype ref="@mediatype"/>
                                        <xxforms:size ref="@size"/>

                                        <!-- Upload file when selected -->
                                        <xforms:action ev:event="xforms-select">
                                            <xforms:send submission="fb-schema-upload-submission"/>
                                        </xforms:action>

                                        <!-- Handle a successful submission -->
                                        <xforms:action ev:event="xforms-submit-done" ev:observer="fb-schema-upload-submission" context="$instance">
                                            <!-- Read the schema and store it -->
                                            <!-- TODO: support catching dynamic XPath error in case doc() fails -->
                                            <xforms:insert context="schema" origin="doc(../schema-uri)"/>
                                            <xxforms:variable name="schema-element" select="schema/*"/>
                                            <xforms:action if="$schema-element/self::xs:schema">
                                                <!-- We got something that looks like a schema -->

                                                <!-- Check for inclusions -->
                                                <xforms:action if="$schema-element/(xs:import | xs:include)">
                                                    <xforms:message>Your schema contains imports or includes. These will be disabled.</xforms:message>
                                                    <!-- Delete inclusions -->
                                                    <xforms:delete xxforms:iterate="$schema-element/(xs:import | xs:include)" nodeset="."/>
                                                </xforms:action>

                                            </xforms:action>
                                            <xforms:action if="not($schema-element/self::xs:schema)">
                                                <!-- Oops, this is definitely not a schema -->
                                                <xforms:message>The uploaded file is not a valid schema.</xforms:message>
                                                <!-- Clear uploaded content -->
                                                <xforms:setvalue ref="schema-uri"/>
                                                <xforms:delete nodeset="$schema-element"/>
                                            </xforms:action>
                                        </xforms:action>

                                        <!-- Clear information when deselected -->
                                        <xforms:action ev:event="xforms-deselect">
                                            <!-- Clear uploaded content -->
                                            <xforms:setvalue ref="$instance/schema-uri"/>
                                            <xforms:delete nodeset="$instance/schema/*"/>
                                        </xforms:action>
                                    </xforms:upload>
                                </xhtml:div>
                            </xforms:group>

                        </xforms:group>
                    </xhtml:div>
                    <xhtml:div class="dialog-button">
                        <xforms:group appearance="xxforms:internal">
                            <xforms:trigger class="fr-inplace-rename" id="fb-edit-schema-trigger">
                                <xforms:label>Change</xforms:label>

                                <xforms:action ev:event="DOMActivate">
                                    <!-- Insert schema into the model -->

                                    <!-- Delete existing XML Schema if any -->
                                    <!-- TODO: What we want in fact is to disable this button if there is an existing schema, and the user will explicitly remove the previous schema -->
                                    <xforms:delete nodeset="$model/xs:schema"/>

                                    <xforms:insert context="$model" origin="$instance/schema/*"/>
                                </xforms:action>

                            </xforms:trigger>
                            or
                            <xforms:trigger appearance="minimal" class="fr-inplace-cancel">
                                <xforms:label>Cancel</xforms:label>
                            </xforms:trigger>

                            <xforms:action ev:event="DOMActivate">
                                <!-- Hide dialog -->
                                <xxforms:hide dialog="fb-schema-upload-dialog"/>
                                <!-- Clear uploaded content -->
                                <xforms:setvalue ref="$instance/schema-uri"/>
                                <xforms:delete nodeset="$instance/schema/*"/>
                            </xforms:action>
                        </xforms:group>
                    </xhtml:div>
                </xxforms:dialog>

            </fr:body>
        </fr:view>

        <!--<widget:xforms-instance-inspector xmlns:widget="http://orbeon.org/oxf/xml/widget"/>-->
    </xhtml:body>
</xhtml:html>
