<?xml version="1.0" encoding="UTF-8"?>
<!--
    Copyright (C) 2008 Orbeon, Inc.

    This program is free software; you can redistribute it and/or modify it under the terms of the
    GNU Lesser General Public License as published by the Free Software Foundation; either version
    2.1 of the License, or (at your option) any later version.

    This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
    without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
    See the GNU Lesser General Public License for more details.

    The full text of the license is available at http://www.gnu.org/copyleft/lesser.html
-->
<xhtml:html xmlns:xhtml="http://www.w3.org/1999/xhtml"
      xmlns:xforms="http://www.w3.org/2002/xforms"
      xmlns:xs="http://www.w3.org/2001/XMLSchema"
      xmlns:ev="http://www.w3.org/2001/xml-events"
      xmlns:xi="http://www.w3.org/2001/XInclude"
      xmlns:xxi="http://orbeon.org/oxf/xml/xinclude"
      xmlns:xxforms="http://orbeon.org/oxf/xml/xforms"
      xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
      xmlns:saxon="http://saxon.sf.net/">
    <xhtml:head>
        <xhtml:title>Orbeon Form Builder</xhtml:title>
        <xhtml:link rel="stylesheet" href="/ops/css/yui/reset-fonts-grids.css" type="text/css"/>
        <xhtml:link rel="stylesheet" href="/ops/css/yui/base-min.css" type="text/css"/>
        <xhtml:link rel="stylesheet" href="/apps/fr/style/form-runner.css" type="text/css"/>
        
        <xhtml:style type="text/css">
            .fb-section-title div {
                background: white url(../../../../apps/fr/style/separator.gif) repeat-x scroll left center
            }

            .fb-toolbox { margin: 1em; padding: .2em; border: 0px solid black; width: auto; background-color: #3598D4; clear: both }
            .fb-toolbox .fb-tool { display: block; float: left; margin: .2em }
            .fb-toolbox .fb-tool button { width: 12em; text-align: left }
            .fb-clear { clear: both }
            .fb-xforms-disabled { display:none }

            .section-container { border-top: 1px solid #3598D4; margin-top: .5em }
            .fb-grid table { margin-top: .5em; margin-left: 1px }
            .fb-grid td { border: 1px dotted gray; padding: .2em }

            .fb-new-grid { margin-top: .5em }

            <!-- Set width of dialog (otherwise becomes too wide) -->
            .fb-delete-confirm-dialog { width: 400px; }
            .fb-toolbox-dialog { width: 320px; }

            .dialog-icon { float: left; margin-right: 2em; margin-left: 1em; padding-bottom: 1em; }
            .dialog-message { margin-top: 1em; padding-top: 0.5em; }
            .dialog-button { text-align: right; padding-right: 2em; padding-top: 2em; padding-bottom: 1em; }

            <!-- In-place editing for regular fields -->

            .fr-section-container .fr-inplace-buttons { display: block; margin-top: .5em }
            .fr-section-container .fr-inplace-input input {
                border: 1px inset rgb(233, 233, 174); padding: 0; background-color: rgb(255, 255, 211)
            }

            .fr-section-container .fr-inplace-textarea textarea.xforms-textarea {
                border: 1px inset rgb(233, 233, 174); padding: 0; background-color: rgb(255, 255, 211)
            }

            .fr-section-container .fr-inplace-value:hover { background-color: rgb(255, 255, 211) }

            <!-- In-place editing for metadata section -->
            #fb-metadata-section .fr-inplace-input .xforms-input input { width: 68em }
            #fb-metadata-section .fr-inplace-textarea textarea.xforms-textarea { width: 68em }
            #fb-metadata-section .fr-inplace-view .fr-inplace-buttons { display: none }

            <!-- In-place editing for section titles -->
            #fb-details-section .fb-section-title .fr-inplace-buttons { display:inline; padding-left: .5em; padding-right: .5em; margin-left: .5em; background: white }
            <!--#fb-details-section .fb-section-title .fr-inplace-value:hover { background-color: rgb(255, 255, 211) }-->
            #fb-details-section .fb-section-title .fr-inplace-value { margin-left: 1em; padding-left: .5em; padding-right: .5em; background: white }
            #fb-details-section .fb-section-title .fr-inplace-content .xforms-label { display: none }
            #fb-details-section .fb-section-title .fr-inplace-delete { margin-right: .5em }
            #fb-details-section .fb-section-title .fr-inplace-delete img { padding: 0 }
            #fb-details-section .fb-section-title .fr-inplace-delete { display: inline }
            #fb-details-section .fb-section-title .xforms-input input { width: 20em }

            <!-- Control editor -->
            .fb-control-label .xforms-label { display: none }
            .fb-control-label .fr-inplace-value { font-weight: bold }
            .fb-control-label .fr-inplace-view .fr-inplace-buttons { display: none }
            .fb-control-control .xforms-label { display: none }
            .fb-control-control .xforms-alert { display: none }
            .fb-control-help {
                display: -moz-inline-box;
                display: inline-block;
                margin-left: .2em;
                vertical-align: middle;
            }

            .fb-control-hint .fr-inplace-value {
                font-size: smaller;
                font-style: italic;
                margin-left: .5em;
                width: 22em;
                color: gray
            }
            .fb-control-hint .fr-inplace-view .fr-inplace-buttons { display: none }

            .fb-grid-row { width: 1em; text-align: center }
            .fb-grid-row img { margin-bottom: .5em; padding: 0 }
            .xforms-repeat-selected-item-1 .xforms-repeat-selected-item-2 .xforms-repeat-selected-item-3 .fb-grid-row { background: #3598D4 }
            .fb-grid-row:hover, .xforms-repeat-selected-item-1 .xforms-repeat-selected-item-2 .xforms-repeat-selected-item-3 .fb-grid-row:hover {
                background: white;
            }


            <!--.fb-section-title-content { background: #eee }-->
        </xhtml:style>
        <xforms:model id="fr-form-model">

            <!-- Main instance -->
            <xforms:instance id="fr-form-instance" src="oxf:/forms/orbeon/builder/example-1.xml"/>

            <!-- Binds on main instance -->
            <xforms:bind nodeset="instance('fr-form-instance')">
                <!-- Constrain form ids -->
                <xforms:bind nodeset="xhtml:head/xforms:model/xforms:instance[@id = 'fr-form-metadata']/*/id" type="xs:NCName"/>
            </xforms:bind>

            <!-- Useful variables -->
            <xxforms:variable name="lang" select="'en'"/><!-- TEMP -->

            <xxforms:variable name="form-instance" select="xhtml:head/xforms:model/xforms:instance[@id = 'fr-form-instance']/*"/>
            <xxforms:variable name="metadata-instance" select="xhtml:head/xforms:model/xforms:instance[@id = 'fr-form-metadata']/*"/>
            <xxforms:variable name="resources" select="xhtml:head/xforms:model/xforms:instance[@id = 'fr-form-resources']/*"/>
            <xxforms:variable name="current-resources" select="$resources/resource[@xml:lang = $lang]"/>
            <xxforms:variable name="body" select="xhtml:body/fr:view/fr:body"/>

            <!-- Submission to test the form -->
            <xforms:submission id="fb-test-form-submission"
                    ref="instance('fr-form-instance')"
                    method="post" replace="all"
                    action="/fr/orbeon/test/test/">

            </xforms:submission>

            <xforms:instance id="fb-variables">
                <variables>
                    <delete-node/>
                    <blank-readonly-value/>
                    <next-section-id/>
                    <next-control-id/>
                </variables>
            </xforms:instance>

            <xforms:bind nodeset="instance('fb-variables')">
                <xforms:bind nodeset="blank-readonly-value" readonly="true()"/>
            </xforms:bind>

            <xxforms:variable name="next-section-id" select="instance('fb-variables')/next-section-id"/>
            <xxforms:variable name="next-control-id" select="instance('fb-variables')/next-control-id"/>

            <!-- Compute the next section id -->
            <xforms:action ev:event="fb-compute-section-id">
                <!-- Initialize with count of existing sections (we could as well start from 1) -->
                <xforms:setvalue if="$next-section-id = ''" ref="$next-section-id" value="count($body//fr:section)"/>
                <!-- Increment number until the id doesn't clash with the control id OR the element name -->
                <xforms:action while="$body//fr:section[@id = concat('section-', $next-section-id, '-section')]
                                        or $form-instance/*[name() = concat('section-', $next-section-id)]">
                    <xforms:setvalue ref="$next-section-id" value=". + 1"/>
                </xforms:action>
            </xforms:action>

            <!-- Compute the next control id -->
            <xforms:action ev:event="fb-compute-control-id">
                <!-- Initialize with count of existing controls (we could as well start from 1) -->
                <xforms:setvalue if="$next-control-id = ''" ref="$next-control-id" value="count($body//xforms:*[ends-with(@id, '-control')])"/>
                <!-- Increment number until the id doesn't clash with the control id OR the element name -->
                <xforms:action while="$body//xforms:*[@id = concat('control-', $next-control-id, '-control')]
                                        or $form-instance/*/*[name() = concat('control-', $next-control-id)]">
                    <xforms:setvalue ref="$next-control-id" value=". + 1"/>
                </xforms:action>
            </xforms:action>

            <xforms:instance id="fb-section-template" xxforms:readonly="true">
                <fr:section id="" context="">
                    <xforms:label ref=""/>
                    <fr:grid columns="1">
                        <!--<xhtml:tr>-->
                            <!--<xhtml:td>-->
                                <!--<xforms:input ref="">-->
                                    <!--<xforms:label ref=""/>-->
                                    <!--<xforms:hint ref=""/>-->
                                    <!--<xforms:help ref=""/>-->
                                    <!--<xforms:alert ref=""/>-->
                                <!--</xforms:input>-->
                            <!--</xhtml:td>-->
                        <!--</xhtml:tr>-->
                    </fr:grid>
                </fr:section>
            </xforms:instance>

            <xforms:instance id="fb-resource-template" xxforms:readonly="true">
                <template>
                    <label>[Please modify the label]</label>
                    <hint>[Please modify the hint]</hint>
                    <help>[Please modify the help]</help>
                    <alert>[Please modify the alert]</alert>
                </template>
            </xforms:instance>

            <xforms:instance id="fb-grid-tr-template" xxforms:readonly="true">
                <xhtml:tr/>
            </xforms:instance>

            <xforms:instance id="fb-grid-td-template" xxforms:readonly="true">
                <xhtml:td/>
            </xforms:instance>

            <xforms:instance id="fb-grid-1-template" xxforms:readonly="true">
                <fr:grid columns="1">
                    <xhtml:tr>
                        <xhtml:td>
                            <xforms:input ref="input">
                                <xforms:label ref=""/>
                                <xforms:hint ref=""/>
                                <xforms:help ref=""/>
                                <xforms:alert ref=""/>
                            </xforms:input>
                        </xhtml:td>
                    </xhtml:tr>
                </fr:grid>
            </xforms:instance>

            <xforms:instance id="fb-grid-2-template" xxforms:readonly="true">
                <fr:grid columns="2">
                    <xhtml:tr>
                        <xhtml:td>
                            <xforms:input ref="input">
                                <xforms:label ref=""/>
                                <xforms:hint ref=""/>
                                <xforms:help ref=""/>
                                <xforms:alert ref=""/>
                            </xforms:input>
                        </xhtml:td>
                        <xhtml:td>
                            <xforms:input ref="input">
                                <xforms:label ref=""/>
                                <xforms:hint ref=""/>
                                <xforms:help ref=""/>
                                <xforms:alert ref=""/>
                            </xforms:input>
                        </xhtml:td>
                    </xhtml:tr>
                </fr:grid>
            </xforms:instance>

            <xforms:instance id="fb-grid-3-template" xxforms:readonly="true">
                <fr:grid columns="2">
                    <xhtml:tr>
                        <xhtml:td>
                            <xforms:input id="" ref="input">
                                <xforms:label ref=""/>
                                <xforms:hint ref=""/>
                                <xforms:help ref=""/>
                                <xforms:alert ref=""/>
                            </xforms:input>
                        </xhtml:td>
                        <xhtml:td>
                            <xforms:input id="" ref="input">
                                <xforms:label ref=""/>
                                <xforms:hint ref=""/>
                                <xforms:help ref=""/>
                                <xforms:alert ref=""/>
                            </xforms:input>
                        </xhtml:td>
                        <xhtml:td>
                            <xforms:input id="" ref="input">
                                <xforms:label ref=""/>
                                <xforms:hint ref=""/>
                                <xforms:help ref=""/>
                                <xforms:alert ref=""/>
                            </xforms:input>
                        </xhtml:td>
                    </xhtml:tr>
                </fr:grid>
            </xforms:instance>

            <xforms:instance id="fb-controls-template" xxforms:readonly="true">
                <templates xmlns="">
                    <template label="Text Line">
                        <xhtml:div class="input">
                            <xforms:input id="" ref="">
                                <xforms:label ref=""/>
                                <xforms:hint ref=""/>
                                <xforms:help ref=""/>
                                <xforms:alert ref=""/>
                            </xforms:input>
                        </xhtml:div>
                    </template>
                    <template label="Text Area">
                        <xhtml:div id="" class="textarea">
                            <xforms:textarea ref="">
                                <xforms:label ref=""/>
                                <xforms:hint ref=""/>
                                <xforms:help ref=""/>
                                <xforms:alert ref=""/>
                            </xforms:textarea>
                        </xhtml:div>
                    </template>
                    <template label="Dropdown">
                        <xhtml:div class="dropdown">
                            <xforms:select1 id="" appearance="minimal" ref="">
                                <xforms:label ref=""/>
                                <xforms:hint ref=""/>
                                <xforms:help ref=""/>
                                <xforms:alert ref=""/>
                                
                                <xforms:item>
                                    <xforms:label>Choice #1</xforms:label>
                                    <xforms:value>1</xforms:value>
                                </xforms:item>
                                <xforms:item>
                                    <xforms:label>Choice #2</xforms:label>
                                    <xforms:value>2</xforms:value>
                                </xforms:item>
                            </xforms:select1>
                        </xhtml:div>
                    </template>
                    <template label="Radio Buttons">
                        <xhtml:div class="radio">
                            <xforms:select1 appearance="full" ref="">
                                <xforms:label>[Choose a label]</xforms:label>
                                <xforms:help/>
                                <xforms:hint/>
                                <xforms:alert/>
                                <xforms:item>
                                    <xforms:label>Choice #1</xforms:label>
                                    <xforms:value>1</xforms:value>
                                </xforms:item>
                                <xforms:item>
                                    <xforms:label>Choice #2</xforms:label>
                                    <xforms:value>2</xforms:value>
                                </xforms:item>
                            </xforms:select1>
                        </xhtml:div>
                    </template>
                    <template label="List box">
                        <xhtml:div class="listbox">
                            <xforms:select1 appearance="compact" ref="">
                                <xforms:label>[Choose a label]</xforms:label>
                                <xforms:help/>
                                <xforms:hint/>
                                <xforms:alert/>
                                <xforms:item>
                                    <xforms:label>Choice #1</xforms:label>
                                    <xforms:value>1</xforms:value>
                                </xforms:item>
                                <xforms:item>
                                    <xforms:label>Choice #2</xforms:label>
                                    <xforms:value>2</xforms:value>
                                </xforms:item>
                            </xforms:select1>
                        </xhtml:div>
                    </template>
                    <template label="Checkboxes">
                        <xhtml:div class="checkbox">
                            <xforms:select appearance="full" ref="">
                                <xforms:label>[Choose a label]</xforms:label>
                                <xforms:help/>
                                <xforms:hint/>
                                <xforms:alert/>
                                <xforms:item>
                                    <xforms:label>Choice #1</xforms:label>
                                    <xforms:value>1</xforms:value>
                                </xforms:item>
                                <xforms:item>
                                    <xforms:label>Choice #2</xforms:label>
                                    <xforms:value>2</xforms:value>
                                </xforms:item>
                            </xforms:select>
                        </xhtml:div>
                    </template>
                    <template label="Output">
                        <xhtml:div class="output">
                            <xforms:output ref="">
                                <xforms:label>[Choose a label]</xforms:label>
                                <xforms:help/>
                            </xforms:output>
                        </xhtml:div>
                    </template>
                    <template label="Button">
                        <xhtml:div class="button">
                            <xforms:trigger>
                                <xforms:label>[Choose a label]</xforms:label>
                                <xforms:help/>
                                <xforms:hint/>
                            </xforms:trigger>
                        </xhtml:div>
                    </template>
                    <template label="Image">
                        <xhtml:div class="image">
                            <!-- TODO -->
                        </xhtml:div>
                    </template>
                    <template label="Upload">
                        <xhtml:div class="upload">
                            <xforms:upload ref="">
                                <xforms:label>[Choose a label]</xforms:label>
                                <xforms:help/>
                                <xforms:hint/>
                                <xforms:alert/>
                            </xforms:upload>
                        </xhtml:div>
                    </template>
                </templates>
            </xforms:instance>

        </xforms:model>
    </xhtml:head>
    <xhtml:body>

        <fr:view>
            <xforms:label>Orbeon Form Builder</xforms:label>
            <xhtml:img src="/apps/fr/style/orbeon-logo-trimmed-transparent-42.png"/>
            <fr:body>

                <!--

                    Here is how a page is organized:

                    doc     := block*
                    block   := grid | repeat | section
                    section := block*
                    repeat  := tabularRepeat | gridRepeat | blockRepeat


                    NOTE: section and repeat can have some properties, such as a label.  

                -->

                <!-- Section about form metadata -->
                <fr:section id="fb-metadata-section" context="$metadata-instance" class="fb-metadata-section">
                    <xforms:label>Form Metadata</xforms:label>

                    <xforms:input id="form-id-control" ref="id" appearance="fr:in-place" class="fr-summary fr-search">
                        <xforms:label>Form Identifier</xforms:label>
                    </xforms:input>

                    <xforms:input id="title-control" ref="title" appearance="fr:in-place" class="fr-summary fr-search">
                        <xforms:label>Form Title</xforms:label>
                    </xforms:input>

                    <xforms:textarea id="description-control" ref="description" appearance="fr:in-place" class="fr-summary fr-search">
                        <xforms:label>Form Description</xforms:label>
                    </xforms:textarea>
                </fr:section>

                <fr:section id="fb-details-section" context="$body">
                    <xforms:label>Form Details</xforms:label>

                    <!--<xhtml:div style="float:right">-->
                        <!--<xforms:trigger>-->
                            <!--<xforms:label>-->
                                <!--<xhtml:img src="../../../../apps/fr/style/plus.png" alt="Open section" title="Open section"/>-->
                                <!--<xhtml:span>New Section</xhtml:span>-->
                            <!--</xforms:label>-->
                            <!--<xforms:action ev:event="DOMActivate">-->
                                <!--<xforms:insert context="." nodeset="fr:section | fr:repeat | fr:grid"-->
                                               <!--at="index('fb-top-level-repeat')" position="after"-->
                                               <!--origin="instance('fb-section-template')"/>-->
                            <!--</xforms:action>-->
                        <!--</xforms:trigger>-->
                    <!--</xhtml:div>-->

                    <!--<xforms:trigger>-->
                        <!--<xforms:label>-->
                            <!--<xhtml:span>Show Toolbox</xhtml:span>-->
                        <!--</xforms:label>-->
                        <!--<xxforms:show ev:event="DOMActivate" dialog="fb-toolbox-dialog"/>-->
                    <!--</xforms:trigger>-->



                    <xhtml:div style="clear: both">

                        <!-- Handle top-level blocks -->
                        <xforms:repeat nodeset="fr:section | fr:repeat | fr:grid" id="fb-top-level-repeat">

                            <!-- Top-level section -->
                            <xforms:group ref=".[local-name() = 'section']">

                                <xxforms:variable name="section-id" select="substring-before(@id, '-section')"/>

                                <!-- Editable section title -->
                                <xforms:input id="fb-section-title-input"
                                              ref="$current-resources/*[name() = $section-id]/label"
                                              appearance="fr:in-place" class="fb-section-title">
                                    <xforms:label>Section</xforms:label>

                                    <!-- Respond to fr-delete event to delete the current section -->
                                    <xforms:action ev:event="fr-delete">
                                        <xforms:setvalue ref="instance('fb-variables')/delete-node" value="context()/saxon:path()"/>
                                        <xxforms:show dialog="fb-delete-confirm-dialog"/>

                                        <!-- TODO: react to dialog close -->
                                        <!-- TODO: delete section information in instance -->
                                        <!-- TODO: delete section information in resources -->

                                    </xforms:action>
                                </xforms:input>

                                <!-- Insert section children -->
                                <xhtml:div class="fb-new-grid">
                                    <xforms:trigger appearance="full">
                                        <xforms:label>
                                            <xhtml:img src="../../../../forms/orbeon/builder/images/action1.gif" alt="New 1-Column Grid" title="New 1-Column Grid"/>
                                            <xhtml:span>New 1-Column Grid</xhtml:span>
                                        </xforms:label>
                                        <xforms:action ev:event="DOMActivate">
                                            <xforms:insert context="." nodeset="fr:section | fr:repeat | fr:grid"
                                                           at="index('fb-section-content-repeat')" position="after"
                                                           origin="instance('fb-grid-1-template')"/>
                                            <!--<xforms:setvalue ref="(fr:section | fr:repeat | fr:grid)[index('fb-section-content-repeat')]/@columns" value="1"/>-->
                                        </xforms:action>
                                    </xforms:trigger>

                                    <xforms:trigger appearance="full">
                                        <xforms:label>
                                            <xhtml:img src="../../../../forms/orbeon/builder/images/action2.gif" alt="New 2-Column Grid" title="New 2-Column Grid"/>
                                            <xhtml:span>New 2-Column Grid</xhtml:span>
                                        </xforms:label>
                                        <xforms:action ev:event="DOMActivate">
                                            <xforms:insert context="." nodeset="fr:section | fr:repeat | fr:grid"
                                                           at="index('fb-section-content-repeat')" position="after"
                                                           origin="instance('fb-grid-2-template')"/>
                                        </xforms:action>
                                    </xforms:trigger>

                                    <xforms:trigger appearance="full">
                                        <xforms:label>
                                            <xhtml:img src="../../../../forms/orbeon/builder/images/action3.gif" alt="New 3-Column Grid" title="New 3-Column Grid"/>
                                            <xhtml:span>New 3-Column Grid</xhtml:span>
                                        </xforms:label>
                                        <xforms:action ev:event="DOMActivate">
                                            <xforms:insert context="." nodeset="fr:section | fr:repeat | fr:grid"
                                                           at="index('fb-section-content-repeat')" position="after"
                                                           origin="instance('fb-grid-3-template')"/>
                                        </xforms:action>
                                    </xforms:trigger>
                                </xhtml:div>

                                <!-- Section content -->
                                <xforms:repeat nodeset="fr:section | fr:repeat | fr:grid" id="fb-section-content-repeat">

                                    <xhtml:div>
                                        <!-- Handle grid -->
                                        <xforms:group ref=".[local-name() = 'grid']">
                                            <!-- TODO: How do we set the fr-grid-1-columns or fr-grid-2-columns style? Need avts on HTML attributes? -->
                                            <xhtml:div class="fb-grid">
                                                <!-- Grid table -->
                                                <xhtml:table>
                                                    <xhtml:tbody>
                                                        <!-- Repeat over table rows -->
                                                        <xforms:repeat nodeset="xhtml:tr" id="fb-section-content-grid-tr-repeat">
                                                            <xhtml:tr>
                                                                <!-- Repeat over table columns -->
                                                                <xforms:repeat nodeset="xhtml:td" id="fb-section-content-grid-td-repeat">

                                                                    <xxforms:variable name="control-id" select="substring-before(xforms:*/@id, '-control')"/>

                                                                    <xhtml:td class="fb-grid-row">
                                                                        <xhtml:img src="../../../../apps/fr/style/drag_handle.gif" alt="Drag" title="Drag"/>

                                                                        <xforms:trigger appearance="minimal">
                                                                            <xforms:label><xhtml:img src="../../../../apps/fr/style/trash.gif" alt="Delete" title="Delete"/></xforms:label>
                                                                            <xforms:action ev:event="DOMActivate">
                                                                                <xforms:delete nodeset="."/>
                                                                            </xforms:action>
                                                                        </xforms:trigger>
                                                                    </xhtml:td>
                                                                    <xhtml:td>
                                                                        <!-- Set label for any control -->
                                                                        <xhtml:span>
                                                                            <xforms:input id="fb-control-label-control"
                                                                                          ref="$current-resources/*[name() = $control-id]/label"
                                                                                          appearance="fr:in-place" class="fb-control-label">
                                                                                <xforms:label class="fb-xforms-disabled"/>
                                                                            </xforms:input>
                                                                        </xhtml:span>

                                                                        <xhtml:span class="fb-control-control">
                                                                            <xforms:group ref="xforms:input">
                                                                                <!--instance('fr-form-instance')/xhtml:head/xforms:model/xforms:instance/*/*[xxx section]/*[count(context()/preceding-sibling::*) + 1]-->
                                                                                <xforms:input ref="instance('fb-variables')/blank-readonly-value">
                                                                                    <xforms:label class="fb-xforms-disabled"/>
                                                                                </xforms:input>
                                                                            </xforms:group>
                                                                            <xforms:group ref="xforms:textarea">
                                                                                <xforms:textarea ref="instance('fb-variables')/blank-readonly-value">
                                                                                    <xforms:label class="fb-xforms-disabled"/>
                                                                                </xforms:textarea>
                                                                            </xforms:group>
                                                                            <xforms:group ref="xforms:select1[@appearance = 'minimal']">
                                                                                <xforms:select1 appearance="minimal" ref="instance('fb-variables')/blank-readonly-value">
                                                                                    <xforms:label class="fb-xforms-disabled"/>
                                                                                    <xforms:item>
                                                                                        <xforms:label>[Choose...]</xforms:label>
                                                                                        <xforms:value/>
                                                                                    </xforms:item>
                                                                                </xforms:select1>

                                                                                <fr:repeat nodeset="xforms:item" id="book-repeat" origin="instance('note-template')" columns="1">
                                                                                    <xhtml:tr>
                                                                                        <xhtml:td>
                                                                                            xxxx
                                                                                        </xhtml:td>
                                                                                    </xhtml:tr>
                                                                                </fr:repeat>

                                                                                <!-- TODO: edit items -->

                                                                                zzz

                                                                            </xforms:group>
                                                                            <!-- TODO -->
                                                                        </xhtml:span>

                                                                        <!-- Edit help for any control -->
                                                                        <xforms:trigger appearance="minimal" id="fb-edit-help-trigger">
                                                                            <xforms:label><xhtml:img class="fb-control-help" alt="Help" title="" src="../../../../ops/images/xforms/help.gif"/></xforms:label>
                                                                            <!-- TODO -->
                                                                            <xxforms:show ev:event="DOMActivate" dialog="fb-edit-help-dialog" neighbor="fb-edit-help-trigger"/>
                                                                        </xforms:trigger>

                                                                        <!-- Edit hint for any control -->
                                                                        <xhtml:span>
                                                                            <xforms:input id="fb-control-hint-control"
                                                                                          ref="$current-resources/*[name() = $control-id]/hint"
                                                                                          appearance="fr:in-place" class="fb-control-hint">
                                                                                <xforms:label class="fb-xforms-disabled"/>
                                                                            </xforms:input>
                                                                        </xhtml:span>

                                                                        <xhtml:span class="fb-control-control">
                                                                        <xforms:group ref=".[@class = ('radio')]/xforms:*">
                                                                            <xforms:select1 ref="instance('form-instance')/xhtml:head/xforms:model/xforms:instance/instance/*[count(xxforms:repeat-current()/preceding-sibling::*) + 1]"
                                                                                    appearance="full">
                                                                                <xforms:label ref="xxforms:repeat-current('form-repeat')/xforms:*/xforms:label"/>
                                                                                <xforms:help ref="xxforms:repeat-current('form-repeat')/xforms:*/xforms:help"/>
                                                                                <xforms:hint ref="xxforms:repeat-current('form-repeat')/xforms:*/xforms:hint"/>
                                                                                <xforms:alert ref="xxforms:repeat-current('form-repeat')/xforms:*/xforms:alert"/>
                                                                                <xforms:itemset nodeset="xxforms:repeat-current('form-repeat')/xforms:*/xforms:item">
                                                                                    <xforms:label ref="xforms:label"/>
                                                                                    <xforms:value ref="xforms:value"/>
                                                                                </xforms:itemset>
                                                                            </xforms:select1>
                                                                        </xforms:group>
                                                                        <xforms:group ref=".[@class = 'dropdown']/xforms:*">
                                                                            <xforms:select1 ref="instance('form-instance')/xhtml:head/xforms:model/xforms:instance/instance/*[count(xxforms:repeat-current()/preceding-sibling::*) + 1]"
                                                                                    appearance="minimal">
                                                                                <xforms:label ref="xxforms:repeat-current('form-repeat')/xforms:*/xforms:label"/>
                                                                                <xforms:help ref="xxforms:repeat-current('form-repeat')/xforms:*/xforms:help"/>
                                                                                <xforms:hint ref="xxforms:repeat-current('form-repeat')/xforms:*/xforms:hint"/>
                                                                                <xforms:alert ref="xxforms:repeat-current('form-repeat')/xforms:*/xforms:alert"/>
                                                                                <xforms:itemset nodeset="xxforms:repeat-current('form-repeat')/xforms:*/xforms:item">
                                                                                    <xforms:label ref="xforms:label"/>
                                                                                    <xforms:value ref="xforms:value"/>
                                                                                </xforms:itemset>
                                                                            </xforms:select1>
                                                                        </xforms:group>
                                                                        <xforms:group ref=".[@class = ('checkbox')]/xforms:*">
                                                                            <xforms:select ref="instance('form-instance')/xhtml:head/xforms:model/xforms:instance/instance/*[count(xxforms:repeat-current()/preceding-sibling::*) + 1]"
                                                                                    appearance="full">
                                                                                <xforms:label ref="xxforms:repeat-current('form-repeat')/xforms:*/xforms:label"/>
                                                                                <xforms:help ref="xxforms:repeat-current('form-repeat')/xforms:*/xforms:help"/>
                                                                                <xforms:hint ref="xxforms:repeat-current('form-repeat')/xforms:*/xforms:hint"/>
                                                                                <xforms:alert ref="xxforms:repeat-current('form-repeat')/xforms:*/xforms:alert"/>
                                                                                <xforms:itemset nodeset="xxforms:repeat-current('form-repeat')/xforms:*/xforms:item">
                                                                                    <xforms:label ref="xforms:label"/>
                                                                                    <xforms:value ref="xforms:value"/>
                                                                                </xforms:itemset>
                                                                            </xforms:select>
                                                                        </xforms:group>
                                                                        <xforms:group ref=".[@class = 'output']/xforms:*">
                                                                            <xforms:output ref="instance('form-instance')/xhtml:head/xforms:model/xforms:instance/instance/*[count(xxforms:repeat-current()/preceding-sibling::*) + 1]">
                                                                                <xforms:label ref="xxforms:repeat-current('form-repeat')/xforms:*/xforms:label"/>
                                                                                <xforms:help ref="xxforms:repeat-current('form-repeat')/xforms:*/xforms:help"/>
                                                                            </xforms:output>
                                                                        </xforms:group>
                                                                        </xhtml:span>
                                                                    </xhtml:td>
                                                                </xforms:repeat>
                                                            </xhtml:tr>
                                                        </xforms:repeat>
                                                    </xhtml:tbody>
                                                </xhtml:table>
                                            </xhtml:div>
                                        </xforms:group>
                                        <xforms:group ref=".[local-name() = 'repeat']">
                                            <!--<xforms:label ref="."/>-->
                                            xxxx Repeat xxxx

                                        </xforms:group>
                                        <xforms:group ref=".[local-name() = 'section']">
                                            <!--<xforms:label ref="."/>-->
                                            xxxx Section xxxx

                                        </xforms:group>
                                    </xhtml:div>
                                </xforms:repeat>

                            </xforms:group>

                            <!-- Top-level grid -->
                            <xforms:group ref=".[local-name() = 'grid']">
                                <xforms:label ref="."/>
                                xxxx Grid xxxx

                                <xhtml:table>
                                    <xforms:repeat nodeset="xhtml:tr">
                                        <xhtml:tr>
                                            <xforms:repeat nodeset="xhtml:td">
                                                <xhtml:td>
                                                    TD
                                                </xhtml:td>
                                            </xforms:repeat>
                                        </xhtml:tr>
                                    </xforms:repeat>
                                </xhtml:table>

                            </xforms:group>

                            <!-- Top-level repeat -->
                            <xforms:group ref=".[local-name() = 'repeat']">
                                <xforms:label ref="."/>
                                xxxx Repeat xxxx

                            </xforms:group>
                        </xforms:repeat>
                    </xhtml:div>
                </fr:section>

                <!-- Test form -->
                <xforms:trigger>
                    <xforms:label>
                        <xhtml:img src="../../../../forms/orbeon/builder/images/play.png" alt="Test Form" title="Test Form"/>
                        <xhtml:span>Test Form</xhtml:span>
                    </xforms:label>
                    <xforms:action ev:event="DOMActivate">

                        <xforms:send submission="fb-test-form-submission"/>

                    </xforms:action>
                </xforms:trigger>

                <!-- Toolbox -->
                <xxforms:dialog id="fb-toolbox-dialog" level="modeless" draggable="true" visible="true" close="false" class="fb-toolbox-dialog">
                    <xforms:label>Toolbox</xforms:label>
                        <xhtml:div class="fb-toolbox">
                            <!-- Add new section -->
                            <xhtml:div class="fb-tool">
                                <xforms:trigger>
                                    <xforms:label>
                                        <xhtml:img src="../../../../apps/fr/style/plus.png" alt="Open section" title="Open section"/>
                                        <xhtml:span>Section</xhtml:span>
                                    </xforms:label>
                                    <xforms:action ev:event="DOMActivate" context="$body">
                                        <!-- Insert section -->

                                        <!-- Insert section template in the UI -->
                                        <xforms:insert context="." nodeset="fr:section | fr:repeat | fr:grid"
                                                       at="index('fb-top-level-repeat')" position="after"
                                                       origin="instance('fb-section-template')"/>

                                        <!-- Set @id value -->
                                        <xforms:dispatch target="fr-form-model" name="fb-compute-section-id"/>
                                        <xforms:setvalue ref="*[index('fb-top-level-repeat')]/@id" value="concat('section-', $next-section-id, '-section')"/>

                                        <!-- Set @context value -->
                                        <xforms:setvalue ref="*[index('fb-top-level-repeat')]/@context" value="concat('section-', $next-section-id)"/>

                                        <!-- Insert container in the instance -->
                                        <xforms:action context="$form-instance">
                                            <!-- TODO: for now assume a top-level section containing a grid -->
                                            <xforms:insert context="." nodeset="*"
                                                           at="index('fb-top-level-repeat')" position="after"
                                                           origin="xxforms:element(concat('section-', $next-section-id))"/>

                                        </xforms:action>

                                        <!-- Insert resources -->
                                        <xforms:insert context="$current-resources" nodeset="*"
                                                       origin="xxforms:element(concat('section-', $next-section-id))"/>

                                        <xforms:insert context="$current-resources/*[last()]" origin="instance('fb-resource-template')/*"/>

                                        <!-- Insert a first component into the section -->
                                        <xforms:setindex repeat="fb-controls-template-repeat" index="1"/>
                                        <xforms:dispatch name="DOMActivate" target="fb-add-control-trigger"/>

                                    </xforms:action>
                                </xforms:trigger>
                            </xhtml:div>
                            <xforms:repeat nodeset="instance('fb-controls-template')/template" id="fb-controls-template-repeat">

                                <xxforms:variable name="control-template" select="xhtml:div/xforms:*"/>

                                <xhtml:div class="fb-tool">
                                    <xforms:trigger id="fb-add-control-trigger" xmlns:f="http://orbeon.org/oxf/xml/formatting">
                                        <xforms:label>
                                            <xforms:output value="concat('&lt;img src=''../../../../forms/orbeon/builder/images/', xhtml:div/@class, '.png''/>')" mediatype="text/html" f:url-norewrite="true"/>
                                            <xforms:output ref="@label"/>
                                        </xforms:label>
                                        <xforms:action ev:event="DOMActivate">
                                            <!-- Insert a new control -->

                                            <!-- TODO: for now assume a top-level section containing a grid -->

                                            <!-- Compute next control id -->
                                            <xforms:dispatch target="fr-form-model" name="fb-compute-control-id"/>

                                            <!-- Insert new holder element into the instance -->
                                            <xforms:insert context="$form-instance/*[index('fb-top-level-repeat')]"
                                                           nodeset="*"
                                                           at="index('fb-section-content-grid-tr-repeat') * 1 + index('fb-section-content-grid-td-repeat') - 1"
                                                           origin="xxforms:element(concat('control-', $next-control-id))"/>

                                            <!-- Insert new control into the document -->
                                            <xforms:action context="$body/fr:section[index('fb-top-level-repeat')]/fr:grid">
                                                <!-- Pointing to section container element -->
                                                <!-- TODO: here assume 1-column grid -->

                                                <!-- Insert row container -->
                                                <xforms:insert context="."
                                                               nodeset="xhtml:tr"
                                                               at="index('fb-section-content-grid-tr-repeat')"
                                                               origin="instance('fb-grid-tr-template')"/>

                                                <!-- Insert column container -->
                                                <xforms:insert context="xhtml:tr[index('fb-section-content-grid-tr-repeat')]"
                                                               nodeset="xhtml:td"
                                                               at="index('fb-section-content-grid-td-repeat')"
                                                               origin="instance('fb-grid-td-template')"/>

                                                <xforms:action context="xhtml:tr[index('fb-section-content-grid-tr-repeat')]/xhtml:td[index('fb-section-content-grid-td-repeat')]">
                                                    <!-- Context is now on td -->

                                                    <!-- Insert control into td -->
                                                    <xforms:insert context="." origin="$control-template"/>

                                                    <xforms:action context="xforms:*">
                                                        <!-- Set @id value -->
                                                        <xforms:setvalue ref="@id" value="concat('control-', $next-control-id, '-control')"/>

                                                        <!-- Set @ref value -->
                                                        <xforms:setvalue ref="@ref" value="concat('control-', $next-control-id)"/>

                                                        <!-- Set xforms:label @ref -->
                                                        <xforms:setvalue ref="xforms:label/@ref" value="concat('instance(''fr-form-resource'')/control-', $next-control-id, '/label')"/>
                                                        <xforms:setvalue ref="xforms:hint/@ref" value="concat('instance(''fr-form-resource'')/control-', $next-control-id, '/hint')"/>
                                                        <xforms:setvalue ref="xforms:help/@ref" value="concat('instance(''fr-form-resource'')/control-', $next-control-id, '/help')"/>
                                                        <xforms:setvalue ref="xforms:alert/@ref" value="concat('instance(''fr-form-resource'')/control-', $next-control-id, '/alert')"/>
                                                    </xforms:action>
                                                </xforms:action>

                                            </xforms:action>

                                            <!-- Insert resources -->
                                            <xforms:insert context="$current-resources" nodeset="*"
                                                           origin="xxforms:element(concat('control-', $next-control-id))"/>

                                            <xforms:insert context="$current-resources/*[last()]" origin="instance('fb-resource-template')/*"/>

                                        </xforms:action>
                                    </xforms:trigger>
                                </xhtml:div>
                            </xforms:repeat>
                        <xhtml:div class="fb-clear"/>
                    </xhtml:div>
                </xxforms:dialog>

                <!-- Help edit -->
                <xxforms:dialog id="fb-edit-help-dialog" level="modal" draggable="true" appearance="minimal">
                    <xforms:label>Edit Help</xforms:label>
                    <xhtml:div>
                        <xhtml:img src="/apps/fr/style/question-large.gif" alt="Question" class="dialog-icon"/>
                        <xhtml:div class="dialog-message">Are you sure you want to delete the current section?</xhtml:div>
                    </xhtml:div>
                    <xhtml:div class="dialog-button">
                        <xforms:group>
                            <xforms:trigger>
                                <xforms:label><xhtml:img src="/apps/fr/style/clear.gif" alt=""/> <xhtml:span>Delete</xhtml:span></xforms:label>
                                <!-- Delete node -->
                                <xforms:delete ev:event="DOMActivate" model="fr-form-model" nodeset="saxon:evaluate(instance('fb-variables')/delete-node)"/>
                            </xforms:trigger>
                            <xforms:trigger>
                                <xforms:label><xhtml:img src="/apps/fr/style/close.gif" alt=""/> <xhtml:span>Cancel</xhtml:span></xforms:label>
                            </xforms:trigger>
                        </xforms:group>
                        <!-- Hide dialog -->
                        <xxforms:hide ev:event="DOMActivate" dialog="fb-edit-help-dialog"/>
                    </xhtml:div>
                </xxforms:dialog>

                <!-- Section delete confirmation -->
                <xxforms:dialog id="fb-delete-confirm-dialog" level="modal" close="false" draggable="true">
                    <xforms:label>Confirm</xforms:label>
                    <xhtml:div>
                        <xhtml:img src="/apps/fr/style/question-large.gif" alt="Question" class="dialog-icon"/>
                        <xhtml:div class="dialog-message">Are you sure you want to delete the current section?</xhtml:div>
                    </xhtml:div>
                    <xhtml:div class="dialog-button">
                        <xforms:group>
                            <xforms:trigger>
                                <xforms:label><xhtml:img src="/apps/fr/style/clear.gif" alt=""/> <xhtml:span>Delete</xhtml:span></xforms:label>
                                <!-- Delete node -->
                                <xforms:delete ev:event="DOMActivate" model="fr-form-model" nodeset="saxon:evaluate(instance('fb-variables')/delete-node)"/>
                            </xforms:trigger>
                            <xforms:trigger>
                                <xforms:label><xhtml:img src="/apps/fr/style/close.gif" alt=""/> <xhtml:span>Cancel</xhtml:span></xforms:label>
                            </xforms:trigger>
                        </xforms:group>
                        <!-- Hide dialog -->
                        <xxforms:hide ev:event="DOMActivate" dialog="fb-delete-confirm-dialog"/>
                    </xhtml:div>
                </xxforms:dialog>
            </fr:body>
        </fr:view>

        <widget:xforms-instance-inspector xmlns:widget="http://orbeon.org/oxf/xml/widget"/>
    </xhtml:body>
</xhtml:html>
