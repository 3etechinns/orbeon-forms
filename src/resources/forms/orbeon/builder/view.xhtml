<?xml version="1.0" encoding="UTF-8"?>
<!--
    Copyright (C) 2008 Orbeon, Inc.

    This program is free software; you can redistribute it and/or modify it under the terms of the
    GNU Lesser General Public License as published by the Free Software Foundation; either version
    2.1 of the License, or (at your option) any later version.

    This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
    without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
    See the GNU Lesser General Public License for more details.

    The full text of the license is available at http://www.gnu.org/copyleft/lesser.html
-->
<xhtml:html xmlns:xhtml="http://www.w3.org/1999/xhtml"
      xmlns:xforms="http://www.w3.org/2002/xforms"
      xmlns:xs="http://www.w3.org/2001/XMLSchema"
      xmlns:ev="http://www.w3.org/2001/xml-events"
      xmlns:xi="http://www.w3.org/2001/XInclude"
      xmlns:xxi="http://orbeon.org/oxf/xml/xinclude"
      xmlns:xxforms="http://orbeon.org/oxf/xml/xforms"
      xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
      xmlns:saxon="http://saxon.sf.net/">
    <xhtml:head>
        <xhtml:title>Orbeon Form Builder</xhtml:title>
        <xhtml:link rel="stylesheet" href="/ops/css/yui/reset-fonts-grids.css" type="text/css"/>
        <xhtml:link rel="stylesheet" href="/ops/css/yui/base-min.css" type="text/css"/>
        <xhtml:link rel="stylesheet" href="/apps/fr/style/form-runner.css" type="text/css"/>
        
        <xhtml:style type="text/css">

            #doc4 { margin-left: 15.5em }

            .fb-section-title div {
                background: white url(../../../../apps/fr/style/separator.gif) repeat-x scroll left center
            }

            <!-- Language toolbar -->
            .fb-language-choice { display: block; float: right; }
            .fb-language-choice .fb-language-triggers { display: block }

            <!-- Toolbox -->
            .fb-toolbox { margin: .5em; padding: .5em; width: auto; background-color: #3598D4; text-align: center }
            .fb-toolbox .fb-tool { display: block }
            .fb-toolbox .fb-tool button { width: 12em; text-align: left }

            .fb-clear { clear: both }
            .fb-xforms-disabled { display:none }

            .section-container { border-top: 1px solid #3598D4; margin-top: .5em }
            .fb-grid table { margin-top: .5em; margin-left: 1px }
            .fb-grid td { border: 1px dotted gray; padding: .2em }

            .fb-toolbar button { width: 12em }
            .fb-section-toolbar { margin-top: .5em }

            <!-- Set width of dialog (otherwise becomes too wide) -->
            #fb-confirmation-dialog { width: 400px; }
            #fb-toolbox-dialog { width: 180px; }
            #fb-xml-dialog .fb-xml-dialog-view { width: 57.69em; *width:56.301em; min-width:750px; height: 400px; overflow: scroll }
            #fb-edit-source-dialog .fb-xml-dialog-view { width: 57.69em; *width:56.301em; min-width:750px; height: 400px }
            #fb-edit-source-dialog .fb-xml-dialog-view textarea.xforms-textarea { width: 99%; height: 29em }
            #fb-toolbox-dialog .yui-panel .hd { background-color: #3598d4 }

            .dialog-icon { float: left; margin-right: 2em; margin-left: 1em; padding-bottom: 1em; }
            .dialog-message { margin-top: 1em; padding-top: 0.5em; }
            .dialog-button { text-align: right; padding-right: 2em; padding-top: 2em; padding-bottom: 1em; }

            <!-- In-place editing for regular fields -->

            .fr-section-container .fr-inplace-buttons { display: block; margin-top: .5em }
            .fr-section-container .fr-inplace-input input {
                border: 1px inset rgb(233, 233, 174); padding: 0; background-color: rgb(255, 255, 211)
            }

            .fr-section-container .fr-inplace-textarea textarea.xforms-textarea {
                border: 1px inset rgb(233, 233, 174); padding: 0; background-color: rgb(255, 255, 211)
            }

            .fr-section-container .fr-inplace-value:hover { background-color: rgb(255, 255, 211) }

            <!-- In-place editing for metadata section -->
            #fb-metadata-section .fr-inplace-input .xforms-input input { width: 68em }
            #fb-metadata-section .fr-inplace-textarea textarea.xforms-textarea { width: 68em }
            #fb-metadata-section .fr-inplace-view .fr-inplace-buttons { display: none }

            <!-- In-place editing for section titles -->
            #fb-details-section .fb-section-title .fr-inplace-buttons { display:inline; padding-left: .5em; padding-right: .5em; margin-left: .5em; background: white }
            <!--#fb-details-section .fb-section-title .fr-inplace-value:hover { background-color: rgb(255, 255, 211) }-->
            #fb-details-section .fb-section-title .fr-inplace-value { margin-left: 1em; padding-left: .5em; padding-right: .5em; background: white }
            #fb-details-section .fb-section-title .fr-inplace-content .xforms-label { display: none }
            #fb-details-section .fb-section-title .fr-inplace-delete { margin-right: .5em }
            #fb-details-section .fb-section-title .fr-inplace-delete img { padding: 0 }
            #fb-details-section .fb-section-title .fr-inplace-delete { display: inline }
            #fb-details-section .fb-section-title .xforms-input input { width: 20em }

            <!-- Highlighting of top-level blocks (sections, ...) -->
            .fb-top-level-content { display: block; padding-left: .5em; margin-bottom: .5em; border-left: 4px solid transparent }
            .fb-top-level-content:hover { border-left: 4px solid gray}
            .fr-section-container .xforms-repeat-selected-item-1 { border-left: 4px solid #3598D4}

            <!-- Highlighting of section content (grids, ...) -->
            .fb-section-content { display: block; padding-left: .5em; margin-bottom: .5em; border-left: 4px solid transparent }
            .fb-section-content:hover { border-left: 4px solid gray}
            .fr-section-container .xforms-repeat-selected-item-2 { border-left: 4px solid #3598D4}

            <!-- Control editor -->
            .fb-control-label .xforms-label { display: none }
            .fb-control-label .fr-inplace-value { font-weight: bold }
            .fb-control-label .fr-inplace-view .fr-inplace-buttons { display: none }
            .fb-control-control .xforms-label { display: none }
            .fb-control-control .xforms-alert { display: none }
            .fb-control-help {
                display: -moz-inline-box;
                display: inline-block;
                margin-left: .2em;
                vertical-align: middle;
            }

            .fb-control-hint .fr-inplace-value {
                font-size: smaller;
                font-style: italic;
                margin-left: .5em;
                width: 22em;
                color: gray
            }
            .fb-control-hint .fr-inplace-view .fr-inplace-buttons { display: none }

            <!-- Grid -->

            <!-- Set min height of table using CSS hack for IE -->
            .fb-grid-cell-icons { min-height: 4em; height: auto !important; height: 4em; text-align: center }

            .fb-grid-control-icons { display: block; text-align: center; float: right }
            .fb-grid-control-icons .xforms-trigger { display: block }

            .fb-grid table { width: 68em }
            .fb-grid tr td { width: auto; vertical-align: top }
            #fb-details-section .fb-grid tr td .xforms-input input { width: 63.5em }
            #fb-details-section .fb-grid tr td textarea.xforms-textarea { width: 64em }
            #fb-details-section .fb-grid tr td .xforms-select1-appearance-minimal { width: 64em }

            .fb-grid-2-columns tr td { width: 50%; }
            #fb-details-section .fb-grid-2-columns tr td .xforms-input input { width: 30em; }
            #fb-details-section .fb-grid-2-columns tr td textarea.xforms-textarea { width: 30em; }
            #fb-details-section .fb-grid-2-columns tr td .xforms-select1-appearance-minimal { width: 30em }

            .fb-grid-3-columns tr td { width: 33.3%; }
            #fb-details-section .fb-grid-3-columns tr td .xforms-input input { width: 18em; }
            #fb-details-section .fb-grid-3-columns tr td textarea.xforms-textarea { width: 19em; }
            #fb-details-section .fb-grid-3-columns tr td .xforms-select1-appearance-minimal { width: 19em }

            .fb-grid-4-columns tr td { width: 25%; }
            #fb-details-section .fb-grid-4-columns tr td .xforms-input input { width: 13em; }
            #fb-details-section .fb-grid-4-columns tr td textarea.xforms-textarea { width: 13em; }
            #fb-details-section .fb-grid-4-columns tr td .xforms-select1-appearance-minimal { width: 13em }

            .fb-grid-cell-icons { width: 1em; text-align: center; margin-right: .2em; float: left }
            .fb-grid-cell-icons img { margin-bottom: .5em; padding: 0 }

            .fb-grid-content { float: left }

            .xforms-repeat-selected-item-4 {
                background-image: url(../../../../apps/fr/style/logo-bg.gif) 
            }

            .fb-grid td .fb-grid-cell-icons img { display: none }
            .fb-grid td:hover .fb-grid-cell-icons img { display: block }

            .fb-grid td .fb-grid-control-icons img { display: none }
            .fb-grid td:hover .fb-grid-control-icons img { display: block }

            .fb-hide-alert .xforms-alert { display: none }

            <!--.fb-section-title-content { background: #eee }-->
        </xhtml:style>
        <xforms:model id="fr-form-model">

            <xforms:action ev:event="xforms-ready">
                <xxforms:script>
                    <!-- Position toolbox to the left -->                    
                    ORBEON.xforms.Globals.dialogs["fb-toolbox-dialog"].cfg.setProperty("x", 0);
                </xxforms:script>
            </xforms:action>

            <!-- Main instance -->
            <xforms:instance id="fr-form-instance" src="oxf:/forms/orbeon/builder/example-1.xml"/>

            <!-- Binds on main instance -->
            <xforms:bind nodeset="instance('fr-form-instance')">
                <!-- Constrain form ids -->
                <xforms:bind nodeset="xhtml:head/xforms:model/xforms:instance[@id = 'fr-form-metadata']/*/id"
                             type="xs:NCName" readonly="false()"
                             calculate="if (normalize-space() = '') then concat('ID', digest(string(random(true)), 'MD5', 'hex')) else ."/>
            </xforms:bind>

            <!-- Instance containing the current language -->
            <xforms:instance id="fb-language-instance">
                <language>en</language>
            </xforms:instance>

            <!-- Variable pointing to the current language -->
            <xxforms:variable name="lang" select="instance('fb-language-instance')"/>

            <!-- Other variables -->
            <xxforms:variable name="form-instance" select="xhtml:head/xforms:model/xforms:instance[@id = 'fr-form-instance']/*"/>
            <xxforms:variable name="metadata-instance" select="xhtml:head/xforms:model/xforms:instance[@id = 'fr-form-metadata']/*"/>
            <xxforms:variable name="resources" select="xhtml:head/xforms:model/xforms:instance[@id = 'fr-form-resources']/*"/>
            <xxforms:variable name="current-resources" select="$resources/resource[@xml:lang = $lang]"/>
            <xxforms:variable name="body" select="xhtml:body/fr:view/fr:body"/>

            <xforms:instance id="fb-xsl-output-instance">
                <xsl:output xmlns:xsl="http://www.w3.org/1999/XSL/Transform" method="xml" omit-xml-declaration="yes" indent="yes" saxon:indent-spaces="4"/>
            </xforms:instance>

            <!-- Submission to test the form -->
            <xforms:submission id="fb-test-form-submission"
                    ref="instance('fr-form-instance')"
                    method="post" replace="all"
                    action="/fr/orbeon/test/test/">

            </xforms:submission>

            <xforms:instance id="fb-variables">
                <variables>
                    <done/>
                    <column-number/>

                    <!-- Confirmation dialog -->
                    <confirmation-message/>
                    <confirmation-target/>

                    <result-node/>

                    <next-section-id/>
                    <next-control-id/>

                    <new-language/>
                    <new-language-trigger/>

                    <new-text/>

                    <new-source/>
                    <new-source-trigger/>

                    <xml-view/>
                </variables>
            </xforms:instance>

            <xforms:bind nodeset="instance('fb-variables')">
                <xforms:bind nodeset="new-language-trigger" readonly="normalize-space(../new-language) = ''"/>
            </xforms:bind>

            <xxforms:variable name="variables" select="instance('fb-variables')"/>
            <xxforms:variable name="next-section-id" select="$variables/next-section-id"/>
            <xxforms:variable name="next-control-id" select="$variables/next-control-id"/>

            <!-- Compute the next section id -->
            <xforms:action ev:event="fb-compute-section-id">
                <!-- Initialize with count of existing sections (we could as well start from 1) -->
                <xforms:setvalue if="$next-section-id = ''" ref="$next-section-id" value="count($body//fr:section)"/>
                <!-- Increment number until the id doesn't clash with the control id OR the element name -->
                <xforms:action while="$body//fr:section[@id = concat('section-', $next-section-id, '-section')]
                                        or $form-instance/*[name() = concat('section-', $next-section-id)]">
                    <xforms:setvalue ref="$next-section-id" value=". + 1"/>
                </xforms:action>
            </xforms:action>

            <!-- Compute the next control id -->
            <xforms:action ev:event="fb-compute-control-id">
                <!-- Initialize with count of existing controls (we could as well start from 1) -->
                <xforms:setvalue if="$next-control-id = ''" ref="$next-control-id" value="count($body//xforms:*[ends-with(@id, '-control')]) + 1"/>
                <!-- Increment number until the id doesn't clash with the control id OR the element name -->
                <xforms:action while="$body//xforms:*[@id = concat('control-', $next-control-id, '-control')]
                                        or $form-instance/*/*[name() = concat('control-', $next-control-id)]">
                    <xforms:setvalue ref="$next-control-id" value=". + 1"/>
                </xforms:action>
            </xforms:action>

            <xforms:instance id="fb-section-template" xxforms:readonly="true">
                <fr:section id="" context="">
                    <xforms:label ref=""/>
                    <fr:grid columns="1">
                        <xhtml:tr>
                            <xhtml:td/>
                        </xhtml:tr>
                    </fr:grid>
                </fr:section>
            </xforms:instance>

            <xforms:instance id="fb-resource-template" xxforms:readonly="true">
                <template>
                    <label>[Please modify the label]</label>
                    <hint>[Please modify the hint]</hint>
                    <help>[Please modify the help]</help>
                    <alert>[Please modify the alert]</alert>
                </template>
            </xforms:instance>

            <xforms:instance id="fb-grid-1-template" xxforms:readonly="true">
                <fr:grid columns="1">
                    <xhtml:tr>
                        <xhtml:td/>
                    </xhtml:tr>
                </fr:grid>
            </xforms:instance>

            <xforms:instance id="fb-grid-2-template" xxforms:readonly="true">
                <fr:grid columns="2">
                    <xhtml:tr>
                        <xhtml:td/>
                        <xhtml:td/>
                    </xhtml:tr>
                </fr:grid>
            </xforms:instance>

            <xforms:instance id="fb-grid-3-template" xxforms:readonly="true">
                <fr:grid columns="3">
                    <xhtml:tr>
                        <xhtml:td/>
                        <xhtml:td/>
                        <xhtml:td/>
                    </xhtml:tr>
                </fr:grid>
            </xforms:instance>

            <xforms:instance id="fb-grid-4-template" xxforms:readonly="true">
                <fr:grid columns="4">
                    <xhtml:tr>
                        <xhtml:td/>
                        <xhtml:td/>
                        <xhtml:td/>
                        <xhtml:td/>
                    </xhtml:tr>
                </fr:grid>
            </xforms:instance>

            <xforms:instance id="fb-controls-template" xxforms:readonly="true">
                <templates xmlns="">
                    <template label="Text Line">
                        <xhtml:div class="input">
                            <xforms:input id="" ref="">
                                <xforms:label ref=""/>
                                <xforms:hint ref=""/>
                                <xforms:help ref=""/>
                                <xforms:alert ref=""/>
                            </xforms:input>
                        </xhtml:div>
                    </template>
                    <template label="Date Picker" image="/ops/images/xforms/calendar.gif">
                        <xhtml:div class="date-input">
                            <xforms:input id="" ref="">
                                <xforms:label ref=""/>
                                <xforms:hint ref=""/>
                                <xforms:help ref=""/>
                                <xforms:alert ref=""/>
                            </xforms:input>
                        </xhtml:div>
                    </template>
                    <template label="Time" image="/forms/orbeon/builder/images/clock.png">
                        <xhtml:div class="time-input">
                            <xforms:input id="" ref="">
                                <xforms:label ref=""/>
                                <xforms:hint ref=""/>
                                <xforms:help ref=""/>
                                <xforms:alert ref=""/>
                            </xforms:input>
                        </xhtml:div>
                    </template>
                    <template label="Date and Time" image="/ops/images/xforms/calendar.gif">
                        <xhtml:div class="dateTime-input">
                            <xforms:input id="" ref="">
                                <xforms:label ref=""/>
                                <xforms:hint ref=""/>
                                <xforms:help ref=""/>
                                <xforms:alert ref=""/>
                            </xforms:input>
                        </xhtml:div>
                    </template>
                    <template label="Text Area">
                        <xhtml:div id="" class="textarea">
                            <xforms:textarea id="" ref="">
                                <xforms:label ref=""/>
                                <xforms:hint ref=""/>
                                <xforms:help ref=""/>
                                <xforms:alert ref=""/>
                            </xforms:textarea>
                        </xhtml:div>
                    </template>
                    <template label="Dropdown">
                        <xhtml:div class="dropdown">
                            <xforms:select1 id="" appearance="minimal" ref="">
                                <xforms:label ref=""/>
                                <xforms:hint ref=""/>
                                <xforms:help ref=""/>
                                <xforms:alert ref=""/>


                                zzz
                                
                                <xforms:item>
                                    <xforms:label>Choice #1</xforms:label>
                                    <xforms:value>1</xforms:value>
                                </xforms:item>
                                <xforms:item>
                                    <xforms:label>Choice #2</xforms:label>
                                    <xforms:value>2</xforms:value>
                                </xforms:item>
                            </xforms:select1>
                        </xhtml:div>
                    </template>
                    <template label="Radio Buttons">
                        <xhtml:div class="radio">
                            <xforms:select1 appearance="full" ref="">
                                <xforms:label>[Choose a label]</xforms:label>
                                <xforms:help/>
                                <xforms:hint/>
                                <xforms:alert/>
                                <xforms:item>
                                    <xforms:label>Choice #1</xforms:label>
                                    <xforms:value>1</xforms:value>
                                </xforms:item>
                                <xforms:item>
                                    <xforms:label>Choice #2</xforms:label>
                                    <xforms:value>2</xforms:value>
                                </xforms:item>
                            </xforms:select1>
                        </xhtml:div>
                    </template>
                    <template label="List box">
                        <xhtml:div class="listbox">
                            <xforms:select1 appearance="compact" ref="">
                                <xforms:label>[Choose a label]</xforms:label>
                                <xforms:help/>
                                <xforms:hint/>
                                <xforms:alert/>
                                <xforms:item>
                                    <xforms:label>Choice #1</xforms:label>
                                    <xforms:value>1</xforms:value>
                                </xforms:item>
                                <xforms:item>
                                    <xforms:label>Choice #2</xforms:label>
                                    <xforms:value>2</xforms:value>
                                </xforms:item>
                            </xforms:select1>
                        </xhtml:div>
                    </template>
                    <template label="Checkboxes">
                        <xhtml:div class="checkbox">
                            <xforms:select appearance="full" ref="">
                                <xforms:label>[Choose a label]</xforms:label>
                                <xforms:help/>
                                <xforms:hint/>
                                <xforms:alert/>
                                <xforms:item>
                                    <xforms:label>Choice #1</xforms:label>
                                    <xforms:value>1</xforms:value>
                                </xforms:item>
                                <xforms:item>
                                    <xforms:label>Choice #2</xforms:label>
                                    <xforms:value>2</xforms:value>
                                </xforms:item>
                            </xforms:select>
                        </xhtml:div>
                    </template>
                    <template label="Output">
                        <xhtml:div class="output">
                            <xforms:output ref="">
                                <xforms:label>[Choose a label]</xforms:label>
                                <xforms:help/>
                            </xforms:output>
                        </xhtml:div>
                    </template>
                    <template label="Button">
                        <xhtml:div class="button">
                            <xforms:trigger>
                                <xforms:label>[Choose a label]</xforms:label>
                                <xforms:help/>
                                <xforms:hint/>
                            </xforms:trigger>
                        </xhtml:div>
                    </template>
                    <template label="Image">
                        <xhtml:div class="image">
                            <!-- TODO -->
                        </xhtml:div>
                    </template>
                    <template label="Upload">
                        <xhtml:div class="upload">
                            <xforms:upload ref="">
                                <xforms:label>[Choose a label]</xforms:label>
                                <xforms:help/>
                                <xforms:hint/>
                                <xforms:alert/>
                            </xforms:upload>
                        </xhtml:div>
                    </template>
                </templates>
            </xforms:instance>

        </xforms:model>
    </xhtml:head>
    <xhtml:body>

        <fr:view>
            <xforms:label>Orbeon Form Builder</xforms:label>
            <xhtml:img src="/apps/fr/style/orbeon-logo-trimmed-transparent-42.png"/>
            <fr:body>

                <xxforms:variable name="current-top-level-block" select="$body/fr:*[index('fb-top-level-repeat')]"/>
                <xxforms:variable name="current-section-content-block" select="$current-top-level-block/fr:*[index('fb-section-content-repeat')]"/>

                <!--

                    Here is how a page is organized:

                    doc     := block*
                    block   := grid | repeat | section
                    section := block*
                    repeat  := tabularRepeat | gridRepeat | blockRepeat


                    NOTE: section and repeat can have some properties, such as a label.  

                -->

                <xforms:group class="fb-language-choice fb-hide-alert">
                    <xforms:select1 appearance="minimal" ref="$lang" id="fb-resources-language-select">
                        <xforms:label>Resources Language</xforms:label>
                        <xforms:itemset nodeset="$resources/resource">
                            <xforms:label value="xxforms:instance('fr-languages-instance')/language[@code = context()/@xml:lang]/(if (@native-name != @english-name) then concat(@native-name, ' (', @english-name, ')') else @native-name)"/>
                            <xforms:value ref="@xml:lang"/>
                        </xforms:itemset>
                    </xforms:select1>
                    <xforms:group class="fb-language-triggers">
                        <xforms:trigger appearance="minimal">
                            <xforms:label>Add</xforms:label>
                            <xxforms:show ev:event="DOMActivate" dialog="fb-add-language-dialog" neighbor="fb-resources-language-select"/>
                        </xforms:trigger>
                        <xforms:trigger appearance="minimal" id="fb-language-remove" ref=".[count($resources/resource) gt 1]">
                            <xforms:label>Remove</xforms:label>
                            <xforms:action ev:event="DOMActivate">
                                <!-- Ask confirmation -->
                                <xforms:setvalue ref="$variables/confirmation-message"
                                                 value="concat('Are you sure you want to delete all resources for language ''',
                                                 xxforms:instance('fr-languages-instance')/language[@code = $lang]/(if (@native-name != @english-name) then concat(@native-name, ' (', @english-name, ')') else @native-name),
                                                 '''?')"/>
                                <xforms:setvalue ref="$variables/confirmation-target">fb-language-remove</xforms:setvalue>
                                <xxforms:show dialog="fb-confirmation-dialog"/>
                            </xforms:action>
                            <xforms:action ev:event="fb-confirmation-yes">
                                <!-- Delete resources for this language -->
                                <xforms:delete nodeset="$resources/resource[@xml:lang = $lang]"/>
                                <xforms:setvalue ref="$lang" value="$resources/resource[1]/@xml:lang"/>
                            </xforms:action>
                        </xforms:trigger>
                    </xforms:group>
                </xforms:group>

                <!-- Section about form metadata -->
                <fr:section id="fb-metadata-section" context="$metadata-instance" class="fb-metadata-section">
                    <xforms:label>Form Metadata</xforms:label>

                    <xforms:input id="form-id-control" ref="id" appearance="fr:in-place" class="fr-summary fr-search">
                        <xforms:label>Form Identifier</xforms:label>
                    </xforms:input>

                    <xforms:input id="title-control" ref="title" appearance="fr:in-place" class="fr-summary fr-search">
                        <xforms:label>Form Title</xforms:label>
                    </xforms:input>

                    <xforms:textarea id="description-control" ref="description" appearance="fr:in-place" class="fr-summary fr-search">
                        <xforms:label>Form Description</xforms:label>
                    </xforms:textarea>
                </fr:section>

                <!-- Form details -->
                <fr:section id="fb-details-section" context="$body">
                    <xforms:label>Form Details</xforms:label>

                    <xhtml:div style="clear: both">

                        <!-- Handle top-level blocks -->
                        <xforms:repeat nodeset="fr:section | fr:repeat | fr:grid" id="fb-top-level-repeat">

                            <xhtml:div class="fb-top-level-content">
                                <!-- Top-level section -->
                                <xforms:group ref=".[local-name() = 'section']">

                                    <!-- Section id -->
                                    <xxforms:variable name="section-id" select="substring-before(@id, '-section')"/>
                                    <!-- Holder element for the section -->
                                    <xxforms:variable name="section-holder" select="$form-instance/*[name() = $section-id]"/>

                                    <!--<xhtml:img src="/apps/fr/style/minus.png" alt="Close section" title="Close section"/>-->

                                    <!-- Editable section title -->
                                    <xforms:group appearance="xxforms:internal" id="fb-section-title-input-container">
                                        <xforms:input id="fb-section-title-input"
                                                      ref="$current-resources/*[name() = $section-id]/label"
                                                      appearance="fr:in-place" class="fb-section-title">
                                            <xforms:label>Section</xforms:label>
                                        </xforms:input>

                                        <!-- Respond to fr-delete event to delete the current section -->
                                        <xforms:action ev:event="fr-delete">
                                            <xforms:setvalue ref="$variables/confirmation-message" value="'Are you sure you want to delete the current section?'"/>
                                            <xforms:setvalue ref="$variables/confirmation-target">fb-section-title-input-container</xforms:setvalue>
                                            <xxforms:show dialog="fb-confirmation-dialog"/>
                                        </xforms:action>
                                        <!-- Respond to confirmation -->
                                        <xforms:action ev:event="fb-confirmation-yes">
                                            <!-- Delete holder element for section -->
                                            <xforms:delete nodeset="$form-instance/*[name() = context()/@context]"/>
                                            <!-- Delete resources for section -->
                                            <xforms:delete xxforms:iterate="$resources/resource/*[name() = context()/@context]" nodeset="."/>

                                            <xforms:action xxforms:iterate="*/xhtml:tr/xhtml:td">
                                                <!-- Delete holder element and resources for control -->
                                                <xforms:action if="exists(xforms:*)">
                                                    <xforms:delete nodeset="$form-instance/*[index('fb-top-level-repeat')]/*[name() = context()/xforms:*/@ref]"/>
                                                    <xforms:delete xxforms:iterate="$resources/resource/*[name() = context()/xforms:*/@ref]" nodeset="."/>
                                                </xforms:action>
                                            </xforms:action>

                                            <!-- Delete section including all controls -->
                                            <xforms:delete nodeset="."/>
                                        </xforms:action>

                                    </xforms:group>

                                    <!-- Section content -->
                                    <xforms:repeat nodeset="fr:section | fr:repeat | fr:grid" id="fb-section-content-repeat">

                                        <xhtml:div class="fb-section-content">
                                            <!-- Grid within top-level section -->
                                            <xforms:group ref=".[local-name() = 'grid']">

                                                <xhtml:div class="fb-grid-toolbar fb-toolbar">
                                                    <xforms:trigger appearance="full">
                                                        <xforms:label>
                                                            <xhtml:span>Insert Row</xhtml:span>
                                                        </xforms:label>
                                                        <xforms:action ev:event="DOMActivate">
                                                            <xforms:action context="$current-section-content-block">
                                                                <!-- Pointing to current grid element -->
                                                                <xforms:insert context="." nodeset="xhtml:tr"
                                                                               at="index('fb-section-content-grid-tr-repeat')"
                                                                               origin="instance(concat('fb-grid-', context()/@columns, '-template'))/xhtml:tr"/>

                                                            </xforms:action>
                                                        </xforms:action>
                                                    </xforms:trigger>
                                                    <xforms:trigger appearance="full" ref=".[xs:integer(@columns) lt 4]">
                                                        <xforms:label>
                                                            <xhtml:span>Insert Column</xhtml:span>
                                                        </xforms:label>
                                                        <xforms:action ev:event="DOMActivate">
                                                            <!-- Context is on current grid -->
                                                            <xforms:setvalue ref="@columns" value=". + 1"/>

                                                            <!-- Save column index -->
                                                            <xforms:setvalue ref="$variables/column-number" value="index('fb-section-content-grid-td-repeat')"/>

                                                            <xforms:action xxforms:iterate="xhtml:tr">
                                                                <xforms:insert nodeset="xhtml:td" origin="xxforms:element('xhtml:td')" at="$variables/column-number"/>
                                                            </xforms:action>
                                                        </xforms:action>
                                                    </xforms:trigger>
                                                    <xforms:trigger appearance="full" ref=".[count(xhtml:tr) gt 1]" id="fb-delete-row-trigger">
                                                        <xforms:label>
                                                            <xhtml:span>Delete Row</xhtml:span>
                                                        </xforms:label>
                                                        <xforms:action ev:event="DOMActivate">
                                                            <!-- Ask confirmation -->
                                                            <xforms:setvalue ref="$variables/confirmation-message">Are you sure you want to delete the current row?</xforms:setvalue>
                                                            <xforms:setvalue ref="$variables/confirmation-target">fb-delete-row-trigger</xforms:setvalue>
                                                            <xxforms:show dialog="fb-confirmation-dialog"/>
                                                        </xforms:action>
                                                        <xforms:action ev:event="fb-confirmation-yes">
                                                            <!-- Context is on current grid -->

                                                            <!-- Delete holder elements and resources -->
                                                            <xforms:action xxforms:iterate="xhtml:tr[index('fb-section-content-grid-tr-repeat')]/xhtml:td">
                                                                <xforms:action if="exists(xforms:*)">
                                                                    <xforms:delete nodeset="$form-instance/*[index('fb-top-level-repeat')]/*[name() = context()/xforms:*/@ref]"/>
                                                                    <xforms:delete xxforms:iterate="$resources/resource/*[name() = context()/xforms:*/@ref]" nodeset="."/>
                                                                </xforms:action>
                                                            </xforms:action>

                                                            <!-- Delete whole row including nested controls -->
                                                            <xforms:delete nodeset="xhtml:tr" at="index('fb-section-content-grid-tr-repeat')"/>
                                                        </xforms:action>
                                                    </xforms:trigger>
                                                    <xforms:trigger appearance="full" ref=".[xs:integer(@columns) gt 1]" id="fb-delete-column-trigger">
                                                        <xforms:label>
                                                            <xhtml:span>Delete Column</xhtml:span>
                                                        </xforms:label>
                                                        <xforms:action ev:event="DOMActivate">
                                                            <!-- Ask confirmation -->
                                                            <xforms:setvalue ref="$variables/confirmation-message">Are you sure you want to delete the current column?</xforms:setvalue>
                                                            <xforms:setvalue ref="$variables/confirmation-target">fb-delete-column-trigger</xforms:setvalue>
                                                            <xxforms:show dialog="fb-confirmation-dialog"/>
                                                        </xforms:action>
                                                        <xforms:action ev:event="fb-confirmation-yes">
                                                            <!-- Context is on current grid -->
                                                            <xforms:setvalue ref="@columns" value=". - 1"/>

                                                            <!-- Save column index -->
                                                            <xforms:setvalue ref="$variables/column-number" value="index('fb-section-content-grid-td-repeat')"/>

                                                            <!-- Iterate over rows and in each delete the appropriate column -->
                                                            <xforms:action xxforms:iterate="xhtml:tr">
                                                                <xforms:action context="xhtml:td[xs:integer($variables/column-number)]">
                                                                    <!-- Delete holder element, resources, and control -->
                                                                    <xforms:action if="exists(xforms:*)">
                                                                        <xforms:delete nodeset="$form-instance/*[index('fb-top-level-repeat')]/*[name() = context()/xforms:*/@ref]"/>
                                                                        <xforms:delete xxforms:iterate="$resources/resource/*[name() = context()/xforms:*/@ref]" nodeset="."/>
                                                                    </xforms:action>
                                                                    <xforms:delete nodeset="."/>
                                                                </xforms:action>
                                                            </xforms:action>
                                                        </xforms:action>
                                                    </xforms:trigger>
                                                    <xforms:trigger appearance="full" id="fb-delete-grid-trigger">
                                                        <xforms:label>
                                                            <xhtml:span>Delete Grid</xhtml:span>
                                                        </xforms:label>
                                                        <xforms:action ev:event="DOMActivate">
                                                            <!-- Ask confirmation -->
                                                            <xforms:setvalue ref="$variables/confirmation-message">Are you sure you want to delete the current grid?</xforms:setvalue>
                                                            <xforms:setvalue ref="$variables/confirmation-target">fb-delete-grid-trigger</xforms:setvalue>
                                                            <xxforms:show dialog="fb-confirmation-dialog"/>
                                                        </xforms:action>
                                                        <xforms:action ev:event="fb-confirmation-yes">
                                                            <!-- Context is on current grid -->

                                                            <xforms:action xxforms:iterate="xhtml:tr/xhtml:td">
                                                                <!-- Delete holder element and resources -->
                                                                <xforms:action if="exists(xforms:*)">
                                                                    <xforms:delete nodeset="$form-instance/*[index('fb-top-level-repeat')]/*[name() = context()/xforms:*/@ref]"/>
                                                                    <xforms:delete xxforms:iterate="$resources/resource/*[name() = context()/xforms:*/@ref]" nodeset="."/>
                                                                </xforms:action>
                                                            </xforms:action>

                                                            <!-- Delete whole grid element -->
                                                            <xforms:delete nodeset="."/>
                                                        </xforms:action>
                                                    </xforms:trigger>
                                                </xhtml:div>

                                                <!-- Use AVTs to set the style on the div depending on the number of columns -->
                                                <xhtml:div class="fb-grid fb-grid-{count(xhtml:tr[1]/xhtml:td)}-columns">
                                                    <!-- Grid table -->
                                                    <xhtml:table>
                                                        <xhtml:tbody>
                                                            <!-- Repeat over table rows -->
                                                            <xforms:repeat nodeset="xhtml:tr" id="fb-section-content-grid-tr-repeat" xxforms:dnd="true">
                                                                <xhtml:tr>
                                                                    <!-- Repeat over table columns -->
                                                                    <xforms:repeat nodeset="xhtml:td" id="fb-section-content-grid-td-repeat" xxforms:dnd="true">

                                                                        <xxforms:variable name="control-id" select="substring-before(xforms:*[1]/@id, '-control')"/>
                                                                        <xhtml:td>
                                                                            <xhtml:div class="fb-grid-cell-icons">
                                                                                <!-- TODO: For now put here, but move once dnd is there and clicking on cell is enough -->
                                                                                <xforms:trigger appearance="minimal">
                                                                                    <xforms:label><xhtml:img src="../../../../apps/fr/style/drag_handle.gif" alt="Drag" title="Drag"/></xforms:label>
                                                                                </xforms:trigger>
                                                                                <xforms:group ref=".[xforms:*]">

                                                                                    <xforms:trigger appearance="minimal">
                                                                                        <xforms:label><xhtml:img src="../../../../apps/fr/style/trash.gif" alt="Delete Control" title="Delete Control"/></xforms:label>
                                                                                        <xforms:action ev:event="DOMActivate">
                                                                                            <!-- Delete holder element, resources, and control -->
                                                                                            <xforms:delete nodeset="$form-instance/*[index('fb-top-level-repeat')]/*[name() = $control-id]"/>
                                                                                            <xforms:delete xxforms:iterate="$resources/resource/*[name() = $control-id]" nodeset="."/>
                                                                                            <xforms:delete nodeset="xforms:*"/>
                                                                                        </xforms:action>
                                                                                    </xforms:trigger>
                                                                                </xforms:group>
                                                                            </xhtml:div>
                                                                            <xforms:group ref=".[xforms:*]" class="fb-grid-control-icons">
                                                                                <!-- Edit details for any control -->
                                                                                <xforms:trigger appearance="minimal" id="fb-edit-details-trigger">
                                                                                    <xforms:label><xhtml:img class="fb-control-help" alt="Details" title="" src="../../../../apps/fr/style/edit.gif"/></xforms:label>
                                                                                    <xforms:action ev:event="DOMActivate">
                                                                                        <!-- TODO zzz edit control id -->
                                                                                    </xforms:action>
                                                                                </xforms:trigger>

                                                                                <!-- Edit help for any control -->
                                                                                <xforms:trigger appearance="minimal" id="fb-edit-help-trigger">
                                                                                    <xforms:label><xhtml:img class="fb-control-help" alt="Help" title="" src="../../../../ops/images/xforms/help.gif"/></xforms:label>
                                                                                    <xforms:action ev:event="DOMActivate">
                                                                                        <xforms:setvalue ref="$variables/result-node" value="$current-resources/*[name() = $control-id]/help/saxon:path()"/>
                                                                                        <xxforms:show dialog="fb-edit-help-dialog" neighbor="fb-edit-help-trigger"/>
                                                                                    </xforms:action>
                                                                                </xforms:trigger>

                                                                                <!-- Edit Alert for any control -->
                                                                                <xforms:trigger appearance="minimal" id="fb-edit-alert-trigger">
                                                                                    <xforms:label><xhtml:img class="fb-control-alert" alt="Alert" title="" src="../../../../ops/images/xforms/error.gif"/></xforms:label>
                                                                                    <xforms:action ev:event="DOMActivate">
                                                                                        <xforms:setvalue ref="$variables/result-node" value="$current-resources/*[name() = $control-id]/alert/saxon:path()"/>
                                                                                        <xxforms:show dialog="fb-edit-alert-dialog" neighbor="fb-edit-alert-trigger"/>
                                                                                    </xforms:action>
                                                                                </xforms:trigger>
                                                                            </xforms:group>


                                                                            <xhtml:div class="fb-grid-content">

                                                                                <xforms:group ref=".[xforms:*]">

                                                                                    <xxforms:variable name="instance-holder" select="$section-holder/*[name() = $control-id]"/>

                                                                                    <!-- Set label for any control -->
                                                                                    <xhtml:span>
                                                                                        <xforms:input id="fb-control-label-control"
                                                                                                      ref="$current-resources/*[name() = $control-id]/label"
                                                                                                      appearance="fr:in-place" class="fb-control-label">
                                                                                            <xforms:label class="fb-xforms-disabled"/>
                                                                                        </xforms:input>
                                                                                    </xhtml:span>

                                                                                    <!-- Edit control type -->
                                                                                    <!--zzzz-->
                                                                                    <!--<xhtml:span>-->
                                                                                        <!--<xforms:input id="fb-control-label-control"-->
                                                                                                      <!--ref="$current-resources/*[name() = $control-id]/label"-->
                                                                                                      <!--appearance="fr:in-place" class="fb-control-label">-->
                                                                                            <!--<xforms:label class="fb-xforms-disabled"/>-->
                                                                                        <!--</xforms:input>-->
                                                                                    <!--</xhtml:span>-->

                                                                                    <!-- Display representation of the control -->
                                                                                    <xhtml:div class="fb-control-control">

                                                                                        <xforms:group ref="xforms:input">
                                                                                            <!--instance('fr-form-instance')/xhtml:head/xforms:model/xforms:instance/*/*[xxx section]/*[count(context()/preceding-sibling::*) + 1]-->
                                                                                            <xforms:input ref="$instance-holder">
                                                                                                <xforms:label class="fb-xforms-disabled"/>
                                                                                            </xforms:input>
                                                                                        </xforms:group>
                                                                                        <xforms:group ref="xforms:textarea">
                                                                                            <xforms:textarea ref="$instance-holder">
                                                                                                <xforms:label class="fb-xforms-disabled"/>
                                                                                            </xforms:textarea>
                                                                                        </xforms:group>
                                                                                        <xforms:group ref="xforms:select1[@appearance = 'minimal']">
                                                                                            <xforms:select1 appearance="minimal" ref="$instance-holder">
                                                                                                <xforms:label class="fb-xforms-disabled"/>
                                                                                                <xforms:item>
                                                                                                    <xforms:label>[Choose...]</xforms:label>
                                                                                                    <xforms:value/>
                                                                                                </xforms:item>
                                                                                            </xforms:select1>

                                                                                            <fr:repeat nodeset="xforms:item" id="book-repeat" origin="instance('note-template')" columns="1">
                                                                                                <xhtml:tr>
                                                                                                    <xhtml:td>
                                                                                                        xxxx
                                                                                                    </xhtml:td>
                                                                                                </xhtml:tr>
                                                                                            </fr:repeat>

                                                                                            <!-- TODO: edit items -->

                                                                                            zzz

                                                                                        </xforms:group>
                                                                                        <!-- TODO -->
                                                                                    </xhtml:div>

                                                                                    <!-- Edit hint for any control -->
                                                                                    <xhtml:span>
                                                                                        <xforms:input id="fb-control-hint-control"
                                                                                                      ref="$current-resources/*[name() = $control-id]/hint"
                                                                                                      appearance="fr:in-place" class="fb-control-hint">
                                                                                            <xforms:label class="fb-xforms-disabled"/>
                                                                                        </xforms:input>
                                                                                    </xhtml:span>
                                                                                </xforms:group>

                                                                                <xhtml:span class="fb-control-control">
                                                                                <xforms:group ref=".[@class = ('radio')]/xforms:*">
                                                                                    <xforms:select1 ref="instance('form-instance')/xhtml:head/xforms:model/xforms:instance/instance/*[count(xxforms:repeat-current()/preceding-sibling::*) + 1]"
                                                                                            appearance="full">
                                                                                        <xforms:label ref="xxforms:repeat-current('form-repeat')/xforms:*/xforms:label"/>
                                                                                        <xforms:help ref="xxforms:repeat-current('form-repeat')/xforms:*/xforms:help"/>
                                                                                        <xforms:hint ref="xxforms:repeat-current('form-repeat')/xforms:*/xforms:hint"/>
                                                                                        <xforms:alert ref="xxforms:repeat-current('form-repeat')/xforms:*/xforms:alert"/>
                                                                                        <xforms:itemset nodeset="xxforms:repeat-current('form-repeat')/xforms:*/xforms:item">
                                                                                            <xforms:label ref="xforms:label"/>
                                                                                            <xforms:value ref="xforms:value"/>
                                                                                        </xforms:itemset>
                                                                                    </xforms:select1>
                                                                                </xforms:group>
                                                                                <xforms:group ref=".[@class = 'dropdown']/xforms:*">
                                                                                    <xforms:select1 ref="instance('form-instance')/xhtml:head/xforms:model/xforms:instance/instance/*[count(xxforms:repeat-current()/preceding-sibling::*) + 1]"
                                                                                            appearance="minimal">
                                                                                        <xforms:label ref="xxforms:repeat-current('form-repeat')/xforms:*/xforms:label"/>
                                                                                        <xforms:help ref="xxforms:repeat-current('form-repeat')/xforms:*/xforms:help"/>
                                                                                        <xforms:hint ref="xxforms:repeat-current('form-repeat')/xforms:*/xforms:hint"/>
                                                                                        <xforms:alert ref="xxforms:repeat-current('form-repeat')/xforms:*/xforms:alert"/>
                                                                                        <xforms:itemset nodeset="xxforms:repeat-current('form-repeat')/xforms:*/xforms:item">
                                                                                            <xforms:label ref="xforms:label"/>
                                                                                            <xforms:value ref="xforms:value"/>
                                                                                        </xforms:itemset>
                                                                                    </xforms:select1>
                                                                                </xforms:group>
                                                                                <xforms:group ref=".[@class = ('checkbox')]/xforms:*">
                                                                                    <xforms:select ref="instance('form-instance')/xhtml:head/xforms:model/xforms:instance/instance/*[count(xxforms:repeat-current()/preceding-sibling::*) + 1]"
                                                                                            appearance="full">
                                                                                        <xforms:label ref="xxforms:repeat-current('form-repeat')/xforms:*/xforms:label"/>
                                                                                        <xforms:help ref="xxforms:repeat-current('form-repeat')/xforms:*/xforms:help"/>
                                                                                        <xforms:hint ref="xxforms:repeat-current('form-repeat')/xforms:*/xforms:hint"/>
                                                                                        <xforms:alert ref="xxforms:repeat-current('form-repeat')/xforms:*/xforms:alert"/>
                                                                                        <xforms:itemset nodeset="xxforms:repeat-current('form-repeat')/xforms:*/xforms:item">
                                                                                            <xforms:label ref="xforms:label"/>
                                                                                            <xforms:value ref="xforms:value"/>
                                                                                        </xforms:itemset>
                                                                                    </xforms:select>
                                                                                </xforms:group>
                                                                                <xforms:group ref=".[@class = 'output']/xforms:*">
                                                                                    <xforms:output ref="instance('form-instance')/xhtml:head/xforms:model/xforms:instance/instance/*[count(xxforms:repeat-current()/preceding-sibling::*) + 1]">
                                                                                        <xforms:label ref="xxforms:repeat-current('form-repeat')/xforms:*/xforms:label"/>
                                                                                        <xforms:help ref="xxforms:repeat-current('form-repeat')/xforms:*/xforms:help"/>
                                                                                    </xforms:output>
                                                                                </xforms:group>
                                                                                </xhtml:span>
                                                                            </xhtml:div>
                                                                        </xhtml:td>
                                                                    </xforms:repeat>
                                                                </xhtml:tr>
                                                            </xforms:repeat>
                                                        </xhtml:tbody>
                                                    </xhtml:table>
                                                </xhtml:div>
                                            </xforms:group>
                                            <!-- Repeat within top-level section -->
                                            <xforms:group ref=".[local-name() = 'repeat']">

                                                <!-- TODO: Handle nested repeat -->

                                            </xforms:group>
                                            <!-- Section within top-level section -->
                                            <xforms:group ref=".[local-name() = 'section']">

                                                <!-- TODO: Handle nested section-->

                                            </xforms:group>
                                        </xhtml:div>
                                    </xforms:repeat>

                                </xforms:group>

                                <!-- Top-level grid -->
                                <xforms:group ref=".[local-name() = 'grid']">
                                    <xforms:label ref="."/>

                                    <!-- TODO: Handle top-level grid -->

                                </xforms:group>

                                <!-- Top-level repeat -->
                                <xforms:group ref=".[local-name() = 'repeat']">

                                    <!-- TODO: Handle top-level repeat -->

                                </xforms:group>
                            </xhtml:div>
                        </xforms:repeat>
                    </xhtml:div>
                </fr:section>

                <xhtml:div class="fb-toolbar fb-form-toolbar">
                    <!-- Test form -->
                    <xforms:trigger>
                        <xforms:label>
                            <xhtml:img src="../../../../forms/orbeon/builder/images/play.png" alt="Test Form" title="Test Form"/>
                            <xhtml:span>Test Form</xhtml:span>
                        </xforms:label>
                        <xforms:send ev:event="DOMActivate" submission="fb-test-form-submission"/>
                    </xforms:trigger>

                    <!-- Show XML -->
                    <xforms:trigger>
                        <xforms:label>
                            <xhtml:img src="../../../../apps/fr/style/view-xml.gif" alt="Show XML" title="Show XML"/>
                            <xhtml:span>Show XML</xhtml:span>
                        </xforms:label>
                        <xxforms:show ev:event="DOMActivate" dialog="fb-xml-dialog"/>
                    </xforms:trigger>

                    <!-- Edit Source -->
                    <xforms:trigger>
                        <xforms:label>
                            <xhtml:img src="../../../../apps/fr/style/edit.gif" alt="Edit Source" title="Edit Source"/>
                            <xhtml:span>Edit Source</xhtml:span>
                        </xforms:label>
                        <xxforms:show ev:event="DOMActivate" dialog="fb-edit-source-dialog"/>
                    </xforms:trigger>

                    <!-- Upload XML Schema -->
                    <xforms:trigger>
                        <xforms:label>
                            <xhtml:img src="../../../../forms/orbeon/builder/images/upload.png" alt="Upload XML Schema" title="Upload XML Schema"/>
                            <xhtml:span>XML Schema</xhtml:span>
                        </xforms:label>
                        <!-- TODO -->
                        <!--<xxforms:show ev:event="DOMActivate" dialog="fb-xml-dialog"/>-->
                    </xforms:trigger>

                    <!-- Upload PDF Template -->
                    <xforms:trigger>
                        <xforms:label>
                            <xhtml:img src="../../../../apps/fr/style/pdf.png" alt="Upload PDF" title="Upload PDF"/>
                            <xhtml:span>Upload PDF</xhtml:span>
                        </xforms:label>
                        <!-- TODO -->
                        <!--<xxforms:show ev:event="DOMActivate" dialog="fb-xml-dialog"/>-->
                    </xforms:trigger>
                </xhtml:div>

                <!-- Toolbox -->
                <xxforms:dialog id="fb-toolbox-dialog" level="modeless" draggable="true" visible="true" close="false" class="fb-toolbox-dialog" neighbor="switch-fb-details-section">
                    <xforms:label>Toolbox</xforms:label>
                        <xhtml:div class="fb-toolbox">
                            <!-- Add new section -->
                            <xhtml:div class="fb-tool">
                                <xforms:trigger>
                                    <xforms:label>
                                        <xhtml:img src="../../../../apps/fr/style/plus.png" alt="Open section" title="Open section"/>
                                        <xhtml:span>Section</xhtml:span>
                                    </xforms:label>
                                    <xforms:action ev:event="DOMActivate" context="$body">
                                        <!-- Insert section -->

                                        <!-- Insert section template in the UI -->
                                        <xforms:insert context="." nodeset="fr:section | fr:repeat | fr:grid"
                                                       at="index('fb-top-level-repeat')" position="after"
                                                       origin="instance('fb-section-template')"/>

                                        <!-- Compute next section id -->
                                        <xforms:dispatch target="fr-form-model" name="fb-compute-section-id"/>

                                        <!-- Set xforms:label @ref value -->
                                        <xforms:setvalue ref="*[index('fb-top-level-repeat')]/xforms:label/@ref" value="concat('$form-resources/section-', $next-section-id, '/label')"/>

                                        <!-- Set @id value -->
                                        <xforms:setvalue ref="*[index('fb-top-level-repeat')]/@id" value="concat('section-', $next-section-id, '-section')"/>

                                        <!-- Set @context value -->
                                        <xforms:setvalue ref="*[index('fb-top-level-repeat')]/@context" value="concat('section-', $next-section-id)"/>

                                        <!-- Insert container in the instance -->
                                        <xforms:action context="$form-instance">
                                            <!-- TODO: for now assume a top-level section containing a grid -->
                                            <xforms:insert context="." nodeset="*"
                                                           at="index('fb-top-level-repeat')" position="after"
                                                           origin="xxforms:element(concat('section-', $next-section-id))"/>

                                        </xforms:action>

                                        <!-- Insert resources placeholders for all languages -->
                                        <xforms:action xxforms:iterate="$resources/resource">
                                            <xforms:insert context="." nodeset="*"
                                                           origin="xxforms:element(concat('section-', $next-section-id))"/>

                                            <xforms:insert context="*[last()]" origin="instance('fb-resource-template')/*"/>
                                        </xforms:action>

                                        <!-- Insert a first component into the section -->
                                        <!--<xforms:setindex repeat="fb-controls-template-repeat" index="1"/>-->
                                        <!--<xforms:dispatch name="DOMActivate" target="fb-add-control-trigger"/>-->

                                    </xforms:action>
                                </xforms:trigger>
                            </xhtml:div>
                            <!-- Add grids -->
                            <xforms:group context="$current-top-level-block" appearance="xxforms:internal">
                                <xhtml:div class="fb-tool">
                                    <xforms:trigger appearance="full">
                                        <xforms:label>
                                            <xhtml:img src="../../../../forms/orbeon/builder/images/action1.gif" alt="New 1-Column Grid" title="New 1-Column Grid"/>
                                            <xhtml:span>1-Column Grid</xhtml:span>
                                        </xforms:label>
                                        <xforms:action ev:event="DOMActivate">
                                            <xforms:insert context="." nodeset="fr:section | fr:repeat | fr:grid"
                                                           at="index('fb-section-content-repeat')" position="after"
                                                           origin="instance('fb-grid-1-template')"/>
                                            <!--<xforms:setvalue ref="(fr:section | fr:repeat | fr:grid)[index('fb-section-content-repeat')]/@columns" value="1"/>-->
                                        </xforms:action>
                                    </xforms:trigger>
                                </xhtml:div>
                                <xhtml:div class="fb-tool">
                                    <xforms:trigger appearance="full">
                                        <xforms:label>
                                            <xhtml:img src="../../../../forms/orbeon/builder/images/action2.gif" alt="New 2-Column Grid" title="New 2-Column Grid"/>
                                            <xhtml:span>2-Column Grid</xhtml:span>
                                        </xforms:label>
                                        <xforms:action ev:event="DOMActivate">
                                            <xforms:insert context="." nodeset="fr:section | fr:repeat | fr:grid"
                                                           at="index('fb-section-content-repeat')" position="after"
                                                           origin="instance('fb-grid-2-template')"/>
                                        </xforms:action>
                                    </xforms:trigger>
                                </xhtml:div>
                                <xhtml:div class="fb-tool">
                                    <xforms:trigger appearance="full">
                                        <xforms:label>
                                            <xhtml:img src="../../../../forms/orbeon/builder/images/action3.gif" alt="New 3-Column Grid" title="New 3-Column Grid"/>
                                            <xhtml:span>3-Column Grid</xhtml:span>
                                        </xforms:label>
                                        <xforms:action ev:event="DOMActivate">
                                            <xforms:insert context="." nodeset="fr:section | fr:repeat | fr:grid"
                                                           at="index('fb-section-content-repeat')" position="after"
                                                           origin="instance('fb-grid-3-template')"/>
                                        </xforms:action>
                                    </xforms:trigger>
                                </xhtml:div>
                                <xhtml:div class="fb-tool">
                                    <xforms:trigger appearance="full">
                                        <xforms:label>
                                            <xhtml:img src="../../../../forms/orbeon/builder/images/action3.gif" alt="New 4-Column Grid" title="New 4-Column Grid"/>
                                            <xhtml:span>4-Column Grid</xhtml:span>
                                        </xforms:label>
                                        <xforms:action ev:event="DOMActivate">
                                            <xforms:insert context="." nodeset="fr:section | fr:repeat | fr:grid"
                                                           at="index('fb-section-content-repeat')" position="after"
                                                           origin="instance('fb-grid-4-template')"/>
                                        </xforms:action>
                                    </xforms:trigger>
                                </xhtml:div>
                            </xforms:group>
                        </xhtml:div>
                        <xhtml:div class="fb-toolbox">
                            <xforms:repeat nodeset="instance('fb-controls-template')/template" id="fb-controls-template-repeat">

                                <xxforms:variable name="control-template" select="xhtml:div/xforms:*"/>

                                <xhtml:div class="fb-tool">
                                    <xforms:trigger id="fb-add-control-trigger" xmlns:f="http://orbeon.org/oxf/xml/formatting">
                                        <xforms:label>
                                            <xforms:output value="concat('&lt;img width=''16'' height=''16'' src=''', if (@image) then @image else concat('../../../../forms/orbeon/builder/images/', xhtml:div/@class, '.png'), '''/>')" mediatype="text/html" f:url-norewrite="true"/>
                                            <xforms:output ref="@label"/>
                                        </xforms:label>
                                        <xforms:action ev:event="DOMActivate">
                                            <!-- Insert a new control -->

                                            <!-- TODO: for now assume a top-level section containing one or more grids; later add repeats and top-level grids -->

                                            <!-- Compute next control id -->
                                            <xforms:dispatch target="fr-form-model" name="fb-compute-control-id"/>

                                            <!-- Insert new holder element into the instance -->
                                            <xforms:insert context="$form-instance/*[index('fb-top-level-repeat')]"
                                                           nodeset="*"
                                                           at="index('fb-section-content-grid-tr-repeat') * 1 + index('fb-section-content-grid-td-repeat') - 1"
                                                           origin="xxforms:element(concat('control-', $next-control-id))"/>

                                            <!-- Insert new control into the document -->
                                            <xforms:action context="$current-section-content-block">
                                                <!-- Pointing to current grid element -->

                                                <xforms:action context="xhtml:tr[index('fb-section-content-grid-tr-repeat')]/xhtml:td[index('fb-section-content-grid-td-repeat')]"
                                                               if="exists(xforms:*)">
                                                    <!-- Context is now on td, and it is not empty -->

                                                    <!-- Hack: use the "done" variable to simulate if/else -->
                                                    <xforms:setvalue ref="$variables/done">false</xforms:setvalue>
                                                    <xforms:action if="following-sibling::xhtml:td[1][not(xforms:*)]">
                                                        <!-- Next cell is empty, move to that one -->
                                                        <xforms:setindex repeat="fb-section-content-grid-td-repeat" index="index('fb-section-content-grid-td-repeat') + 1"/>
                                                        <xforms:setvalue ref="$variables/done">true</xforms:setvalue>
                                                    </xforms:action>
                                                    <xforms:action if="$variables/done = 'false' and not(following-sibling::xhtml:td)">
                                                        <!-- We are the last cell of the row -->
                                                        <xforms:action if="exists(../following-sibling::xhtml:tr[1]/xhtml:td[1]/xforms:*) or not(exists(../following-sibling::xhtml:tr[1]))">
                                                            <!-- The first cell of the next row is occupied, or there is no next row: insert new row -->
                                                            <xforms:insert context="self::xhtml:td" nodeset="parent::xhtml:tr"
                                                                           origin="instance(concat('fb-grid-', count(../xhtml:td), '-template'))/xhtml:tr"/>
                                                            <!-- Make sure the first cell is selected -->
                                                            <xforms:setindex repeat="fb-section-content-grid-td-repeat" index="1"/>
                                                            <xforms:setvalue ref="$variables/done">true</xforms:setvalue>
                                                        </xforms:action>
                                                        <xforms:action if="$variables/done = 'false'">
                                                            <!-- There is a next row, and its first cell is empty, move to that one -->
                                                            <xforms:setindex repeat="fb-section-content-grid-tr-repeat" index="index('fb-section-content-grid-tr-repeat') + 1"/>
                                                            <xforms:setindex repeat="fb-section-content-grid-td-repeat" index="1"/>
                                                            <xforms:setvalue ref="$variables/done">true</xforms:setvalue>
                                                        </xforms:action>
                                                    </xforms:action>

                                                </xforms:action>

                                                <!-- This ensures the context is recomputed -->
                                                <xforms:action context="xhtml:tr[index('fb-section-content-grid-tr-repeat')]/xhtml:td[index('fb-section-content-grid-td-repeat')]">
                                                    <!-- Context is now on td -->

                                                    <!-- Insert control into td -->
                                                    <xforms:insert context="." origin="$control-template"/>

                                                    <xforms:action context="xforms:*">
                                                        <!-- Set @id value -->
                                                        <xforms:setvalue ref="@id" value="concat('control-', $next-control-id, '-control')"/>

                                                        <!-- Set @ref value -->
                                                        <xforms:setvalue ref="@ref" value="concat('control-', $next-control-id)"/>

                                                        <!-- Set xforms:label, xforms:hint, xforms:help and xforms:alert @ref -->
                                                        <xforms:setvalue ref="xforms:label/@ref" value="concat('$form-resources/control-', $next-control-id, '/label')"/>
                                                        <xforms:setvalue ref="xforms:hint/@ref" value="concat('$form-resources/control-', $next-control-id, '/hint')"/>
                                                        <xforms:setvalue ref="xforms:help/@ref" value="concat('$form-resources/control-', $next-control-id, '/help')"/>
                                                        <xforms:setvalue ref="xforms:alert/@ref" value="concat('$form-resources/control-', $next-control-id, '/alert')"/>
                                                    </xforms:action>
                                                </xforms:action>

                                            </xforms:action>

                                            <!-- Insert resources placeholders for all languages -->
                                            <xforms:action xxforms:iterate="$resources/resource">
                                                <xforms:insert context="." nodeset="*"
                                                               origin="xxforms:element(concat('control-', $next-control-id))"/>

                                                <xforms:insert context="*[last()]" origin="instance('fb-resource-template')/*"/>
                                            </xforms:action>

                                        </xforms:action>
                                    </xforms:trigger>
                                </xhtml:div>
                            </xforms:repeat>
                        <xhtml:div class="fb-clear"/>
                    </xhtml:div>
                </xxforms:dialog>

                <!-- Edit help -->
                <xxforms:dialog id="fb-edit-help-dialog" appearance="minimal">
                    <xforms:label>Edit Help</xforms:label>
                    <xhtml:div>
                        <xforms:group class="fb-hide-alert">
                            <xforms:textarea ref="$variables/new-text">
                                <xforms:label>Help Message:</xforms:label>
                            </xforms:textarea>
                            <xhtml:div>
                                <xforms:trigger class="fr-inplace-rename">
                                    <xforms:label>Change</xforms:label>
                                    <xforms:setvalue ev:event="DOMActivate" ref="$form-instance/root()/saxon:evaluate($variables/result-node)" value="$variables/new-text"/>
                                </xforms:trigger>
                                or
                                <xforms:trigger appearance="minimal" class="fr-inplace-cancel">
                                    <xforms:label>Cancel</xforms:label>
                                </xforms:trigger>
                            </xhtml:div>
                        </xforms:group>
                        <!-- Hide dialog -->
                        <xxforms:hide ev:event="DOMActivate" dialog="fb-edit-help-dialog"/>
                    </xhtml:div>
                    <!-- Copy help value when the dialog opens -->
                    <xforms:setvalue ev:event="xxforms-dialog-open" ref="$variables/new-text" value="$form-instance/root()/saxon:evaluate($variables/result-node)"/>
                </xxforms:dialog>

                <!-- Edit alert -->
                <xxforms:dialog id="fb-edit-alert-dialog" appearance="minimal">
                    <xforms:label>Edit Alert</xforms:label>
                    <xhtml:div>
                        <xforms:group class="fb-hide-alert">
                            <xforms:textarea ref="$variables/new-text">
                                <xforms:label>Alert Message:</xforms:label>
                            </xforms:textarea>
                            <xhtml:div>
                                <xforms:trigger class="fr-inplace-rename">
                                    <xforms:label>Change</xforms:label>
                                    <xforms:setvalue ev:event="DOMActivate" ref="$form-instance/root()/saxon:evaluate($variables/result-node)" value="$variables/new-text"/>
                                </xforms:trigger>
                                or
                                <xforms:trigger appearance="minimal" class="fr-inplace-cancel">
                                    <xforms:label>Cancel</xforms:label>
                                </xforms:trigger>
                            </xhtml:div>
                        </xforms:group>
                        <!-- Hide dialog -->
                        <xxforms:hide ev:event="DOMActivate" dialog="fb-edit-alert-dialog"/>
                    </xhtml:div>
                    <!-- Copy help value when the dialog opens -->
                    <xforms:setvalue ev:event="xxforms-dialog-open" ref="$variables/new-text" value="$form-instance/root()/saxon:evaluate($variables/result-node)"/>
                </xxforms:dialog>

                <!-- Dialog to show the XML -->
                <xxforms:dialog id="fb-xml-dialog" level="modeless" close="true" draggable="true">
                    <xforms:label>View XML</xforms:label>
                    <xhtml:div class="fb-xml-dialog-view">
                        <xforms:output mediatype="text/html" value="$variables/xml-view"/>
                    </xhtml:div>
                    <xhtml:div class="dialog-button">
                        <xforms:trigger>
                            <xforms:label><xhtml:img src="/apps/fr/style/close.gif" alt=""/> <xhtml:span>Close</xhtml:span></xforms:label>
                        </xforms:trigger>
                    </xhtml:div>
                    <!-- Hide dialog -->
                    <xxforms:hide ev:event="DOMActivate" dialog="fb-xml-dialog"/>
                    <!-- Serialize XML when the dialog opens-->
                    <xforms:setvalue ev:event="xxforms-dialog-open" ref="$variables/xml-view"
                                     value="xxforms:serialize(xxforms:call-xpl(
                                         'oxf:/ops/utils/formatting/format.xpl', 'data', instance('fr-form-instance'), 'data')/*, 'html')"/>
                    <!-- Clear XML when the dialog closes-->
                    <xforms:setvalue ev:event="xxforms-dialog-close" ref="$variables/xml-view"/>
                </xxforms:dialog>

                <!-- Dialog to edit the source -->
                <xxforms:dialog id="fb-edit-source-dialog" level="modeless" close="true" draggable="true">
                    <xforms:label>Edit source</xforms:label>
                    <xhtml:div class="fb-xml-dialog-view">
                        <xforms:textarea ref="$variables/new-source"/>
                    </xhtml:div>
                    <xhtml:div class="dialog-button">
                        <xhtml:span class="fr-inplace-buttons">
                            <xforms:trigger class="fr-inplace-rename" ref="$variables/new-source-trigger">
                                <xforms:label>Save</xforms:label>
                                <!-- TODO: At the very least, should make sure the XML is well-formed. Even better would be to validate it. -->
                                <xforms:action ev:event="DOMActivate">

                                    <!-- Parse the XML and insert it -->

                                    <!-- TODO: extra line breaks are added as you edit and save the XML -->
                                    <xforms:message level="xxforms:log-debug">
                                        <xforms:output value="replace($variables/new-source, '&#x0d;', '&#x0d;xxx')"/>
                                    </xforms:message>

                                    <xforms:insert nodeset="instance('fr-form-instance')" origin="saxon:parse($variables/new-source)"/>
                                    <!-- Saxon serialization adds an extra meta element -->
                                    <xforms:delete nodeset="instance('fr-form-instance')/xhtml:head/meta[@http-equiv = 'Content-Type']"/>

                                </xforms:action>
                            </xforms:trigger>
                            or
                            <xforms:trigger appearance="minimal" class="fr-inplace-cancel">
                                <xforms:label>Cancel</xforms:label>
                            </xforms:trigger>
                        </xhtml:span>
                    </xhtml:div>
                    <!-- Hide dialog -->
                    <xxforms:hide ev:event="DOMActivate" dialog="fb-edit-source-dialog"/>
                    <!-- Serialize XML when the dialog opens -->
                    <xforms:setvalue ev:event="xxforms-dialog-open" ref="$variables/new-source"
                                     value="saxon:serialize(instance('fr-form-instance'), xxforms:instance('fb-xsl-output-instance'))"/>
                </xxforms:dialog>

                <!-- Add language dialog -->
                <xxforms:dialog id="fb-add-language-dialog" appearance="minimal">
                    <xforms:label>Add Language</xforms:label>
                    <xhtml:div>
                        <xforms:group>
                            <xforms:group class="fb-hide-alert">
                                <xforms:select1 ref="$variables/new-language" xxforms:refresh-items="false">
                                    <xforms:label>Add the following language:</xforms:label>
                                    <xforms:item>
                                        <xforms:label>[Select...]</xforms:label>
                                        <xforms:value/>
                                    </xforms:item>
                                    <xforms:itemset model="fr-resources-model"
                                                    nodeset="instance('fr-languages-instance')/language[not(@exclude = 'true') and not(@code = $lang)]">
                                        <xforms:label value="if (@native-name != @english-name) then concat(@native-name, ' (', @english-name, ')') else @native-name"/>
                                        <xforms:value ref="@code"/>
                                    </xforms:itemset>
                                </xforms:select1>
                            </xforms:group>
                            <xhtml:span class="fr-inplace-buttons">
                                <xforms:trigger class="fr-inplace-rename" ref="$variables/new-language-trigger">
                                    <xforms:label>Add</xforms:label>
                                    <xforms:action ev:event="DOMActivate">
                                        <xforms:insert context="$resources" nodeset="resource" origin="resource[1]"/>
                                        <xforms:setvalue ref="$resources/resource[last()]/@xml:lang" value="$variables/new-language"/>
                                        <xforms:setvalue ref="$lang" value="$variables/new-language"/>
                                    </xforms:action>
                                </xforms:trigger>
                                or
                                <xforms:trigger appearance="minimal" class="fr-inplace-cancel">
                                    <xforms:label>Cancel</xforms:label>
                                </xforms:trigger>
                            </xhtml:span>
                        </xforms:group>
                    </xhtml:div>
                    <!-- Hide dialog -->
                    <xxforms:hide ev:event="DOMActivate" dialog="fb-add-language-dialog"/>
                    <!-- Clear selection list when the dialog opens -->
                    <xforms:setvalue ev:event="xxforms-dialog-open" ref="$variables/new-language"/>
                </xxforms:dialog>

                <!-- Generic confirmation dialog -->
                <xxforms:dialog id="fb-confirmation-dialog" level="modal" close="false" draggable="true">
                    <xforms:label>Confirm</xforms:label>
                    <xhtml:div>
                        <xhtml:img src="/apps/fr/style/question-large.gif" alt="Question" class="dialog-icon"/>
                        <xhtml:div class="dialog-message">
                            <xforms:output value="$variables/confirmation-message"/>
                        </xhtml:div>
                    </xhtml:div>
                    <xhtml:div class="dialog-button">
                        <xforms:group>
                            <xforms:trigger>
                                <xforms:label><xhtml:img src="/apps/fr/style/clear.gif" alt=""/> <xhtml:span>Delete</xhtml:span></xforms:label>
                                <xforms:dispatch ev:event="DOMActivate" name="fb-confirmation-yes" target="{$variables/confirmation-target}"/>
                            </xforms:trigger>
                            <xforms:trigger id="fb-confirmation-dialog-cancel-trigger">
                                <xforms:label><xhtml:img src="/apps/fr/style/close.gif" alt=""/> <xhtml:span>Cancel</xhtml:span></xforms:label>
                                <xforms:dispatch ev:event="DOMActivate" name="fb-confirmation-no" target="{$variables/confirmation-target}"/>
                            </xforms:trigger>
                        </xforms:group>
                    </xhtml:div>
                    <!-- Hide dialog -->
                    <xxforms:hide ev:event="DOMActivate" dialog="fb-confirmation-dialog"/>
                    <!-- Set focus when the dialog open  -->
                    <xforms:setfocus ev:event="xxforms-dialog-open" control="fb-confirmation-dialog-cancel-trigger"/>
                </xxforms:dialog>

            </fr:body>
        </fr:view>

        <!--<widget:xforms-instance-inspector xmlns:widget="http://orbeon.org/oxf/xml/widget"/>-->
    </xhtml:body>
</xhtml:html>
