<?xml version="1.0" encoding="UTF-8"?>
<!--
    Copyright (C) 2008 Orbeon, Inc.

    This program is free software; you can redistribute it and/or modify it under the terms of the
    GNU Lesser General Public License as published by the Free Software Foundation; either version
    2.1 of the License, or (at your option) any later version.

    This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
    without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
    See the GNU Lesser General Public License for more details.

    The full text of the license is available at http://www.gnu.org/copyleft/lesser.html
-->
<xhtml:html xmlns:xhtml="http://www.w3.org/1999/xhtml"
      xmlns:xforms="http://www.w3.org/2002/xforms"
      xmlns:xs="http://www.w3.org/2001/XMLSchema"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xmlns:ev="http://www.w3.org/2001/xml-events"
      xmlns:xi="http://www.w3.org/2001/XInclude"
      xmlns:xxi="http://orbeon.org/oxf/xml/xinclude"
      xmlns:xxforms="http://orbeon.org/oxf/xml/xforms"
      xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
      xmlns:fb="http://orbeon.org/oxf/xml/form-builder"
      xmlns:saxon="http://saxon.sf.net/">
    <xhtml:head>
        <xhtml:title>Orbeon Form Builder</xhtml:title>
        <!-- CSS -->
        <xhtml:link rel="stylesheet" href="/ops/css/yui/reset-fonts-grids.css" type="text/css"/>
        <xhtml:link rel="stylesheet" href="/ops/css/yui/base-min.css" type="text/css"/>
        <xhtml:link rel="stylesheet" href="/apps/fr/style/form-runner.css" type="text/css"/>
        <xhtml:link rel="stylesheet" href="/forms/orbeon/builder/form-builder.css" type="text/css"/>

        <!-- Include main model -->
        <xi:include href="oxf:/forms/orbeon/builder/form/model.xml" xxi:omit-xml-base="true"/>
    </xhtml:head>
    <xhtml:body>

        <fr:view>
            <xforms:label>Orbeon Form Builder</xforms:label>
            <fr:body>

                <!-- In-place view deselected, remember id -->
                <xforms:action ev:event="xforms-deselect" if="for $target in event('xxforms:target') return starts-with($target, 'fr-inplace-') and ends-with($target, '-view')">

                    <!-- Hide currently visible in-place edit if any -->
                    <xforms:toggle if="$variables/inplace-id != ''" case="{$variables/inplace-id}" xxforms:repeat-indexes="{$variables/inplace-repeat-indexes}"/>

                    <!-- Remember new id and indexes -->
                    <xforms:setvalue ref="$variables/inplace-id" value="event('xxforms:target')"/>
                    <xforms:setvalue ref="$variables/inplace-repeat-indexes" value="string-join(event('xxforms:repeat-indexes'), ' ')"/>
                </xforms:action>

                <!-- In-place edit deselected, forget id -->
                <xforms:action ev:event="xforms-deselect" if="for $target in event('xxforms:target') return starts-with($target, 'fr-inplace-') and ends-with($target, '-edit')">
                    <xforms:setvalue ref="$variables/inplace-id"/>
                    <xforms:setvalue ref="$variables/inplace-repeat-indexes"/>
                </xforms:action>

                <xforms:group ref=".[instance('fb-user-agent-instance')/is-ie = 'true']">
                    <xforms:switch>
                        <xforms:case id="fb-ie-warning-case-on">
                            <xhtml:div class="fb-ie-warning">
                                Orbeon Form Builder still needs work to provide a satisfactory experience with Internet Explorer.
                                Please bear with us while we fix this. In the meanwhile, we recommend you use <a
                                href="http://www.mozilla.com/firefox/">Firefox</a>, <a
                                href="http://www.apple.com/safari/">Safari</a>, or <a href="http://www.opera.com/">Opera</a>.
                                <xforms:trigger appearance="minimal">
                                    <xforms:label>[close]</xforms:label>
                                    <xforms:toggle ev:event="DOMActivate" case="fb-ie-warning-case-off"/>
                                </xforms:trigger>
                            </xhtml:div>
                        </xforms:case>
                        <xforms:case id="fb-ie-warning-case-off"/>
                    </xforms:switch>
                </xforms:group>

                <!--

                    Here is how a page is organized:

                    doc     := block*
                    block   := grid | repeat | section
                    section := block*
                    repeat  := tabularRepeat | gridRepeat | blockRepeat


                    NOTE: section and repeat can have some properties, such as a label.  

                -->

                <!-- Section about form metadata -->
                <fr:section id="fb-metadata-section" class="fb-metadata-section">
                    <xforms:label>About this Form</xforms:label>

                    <fr:grid columns="2">
                        <xhtml:tr>
                            <xhtml:td>
                                <xforms:input id="application-name-control" bind="application-name-bind" appearance="fr:in-place" class="fr-summary fr-search" incremental="true">
                                    <xforms:label ref="$form-resources/application-name/label"/>
                                    <xforms:hint ref="$form-resources/application-name/hint"/>
                                    <xforms:alert ref="$form-resources/application-name/alert"/>
                                </xforms:input>
                            </xhtml:td>
                            <xhtml:td>
                                <xforms:input id="form-name-control" bind="form-name-bind" appearance="fr:in-place" class="fr-summary fr-search" incremental="true">
                                    <xforms:label ref="$form-resources/form-name/label"/>
                                    <xforms:hint ref="$form-resources/form-name/hint"/>
                                    <xforms:alert ref="$form-resources/form-name/alert"/>
                                </xforms:input>
                            </xhtml:td>
                        </xhtml:tr>
                        <xhtml:tr>
                            <xhtml:td>
                                <!-- Image -->
                                <xforms:group>
                                    <xforms:label>Logo</xforms:label>
                                    <xforms:group ref="$metadata-instance/logo[normalize-space() != '']">
                                        <xforms:output ref="." mediatype="image/*">
                                            <xforms:label class="fb-xforms-disabled"/>
                                        </xforms:output>
                                    </xforms:group>
                                    <!-- File chooser -->
                                    <xforms:upload id="logo-control" bind="logo-bind" class="fr-attachment">
                                        <xforms:label class="fb-xforms-disabled"/>
                                        <xforms:filename ref="@filename"/>
                                        <xforms:mediatype ref="@mediatype"/>
                                        <xxforms:size ref="@size"/>
                                    </xforms:upload>
                                </xforms:group>
                            </xhtml:td>
                            <xhtml:td>
                                <xforms:input id="title-control" bind="title-bind"
                                              appearance="fr:in-place" class="fr-summary fr-search" incremental="true">
                                    <xforms:label ref="$form-resources/title/label"/>
                                    <xforms:hint ref="$form-resources/title/hint"/>
                                    <xforms:alert ref="$form-resources/title/alert"/>
                                </xforms:input>
                            </xhtml:td>
                        </xhtml:tr>
                        <xhtml:tr>
                            <xhtml:td colspan="2">
                                <xhtml:div>
                                    <xforms:textarea id="description-control" bind="description-bind"
                                                     appearance="fr:in-place" class="fr-summary fr-search" incremental="true">
                                        <xforms:label ref="$form-resources/description/label"/>
                                        <xforms:hint ref="$form-resources/description/hint"/>
                                    </xforms:textarea>
                                </xhtml:div>
                            </xhtml:td>
                        </xhtml:tr>
                    </fr:grid>
                </fr:section>

                <!-- Form details -->
                <fr:section id="fb-details-section" context="$body">
                    <xforms:label>Form Details</xforms:label>

                    <xhtml:div>

                        <!-- Handle top-level blocks -->
                        <xforms:repeat nodeset="fr:section | fr:repeat | fr:grid" id="fb-top-level-repeat" xxforms:dnd="vertical">

                            <xxforms:variable name="top-level-position" select="position()"/>
                            <xxforms:variable name="is-top-level-current" select="$top-level-position = index('fb-top-level-repeat')"/>

                            <xhtml:div class="fb-top-level-content">
                                <!-- Top-level section -->
                                <xforms:group ref=".[local-name() = 'section']">

                                    <!-- Section name -->
                                    <xxforms:variable name="section-name" select="@context"/>
                                    <!-- Holder element for the section -->
                                    <xxforms:variable name="section-holder" select="$form-instance/*[name() = $section-name]"/>

                                    <!--<xhtml:img src="/apps/fr/style/minus.png" alt="Close section" title="Close section"/>-->

                                    <!-- Editable section title -->
                                    <xforms:group appearance="xxforms:internal" id="fb-section-title-input-container">
                                        <xforms:input id="fb-section-title-input"
                                                      ref="$current-resources/*[name() = $section-name]/label"
                                                      appearance="fr:in-place" class="fb-section-title">
                                            <xforms:label>Section</xforms:label>
                                            <xforms:hint>Enter a section name</xforms:hint>
                                        </xforms:input>

                                        <!-- Respond to fr-delete event to delete the current section -->
                                        <xforms:action ev:event="fr-delete">
                                            <xforms:setvalue ref="$variables/confirmation-message"
                                                             value="concat('Are you sure you want to delete the current section? ',
                                                                    count(context()/*/xhtml:tr/xhtml:td[xforms:*]),
                                                                    ' controls will be deleted.')"/>

                                            <xforms:setvalue ref="$variables/confirmation-target">fb-section-title-input-container</xforms:setvalue>
                                            <xxforms:show dialog="fb-confirmation-dialog"/>
                                        </xforms:action>
                                        <!-- Respond to confirmation -->
                                        <xforms:action ev:event="fb-confirmation-yes">
                                            <!-- Delete holder element for section -->
                                            <xforms:delete nodeset="$form-instance/*[name() = context()/@context]"/>
                                            <!-- Delete resources for section -->
                                            <xforms:delete xxforms:iterate="$resources/resource/*[name() = context()/@context]" nodeset="."/>

                                            <xforms:action xxforms:iterate="*/xhtml:tr/xhtml:td">
                                                <!-- Delete holder element and resources for control -->
                                                <xforms:action if="exists(xforms:*)">
                                                    <xforms:delete nodeset="$form-instance/*[index('fb-top-level-repeat')]/*[name() = context()/xforms:*/@ref]"/>
                                                    <xforms:delete xxforms:iterate="$resources/resource/*[name() = context()/xforms:*/@ref]" nodeset="."/>
                                                </xforms:action>
                                            </xforms:action>

                                            <!-- Delete section including all controls -->
                                            <xforms:delete nodeset="."/>
                                        </xforms:action>

                                    </xforms:group>

                                    <!-- Section content -->
                                    <xforms:repeat nodeset="fr:section | fr:repeat | fr:grid" id="fb-section-content-repeat">
                                        <xxforms:variable name="section-content-position" select="position()"/>
                                        <xxforms:variable name="is-section-content-current"
                                                          select="$is-top-level-current and $section-content-position = index('fb-section-content-repeat')"/>

                                        <xhtml:div class="fb-section-content">
                                            <!-- Grid within top-level section -->
                                            <xforms:group ref=".[local-name() = 'grid']">
                                                <xxforms:variable name="grid" select="."/>

                                                <!-- Use AVTs to set the style on the div depending on the number of columns -->
                                                <xhtml:div class="fb-grid fb-grid-{count(xhtml:tr[1]/xhtml:td)}-columns">
                                                    <!-- Grid table -->
                                                    <xhtml:table class="fb-grid-table">
                                                        <xhtml:tbody>
                                                            <xhtml:tr>
                                                                <!-- Top left corner td -->
                                                                <xhtml:td class="fb-grid-top-left-td">
                                                                    <xforms:trigger appearance="minimal" id="fb-delete-grid-trigger">
                                                                        <xforms:label>
                                                                            <xforms:label><xhtml:img src="/apps/fr/style/images/silk/bin_closed.png" alt="Delete Grid" title="Delete Grid"/></xforms:label>
                                                                        </xforms:label>
                                                                        <xforms:action ev:event="DOMActivate">
                                                                            <!-- Ask confirmation -->
                                                                            <xforms:setvalue ref="$variables/confirmation-message"
                                                                                             value="concat('Are you sure you want to delete the current grid? ',
                                                                                                    count($grid/xhtml:tr/xhtml:td[xforms:*]),
                                                                                                    ' controls will be deleted.')"/>
                                                                            <xforms:setvalue ref="$variables/confirmation-target">fb-delete-grid-trigger</xforms:setvalue>
                                                                            <xxforms:show dialog="fb-confirmation-dialog"/>
                                                                        </xforms:action>
                                                                        <xforms:action ev:event="fb-confirmation-yes">
                                                                            <!-- Context is on current grid -->

                                                                            <xforms:action xxforms:iterate="$grid/xhtml:tr/xhtml:td">
                                                                                <!-- Delete control -->
                                                                                <xforms:dispatch if="exists(xforms:*)" name="fb-delete-control" target="fr-form-model">
                                                                                    <xxforms:context name="control" select="xforms:*"/>
                                                                                </xforms:dispatch>
                                                                            </xforms:action>

                                                                            <!-- Delete whole grid element -->
                                                                            <xforms:delete nodeset="."/>
                                                                        </xforms:action>
                                                                    </xforms:trigger>
                                                                </xhtml:td>
                                                                <!-- Column icons -->
                                                                <xforms:repeat nodeset="xhtml:tr[1]/xhtml:td" id="fb-section-content-grid-top-repeat">
                                                                    <xxforms:variable name="column-number" select="position()"/>
                                                                    <xhtml:td class="fb-grid-column-toolbar-td">
                                                                        <!-- Insert column to the left -->
                                                                        <xhtml:div class="fb-insert-left">
                                                                            <xforms:trigger appearance="minimal" ref=".[xs:integer($grid/@columns) lt 4]" id="fb-insert-column-left-trigger">
                                                                                <xforms:label><xhtml:img src="/apps/fr/style/previous.gif" alt="Insert Column to the Left" title="Insert Column to the Left"/></xforms:label>
                                                                                <xforms:action ev:event="DOMActivate">
                                                                                    <!-- Increment number of columns -->
                                                                                    <xforms:setvalue ref="$grid/@columns" value=". + 1"/>

                                                                                    <!-- Prepare span grid -->
                                                                                    <xforms:dispatch name="fb-prepare-span-grid" target="fr-form-model">
                                                                                        <xxforms:context name="grid" select="$grid"/>
                                                                                    </xforms:dispatch>

                                                                                    <!-- Figure out what tds are affected -->
                                                                                    <xxforms:variable name="insert-tds"
                                                                                                      select="for $c in for $r in instance('fb-span-grid-instance')/r
                                                                                                                          return $r/c[$column-number][. != 'x']
                                                                                                                return $grid/xhtml:tr[count($c/../preceding-sibling::r) + 1]/xhtml:td[count($c/preceding-sibling::c[. != 'x']) + 1]"/>

                                                                                    <xforms:action xxforms:iterate="$insert-tds">
                                                                                        <xforms:insert nodeset="." origin="xxforms:element('xhtml:td', context()/@rowspan)" position="before"/>
                                                                                    </xforms:action>
                                                                                </xforms:action>
                                                                            </xforms:trigger>
                                                                        </xhtml:div>
                                                                        <!-- Insert column to the right -->
                                                                        <xhtml:div class="fb-insert-right">
                                                                            <xforms:trigger appearance="minimal" ref=".[xs:integer($grid/@columns) lt 4]" id="fb-insert-column-right-trigger">
                                                                                <xforms:label><xhtml:img src="/apps/fr/style/next.gif" alt="Insert Column to the Right" title="Insert Column to the Right"/></xforms:label>
                                                                                <xforms:action context="$grid" ev:event="DOMActivate">
                                                                                    <!-- Increment number of columns -->
                                                                                    <xforms:setvalue ref="$grid/@columns" value=". + 1"/>

                                                                                    <!-- Prepare span grid -->
                                                                                    <xforms:dispatch name="fb-prepare-span-grid" target="fr-form-model">
                                                                                        <xxforms:context name="grid" select="$grid"/>
                                                                                    </xforms:dispatch>

                                                                                    <!-- Figure out what tds are affected -->
                                                                                    <xxforms:variable name="insert-tds"
                                                                                                      select="for $c in for $r in instance('fb-span-grid-instance')/r
                                                                                                                          return $r/c[$column-number][. != 'x']
                                                                                                                return $grid/xhtml:tr[count($c/../preceding-sibling::r) + 1]/xhtml:td[count($c/preceding-sibling::c[. != 'x']) + 1]"/>

                                                                                    <xforms:action xxforms:iterate="$insert-tds">
                                                                                        <xforms:insert nodeset="." origin="xxforms:element('xhtml:td', context()/@rowspan)" position="after"/>
                                                                                    </xforms:action>
                                                                                </xforms:action>
                                                                            </xforms:trigger>
                                                                        </xhtml:div>
                                                                        <!-- Delete column -->
                                                                        <xforms:trigger appearance="minimal" ref=".[xs:integer($grid/@columns) gt 1]" id="fb-delete-column-trigger">
                                                                            <xforms:label><xhtml:img src="/apps/fr/style/images/silk/bin_closed.png" alt="Delete Column" title="Delete Column"/></xforms:label>
                                                                            <xforms:action ev:event="DOMActivate">

                                                                                <!-- Prepare span grid -->
                                                                                <xforms:dispatch name="fb-prepare-span-grid" target="fr-form-model">
                                                                                    <xxforms:context name="grid" select="$grid"/>
                                                                                </xforms:dispatch>

                                                                                <xxforms:variable name="delete-tds"
                                                                                                  select="for $c in for $r in instance('fb-span-grid-instance')/r
                                                                                                                      return $r/c[$column-number][. != 'x']
                                                                                                            return $grid/xhtml:tr[count($c/../preceding-sibling::r) + 1]/xhtml:td[count($c/preceding-sibling::c[. != 'x']) + 1]"/>

                                                                                <xxforms:variable name="count" select="count($delete-tds[xforms:*])"/>

                                                                                <xforms:action if="$count > 0">
                                                                                    <!-- Ask confirmation -->
                                                                                    <xforms:setvalue ref="$variables/confirmation-message"
                                                                                                     value="concat('Are you sure you want to delete the current column? ',
                                                                                                            $count,
                                                                                                            ' controls will be deleted.')"/>
                                                                                    <xforms:setvalue ref="$variables/confirmation-target">fb-delete-column-trigger</xforms:setvalue>
                                                                                    <xxforms:show dialog="fb-confirmation-dialog"/>
                                                                                </xforms:action>
                                                                                <xforms:action if="$count = 0">
                                                                                    <!-- We are automatically confirmed-->
                                                                                    <xforms:dispatch name="fb-confirmation-yes" target="fb-delete-column-trigger"/>
                                                                                </xforms:action>
                                                                            </xforms:action>
                                                                            <xforms:action ev:event="fb-confirmation-yes">
                                                                                <xforms:setvalue ref="$grid/@columns" value=". - 1"/>

                                                                                <xxforms:variable name="delete-tds"
                                                                                                  select="for $c in for $r in instance('fb-span-grid-instance')/r
                                                                                                                      return $r/c[$column-number][. != 'x']
                                                                                                            return $grid/xhtml:tr[count($c/../preceding-sibling::r) + 1]/xhtml:td[count($c/preceding-sibling::c[. != 'x']) + 1]"/>

                                                                                <!-- Iterate over rows and in each delete the appropriate column -->
                                                                                <xforms:action xxforms:iterate="$delete-tds">
                                                                                    <!-- Delete control -->
                                                                                    <xforms:dispatch if="exists(xforms:*)" name="fb-delete-control" target="fr-form-model">
                                                                                        <xxforms:context name="control" select="xforms:*"/>
                                                                                    </xforms:dispatch>
                                                                                    <xforms:delete nodeset="."/>
                                                                                </xforms:action>
                                                                            </xforms:action>
                                                                        </xforms:trigger>
                                                                    </xhtml:td>
                                                                </xforms:repeat>
                                                            </xhtml:tr>
                                                        </xhtml:tbody>
                                                        <xhtml:tbody>
                                                            <!-- Repeat over table rows -->
                                                            <xforms:repeat nodeset="xhtml:tr" id="fb-section-content-grid-tr-repeat" xxforms:dnd="true">
                                                                <xxforms:variable name="tr" select="."/>
                                                                <xxforms:variable name="tr-position" select="position()"/>
                                                                <xhtml:tr class="fb-grid-tr">
                                                                    <xhtml:td>
                                                                        <xhtml:div class="fb-grid-row-icons">
                                                                            <!-- Insert row above -->
                                                                            <xhtml:div>
                                                                                <xforms:trigger appearance="minimal" id="fb-insert-row-above-trigger">
                                                                                    <xforms:label><xhtml:img src="/apps/fr/style/up.gif" alt="Insert Row Above" title="Insert Row Above"/></xforms:label>
                                                                                    <xforms:action context="$grid" ev:event="DOMActivate">
                                                                                        <xforms:action ev:event="DOMActivate">

                                                                                            <!-- Prepare span grid -->
                                                                                            <xforms:dispatch name="fb-prepare-span-grid" target="fr-form-model">
                                                                                                <xxforms:context name="grid" select="$grid"/>
                                                                                            </xforms:dispatch>

                                                                                            <!-- Adjust rowspans -->
                                                                                            <xforms:action xxforms:iterate="instance('fb-span-grid-instance')/r[$tr-position]/c[. = 'x']">
                                                                                                <!-- This current cell in the row to delete is impacted by a rowspan -->
                                                                                                <xxforms:variable name="x" select="count(preceding-sibling::c) + 1"/>

                                                                                                <!-- Find td which contains the rowspan -->
                                                                                                <xxforms:variable name="c" select="(../preceding-sibling::r/c[$x][. != 'x'])[last()]"/>
                                                                                                <xxforms:variable name="y" select="count($c/../preceding-sibling::r) + 1"/>
                                                                                                <xxforms:variable name="rowspan-td-x" select="count($c/preceding-sibling::c[. != 'x']) + 1"/>
                                                                                                <xxforms:variable name="rowspan-td" select="$grid/xhtml:tr[$y]/xhtml:td[$rowspan-td-x]"/>

                                                                                                <!-- Increment rowspan value -->
                                                                                                <xxforms:variable name="current-rowspan" select="if ($rowspan-td/@rowspan) then xs:integer($rowspan-td/@rowspan) else 1"/>
                                                                                                <xforms:insert context="$rowspan-td" origin="xxforms:attribute('rowspan', xs:string($current-rowspan + 1))"/>

                                                                                            </xforms:action>

                                                                                            <!-- Number of tds that must be in the new row -->
                                                                                            <xxforms:variable name="new-td-count" select="count(instance('fb-span-grid-instance')/r[$tr-position]/c[. != 'x'])"/>
                                                                                            <!-- Insert new row -->
                                                                                            <xforms:insert context="$grid" nodeset="xhtml:tr"
                                                                                                           at="$tr-position" position="before"
                                                                                                           origin="xxforms:element('xhtml:tr', for $td in (1 to $new-td-count) return xxforms:element('xhtml:td'))"/>
                                                                                        </xforms:action>
                                                                                    </xforms:action>
                                                                                </xforms:trigger>
                                                                            </xhtml:div>
                                                                            <!-- Delete row -->
                                                                            <xforms:trigger appearance="minimal" ref=".[count($grid/xhtml:tr) gt 1]" id="fb-delete-row-trigger">
                                                                                <xforms:label><xhtml:img src="/apps/fr/style/images/silk/bin_closed.png" alt="Delete Row" title="Delete Row"/></xforms:label>
                                                                                <xforms:action ev:event="DOMActivate">

                                                                                    <xxforms:variable name="count" select="count($tr/xhtml:td[xforms:*])"/>

                                                                                    <xforms:action if="$count > 0">
                                                                                        <!-- Ask confirmation -->
                                                                                        <xforms:setvalue ref="$variables/confirmation-message"
                                                                                                         value="concat('Are you sure you want to delete the current row? ',
                                                                                                                $count, ' controls will be deleted.')"/>
                                                                                        <xforms:setvalue ref="$variables/confirmation-target">fb-delete-row-trigger</xforms:setvalue>
                                                                                        <xxforms:show dialog="fb-confirmation-dialog"/>
                                                                                    </xforms:action>
                                                                                    <xforms:action if="$count = 0">
                                                                                        <!-- We are automatically confirmed -->
                                                                                        <xforms:dispatch name="fb-confirmation-yes" target="fb-delete-row-trigger"/>
                                                                                    </xforms:action>
                                                                                </xforms:action>
                                                                                <xforms:action ev:event="fb-confirmation-yes">
                                                                                    <!-- Context is on current grid -->

                                                                                    <!-- Prepare span grid -->
                                                                                    <xforms:dispatch name="fb-prepare-span-grid" target="fr-form-model">
                                                                                        <xxforms:context name="grid" select="$grid"/>
                                                                                    </xforms:dispatch>

                                                                                    <!-- Adjust rowspans -->
                                                                                    <xforms:action xxforms:iterate="instance('fb-span-grid-instance')/r[$tr-position]/c[. = 'x']">
                                                                                        <!-- This current cell in the row to delete is impacted by a rowspan -->
                                                                                        <xxforms:variable name="x" select="count(preceding-sibling::c) + 1"/>

                                                                                        <!-- Find td which contains the rowspan -->
                                                                                        <xxforms:variable name="c" select="(../preceding-sibling::r/c[$x][. != 'x'])[last()]"/>
                                                                                        <xxforms:variable name="y" select="count($c/../preceding-sibling::r) + 1"/>
                                                                                        <xxforms:variable name="rowspan-td-x" select="count($c/preceding-sibling::c[. != 'x']) + 1"/>
                                                                                        <xxforms:variable name="rowspan-td" select="$grid/xhtml:tr[$y]/xhtml:td[$rowspan-td-x]"/>

                                                                                        <!-- Decrement rowspan value -->
                                                                                        <xforms:setvalue ref="$rowspan-td/@rowspan" value=". - 1"/>

                                                                                    </xforms:action>

                                                                                    <!-- Delete holder elements and resources -->
                                                                                    <xforms:action xxforms:iterate="$tr/xhtml:td">
                                                                                        <!-- Delete control -->
                                                                                        <xforms:dispatch if="exists(xforms:*)" name="fb-delete-control" target="fr-form-model">
                                                                                            <xxforms:context name="control" select="xforms:*"/>
                                                                                        </xforms:dispatch>
                                                                                    </xforms:action>

                                                                                    <!-- Delete whole row including nested controls -->
                                                                                    <xforms:delete nodeset="$grid/xhtml:tr" at="$tr-position"/>
                                                                                </xforms:action>
                                                                            </xforms:trigger>
                                                                            <!-- Insert row below -->
                                                                            <xhtml:div>
                                                                                <xforms:trigger appearance="minimal" id="fb-insert-row-below-trigger">
                                                                                    <xforms:label><xhtml:img src="/apps/fr/style/down.gif" alt="Insert Row Below" title="Insert Row Below"/></xforms:label>
                                                                                    <xforms:action ev:event="DOMActivate">
                                                                                        <xforms:action ev:event="DOMActivate">

                                                                                            <!-- Prepare span grid -->
                                                                                            <xforms:dispatch name="fb-prepare-span-grid" target="fr-form-model">
                                                                                                <xxforms:context name="grid" select="$grid"/>
                                                                                            </xforms:dispatch>

                                                                                            <!-- Adjust rowspans -->
                                                                                            <xforms:action xxforms:iterate="instance('fb-span-grid-instance')/r[$tr-position + 1]/c[. = 'x']">
                                                                                                <!-- This current cell in the row to delete is impacted by a rowspan -->
                                                                                                <xxforms:variable name="x" select="count(preceding-sibling::c) + 1"/>

                                                                                                <!-- Find td which contains the rowspan -->
                                                                                                <xxforms:variable name="c" select="(../preceding-sibling::r/c[$x][. != 'x'])[last()]"/>
                                                                                                <xxforms:variable name="y" select="count($c/../preceding-sibling::r) + 1"/>
                                                                                                <xxforms:variable name="rowspan-td-x" select="count($c/preceding-sibling::c[. != 'x']) + 1"/>
                                                                                                <xxforms:variable name="rowspan-td" select="$grid/xhtml:tr[$y]/xhtml:td[$rowspan-td-x]"/>

                                                                                                <!-- Increment rowspan value -->
                                                                                                <xxforms:variable name="current-rowspan" select="if ($rowspan-td/@rowspan) then xs:integer($rowspan-td/@rowspan) else 1"/>
                                                                                                <xforms:insert context="$rowspan-td" origin="xxforms:attribute('rowspan', xs:string($current-rowspan + 1))"/>

                                                                                            </xforms:action>

                                                                                            <!-- Number of tds that must be in the new row -->
                                                                                            <xxforms:variable name="new-td-count"
                                                                                                              select="if ($tr/following-sibling::xhtml:tr)
                                                                                                                      then count(instance('fb-span-grid-instance')/r[$tr-position + 1]/c[. != 'x'])
                                                                                                                      else xs:integer($grid/@columns)"/>

                                                                                            <!-- Insert new row -->
                                                                                            <xforms:insert context="$grid" nodeset="xhtml:tr"
                                                                                                           at="$tr-position" position="after"
                                                                                                           origin="xxforms:element('xhtml:tr', for $td in (1 to $new-td-count) return xxforms:element('xhtml:td'))"/>
                                                                                        </xforms:action>
                                                                                    </xforms:action>
                                                                                </xforms:trigger>
                                                                            </xhtml:div>
                                                                        </xhtml:div>
                                                                    </xhtml:td>
                                                                    <!-- Repeat over table columns -->
                                                                    <xforms:repeat nodeset="xhtml:td" id="fb-section-content-grid-td-repeat" xxforms:dnd="true">

                                                                        <xxforms:variable name="td" select="."/>
                                                                        <xxforms:variable name="td-position" select="position()"/>

                                                                        <xxforms:variable name="control" select="xforms:*[1]"/>
                                                                        <xxforms:variable name="control-name" select="substring-before($control/@id, '-control')"/>
                                                                        <xxforms:variable name="instance-holder" select="$section-holder/*[name() = $control-name]"/>
                                                                        <xxforms:variable name="resource-holder" select="$current-resources/*[name() = $control-name]"/>

                                                                        <!-- The rowspan below has an IE HACK as IE messesup rowspan with invisible <tr> elements -->
                                                                        <xhtml:td class="fb-grid-td" rowspan="{if (@rowspan) then if (instance('fb-user-agent-instance')/is-ie = 'true') then @rowspan * 2 - 1 else @rowspan else 1}">
                                                                            <xhtml:div class="fb-grid-cell-icons">
                                                                                <!-- TODO: For now put here, but move once dnd is there and clicking on cell is enough -->
                                                                                <!-- Drag -->
                                                                                <xforms:trigger appearance="minimal">
                                                                                    <xforms:label><xhtml:img src="/apps/fr/style/drag_handle.gif" alt="Drag" title="Drag"/></xforms:label>
                                                                                </xforms:trigger>
                                                                                <!-- Expand cell down -->
                                                                                <xforms:group ref=".[exists($td/../following-sibling::xhtml:tr[xs:integer(if ($td/@rowspan) then $td/@rowspan else 1)])]">
                                                                                    <xforms:trigger appearance="minimal" id="fb-expand-cell-down-trigger">
                                                                                        <xforms:label><xhtml:img src="/apps/fr/style/images/silk/arrow_down.png" alt="Expand" title="Expand"/></xforms:label>
                                                                                        <xforms:action ev:event="DOMActivate">

                                                                                            <!-- Prepare span grid -->
                                                                                            <xforms:dispatch name="fb-prepare-span-grid" target="fr-form-model">
                                                                                                <xxforms:context name="grid" select="$grid"/>
                                                                                            </xforms:dispatch>

                                                                                            <!-- Value of rowspan on td to expand -->
                                                                                            <xxforms:variable name="current-rowspan" select="if ($td/@rowspan) then xs:integer($td/@rowspan) else 1"/>
                                                                                            <!-- Column number of the td to expand -->
                                                                                            <xxforms:variable name="x" select="count((instance('fb-span-grid-instance')/r[$tr-position]/c[. != 'x'])[$td-position]/preceding-sibling::c) + 1"/>
                                                                                            <!-- Position of the td to delete -->
                                                                                            <xxforms:variable name="delete-td-position" select="count(instance('fb-span-grid-instance')/r[$tr-position + $current-rowspan]/c[$x]/preceding-sibling::c[. != 'x']) + 1"/>
                                                                                            <!-- td to delete -->
                                                                                            <xxforms:variable name="delete-td" select="$td/../following-sibling::xhtml:tr[$current-rowspan]/xhtml:td[$delete-td-position]"/>

                                                                                            <xforms:action if="exists($delete-td/xforms:*)">
                                                                                                <!-- Ask confirmation -->
                                                                                                <xforms:setvalue ref="$variables/confirmation-message"
                                                                                                                 value="concat('Are you sure you want to expand the current cell? ',
                                                                                                                        'One control will be deleted.')"/>
                                                                                                <xforms:setvalue ref="$variables/confirmation-target">fb-expand-cell-down-trigger</xforms:setvalue>
                                                                                                <xxforms:show dialog="fb-confirmation-dialog"/>
                                                                                            </xforms:action>
                                                                                            <xforms:action if="not(exists($delete-td/xforms:*))">
                                                                                                <!-- We are automatically confirmed as there is no control to delete -->
                                                                                                <xforms:dispatch name="fb-confirmation-yes" target="fb-expand-cell-down-trigger"/>
                                                                                            </xforms:action>
                                                                                        </xforms:action>
                                                                                        <xforms:action ev:event="fb-confirmation-yes">

                                                                                            <!-- TODO: The following lines are duplicated from above. Should pass reference to delete-td instead. -->
                                                                                            <xxforms:variable name="current-rowspan" select="if ($td/@rowspan) then xs:integer($td/@rowspan) else 1"/>
                                                                                            <xxforms:variable name="x" select="count((instance('fb-span-grid-instance')/r[$tr-position]/c[. != 'x'])[$td-position]/preceding-sibling::c) + 1"/>
                                                                                            <xxforms:variable name="delete-td-position" select="count(instance('fb-span-grid-instance')/r[$tr-position + $current-rowspan]/c[$x]/preceding-sibling::c[. != 'x']) + 1"/>
                                                                                            <xxforms:variable name="delete-td" select="$td/../following-sibling::xhtml:tr[$current-rowspan]/xhtml:td[$delete-td-position]"/>

                                                                                            <!-- rowspan delta -->
                                                                                            <xxforms:variable name="rowspan-delta" select="if ($delete-td/@rowspan) then xs:integer($delete-td/@rowspan) else 1"/>

                                                                                            <!-- Increase rowspan on current xhtml:td -->
                                                                                            <xforms:insert context="$td" origin="xxforms:attribute('rowspan', xs:string($current-rowspan + $rowspan-delta))"/>
                                                                                            <!-- Delete holder element, resources, and control in td to delete -->
                                                                                            <xforms:dispatch if="exists($delete-td/xforms:*)" name="fb-delete-control" target="fr-form-model">
                                                                                                <xxforms:context name="control" select="$delete-td/xforms:*"/>
                                                                                            </xforms:dispatch>
                                                                                            <!-- Delete xhtml:td -->
                                                                                            <xforms:delete nodeset="$delete-td"/>
                                                                                        </xforms:action>
                                                                                    </xforms:trigger>
                                                                                </xforms:group>
                                                                                <!-- Shrink -->
                                                                                <xforms:group ref=".[$td/@rowspan and $td/@rowspan > 1]">
                                                                                    <xforms:trigger appearance="minimal" id="fb-shrink-cell-down-trigger">
                                                                                        <xforms:label><xhtml:img src="/apps/fr/style/images/silk/arrow_up.png" alt="Shrink" title="Shrink"/></xforms:label>
                                                                                        <xforms:action ev:event="DOMActivate">

                                                                       pub                     <!-- Prepare span grid -->
                                                                                            <xforms:dispatch name="fb-prepare-span-grid" target="fr-form-model">
                                                                                                <xxforms:context name="grid" select="$grid"/>
                                                                                            </xforms:dispatch>

                                                                                            <!-- Decrease rowspan on current xhtml:td -->
                                                                                            <xxforms:variable name="current-rowspan" select="xs:integer($td/@rowspan)"/>
                                                                                            <xforms:setvalue ref="$td/@rowspan" value="$current-rowspan - 1"/>

                                                                                            <!-- Insert xhtml:td in the right place -->
                                                                                            <xxforms:variable name="x" select="count((instance('fb-span-grid-instance')/r[$tr-position]/c[. != 'x'])[$td-position]/preceding-sibling::c) + 1"/>
                                                                                            <xxforms:variable name="insert-td-position" select="count(instance('fb-span-grid-instance')/r[$tr-position + $current-rowspan - 1]/c[$x]/preceding-sibling::c[. != 'x'])"/>
                                                                                            <xforms:insert if="$insert-td-position > 0" context="$grid/xhtml:tr[$tr-position + $current-rowspan - 1]" nodeset="xhtml:td" at="$insert-td-position" origin="xxforms:element('xhtml:td')"/>
                                                                                            <xforms:insert if="$insert-td-position = 0" context="$grid/xhtml:tr[$tr-position + $current-rowspan - 1]" origin="xxforms:element('xhtml:td')"/>

                                                                                        </xforms:action>
                                                                                    </xforms:trigger>
                                                                                </xforms:group>
                                                                                <!-- Delete control -->
                                                                                <xforms:group ref=".[$control]">
                                                                                    <xforms:trigger appearance="minimal">
                                                                                        <xforms:label><xhtml:img src="/apps/fr/style/images/silk/bin_closed.png" alt="Delete Control" title="Delete Control"/></xforms:label>
                                                                                        <xforms:action ev:event="DOMActivate">
                                                                                            <!-- Delete control -->
                                                                                            <xforms:dispatch name="fb-delete-control" target="fr-form-model">
                                                                                                <xxforms:context name="control" select="$control"/>
                                                                                            </xforms:dispatch>
                                                                                        </xforms:action>
                                                                                    </xforms:trigger>
                                                                                </xforms:group>
                                                                            </xhtml:div>

                                                                            <xforms:group ref=".[$control]" class="fb-grid-control-icons">
                                                                                <!-- Edit details for any control -->
                                                                                <xforms:trigger appearance="minimal" id="fb-edit-details-trigger">
                                                                                    <xforms:label><xhtml:img class="fb-control-help" alt="Details" title="" src="/apps/fr/style/images/silk/cog.png"/></xforms:label>
                                                                                    <xforms:action ev:event="DOMActivate" context="instance('fb-details-editor-instance')">
                                                                                        <xxforms:show dialog="fb-edit-details-dialog" neighbor="fb-edit-details-trigger">
                                                                                            <xxforms:context name="control" select="$control"/>
                                                                                            <xxforms:context name="control-name" select="$control-name"/>
                                                                                            <xxforms:context name="instance-holder" select="$instance-holder"/>
                                                                                        </xxforms:show>
                                                                                    </xforms:action>
                                                                                </xforms:trigger>

                                                                                <!-- Edit help for any control -->
                                                                                <xforms:trigger appearance="minimal" id="fb-edit-help-trigger">
                                                                                    <xforms:label><xhtml:img class="fb-control-help" alt="Help" title="" src="/ops/images/xforms/help.png"/></xforms:label>
                                                                                    <xforms:action ev:event="DOMActivate">
                                                                                        <xforms:setvalue ref="$variables/result-node" value="$resource-holder/help/saxon:path()"/>
                                                                                        <xxforms:show dialog="fb-edit-help-dialog" neighbor="fb-edit-help-trigger"/>
                                                                                    </xforms:action>
                                                                                </xforms:trigger>

                                                                                <!-- Edit validation for any control -->
                                                                                <xforms:trigger appearance="minimal" id="fb-edit-alert-trigger">
                                                                                    <xforms:label><xhtml:img class="fb-control-alert" alt="Alert" title="" src="/apps/fr/style/images/silk/exclamation.png"/></xforms:label>
                                                                                    <xforms:action ev:event="DOMActivate">
                                                                                        <xforms:setvalue ref="$current-control-name" value="$control-name"/>
                                                                                        <xxforms:show dialog="fb-edit-validation-dialog" neighbor="fb-edit-alert-trigger"/>
                                                                                    </xforms:action>
                                                                                </xforms:trigger>

                                                                                <!-- Change appearance for selection controls -->
                                                                                <xforms:group ref=".[xforms:select1 | xforms:select]">
                                                                                    <xforms:trigger appearance="minimal">
                                                                                        <xforms:label>
                                                                                            <xhtml:img src="/apps/fr/style/update.gif" alt="Switch Appearance" title="Switch Appearance"/>
                                                                                        </xforms:label>
                                                                                        <xforms:action ev:event="DOMActivate">

                                                                                            <!-- select1 minimal -> compact -> full -> select compact -> full -->

                                                                                            <xforms:setvalue ref="$variables/done">false</xforms:setvalue>
                                                                                            <xforms:action if="xforms:select1 and xforms:select1/@appearance = 'full'">
                                                                                                <!-- Switch to xforms:select -->

                                                                                                <!-- Create xforms:select, copy all attributes and children elements, and delete xforms:select1 -->
                                                                                                <xforms:insert nodeset="xforms:select1" origin="xxforms:element('xforms:select')"/>
                                                                                                <xforms:insert context="xforms:select" origin="../xforms:select1/(@*, *)"/>
                                                                                                <xforms:delete nodeset="xforms:select1"/>
                                                                                                <xforms:setvalue ref="xforms:select/@appearance" value="'compact'"/>

                                                                                                <xforms:setvalue ref="$variables/done">true</xforms:setvalue>
                                                                                            </xforms:action>
                                                                                            <xforms:action if="$variables/done != 'true' and xforms:select and xforms:select/@appearance = 'full'">
                                                                                                <!-- Switch to xforms:select1 -->

                                                                                                <!-- Create xforms:select1, copy all attributes and children elements, and delete xforms:select -->
                                                                                                <xforms:insert nodeset="xforms:select" origin="xxforms:element('xforms:select1')"/>
                                                                                                <xforms:insert context="xforms:select1" origin="../xforms:select/(@*, *)"/>
                                                                                                <xforms:delete nodeset="xforms:select"/>
                                                                                                <xforms:setvalue ref="xforms:select1/@appearance" value="'minimal'"/>

                                                                                                <xforms:setvalue ref="$variables/done">true</xforms:setvalue>
                                                                                            </xforms:action>
                                                                                            <xforms:action if="$variables/done != 'true' and xforms:select1">
                                                                                                <!-- Simply update the appearance of xforms:select1 -->
                                                                                                <xforms:setvalue ref="xforms:select1/@appearance"
                                                                                                                 value="if (. = 'minimal') then 'compact' else if (. = 'compact') then 'full' else ."/>
                                                                                            </xforms:action>
                                                                                            <xforms:action if="$variables/done != 'true' and xforms:select">
                                                                                                <!-- Simply update the appearance of xforms:select -->
                                                                                                <xforms:setvalue ref="xforms:select/@appearance"
                                                                                                                 value="if (. = 'compact') then 'full' else ."/>
                                                                                            </xforms:action>

                                                                                        </xforms:action>
                                                                                    </xforms:trigger>
                                                                                </xforms:group>
                                                                            </xforms:group>


                                                                            <xhtml:div class="fb-grid-content">

                                                                                <xforms:group ref=".[$control]">

                                                                                    <!-- Set label for any control -->
                                                                                    <xhtml:span>
                                                                                        <xforms:input id="fb-control-label-control" ref="$resource-holder/label"
                                                                                                      appearance="fr:in-place" class="fb-control-label"
                                                                                                      navindex="1000">
                                                                                            <!-- TODO: navindex is just for testing -->
                                                                                            <xforms:label class="fb-xforms-disabled"/>
                                                                                            <xforms:hint>Enter a label</xforms:hint>
                                                                                        </xforms:input>
                                                                                    </xhtml:span>

                                                                                    <!-- Display representation of the control -->
                                                                                    <xhtml:div class="fb-control-control">

                                                                                        <xforms:group ref="xforms:input">
                                                                                            <xforms:input ref="$instance-holder">
                                                                                                <xforms:label class="fb-xforms-disabled"/>
                                                                                                <!--<xforms:hint value="$control-name"/>-->
                                                                                            </xforms:input>
                                                                                        </xforms:group>
                                                                                        <xforms:group ref="xforms:textarea">
                                                                                            <xforms:textarea ref="$instance-holder">
                                                                                                <xforms:label class="fb-xforms-disabled"/>
                                                                                            </xforms:textarea>
                                                                                        </xforms:group>
                                                                                        <xforms:group ref="xforms:select1[@appearance = 'minimal']">
                                                                                            <xforms:select1 appearance="minimal" ref="$instance-holder" id="fb-edit-select1-minimal-control">
                                                                                                <xforms:label class="fb-xforms-disabled"/>
                                                                                                <xforms:item>
                                                                                                    <xforms:label>[Choose...]</xforms:label>
                                                                                                    <xforms:value/>
                                                                                                </xforms:item>
                                                                                                <xforms:itemset nodeset="$resource-holder/item">
                                                                                                    <xforms:label ref="label"/>
                                                                                                    <xforms:value ref="value"/>
                                                                                                </xforms:itemset>
                                                                                            </xforms:select1>
                                                                                            <xforms:trigger appearance="minimal">
                                                                                                <xforms:label>Edit Items</xforms:label>
                                                                                                <xforms:action ev:event="DOMActivate">
                                                                                                    <xforms:setvalue ref="$variables/itemset-resource-id" value="name($resource-holder)"/>
                                                                                                    <xxforms:show dialog="fb-itemset-editor-dialog" neighbor="fb-edit-select1-minimal-control"/>
                                                                                                </xforms:action>
                                                                                            </xforms:trigger>
                                                                                        </xforms:group>
                                                                                        <xforms:group ref="xforms:select1[@appearance = 'full']">
                                                                                            <xforms:select1 appearance="full" ref="$instance-holder" id="fb-edit-select1-full-control">
                                                                                                <xforms:label class="fb-xforms-disabled"/>
                                                                                                <xforms:itemset nodeset="$resource-holder/item">
                                                                                                    <xforms:label ref="label"/>
                                                                                                    <xforms:value ref="value"/>
                                                                                                </xforms:itemset>
                                                                                            </xforms:select1>
                                                                                            <xforms:trigger appearance="minimal">
                                                                                                <xforms:label>Edit Items</xforms:label>
                                                                                                <xforms:action ev:event="DOMActivate">
                                                                                                    <xforms:setvalue ref="$variables/itemset-resource-id" value="name($resource-holder)"/>
                                                                                                    <xxforms:show dialog="fb-itemset-editor-dialog" neighbor="fb-edit-select1-full-control"/>
                                                                                                </xforms:action>
                                                                                            </xforms:trigger>
                                                                                        </xforms:group>
                                                                                        <xforms:group ref="xforms:select1[@appearance = 'compact']">
                                                                                            <xforms:select1 appearance="compact" ref="$instance-holder" id="fb-edit-select1-compact-control">
                                                                                                <xforms:label class="fb-xforms-disabled"/>
                                                                                                <xforms:itemset nodeset="$resource-holder/item">
                                                                                                    <xforms:label ref="label"/>
                                                                                                    <xforms:value ref="value"/>
                                                                                                </xforms:itemset>
                                                                                            </xforms:select1>
                                                                                            <xforms:trigger appearance="minimal">
                                                                                                <xforms:label>Edit Items</xforms:label>
                                                                                                <xforms:action ev:event="DOMActivate">
                                                                                                    <xforms:setvalue ref="$variables/itemset-resource-id" value="name($resource-holder)"/>
                                                                                                    <xxforms:show dialog="fb-itemset-editor-dialog" neighbor="fb-edit-select1-compact-control"/>
                                                                                                </xforms:action>
                                                                                            </xforms:trigger>
                                                                                        </xforms:group>
                                                                                        <xforms:group ref="xforms:select[@appearance = 'full']">
                                                                                            <xforms:select appearance="full" ref="$instance-holder" id="fb-edit-select-full-control">
                                                                                                <xforms:label class="fb-xforms-disabled"/>
                                                                                                <xforms:itemset nodeset="$resource-holder/item">
                                                                                                    <xforms:label ref="label"/>
                                                                                                    <xforms:value ref="value"/>
                                                                                                </xforms:itemset>
                                                                                            </xforms:select>
                                                                                            <xforms:trigger appearance="minimal">
                                                                                                <xforms:label>Edit Items</xforms:label>
                                                                                                <xforms:action ev:event="DOMActivate">
                                                                                                    <xforms:setvalue ref="$variables/itemset-resource-id" value="name($resource-holder)"/>
                                                                                                    <xxforms:show dialog="fb-itemset-editor-dialog" neighbor="fb-edit-select-full-control"/>
                                                                                                </xforms:action>
                                                                                            </xforms:trigger>
                                                                                        </xforms:group>
                                                                                        <xforms:group ref="xforms:select[@appearance = 'compact']">
                                                                                            <xforms:select appearance="compact" ref="$instance-holder" id="fb-edit-select-compact-control">
                                                                                                <xforms:label class="fb-xforms-disabled"/>
                                                                                                <xforms:itemset nodeset="$resource-holder/item">
                                                                                                    <xforms:label ref="label"/>
                                                                                                    <xforms:value ref="value"/>
                                                                                                </xforms:itemset>
                                                                                            </xforms:select>
                                                                                            <xforms:trigger appearance="minimal">
                                                                                                <xforms:label>Edit Items</xforms:label>
                                                                                                <xforms:action ev:event="DOMActivate">
                                                                                                    <xforms:setvalue ref="$variables/itemset-resource-id" value="name($resource-holder)"/>
                                                                                                    <xxforms:show dialog="fb-itemset-editor-dialog" neighbor="fb-edit-select-compact-control"/>
                                                                                                </xforms:action>
                                                                                            </xforms:trigger>
                                                                                        </xforms:group>
                                                                                        <xforms:group ref="xforms:output[not(@mediatype)]">
                                                                                            <xforms:output ref="$instance-holder" id="fb-edit-output-control">
                                                                                                <xforms:label class="fb-xforms-disabled"/>
                                                                                            </xforms:output>
                                                                                            <xforms:trigger appearance="minimal">
                                                                                                <xforms:label>Edit Items</xforms:label>
                                                                                                <xforms:action ev:event="DOMActivate">
                                                                                                    <!--<xforms:setvalue ref="$variables/itemset-resource-id" value="name($resource-holder)"/>-->
                                                                                                    <!--<xxforms:show dialog="fb-itemset-editor-dialog" neighbor="fb-edit-select1-minimal-control"/>-->
                                                                                                </xforms:action>
                                                                                            </xforms:trigger>
                                                                                        </xforms:group>
                                                                                        <xforms:group ref="xforms:trigger">
                                                                                            <xforms:trigger ref="$instance-holder" id="fb-edit-trigger-control">
                                                                                                <!-- Trigger shows its label -->
                                                                                                <xforms:label ref="$resource-holder/label"/>
                                                                                            </xforms:trigger>
                                                                                        </xforms:group>
                                                                                        <xforms:group ref="xforms:output[@mediatype = 'image/*']">
                                                                                            <!-- Image -->
                                                                                            <xforms:group ref="$instance-holder[normalize-space() != '']">
                                                                                                <xforms:output ref="." mediatype="image/*" id="fb-edit-output-image-control">
                                                                                                    <xforms:label class="fb-xforms-disabled"/>
                                                                                                </xforms:output>
                                                                                            </xforms:group>
                                                                                            <!-- File chooser -->
                                                                                            <!--<xhtml:img width="16" height="16" src="/forms/orbeon/builder/images/image.png"/>-->
                                                                                            <xforms:upload ref="$instance-holder">
                                                                                                <xforms:label class="fb-xforms-disabled"/>
                                                                                                <xforms:filename ref="@filename"/>
                                                                                                <xforms:mediatype ref="@mediatype"/>
                                                                                                <xxforms:size ref="@size"/>
                                                                                            </xforms:upload>
                                                                                        </xforms:group>
                                                                                        <xforms:group ref="xforms:upload">
                                                                                            <xforms:upload ref="$instance-holder" id="fb-edit-upload-control">
                                                                                                <xforms:label class="fb-xforms-disabled"/>
                                                                                                <xforms:filename ref="@filename"/>
                                                                                                <xforms:mediatype ref="@mediatype"/>
                                                                                                <xxforms:size ref="@size"/>
                                                                                            </xforms:upload>
                                                                                        </xforms:group>
                                                                                    </xhtml:div>

                                                                                    <!-- Edit hint for any control -->
                                                                                    <xhtml:span>
                                                                                        <xforms:input id="fb-control-hint-control" ref="$resource-holder/hint"
                                                                                                      appearance="fr:in-place" class="fb-control-hint"
                                                                                                      navindex="1000">
                                                                                            <!-- TODO: navindex is just for testing -->
                                                                                            <xforms:label class="fb-xforms-disabled"/>
                                                                                            <xforms:hint>Enter an optional hint</xforms:hint>
                                                                                        </xforms:input>
                                                                                    </xhtml:span>
                                                                                </xforms:group>
                                                                            </xhtml:div>
                                                                        </xhtml:td>
                                                                    </xforms:repeat>
                                                                </xhtml:tr>
                                                            </xforms:repeat>
                                                            <!-- IE hack so that the bottom border shows up -->
                                                            <xhtml:tr>
                                                                <xhtml:td colspan="4"/>
                                                            </xhtml:tr>
                                                        </xhtml:tbody>
                                                    </xhtml:table>
                                                </xhtml:div>
                                            </xforms:group>
                                            <!-- Repeat within top-level section -->
                                            <xforms:group ref=".[local-name() = 'repeat']">

                                                <!-- TODO: Handle nested repeat -->

                                            </xforms:group>
                                            <!-- Section within top-level section -->
                                            <xforms:group ref=".[local-name() = 'section']">

                                                <!-- TODO: Handle nested section-->

                                            </xforms:group>
                                        </xhtml:div>
                                    </xforms:repeat>

                                </xforms:group>

                                <!-- Top-level grid -->
                                <xforms:group ref=".[local-name() = 'grid']">
                                    <xforms:label ref="."/>

                                    <!-- TODO: Handle top-level grid -->

                                </xforms:group>

                                <!-- Top-level repeat -->
                                <xforms:group ref=".[local-name() = 'repeat']">

                                    <!-- TODO: Handle top-level repeat -->

                                </xforms:group>
                            </xhtml:div>
                        </xforms:repeat>
                    </xhtml:div>
                </fr:section>

                <!-- Dialog to view the source -->
                <xi:include href="oxf:/forms/orbeon/builder/form/dialog-view-source.xml" xxi:omit-xml-base="true"/>

                <!-- Dialog to edit the source -->
                <xi:include href="oxf:/forms/orbeon/builder/form/dialog-edit-source.xml" xxi:omit-xml-base="true"/>

                <!-- Add language dialog -->
                <xi:include href="oxf:/forms/orbeon/builder/form/dialog-language.xml" xxi:omit-xml-base="true"/>

                <!-- CSS upload dialog -->
                <xi:include href="oxf:/forms/orbeon/builder/form/dialog-css.xml" xxi:omit-xml-base="true"/>

                <!-- PDF upload dialog -->
                <xi:include href="oxf:/forms/orbeon/builder/form/dialog-pdf.xml" xxi:omit-xml-base="true"/>

                <!-- Help dialog -->
                <xi:include href="oxf:/forms/orbeon/builder/form/dialog-help.xml" xxi:omit-xml-base="true"/>

                <!-- Publish dialog -->
                <xi:include href="oxf:/forms/orbeon/builder/form/dialog-publish.xml" xxi:omit-xml-base="true"/>

                <!-- Toolbox dialog -->
                <xi:include href="oxf:/forms/orbeon/builder/form/dialog-toolbox.xml" xxi:omit-xml-base="true"/>

                <!-- Dialog to edit itemsets -->
                <xi:include href="oxf:/forms/orbeon/builder/form/dialog-itemsets.xml" xxi:omit-xml-base="true"/>

                <!-- Edit details -->
                <xi:include href="oxf:/forms/orbeon/builder/form/dialog-details.xml" xxi:omit-xml-base="true"/>

                <!-- Validation dialog -->
                <xi:include href="oxf:/forms/orbeon/builder/form/dialog-validation.xml" xxi:omit-xml-base="true"/>

                <!-- Schema upload -->
                <xi:include href="oxf:/forms/orbeon/builder/form/dialog-schema.xml" xxi:omit-xml-base="true"/>

                <!-- Submission editor -->
                <xi:include href="oxf:/forms/orbeon/builder/form/dialog-submission.xml" xxi:omit-xml-base="true"/>

                <!-- Generic confirmation dialog -->
                <xxforms:dialog id="fb-confirmation-dialog" level="modal" close="false" draggable="true">
                    <xforms:label>Confirm</xforms:label>
                    <xhtml:div>
                        <xhtml:img src="/apps/fr/style/question-large.gif" alt="Question" class="fr-dialog-icon"/>
                        <xhtml:div class="fr-dialog-message">
                            <xforms:output value="$variables/confirmation-message"/>
                        </xhtml:div>
                    </xhtml:div>
                    <xhtml:div class="fr-dialog-buttons">
                        <xforms:group>
                            <xforms:trigger>
                                <xforms:label><xhtml:img src="/apps/fr/style/clear.gif" alt=""/> <xhtml:span>Delete</xhtml:span></xforms:label>
                                <xforms:dispatch ev:event="DOMActivate" name="fb-confirmation-yes" target="{$variables/confirmation-target}"/>
                            </xforms:trigger>
                            <xforms:trigger id="fb-confirmation-dialog-cancel-trigger">
                                <xforms:label><xhtml:img src="/apps/fr/style/close.gif" alt=""/> <xhtml:span>Cancel</xhtml:span></xforms:label>
                                <xforms:dispatch ev:event="DOMActivate" name="fb-confirmation-no" target="{$variables/confirmation-target}"/>
                            </xforms:trigger>
                        </xforms:group>
                    </xhtml:div>
                    <!-- Hide dialog -->
                    <xxforms:hide ev:event="DOMActivate" dialog="fb-confirmation-dialog"/>
                    <!-- Set focus when the dialog open  -->
                    <xforms:setfocus ev:event="xxforms-dialog-open" control="fb-confirmation-dialog-cancel-trigger"/>
                </xxforms:dialog>

            </fr:body>
            <fr:buttons>
                <fr:back-button/>
                <fr:clear-button/>

                <!-- Test form -->
                <xforms:trigger model="fr-form-model" ref="instance('fb-variables')/publish-trigger">
                    <xforms:label>
                        <xhtml:img src="/forms/orbeon/builder/images/play.png" alt="Test Form" title="Test Form"/>
                        <xhtml:span>Test</xhtml:span>
                    </xforms:label>
                    <xforms:send ev:event="DOMActivate" submission="fb-test-form-submission"/>
                </xforms:trigger>

                <!-- Publish form -->
                <xforms:trigger id="fb-publish-button" model="fr-form-model" ref="instance('fb-variables')/publish-trigger">
                    <xforms:label>
                        <xhtml:img src="/apps/fr/style/images/silk/world.png" alt="Publish" title="Publish"/>
                        <xhtml:span>Publish</xhtml:span>
                    </xforms:label>
                    <xforms:action ev:event="DOMActivate">
                        <xxforms:show dialog="fb-publish-dialog"/>
                    </xforms:action>
                </xforms:trigger>

                <!--<fr:print-button/>-->
                <!--<fr:save-locally-button/>-->
                <fr:save-button/>
            </fr:buttons>
        </fr:view>

        <!--<widget:xforms-instance-inspector xmlns:widget="http://orbeon.org/oxf/xml/widget"/>-->
    </xhtml:body>
</xhtml:html>
