<?xml version="1.0" encoding="UTF-8"?>
<!--
    Copyright (C) 2008 Orbeon, Inc.

    This program is free software; you can redistribute it and/or modify it under the terms of the
    GNU Lesser General Public License as published by the Free Software Foundation; either version
    2.1 of the License, or (at your option) any later version.

    This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
    without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
    See the GNU Lesser General Public License for more details.

    The full text of the license is available at http://www.gnu.org/copyleft/lesser.html
-->
<xhtml:html xmlns:xhtml="http://www.w3.org/1999/xhtml"
      xmlns:xforms="http://www.w3.org/2002/xforms"
      xmlns:xs="http://www.w3.org/2001/XMLSchema"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xmlns:ev="http://www.w3.org/2001/xml-events"
      xmlns:xi="http://www.w3.org/2001/XInclude"
      xmlns:xxi="http://orbeon.org/oxf/xml/xinclude"
      xmlns:xxforms="http://orbeon.org/oxf/xml/xforms"
      xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
      xmlns:saxon="http://saxon.sf.net/">
    <xhtml:head>
        <xhtml:title>Orbeon Form Builder</xhtml:title>
        <xhtml:link rel="stylesheet" href="/ops/css/yui/reset-fonts-grids.css" type="text/css"/>
        <xhtml:link rel="stylesheet" href="/ops/css/yui/base-min.css" type="text/css"/>
        <xhtml:link rel="stylesheet" href="/apps/fr/style/form-runner.css" type="text/css"/>
        <xhtml:link rel="stylesheet" href="/forms/orbeon/builder/form-builder.css" type="text/css"/>
        <xforms:model id="fr-form-model">

            <xforms:action ev:event="xforms-model-construct-done">
                <xxforms:variable name="user-agent" select="xxforms:get-request-header('user-agent')"/>
                <xforms:setvalue ref="instance('fb-user-agent-instance')/value" value="$user-agent"/>
                <xforms:setvalue ref="instance('fb-user-agent-instance')/is-ie"
                                 value="contains(lower-case($user-agent), 'msie') and not(contains(lower-case($user-agent), 'opera'))"/>
            </xforms:action>

            <xforms:action ev:event="xforms-ready">
                <xxforms:script>
                    <!-- Position toolbox to the left upon loading -->
                    ORBEON.xforms.Globals.dialogs["fb-toolbox-dialog"].cfg.setProperty("x", 0);
                </xxforms:script>
            </xforms:action>

            <!-- Variable pointing to the current language -->
            <xxforms:variable name="lang" select="instance('fb-language-instance')"/>

            <!-- Other variables -->
            <xxforms:variable name="model" select="xhtml:head/xforms:model[@id = 'fr-form-model']"/>
            <xxforms:variable name="form-instance" select="$model/xforms:instance[@id = 'fr-form-instance']/*"/>
            <xxforms:variable name="metadata-instance" select="$model/xforms:instance[@id = 'fr-form-metadata']/*"/>
            <xxforms:variable name="resources" select="$model/xforms:instance[@id = 'fr-form-resources']/*"/>
            <xxforms:variable name="current-resources" select="$resources/resource[@xml:lang = $lang]"/>
            <xxforms:variable name="body" select="xhtml:body/fr:view/fr:body"/>

            <xxforms:variable name="current-top-level-block" select="$body/fr:*[index('fb-top-level-repeat')]"/>
            <xxforms:variable name="current-section-content-block" select="$current-top-level-block/fr:*[index('fb-section-content-repeat')]"/>
            <xxforms:variable name="current-td" select="$current-section-content-block/
                                                xhtml:tr[index('fb-section-content-grid-tr-repeat')]/
                                                xhtml:td[index('fb-section-content-grid-td-repeat')]"/>

            <!-- Main instance -->
            <xforms:instance id="fr-form-instance" src="oxf:/forms/orbeon/builder/form/template.xml"/>

            <!-- Binds on main instance -->
            <xforms:bind nodeset=".">
                <!-- Form metadata (also used by Form Runner) -->
                <xforms:bind nodeset="xhtml:head/xforms:model[@id = 'fr-form-model']/xforms:instance[@id = 'fr-form-metadata']/*">
                    <xforms:bind id="application-name-bind" nodeset="application-name" required="true()" type="xs:NCName" readonly="false()"
                                 calculate="if (normalize-space() = '') then concat('ID', digest(string(random(true)), 'MD5', 'hex')) else ."/>
                    <xforms:bind id="form-name-bind" nodeset="form-name" required="true()" type="xs:NCName" readonly="false()"
                                 calculate="if (normalize-space() = '') then concat('ID', digest(string(random(true)), 'MD5', 'hex')) else ."/>
                    <xforms:bind id="title-bind" nodeset="title" required="true()"/>
                    <xforms:bind id="description-bind" nodeset="description"/>
                    <xforms:bind id="logo-bind" nodeset="logo" type="xs:anyURI"/>
                </xforms:bind>
                <!-- Global attachments (also used by Form Runner) -->
                <xforms:bind nodeset="xhtml:head/xforms:model[@id = 'fr-form-model']/xforms:instance[@id = 'fr-form-attachments']/*">
                    <xforms:bind id="css-attachment-bind" nodeset="css" type="xs:anyURI"/>
                    <xforms:bind id="pdf-attachment-bind" nodeset="pdf" type="xs:anyURI"/>
                </xforms:bind>
                <!-- Form instance -->
                <xforms:bind nodeset="xhtml:head/xforms:model[@id = 'fr-form-model']/xforms:instance[@id = 'fr-form-instance']/*">

                    <!-- Handle "date" type. Note we make it optional with xforms:date so we can save the form -->
                    <xforms:bind nodeset="*/*[name() = $model/xforms:bind/xforms:bind/xforms:bind[substring-after(@type, ':') = 'date']/@nodeset]" type="xforms:date"/>
                    <!-- Handle "boolean" type -->
                    <!--<xforms:bind nodeset="*/*[name() = $model/xforms:bind/xforms:bind/xforms:bind[substring-after(@type, ':') = 'boolean']/@nodeset]" type="xs:boolean"/>-->

                    <!-- Handle local attachments -->
                    <xforms:bind nodeset="*/*[@filename and @mediatype and @size]" type="xs:anyURI" class="fr-attachment"/>
                </xforms:bind>
                <!-- Set HTML title -->
                <xforms:bind nodeset="xhtml:head/xhtml:title" calculate="$metadata-instance/title"/>
            </xforms:bind>

            <!-- Metadata -->
            <xforms:instance id="fr-form-metadata" xxforms:readonly="true">
                <metadata>
                    <application-name>orbeon</application-name>
                    <form-name>builder</form-name>
                    <title>Orbeon Form Builder</title>
                    <description>Orbeon Form Builder allows you to easily build forms right from your web browser and without programming.</description>
                    <author>Orbeon, Inc.</author>
                    <logo mediatype="image/png" filename="orbeon-logo-trimmed-transparent-42.png" size="">/apps/fr/style/orbeon-logo-trimmed-transparent-42.png</logo>
                </metadata>
            </xforms:instance>

            <!-- All form resources -->
            <xforms:instance id="fr-form-resources" xxforms:readonly="true">
                <resources>
                    <resource xml:lang="en">
                        <application-name>
                            <label>Application Name</label>
                        </application-name>
                        <form-name>
                            <label>Form Name</label>
                        </form-name>
                        <title>
                            <label>Form Title</label>
                        </title>
                        <description>
                            <label>Form Description</label>
                        </description>
                        <logo>
                            <label>Logo</label>
                        </logo>
                        <!-- TODO: i18n whole Form Builder -->
                    </resource>
                    <resource xml:lang="fr">
                        <application-name>
                            <label>Nom de l'application</label>
                        </application-name>
                        <form-name>
                            <label>Nom du formulaire</label>
                        </form-name>
                        <title>
                            <label>Titre du formulaire</label>
                        </title>
                        <description>
                            <label>Description du formulaire</label>
                        </description>
                        <logo>
                            <label>Logo</label>
                        </logo>
                    </resource>
                </resources>
            </xforms:instance>

            <!-- Instance containing the current language -->
            <xforms:instance id="fb-language-instance">
                <language>en</language>
            </xforms:instance>

            <!-- Configuration for Saxon serialization -->
            <xforms:instance id="fb-xsl-output-instance">
                <xsl:output xmlns:xsl="http://www.w3.org/1999/XSL/Transform" method="xml" omit-xml-declaration="yes" indent="yes" saxon:indent-spaces="4"/>
            </xforms:instance>

            <!-- Store user-agent details -->
            <xforms:instance id="fb-user-agent-instance">
                <user-agent>
                    <value/>
                    <is-ie/>
                </user-agent>
            </xforms:instance>

            <!-- Submission to test the form -->
            <xforms:submission id="fb-test-form-submission"
                    ref="instance('fr-form-instance')" method="post" replace="all"
                    resource="/fr/orbeon/test/test/" xxforms:target="_blank" xxforms:show-progress="false"/>

            <!-- TODO: check where local variable can be used instead -->
            <xforms:instance id="fb-variables">
                <variables>
                    <done/>

                    <!-- Confirmation dialog -->
                    <confirmation-message/>
                    <confirmation-target/>

                    <!-- Itemset editor dialog -->
                    <itemset-resource-id/>
                    <itemset-lang/>

                    <result-node/>

                    <next-section-id/>
                    <next-control-id/>

                    <new-language/>
                    <new-language-trigger/>

                    <new-text/>

                    <new-source/>
                    <new-source-trigger/>

                    <xml-view/>
                </variables>
            </xforms:instance>

            <!-- Ensure there is an empty xhtml:td to place a new control (may fail) -->
            <xforms:action ev:event="fb-ensure-empty-td">

                <xforms:action context="$current-td">
                    <xforms:action if="not(exists(xforms:*))">
                        <!-- There is no xforms:* element in the current td, don't change anything -->
                    </xforms:action>
                    <xforms:action if="exists(xforms:*)">
                        <!-- There is an xforms:* element in the current td, figure out what to do -->
                        <xxforms:variable name="is-next-td-available" select="following-sibling::xhtml:td[1][not(xforms:*)]"/>
                        <xforms:action if="$is-next-td-available">
                            <!-- Next cell is empty, move to that one -->
                            <xforms:setindex repeat="fb-section-content-grid-td-repeat" index="index('fb-section-content-grid-td-repeat') + 1"/>
                        </xforms:action>
                        <xforms:action if="not($is-next-td-available) and following-sibling::xhtml:td">
                            <!-- TODO: Not sure we have a plan here -->
                        </xforms:action>
                        <xforms:action if="not($is-next-td-available) and not(following-sibling::xhtml:td)">
                            <xxforms:variable name="is-insert-new-row"
                                              select="exists(../following-sibling::xhtml:tr[1]/xhtml:td[1]/xforms:*) or not(exists(../following-sibling::xhtml:tr[1]))"/>
                            <!-- We are the last cell of the row -->
                            <xforms:action if="$is-insert-new-row">
                                <!-- The first cell of the next row is occupied, or there is no next row: insert new row -->
                                <xforms:insert context="self::xhtml:td" nodeset="parent::xhtml:tr"
                                               origin="instance(concat('fb-grid-', count(../xhtml:td), '-template'))/xhtml:tr"/>
                                <!-- Make sure the first cell is selected -->
                                <xforms:setindex repeat="fb-section-content-grid-td-repeat" index="1"/>
                            </xforms:action>
                            <xforms:action if="not($is-insert-new-row)">
                                <!-- There is a next row, and its first cell is empty, move to that one -->
                                <xforms:setindex repeat="fb-section-content-grid-tr-repeat" index="index('fb-section-content-grid-tr-repeat') + 1"/>
                                <xforms:setindex repeat="fb-section-content-grid-td-repeat" index="1"/>
                            </xforms:action>
                        </xforms:action>
                    </xforms:action>
                </xforms:action>
            </xforms:action>

            <!-- Delete control and associated resources -->
            <xforms:action ev:event="fb-delete-control">
                <xxforms:variable name="control" select="event('control')"/>

                <xxforms:variable name="control-name" select="substring-before($control/@id, '-control')"/>
                <xxforms:variable name="section-name" select="$control/ancestor::fr:section[1]/@context"/>
                <xxforms:variable name="bind" select="$model/xforms:bind[@id = 'fr-form-binds']/xforms:bind[@nodeset = $section-name]/xforms:bind[@nodeset = $control-name]"/>

                <!-- Delete control -->
                <xforms:delete nodeset="$control"/>
                <!-- Delete instance holder -->
                <xforms:delete nodeset="$form-instance/*[name() = $section-name]/*[name() = $control-name]"/>
                <!-- Delete resources -->
                <xforms:delete xxforms:iterate="$resources/resource/*[name() = $control-name]" nodeset="."/>
                <!-- Delete bind if any -->
                <xforms:delete nodeset="$bind"/>
            </xforms:action>

            <!-- Insert instance and resource holders -->
            <xforms:action ev:event="fb-insert-holders">
                <xxforms:variable name="current-td" select="event('current-td')"/>
                <xxforms:variable name="section-name" select="event('section-name')"/>
                <xxforms:variable name="instance-holder" select="event('instance-holder')"/>
                <xxforms:variable name="resource-holders" select="event('resource-holders')"/>

                <!-- All the xhtml:td elements up to and including the current one -->
                <xxforms:variable name="tds" select="($current-td/../preceding-sibling::xhtml:tr/xhtml:td, $current-td/preceding-sibling::xhtml:td)"/>

                <!-- Name of the preceding control id -->
                <xxforms:variable name="preceding-control-id" select="substring-before(($tds/xforms:*)[last()]/@id, '-control')"/>

                <!--<xforms:message>-->
                    <!--Preceding: <xforms:output value="$preceding-control-id"/>-->
                <!--</xforms:message>-->

                <!-- Insert new holder element into the instance just after the previous control -->
                <xforms:insert context="$form-instance/*[name() = $section-name]"
                               nodeset="*[name() = $preceding-control-id]"
                               origin="$instance-holder"/>

                <!-- Insert resources placeholders for all languages -->
                <xforms:action xxforms:iterate="$resources/resource">
                    <xxforms:variable name="position" select="position()"/>
                    <xforms:insert context="." nodeset="*[name() = $preceding-control-id]" origin="$resource-holders[$position]"/>

                    <!-- Insert resource templates only if holder passed is not empty -->
                    <xforms:insert context="*[name() = name($resource-holders[$position])]" if="not(*)" origin="instance('fb-resource-template')/*"/>
                </xforms:action>
            </xforms:action>

            <!-- Cut/copy/paste instance -->
            <xforms:instance id="fb-xcv-instance">
                <xcv>
                    <control/>
                    <holder/>
                    <resources/>
                    <bind/>
                    <cut-trigger/>
                    <copy-trigger/>
                    <paste-trigger/>
                </xcv>
            </xforms:instance>
            <xxforms:variable name="xcv" select="instance('fb-xcv-instance')"/>

            <xforms:bind nodeset="$xcv">
                <xforms:bind nodeset="cut-trigger" readonly="not(exists($current-td/xforms:*))"/>
                <xforms:bind nodeset="copy-trigger" readonly="not(exists($current-td/xforms:*))"/>
                <xforms:bind nodeset="paste-trigger" readonly="not(exists(../control/*))"/>
            </xforms:bind>

            <!-- Copy current control to xcv instance -->
            <xforms:action ev:event="fb-copy-control">
                <xxforms:variable name="current-control" select="event('current-td')/xforms:*"/>

                <xforms:action if="exists($current-control)">
                    <xxforms:variable name="current-control-name" select="substring-before($current-control/@id, '-control')"/>
                    <xxforms:variable name="current-bind-id" select="concat($current-control-name, '-bind')"/>
                    <xxforms:variable name="bind" select="$model//xforms:bind[@id = $current-bind-id]"/>

                    <!-- Clear clipboard -->
                    <xforms:action xxforms:iterate="$xcv/*">
                        <xforms:delete while="*" nodeset="*"/>
                    </xforms:action>

                    <!-- Copy control -->
                    <xforms:insert context="$xcv/control" origin="$current-control"/>

                    <!-- Copy holder -->
                    <xforms:insert context="$xcv/holder" origin="$form-instance/*/*[name() = $current-control-name]"/>

                    <!-- Copy all resources -->
                    <xforms:insert context="$xcv/resources" origin="$resources/resource/*[name() = $current-control-name]"/>

                    <!-- Copy bind if any -->
                    <xforms:insert context="$xcv/bind" origin="$bind"/>
                </xforms:action>

            </xforms:action>

            <!-- Adjust control bindings -->
            <xforms:action ev:event="fb-rename-control">
                <xxforms:variable name="control" select="event('control')"/>
                <xxforms:variable name="new-control-name" select="event('new-name')"/>

                <xforms:action context="$control">
                    <!-- Set @id value -->
                    <xforms:setvalue ref="@id" value="concat($new-control-name, '-control')"/>

                    <!-- Set @ref value if present -->
                    <xforms:setvalue ref="@ref" value="$new-control-name"/>

                    <!-- Set @bind value if present -->
                    <xforms:setvalue ref="@bind" value="concat($new-control-name, '-bind')"/>

                    <!-- Set xforms:label, xforms:hint, xforms:help and xforms:alert @ref -->
                    <xforms:action xxforms:iterate="(xforms:label, xforms:hint, xforms:help, xforms:alert)">
                        <xxforms:variable name="local-name" select="local-name()"/>
                        <xforms:setvalue ref="@ref" value="concat('$form-resources/', $new-control-name, '/', $local-name)"/>
                    </xforms:action>

                    <!-- Set xforms:itemset/@nodeset value -->
                    <xforms:setvalue ref="xforms:itemset/@nodeset" value="concat('$form-resources/', $new-control-name, '/item')"/>
                </xforms:action>
            </xforms:action>

            <!-- Rename holders -->
            <xforms:action ev:event="fb-rename-holders">
                <xxforms:variable name="holders" select="event('holders')"/>
                <xxforms:variable name="new-name" select="event('new-name')"/>
                
                <!-- Iterate through instance holder and all resources -->
                <xforms:action xxforms:iterate="$holders">
                    <xxforms:variable name="current-holder" select="."/>

                    <!-- Insert new placeholder after existing one -->
                    <xforms:insert nodeset="$current-holder" origin="xxforms:element($new-name)"/>
                    <!-- Copy existing content into new element -->
                    <xforms:insert context="$current-holder/following-sibling::*[1]" origin="$current-holder/(@* | node())"/>
                    <!-- Delete old element -->
                    <xforms:delete nodeset="$current-holder"/>
                </xforms:action>
            </xforms:action>

            <!-- Paste control if there is one in the clipboard -->
            <xforms:action ev:event="fb-paste-control" if="$xcv/control/xforms:*">

                <!-- Try to find empty td -->
                <xforms:dispatch name="fb-ensure-empty-td" target="fr-form-model"/>

                <!-- Get new td -->
                <xxforms:variable name="new-td" select="$current-section-content-block/
                    xhtml:tr[index('fb-section-content-grid-tr-repeat')]/
                    xhtml:td[index('fb-section-content-grid-td-repeat')]"/>
                <xforms:action context="$new-td" if="not(exists(xforms:*))">
                    <!-- We now have an empty cell for pasting -->

                    <xxforms:variable name="xcv-control-id" select="$xcv/control/xforms:*/@id"/>

                    <!-- Check if clipboard control id is in use -->
                    <xforms:action if="$body//xforms:*[@id = $xcv-control-id]">
                        <!-- If so, get new id and replace references -->
                        <xforms:dispatch name="fb-compute-control-id" target="fr-form-model"/>
                        <xxforms:variable name="new-control-name" select="concat('control-', $next-control-id)"/>

                        <!-- Adjust bindings on xcv control -->
                        <xforms:dispatch name="fb-rename-control" target="fr-form-model">
                            <xxforms:context name="control" select="$xcv/control/xforms:*"/>
                            <xxforms:context name="new-name" select="$new-control-name"/>
                        </xforms:dispatch>

                        <!-- Rename holders -->
                        <xforms:dispatch name="fb-rename-holders" target="fr-form-model">
                            <xxforms:context name="holders" select="($xcv/holder/*, $xcv/resources/*)"/>
                            <xxforms:context name="new-name" select="$new-control-name"/>
                        </xforms:dispatch>

                        <!-- Update bind if existing -->
                        <xforms:setvalue ref="$xcv/bind/xforms:bind/@id" value="concat($new-control-name, '-bind')"/>
                        <xforms:setvalue ref="$xcv/bind/xforms:bind/@nodeset" value="$new-control-name"/>

                    </xforms:action>

                    <!-- Insert control -->
                    <xforms:insert context="$new-td" origin="$xcv/control/xforms:*"/>

                    <!-- Insert instance and resource holders -->
                    <!-- TODO: match against existing languages, as that may have changed between copy and paste -->
                    <xxforms:variable name="section-name" select="$current-td/ancestor::fr:section[1]/@context"/>
                    <xforms:dispatch name="fb-insert-holders" target="fr-form-model">
                        <xxforms:context name="current-td" select="$new-td"/>
                        <xxforms:context name="section-name" select="$section-name"/>
                        <xxforms:context name="instance-holder" select="$xcv/holder/*"/>
                        <xxforms:context name="resource-holders" select="$xcv/resources/*"/>
                    </xforms:dispatch>

                    <!-- Insert bind if any -->
                    <xforms:action if="exists($xcv/bind/xforms:bind)">
                        <xxforms:variable name="control-name" select="substring-before($xcv/control/xforms:*/@id, '-control')"/>
                        <xforms:dispatch name="fb-ensure-bind" target="fr-form-model">
                            <xxforms:context name="control-name" select="$control-name"/>
                        </xforms:dispatch>
                        <xxforms:variable name="bind" select="$model//xforms:bind[@nodeset = $control-name]"/>
                        <xforms:insert nodeset="$bind" origin="$xcv/bind/xforms:bind"/>
                        <xforms:delete nodeset="$bind"/>
                    </xforms:action>

                </xforms:action>
            </xforms:action>

            <!-- Generic instance to set the control id on which to work -->
            <!-- NOTE: Ideally we wouldn't need this kind of global variables, but could either call functions or pass parameters to events -->
            <xforms:instance id="fb-current-control-instance">
                <control>
                    <id/>
                </control>
            </xforms:instance>
            <xxforms:variable name="current-control-name" select="instance('fb-current-control-instance')/id"/>

            <!-- Create the bind element for the current control if it does not exist yet -->
            <xforms:action ev:event="fb-ensure-bind">
                <xxforms:variable name="control-name" select="event('control-name')"/>

                <!-- Insert bind container if needed -->
                <xforms:insert context="$model"
                               if="not(xforms:bind[@id = 'fr-form-binds'])"
                               nodeset="xforms:instance[@id = 'fr-form-instance']"
                               origin="instance('fb-bind-template')"/>

                <!-- Insert bind for section if needed -->
                <xxforms:variable name="current-control" select="$body//xforms:*[@id = concat($control-name, '-control')]"/>
                <xxforms:variable name="current-section-name" select="$current-control/ancestor::fr:section[1]/@context"/>
                <xforms:action context="$model/xforms:bind[@id = 'fr-form-binds']">
                    <xforms:action if="not(xforms:bind[@nodeset = $current-section-name])">
                        <xforms:insert context="." nodeset="xforms:bind" origin="instance('fb-bind-template')"/>
                        <xforms:setvalue ref="xforms:bind[last()]/@id" value="concat($current-section-name, '-bind')"/>
                        <xforms:setvalue ref="xforms:bind[last()]/@nodeset" value="$current-section-name"/>
                    </xforms:action>
                </xforms:action>

                <!-- Insert bind for control if needed -->
                <xxforms:variable name="current-bind-id" select="concat($control-name, '-bind')"/>
                <xforms:action context="$model/xforms:bind[@id = 'fr-form-binds']/xforms:bind[@nodeset = $current-section-name]">
                    <xforms:action if="not(xforms:bind[@id = $current-bind-id])">
                        <xforms:insert context="." nodeset="xforms:bind" origin="instance('fb-bind-template')"/>
                        <xforms:setvalue ref="xforms:bind[last()]/@id" value="$current-bind-id"/>
                        <xforms:setvalue ref="xforms:bind[last()]/@nodeset" value="$control-name"/>
                    </xforms:action>
                </xforms:action>
            </xforms:action>

            <!-- Details dialog -->
            <xforms:instance id="fb-details-editor-instance">
                <details>
                    <original-control-name/>
                    <control-name/>
                    <control/>
                    <classes/>
                    <instance-holder/>
                    <change-trigger/>
                </details>
            </xforms:instance>

            <xforms:bind nodeset="instance('fb-details-editor-instance')">
                <xforms:bind nodeset="control-name" constraint=". = ../original-control-name or not(concat(normalize-space(), '-control') = $body//xforms:*/@id)" type="xs:NCName"/>
                <xforms:bind nodeset="change-trigger" readonly="../control-name != ../original-control-name and concat(normalize-space(../control-name), '-control') = $body//xforms:*/@id"/>
            </xforms:bind>

            <!-- Validation dialog -->
            <xforms:instance id="fb-validation-editor-instance">
                <validation>
                    <builtin-type/>
                    <required>false</required>
                    <schema-type/>
                    <alert/>
                </validation>
            </xforms:instance>

            <xforms:bind nodeset="instance('fb-validation-editor-instance')">
                <xforms:bind nodeset="required" readonly="../schema-type != ''"/>
            </xforms:bind>

            <xforms:instance id="fb-validation-types-instance" xxforms:readonly="true">
                <choices>
                    <choices>
                        <label>String Types</label>
                        <type allow-empty="true">string</type>
                        <type allow-empty="true">normalizedString</type>
                        <type>token</type>
                        <type>language</type>
                        <type>Name</type>
                        <type>NCName</type>
                        <type>ID</type>
                        <type>IDREF</type>
                        <type>IDREFS</type>
                        <type>ENTITY</type>
                        <type>ENTITIES</type>
                        <type>NMTOKEN</type>
                        <type>NMTOKENS</type>
                    </choices>
                    <choices>
                        <label>Number Types</label>
                        <type>float</type>
                        <type>double</type>
                        <type>decimal</type>
                        <type>integer</type>
                        <type>long</type>
                        <type>int</type>
                        <type>short</type>
                        <type>byte</type>
                        <type>positiveInteger</type>
                        <type>nonPositiveInteger</type>
                        <type>negativeInteger</type>
                        <type>nonNegativeInteger</type>
                        <type>unsignedLong</type>
                        <type>unsignedInt</type>
                        <type>unsignedShort</type>
                        <type>unsignedByte</type>
                    </choices>
                    <choices>
                        <label>Time Types</label>
                        <type>duration</type>
                        <type>dateTime</type>
                        <type>time</type>
                        <type>date</type>
                        <type>gYearMonth</type>
                        <type>gYear</type>
                        <type>gMonthDay</type>
                        <type>gDay</type>
                        <type>gMonth</type>
                    </choices>
                    <choices>
                        <label>Other Types</label>
                        <type>boolean</type>
                        <!-- Not 100% sure if these two types allow empty content -->
                        <type allow-empty="true">hexBinary</type>
                        <type allow-empty="true">base64Binary</type>
                        <type>anyURI</type>
                        <type>QName</type>
                        <type>NOTATION</type>
                    </choices>
                </choices>
            </xforms:instance>

            <!-- Schema upload dialog -->
            <xforms:instance id="fb-schema-upload-instance">
                <validation>
                    <schema-uri filename="" mediatype="" size=""/>
                    <schema>
                        <!-- Content will be like this -->
                        <!--<xs:schema>-->
                            <!--...-->
                        <!--</xs:schema>-->
                    </schema>
                    <temp-type/>
                </validation>
            </xforms:instance>

            <xforms:bind nodeset="instance('fb-schema-upload-instance')">
                <xforms:bind nodeset="temp-type" readonly="true()"/>
            </xforms:bind>

            <!-- Submission to upload the schema -->
            <xforms:submission id="fb-schema-upload-submission" ref="instance('fb-schema-upload-instance')"
                               method="post" replace="none" resource="test:"/>

            <!-- Instance for the itemset editor -->
            <xforms:instance id="fb-itemset-instance">
                <itemset>
                    <!-- Content will be like this -->
                    <!--<item>-->
                        <!--<label xml:lang="en"/>-->
                        <!--<label xml:lang="fr"/>-->
                        <!--<value/>-->
                    <!--</item>-->
                </itemset>
            </xforms:instance>

            <!-- Item template for the itemset editor -->
            <xforms:instance id="fb-item-template">
                <item>
                    <!-- Content will be like this -->
                    <!--<label xml:lang="en"/>-->
                    <!--<label xml:lang="fr"/>-->
                    <!--<value/>-->
                </item>
            </xforms:instance>

            <!-- Template for outer bind -->
            <xforms:instance id="fb-bind-template" xxforms:readonly="true">
                <xforms:bind id="fr-form-binds" nodeset="."/>
            </xforms:instance>

            <xforms:bind nodeset="instance('fb-variables')">
                <xforms:bind nodeset="new-language-trigger" readonly="normalize-space(../new-language) = ''"/>
            </xforms:bind>

            <xxforms:variable name="variables" select="instance('fb-variables')"/>
            <xxforms:variable name="next-section-id" select="$variables/next-section-id"/>
            <xxforms:variable name="next-control-id" select="$variables/next-control-id"/>

            <!-- Compute the next section id -->
            <xforms:action ev:event="fb-compute-section-id">
                <!-- Initialize with count of existing sections (we could as well start from 1) -->
                <xforms:setvalue if="$next-section-id = ''" ref="$next-section-id" value="count($body//fr:section)"/>
                <!-- Increment number until the id doesn't clash with the control id OR the element name -->
                <xforms:action while="$body//fr:section[@id = concat('section-', $next-section-id, '-section')]
                                        or $form-instance/*[name() = concat('section-', $next-section-id)]">
                    <xforms:setvalue ref="$next-section-id" value=". + 1"/>
                </xforms:action>
            </xforms:action>

            <!-- Compute the next control id -->
            <xforms:action ev:event="fb-compute-control-id">
                <!-- Initialize based on count of existing controls (we could as well start from 1) -->
                <xforms:setvalue if="$next-control-id = ''" ref="$next-control-id" value="count($body//xforms:*[ends-with(@id, '-control')]) + 1"/>
                <!-- Increment number until the id doesn't clash with the control id OR the element name -->
                <xforms:action while="$body//xforms:*[@id = concat('control-', $next-control-id, '-control')]
                                        or $form-instance/*/*[name() = concat('control-', $next-control-id)]">
                    <xforms:setvalue ref="$next-control-id" value=". + 1"/>
                </xforms:action>
            </xforms:action>

            <xforms:instance id="fb-section-template" xxforms:readonly="true">
                <fr:section id="" context="">
                    <xforms:label ref=""/>
                    <fr:grid columns="1">
                        <xhtml:tr>
                            <xhtml:td/>
                        </xhtml:tr>
                    </fr:grid>
                </fr:section>
            </xforms:instance>

            <xforms:instance id="fb-resource-template" xxforms:readonly="true">
                <template>
                    <label>[Please modify the label]</label>
                    <hint>[Please modify the hint]</hint>
                    <help/>
                    <alert>The value of this field is incorrect</alert>
                </template>
            </xforms:instance>

            <xforms:instance id="fb-grid-1-template" xxforms:readonly="true">
                <fr:grid columns="1">
                    <xhtml:tr>
                        <xhtml:td/>
                    </xhtml:tr>
                </fr:grid>
            </xforms:instance>

            <xforms:instance id="fb-grid-2-template" xxforms:readonly="true">
                <fr:grid columns="2">
                    <xhtml:tr>
                        <xhtml:td/>
                        <xhtml:td/>
                    </xhtml:tr>
                </fr:grid>
            </xforms:instance>

            <xforms:instance id="fb-grid-3-template" xxforms:readonly="true">
                <fr:grid columns="3">
                    <xhtml:tr>
                        <xhtml:td/>
                        <xhtml:td/>
                        <xhtml:td/>
                    </xhtml:tr>
                </fr:grid>
            </xforms:instance>

            <xforms:instance id="fb-grid-4-template" xxforms:readonly="true">
                <fr:grid columns="4">
                    <xhtml:tr>
                        <xhtml:td/>
                        <xhtml:td/>
                        <xhtml:td/>
                        <xhtml:td/>
                    </xhtml:tr>
                </fr:grid>
            </xforms:instance>

            <xforms:instance id="fb-controls-template" xxforms:readonly="true">
                <templates xmlns="">
                    <template label="Text Line">
                        <xhtml:div class="input">
                            <xforms:input id="" ref="" incremental="true">
                                <xforms:label ref=""/>
                                <xforms:hint ref=""/>
                                <xforms:help ref=""/>
                                <xforms:alert ref=""/>
                            </xforms:input>
                        </xhtml:div>
                    </template>
                    <template label="Date Picker" image="/ops/images/xforms/calendar.gif">
                        <xhtml:div class="date-input">
                            <xforms:input id="" ref="" incremental="true">
                                <xforms:label ref=""/>
                                <xforms:hint ref=""/>
                                <xforms:help ref=""/>
                                <xforms:alert ref=""/>
                            </xforms:input>
                        </xhtml:div>
                    </template>
                    <!-- TODO -->
                    <!--<template label="Time" image="/forms/orbeon/builder/images/clock.png">-->
                        <!--<xhtml:div class="time-input">-->
                            <!--<xforms:input id="" ref="" incremental="true">-->
                                <!--<xforms:label ref=""/>-->
                                <!--<xforms:hint ref=""/>-->
                                <!--<xforms:help ref=""/>-->
                                <!--<xforms:alert ref=""/>-->
                            <!--</xforms:input>-->
                        <!--</xhtml:div>-->
                    <!--</template>-->
                    <!--<template label="Date and Time" image="/ops/images/xforms/calendar.gif">-->
                        <!--<xhtml:div class="dateTime-input">-->
                            <!--<xforms:input id="" ref="" incremental="true">-->
                                <!--<xforms:label ref=""/>-->
                                <!--<xforms:hint ref=""/>-->
                                <!--<xforms:help ref=""/>-->
                                <!--<xforms:alert ref=""/>-->
                            <!--</xforms:input>-->
                        <!--</xhtml:div>-->
                    <!--</template>-->
                    <template label="Text Area">
                        <xhtml:div id="" class="textarea">
                            <xforms:textarea id="" ref="" incremental="true">
                                <xforms:label ref=""/>
                                <xforms:hint ref=""/>
                                <xforms:help ref=""/>
                                <xforms:alert ref=""/>
                            </xforms:textarea>
                        </xhtml:div>
                    </template>
                    <template label="Dropdown">
                        <xhtml:div class="dropdown">
                            <xforms:select1 id="" appearance="minimal" ref="">
                                <xforms:label ref=""/>
                                <xforms:hint ref=""/>
                                <xforms:help ref=""/>
                                <xforms:alert ref=""/>
                                <xforms:item>
                                    <xforms:label>[Select...]</xforms:label>
                                    <xforms:value/>
                                </xforms:item>
                                <xforms:itemset nodeset="">
                                    <xforms:label ref="label"/>
                                    <xforms:value ref="value"/>
                                </xforms:itemset>
                            </xforms:select1>
                        </xhtml:div>
                    </template>
                    <template label="Radio Buttons">
                        <xhtml:div class="radio">
                            <xforms:select1 id="" appearance="full" ref="">
                                <xforms:label ref=""/>
                                <xforms:hint ref=""/>
                                <xforms:help ref=""/>
                                <xforms:alert ref=""/>
                                <xforms:itemset nodeset="">
                                    <xforms:label ref="label"/>
                                    <xforms:value ref="value"/>
                                </xforms:itemset>
                            </xforms:select1>
                        </xhtml:div>
                    </template>
                    <template label="List box (single)">
                        <xhtml:div class="listbox">
                            <xforms:select1 id="" appearance="compact" ref="">
                                <xforms:label ref=""/>
                                <xforms:hint ref=""/>
                                <xforms:help ref=""/>
                                <xforms:alert ref=""/>
                                <xforms:itemset nodeset="">
                                    <xforms:label ref="label"/>
                                    <xforms:value ref="value"/>
                                </xforms:itemset>
                            </xforms:select1>
                        </xhtml:div>
                    </template>
                    <template label="Checkboxes">
                        <xhtml:div class="checkbox">
                            <xforms:select id="" appearance="full" ref="">
                                <xforms:label ref=""/>
                                <xforms:hint ref=""/>
                                <xforms:help ref=""/>
                                <xforms:alert ref=""/>
                                <xforms:itemset nodeset="">
                                    <xforms:label ref="label"/>
                                    <xforms:value ref="value"/>
                                </xforms:itemset>
                            </xforms:select>
                        </xhtml:div>
                    </template>
                    <template label="List box (mult.)" image="/forms/orbeon/builder/images/listbox.png">
                        <xhtml:div class="listbox-multiple">
                            <xforms:select id="" appearance="compact" ref="">
                                <xforms:label ref=""/>
                                <xforms:hint ref=""/>
                                <xforms:help ref=""/>
                                <xforms:alert ref=""/>
                                <xforms:itemset nodeset="">
                                    <xforms:label ref="label"/>
                                    <xforms:value ref="value"/>
                                </xforms:itemset>
                            </xforms:select>
                        </xhtml:div>
                    </template>
                    <template label="Output">
                        <xhtml:div class="output">
                            <xforms:output id="" ref="">
                                <xforms:label ref=""/>
                                <xforms:help ref=""/>
                                <!-- No hint? -->
                                <xforms:alert ref=""/>
                            </xforms:output>
                        </xhtml:div>
                    </template>
                    <template label="Button">
                        <xhtml:div class="button">
                            <xforms:trigger id="">
                                <xforms:label ref=""/>
                                <xforms:help ref=""/>
                                <!-- No hint? -->
                                <xforms:alert ref=""/>
                            </xforms:trigger>
                        </xhtml:div>
                    </template>
                    <template label="Image">
                        <xhtml:div class="image">
                            <xforms:output id="" bind="" mediatype="image/*" class="fr-attachment">
                                <xforms:label ref=""/>
                                <xforms:help ref=""/>
                                <!-- No hint? -->
                                <xforms:alert ref=""/>
                            </xforms:output>
                        </xhtml:div>
                    </template>
                    <template label="Upload">
                        <xhtml:div class="upload">
                            <xforms:upload id="" ref="" class="fr-attachment">
                                <xforms:label ref=""/>
                                <xforms:hint ref=""/>
                                <xforms:help ref=""/>
                                <xforms:alert ref=""/>
                                <xforms:filename ref="@filename"/>
                                <xforms:mediatype ref="@mediatype"/>
                                <xxforms:size ref="@size"/>
                            </xforms:upload>
                        </xhtml:div>
                    </template>
                </templates>
            </xforms:instance>

        </xforms:model>
    </xhtml:head>
    <xhtml:body>

        <fr:view>
            <xforms:label>Orbeon Form Builder</xforms:label>
            <!--<xhtml:img src="/apps/fr/style/orbeon-logo-trimmed-transparent-42.png"/>-->
            <fr:body>

                <!--<xforms:output value="instance('fb-user-agent-instance')/value"/>-->

                <xforms:group ref=".[instance('fb-user-agent-instance')/is-ie = 'true']" class="fb-ie-warning">
                    Orbeon Form Builder still needs work to provide a satisfactory experience with Internet Explorer.
                    Please bear with us while we fix this. In the meanwhile, we recommend you use <a
                    href="http://www.mozilla.com/firefox/">Firefox</a>, <a
                    href="http://www.apple.com/safari/">Safari</a>, or <a href="http://www.opera.com/">Opera</a>.
                </xforms:group>

                <!--

                    Here is how a page is organized:

                    doc     := block*
                    block   := grid | repeat | section
                    section := block*
                    repeat  := tabularRepeat | gridRepeat | blockRepeat


                    NOTE: section and repeat can have some properties, such as a label.  

                -->



                <!-- Section about form metadata -->
                <fr:section id="fb-metadata-section" class="fb-metadata-section">
                    <xforms:label>Form Metadata</xforms:label>

                    <fr:grid columns="2">
                        <xhtml:tr>
                            <xhtml:td>
                                <xforms:input id="application-name-control" bind="application-name-bind" appearance="fr:in-place" class="fr-summary fr-search">
                                    <xforms:label ref="$form-resources/application-name"/>
                                </xforms:input>
                            </xhtml:td>
                            <xhtml:td>
                                <xforms:input id="form-name-control" bind="form-name-bind" appearance="fr:in-place" class="fr-summary fr-search">
                                    <xforms:label ref="$form-resources/form-name"/>
                                </xforms:input>
                            </xhtml:td>
                        </xhtml:tr>
                        <xhtml:tr>
                            <xhtml:td>
                                <!-- Image -->
                                <xforms:group>
                                    <xforms:label>Logo</xforms:label>
                                    <xforms:group ref="$metadata-instance/logo[normalize-space() != '']">
                                        <xforms:output ref="." mediatype="image/*">
                                            <xforms:label class="fb-xforms-disabled"/>
                                        </xforms:output>
                                    </xforms:group>
                                    <!-- File chooser -->
                                    <xforms:upload id="logo-control" bind="logo-bind" class="fr-attachment">
                                        <xforms:label class="fb-xforms-disabled"/>
                                        <xforms:filename ref="@filename"/>
                                        <xforms:mediatype ref="@mediatype"/>
                                        <xxforms:size ref="@size"/>
                                    </xforms:upload>
                                </xforms:group>
                            </xhtml:td>
                            <xhtml:td>
                                <xforms:input id="title-control" bind="title-bind" appearance="fr:in-place" class="fr-summary fr-search">
                                    <xforms:label ref="$form-resources/title"/>
                                </xforms:input>
                            </xhtml:td>
                        </xhtml:tr>
                        <xhtml:tr>
                            <xhtml:td colspan="2">
                                <xhtml:div>
                                    <xforms:textarea id="description-control" bind="description-bind" appearance="fr:in-place" class="fr-summary fr-search">
                                        <xforms:label ref="$form-resources/description"/>
                                    </xforms:textarea>
                                </xhtml:div>
                            </xhtml:td>
                        </xhtml:tr>
                    </fr:grid>
                </fr:section>

                <!-- Form details -->
                <fr:section id="fb-details-section" context="$body">
                    <xforms:label>Form Details</xforms:label>

                    <xhtml:div style="clear: both">

                        <!-- Handle top-level blocks -->
                        <xforms:repeat nodeset="fr:section | fr:repeat | fr:grid" id="fb-top-level-repeat">

                            <xxforms:variable name="top-level-position" select="position()"/>
                            <xxforms:variable name="is-top-level-current" select="$top-level-position = index('fb-top-level-repeat')"/>

                            <xhtml:div class="fb-top-level-content">
                                <!-- Top-level section -->
                                <xforms:group ref=".[local-name() = 'section']">

                                    <!-- Section name -->
                                    <xxforms:variable name="section-name" select="@context"/>
                                    <!-- Holder element for the section -->
                                    <xxforms:variable name="section-holder" select="$form-instance/*[name() = $section-name]"/>

                                    <!--<xhtml:img src="/apps/fr/style/minus.png" alt="Close section" title="Close section"/>-->

                                    <!-- Editable section title -->
                                    <xforms:group appearance="xxforms:internal" id="fb-section-title-input-container">
                                        <xforms:input id="fb-section-title-input"
                                                      ref="$current-resources/*[name() = $section-name]/label"
                                                      appearance="fr:in-place" class="fb-section-title">
                                            <xforms:label>Section</xforms:label>
                                        </xforms:input>

                                        <!-- Respond to fr-delete event to delete the current section -->
                                        <xforms:action ev:event="fr-delete">
                                            <xforms:setvalue ref="$variables/confirmation-message"
                                                             value="concat('Are you sure you want to delete the current section? ',
                                                                    count(context()/*/xhtml:tr/xhtml:td[xforms:*]),
                                                                    ' controls will be deleted.')"/>

                                            <xforms:setvalue ref="$variables/confirmation-target">fb-section-title-input-container</xforms:setvalue>
                                            <xxforms:show dialog="fb-confirmation-dialog"/>
                                        </xforms:action>
                                        <!-- Respond to confirmation -->
                                        <xforms:action ev:event="fb-confirmation-yes">
                                            <!-- Delete holder element for section -->
                                            <xforms:delete nodeset="$form-instance/*[name() = context()/@context]"/>
                                            <!-- Delete resources for section -->
                                            <xforms:delete xxforms:iterate="$resources/resource/*[name() = context()/@context]" nodeset="."/>

                                            <xforms:action xxforms:iterate="*/xhtml:tr/xhtml:td">
                                                <!-- Delete holder element and resources for control -->
                                                <xforms:action if="exists(xforms:*)">
                                                    <xforms:delete nodeset="$form-instance/*[index('fb-top-level-repeat')]/*[name() = context()/xforms:*/@ref]"/>
                                                    <xforms:delete xxforms:iterate="$resources/resource/*[name() = context()/xforms:*/@ref]" nodeset="."/>
                                                </xforms:action>
                                            </xforms:action>

                                            <!-- Delete section including all controls -->
                                            <xforms:delete nodeset="."/>
                                        </xforms:action>

                                    </xforms:group>

                                    <!-- Section content -->
                                    <xforms:repeat nodeset="fr:section | fr:repeat | fr:grid" id="fb-section-content-repeat">
                                        <xxforms:variable name="section-content-position" select="position()"/>
                                        <xxforms:variable name="is-section-content-current"
                                                          select="$is-top-level-current and $section-content-position = index('fb-section-content-repeat')"/>

                                        <xhtml:div class="fb-section-content">
                                            <!-- Grid within top-level section -->
                                            <xforms:group ref=".[local-name() = 'grid']">
                                                <xxforms:variable name="grid" select="."/>

                                                <xhtml:div class="fb-grid-toolbar fb-toolbar">
                                                    <xforms:trigger appearance="minimal" id="fb-delete-grid-trigger">
                                                        <xforms:label>
                                                            <xforms:label><xhtml:img src="../../../../apps/fr/style/trash.gif" alt="Delete Grid" title="Delete Grid"/></xforms:label>
                                                            <!--<xhtml:span>Delete Grid</xhtml:span>-->
                                                        </xforms:label>
                                                        <xforms:action ev:event="DOMActivate">
                                                            <!-- Ask confirmation -->
                                                            <xforms:setvalue ref="$variables/confirmation-message"
                                                                             value="concat('Are you sure you want to delete the current grid? ',
                                                                                    count(context()/xhtml:tr/xhtml:td[xforms:*]),
                                                                                    ' controls will be deleted.')"/>
                                                            <xforms:setvalue ref="$variables/confirmation-target">fb-delete-grid-trigger</xforms:setvalue>
                                                            <xxforms:show dialog="fb-confirmation-dialog"/>
                                                        </xforms:action>
                                                        <xforms:action ev:event="fb-confirmation-yes">
                                                            <!-- Context is on current grid -->

                                                            <xforms:action xxforms:iterate="xhtml:tr/xhtml:td">
                                                                <!-- Delete holder element and resources -->
                                                                <xforms:action if="exists(xforms:*)">
                                                                    <xforms:delete nodeset="$form-instance/*[index('fb-top-level-repeat')]/*[name() = context()/xforms:*/@ref]"/>
                                                                    <xforms:delete xxforms:iterate="$resources/resource/*[name() = context()/xforms:*/@ref]" nodeset="."/>
                                                                </xforms:action>
                                                            </xforms:action>

                                                            <!-- Delete whole grid element -->
                                                            <xforms:delete nodeset="."/>
                                                        </xforms:action>
                                                    </xforms:trigger>

                                                    <xforms:trigger appearance="full">
                                                        <!-- TODO: row icons -->
                                                        <xforms:label>
                                                            <xhtml:img src="../../../../apps/fr/style/down.gif" alt="Insert Row" title="Insert Row"/>
                                                            <xhtml:span>Insert Row</xhtml:span>
                                                        </xforms:label>
                                                        <xforms:action ev:event="DOMActivate">
                                                            <xforms:action context="$grid">
                                                                <!-- Pointing to current grid element -->
                                                                <xforms:insert context="." nodeset="xhtml:tr"
                                                                               at="index('fb-section-content-grid-tr-repeat')"
                                                                               origin="instance(concat('fb-grid-', context()/@columns, '-template'))/xhtml:tr"/>

                                                            </xforms:action>
                                                        </xforms:action>
                                                    </xforms:trigger>
                                                    <xforms:trigger appearance="full" ref=".[$is-section-content-current and count(xhtml:tr) gt 1]" id="fb-delete-row-trigger">
                                                        <!-- TODO: row icons -->
                                                        <xforms:label>
                                                            <xforms:label><xhtml:img src="../../../../apps/fr/style/trash.gif" alt="Delete Row" title="Delete Row"/></xforms:label>
                                                            <xhtml:span>Delete Row</xhtml:span>
                                                        </xforms:label>
                                                        <xforms:action ev:event="DOMActivate">

                                                            <xxforms:variable name="count" select="count(xhtml:tr[index('fb-section-content-grid-tr-repeat')]/xhtml:td[xforms:*])"/>

                                                            <xforms:action if="$count > 0">
                                                                <!-- Ask confirmation -->
                                                                <xforms:setvalue ref="$variables/confirmation-message"
                                                                                 value="concat('Are you sure you want to delete the current row? ',
                                                                                        $count, ' controls will be deleted.')"/>
                                                                <xforms:setvalue ref="$variables/confirmation-target">fb-delete-row-trigger</xforms:setvalue>
                                                                <xxforms:show dialog="fb-confirmation-dialog"/>
                                                            </xforms:action>
                                                            <xforms:action if="$count = 0">
                                                                <!-- We are automatically confirmed-->
                                                                <xforms:dispatch name="fb-confirmation-yes" target="fb-delete-row-trigger"/>
                                                            </xforms:action>

                                                        </xforms:action>
                                                        <xforms:action ev:event="fb-confirmation-yes">
                                                            <!-- Context is on current grid -->

                                                            <!-- Delete holder elements and resources -->
                                                            <xforms:action xxforms:iterate="xhtml:tr[index('fb-section-content-grid-tr-repeat')]/xhtml:td">
                                                                <xforms:action if="exists(xforms:*)">
                                                                    <xforms:delete nodeset="$form-instance/*[index('fb-top-level-repeat')]/*[name() = context()/xforms:*/@ref]"/>
                                                                    <xforms:delete xxforms:iterate="$resources/resource/*[name() = context()/xforms:*/@ref]" nodeset="."/>
                                                                </xforms:action>
                                                            </xforms:action>

                                                            <!-- Delete whole row including nested controls -->
                                                            <xforms:delete nodeset="xhtml:tr" at="index('fb-section-content-grid-tr-repeat')"/>
                                                        </xforms:action>
                                                    </xforms:trigger>
                                                </xhtml:div>

                                                <!-- Use AVTs to set the style on the div depending on the number of columns -->
                                                <xhtml:div class="fb-grid fb-grid-{count(xhtml:tr[1]/xhtml:td)}-columns">
                                                    <!-- Grid table -->
                                                    <xhtml:table class="fb-grid-table">
                                                        <xhtml:tbody>
                                                            <xhtml:tr>
                                                                <!--<xhtml:td>TODO: row icons</xhtml:td>-->
                                                                <xforms:repeat nodeset="xhtml:tr[1]/xhtml:td" id="fb-section-content-grid-top-repeat">
                                                                    <xxforms:variable name="column-number" select="position()"/>
                                                                    <xhtml:td style="text-align: center">
                                                                        <xhtml:div style="float: left">
                                                                            <xforms:trigger appearance="minimal" ref=".[xs:integer($grid/@columns) lt 4]" id="fb-insert-column-left-trigger">
                                                                                <xforms:label><xhtml:img src="../../../../apps/fr/style/previous.gif" alt="Insert Column" title="Insert Column"/></xforms:label>
                                                                                <xforms:action context="$grid" ev:event="DOMActivate">
                                                                                    <!-- Context is on current grid -->
                                                                                    <xforms:setvalue ref="@columns" value=". + 1"/>

                                                                                    <xforms:action xxforms:iterate="xhtml:tr">
                                                                                        <xforms:insert nodeset="xhtml:td" origin="xxforms:element('xhtml:td')" at="$column-number" position="before"/>
                                                                                    </xforms:action>
                                                                                </xforms:action>
                                                                            </xforms:trigger>
                                                                        </xhtml:div>
                                                                        <xhtml:div style="float: right">
                                                                            <xforms:trigger appearance="minimal" ref=".[xs:integer($grid/@columns) lt 4]" id="fb-insert-column-right-trigger">
                                                                                <xforms:label><xhtml:img src="../../../../apps/fr/style/next.gif" alt="Insert Column" title="Insert Column"/></xforms:label>
                                                                                <xforms:action context="$grid" ev:event="DOMActivate">
                                                                                    <!-- Context is on current grid -->
                                                                                    <xforms:setvalue ref="@columns" value=". + 1"/>

                                                                                    <xforms:action xxforms:iterate="xhtml:tr">
                                                                                        <xforms:insert nodeset="xhtml:td" origin="xxforms:element('xhtml:td')" at="$column-number" position="after"/>
                                                                                    </xforms:action>
                                                                                </xforms:action>
                                                                            </xforms:trigger>
                                                                        </xhtml:div>
                                                                        <xforms:trigger appearance="minimal" ref=".[xs:integer($grid/@columns) gt 1]" id="fb-delete-column-trigger">
                                                                            <xforms:label><xhtml:img src="../../../../apps/fr/style/trash.gif" alt="Delete Column" title="Delete Column"/></xforms:label>
                                                                            <xforms:action ev:event="DOMActivate">

                                                                                <xxforms:variable name="count" select="count($grid/xhtml:tr/xhtml:td[xs:integer($column-number)][xforms:*])"/>

                                                                                <xforms:action if="$count > 0">
                                                                                    <!-- Ask confirmation -->
                                                                                    <xforms:setvalue ref="$variables/confirmation-message"
                                                                                                     value="concat('Are you sure you want to delete the current column? ',
                                                                                                            $count,
                                                                                                            ' controls will be deleted.')"/>
                                                                                    <xforms:setvalue ref="$variables/confirmation-target">fb-delete-column-trigger</xforms:setvalue>
                                                                                    <xxforms:show dialog="fb-confirmation-dialog"/>
                                                                                </xforms:action>
                                                                                <xforms:action if="$count = 0">
                                                                                    <!-- We are automatically confirmed-->
                                                                                    <xforms:dispatch name="fb-confirmation-yes" target="fb-delete-column-trigger"/>
                                                                                </xforms:action>
                                                                            </xforms:action>
                                                                            <xforms:action ev:event="fb-confirmation-yes">
                                                                                <!-- Context is on current grid -->
                                                                                <xforms:setvalue ref="$grid/@columns" value=". - 1"/>

                                                                                <!-- Iterate over rows and in each delete the appropriate column -->
                                                                                <xforms:action xxforms:iterate="$grid/xhtml:tr">
                                                                                    <xforms:action context="xhtml:td[xs:integer($column-number)]">
                                                                                        <!-- Delete holder element, resources, and control -->
                                                                                        <xforms:action if="exists(xforms:*)">
                                                                                            <xforms:delete nodeset="$form-instance/*[index('fb-top-level-repeat')]/*[name() = context()/xforms:*/@ref]"/>
                                                                                            <xforms:delete xxforms:iterate="$resources/resource/*[name() = context()/xforms:*/@ref]" nodeset="."/>
                                                                                        </xforms:action>
                                                                                        <xforms:delete nodeset="."/>
                                                                                    </xforms:action>
                                                                                </xforms:action>
                                                                            </xforms:action>
                                                                        </xforms:trigger>
                                                                    </xhtml:td>
                                                                </xforms:repeat>
                                                            </xhtml:tr>
                                                        </xhtml:tbody>
                                                        <xhtml:tbody>
                                                            <!-- Repeat over table rows -->
                                                            <xforms:repeat nodeset="xhtml:tr" id="fb-section-content-grid-tr-repeat" xxforms:dnd="true">
                                                                <xhtml:tr class="fb-grid-tr">
                                                                    <!--<xhtml:td>TODO: row icons</xhtml:td>-->
                                                                    <!-- Repeat over table columns -->
                                                                    <xforms:repeat nodeset="xhtml:td" id="fb-section-content-grid-td-repeat" xxforms:dnd="true">

                                                                        <xxforms:variable name="control" select="xforms:*[1]"/>
                                                                        <xxforms:variable name="control-name" select="substring-before($control/@id, '-control')"/>
                                                                        <xxforms:variable name="instance-holder" select="$section-holder/*[name() = $control-name]"/>
                                                                        <xxforms:variable name="resource-holder" select="$current-resources/*[name() = $control-name]"/>

                                                                        <xhtml:td class="fb-grid-td">
                                                                            <xhtml:div class="fb-grid-cell-icons">
                                                                                <!-- TODO: For now put here, but move once dnd is there and clicking on cell is enough -->
                                                                                <xforms:trigger appearance="minimal">
                                                                                    <xforms:label><xhtml:img src="../../../../apps/fr/style/drag_handle.gif" alt="Drag" title="Drag"/></xforms:label>
                                                                                </xforms:trigger>
                                                                                <xforms:group ref=".[$control]">

                                                                                    <xforms:trigger appearance="minimal">
                                                                                        <xforms:label><xhtml:img src="../../../../apps/fr/style/trash.gif" alt="Delete Control" title="Delete Control"/></xforms:label>
                                                                                        <xforms:action ev:event="DOMActivate">
                                                                                            <!-- Delete holder element, resources, and control -->
                                                                                            <xforms:dispatch name="fb-delete-control" target="fr-form-model">
                                                                                                <xxforms:context name="control" select="$control"/>
                                                                                            </xforms:dispatch>
                                                                                        </xforms:action>
                                                                                    </xforms:trigger>
                                                                                </xforms:group>
                                                                            </xhtml:div>

                                                                            <xforms:group ref=".[$control]" class="fb-grid-control-icons">
                                                                                <!-- Edit details for any control -->
                                                                                <xforms:trigger appearance="minimal" id="fb-edit-details-trigger">
                                                                                    <xforms:label><xhtml:img class="fb-control-help" alt="Details" title="" src="../../../../apps/fr/style/edit.gif"/></xforms:label>
                                                                                    <xforms:action ev:event="DOMActivate" context="instance('fb-details-editor-instance')">
                                                                                        <xxforms:show dialog="fb-edit-details-dialog" neighbor="fb-edit-details-trigger">
                                                                                            <xxforms:context name="control" select="$control"/>
                                                                                            <xxforms:context name="control-name" select="$control-name"/>
                                                                                            <xxforms:context name="instance-holder" select="$instance-holder"/>
                                                                                        </xxforms:show>
                                                                                    </xforms:action>
                                                                                </xforms:trigger>

                                                                                <!-- Edit help for any control -->
                                                                                <xforms:trigger appearance="minimal" id="fb-edit-help-trigger">
                                                                                    <xforms:label><xhtml:img class="fb-control-help" alt="Help" title="" src="../../../../ops/images/xforms/help.gif"/></xforms:label>
                                                                                    <xforms:action ev:event="DOMActivate">
                                                                                        <xforms:setvalue ref="$variables/result-node" value="$resource-holder/help/saxon:path()"/>
                                                                                        <xxforms:show dialog="fb-edit-help-dialog" neighbor="fb-edit-help-trigger"/>
                                                                                    </xforms:action>
                                                                                </xforms:trigger>

                                                                                <!-- Edit validation for any control -->
                                                                                <xforms:trigger appearance="minimal" id="fb-edit-alert-trigger">
                                                                                    <xforms:label><xhtml:img class="fb-control-alert" alt="Alert" title="" src="../../../../ops/images/xforms/error.gif"/></xforms:label>
                                                                                    <xforms:action ev:event="DOMActivate">
                                                                                        <xforms:setvalue ref="$current-control-name" value="$control-name"/>
                                                                                        <xxforms:show dialog="fb-edit-validation-dialog" neighbor="fb-edit-alert-trigger"/>
                                                                                    </xforms:action>
                                                                                </xforms:trigger>

                                                                                <!-- Change appearance for selection controls -->
                                                                                <xforms:group ref=".[xforms:select1 | xforms:select]">
                                                                                    <xforms:trigger appearance="minimal">
                                                                                        <xforms:label>
                                                                                            <xhtml:img src="../../../../apps/fr/style/update.gif" alt="Switch Appearance" title="Switch Appearance"/>
                                                                                        </xforms:label>
                                                                                        <xforms:action ev:event="DOMActivate">

                                                                                            <!-- select1 minimal -> compact -> full -> select compact -> full -->

                                                                                            <xforms:setvalue ref="$variables/done">false</xforms:setvalue>
                                                                                            <xforms:action if="xforms:select1 and xforms:select1/@appearance = 'full'">
                                                                                                <!-- Switch to xforms:select -->

                                                                                                <!-- Create xforms:select, copy all attributes and children elements, and delete xforms:select1 -->
                                                                                                <xforms:insert nodeset="xforms:select1" origin="xxforms:element('xforms:select')"/>
                                                                                                <xforms:insert context="xforms:select" origin="../xforms:select1/(@*, *)"/>
                                                                                                <xforms:delete nodeset="xforms:select1"/>
                                                                                                <xforms:setvalue ref="xforms:select/@appearance" value="'compact'"/>

                                                                                                <xforms:setvalue ref="$variables/done">true</xforms:setvalue>
                                                                                            </xforms:action>
                                                                                            <xforms:action if="$variables/done != 'true' and xforms:select and xforms:select/@appearance = 'full'">
                                                                                                <!-- Switch to xforms:select1 -->

                                                                                                <!-- Create xforms:select1, copy all attributes and children elements, and delete xforms:select -->
                                                                                                <xforms:insert nodeset="xforms:select" origin="xxforms:element('xforms:select1')"/>
                                                                                                <xforms:insert context="xforms:select1" origin="../xforms:select/(@*, *)"/>
                                                                                                <xforms:delete nodeset="xforms:select"/>
                                                                                                <xforms:setvalue ref="xforms:select1/@appearance" value="'minimal'"/>

                                                                                                <xforms:setvalue ref="$variables/done">true</xforms:setvalue>
                                                                                            </xforms:action>
                                                                                            <xforms:action if="$variables/done != 'true' and xforms:select1">
                                                                                                <!-- Simply update the appearance of xforms:select1 -->
                                                                                                <xforms:setvalue ref="xforms:select1/@appearance"
                                                                                                                 value="if (. = 'minimal') then 'compact' else if (. = 'compact') then 'full' else ."/>
                                                                                            </xforms:action>
                                                                                            <xforms:action if="$variables/done != 'true' and xforms:select">
                                                                                                <!-- Simply update the appearance of xforms:select -->
                                                                                                <xforms:setvalue ref="xforms:select/@appearance"
                                                                                                                 value="if (. = 'compact') then 'full' else ."/>
                                                                                            </xforms:action>

                                                                                        </xforms:action>
                                                                                    </xforms:trigger>
                                                                                </xforms:group>
                                                                            </xforms:group>


                                                                            <xhtml:div class="fb-grid-content">

                                                                                <xforms:group ref=".[$control]">

                                                                                    <!-- Set label for any control -->
                                                                                    <xhtml:span>
                                                                                        <xforms:input id="fb-control-label-control" ref="$resource-holder/label"
                                                                                                      appearance="fr:in-place" class="fb-control-label">
                                                                                            <xforms:label class="fb-xforms-disabled"/>
                                                                                        </xforms:input>
                                                                                    </xhtml:span>

                                                                                    <!-- Display representation of the control -->
                                                                                    <xhtml:div class="fb-control-control">

                                                                                        <xforms:group ref="xforms:input">
                                                                                            <xforms:input ref="$instance-holder">
                                                                                                <xforms:label class="fb-xforms-disabled"/>
                                                                                                <!--<xforms:hint value="$control-name"/>-->
                                                                                            </xforms:input>
                                                                                        </xforms:group>
                                                                                        <xforms:group ref="xforms:textarea">
                                                                                            <xforms:textarea ref="$instance-holder">
                                                                                                <xforms:label class="fb-xforms-disabled"/>
                                                                                            </xforms:textarea>
                                                                                        </xforms:group>
                                                                                        <xforms:group ref="xforms:select1[@appearance = 'minimal']">
                                                                                            <xforms:select1 appearance="minimal" ref="$instance-holder" id="fb-edit-select1-minimal-control">
                                                                                                <xforms:label class="fb-xforms-disabled"/>
                                                                                                <xforms:item>
                                                                                                    <xforms:label>[Choose...]</xforms:label>
                                                                                                    <xforms:value/>
                                                                                                </xforms:item>
                                                                                                <xforms:itemset nodeset="$resource-holder/item">
                                                                                                    <xforms:label ref="label"/>
                                                                                                    <xforms:value ref="value"/>
                                                                                                </xforms:itemset>
                                                                                            </xforms:select1>
                                                                                            <xforms:trigger appearance="minimal">
                                                                                                <xforms:label>Edit</xforms:label>
                                                                                                <xforms:action ev:event="DOMActivate">
                                                                                                    <xforms:setvalue ref="$variables/itemset-resource-id" value="name($resource-holder)"/>
                                                                                                    <xxforms:show dialog="fb-itemset-editor-dialog" neighbor="fb-edit-select1-minimal-control"/>
                                                                                                </xforms:action>
                                                                                            </xforms:trigger>
                                                                                        </xforms:group>
                                                                                        <xforms:group ref="xforms:select1[@appearance = 'full']">
                                                                                            <xforms:select1 appearance="full" ref="$instance-holder" id="fb-edit-select1-full-control">
                                                                                                <xforms:label class="fb-xforms-disabled"/>
                                                                                                <xforms:itemset nodeset="$resource-holder/item">
                                                                                                    <xforms:label ref="label"/>
                                                                                                    <xforms:value ref="value"/>
                                                                                                </xforms:itemset>
                                                                                            </xforms:select1>
                                                                                            <xforms:trigger appearance="minimal">
                                                                                                <xforms:label>Edit</xforms:label>
                                                                                                <xforms:action ev:event="DOMActivate">
                                                                                                    <xforms:setvalue ref="$variables/itemset-resource-id" value="name($resource-holder)"/>
                                                                                                    <xxforms:show dialog="fb-itemset-editor-dialog" neighbor="fb-edit-select1-full-control"/>
                                                                                                </xforms:action>
                                                                                            </xforms:trigger>
                                                                                        </xforms:group>
                                                                                        <xforms:group ref="xforms:select1[@appearance = 'compact']">
                                                                                            <xforms:select1 appearance="compact" ref="$instance-holder" id="fb-edit-select1-compact-control">
                                                                                                <xforms:label class="fb-xforms-disabled"/>
                                                                                                <xforms:itemset nodeset="$resource-holder/item">
                                                                                                    <xforms:label ref="label"/>
                                                                                                    <xforms:value ref="value"/>
                                                                                                </xforms:itemset>
                                                                                            </xforms:select1>
                                                                                            <xforms:trigger appearance="minimal">
                                                                                                <xforms:label>Edit</xforms:label>
                                                                                                <xforms:action ev:event="DOMActivate">
                                                                                                    <xforms:setvalue ref="$variables/itemset-resource-id" value="name($resource-holder)"/>
                                                                                                    <xxforms:show dialog="fb-itemset-editor-dialog" neighbor="fb-edit-select1-compact-control"/>
                                                                                                </xforms:action>
                                                                                            </xforms:trigger>
                                                                                        </xforms:group>
                                                                                        <xforms:group ref="xforms:select[@appearance = 'full']">
                                                                                            <xforms:select appearance="full" ref="$instance-holder" id="fb-edit-select-full-control">
                                                                                                <xforms:label class="fb-xforms-disabled"/>
                                                                                                <xforms:itemset nodeset="$resource-holder/item">
                                                                                                    <xforms:label ref="label"/>
                                                                                                    <xforms:value ref="value"/>
                                                                                                </xforms:itemset>
                                                                                            </xforms:select>
                                                                                            <xforms:trigger appearance="minimal">
                                                                                                <xforms:label>Edit</xforms:label>
                                                                                                <xforms:action ev:event="DOMActivate">
                                                                                                    <xforms:setvalue ref="$variables/itemset-resource-id" value="name($resource-holder)"/>
                                                                                                    <xxforms:show dialog="fb-itemset-editor-dialog" neighbor="fb-edit-select-full-control"/>
                                                                                                </xforms:action>
                                                                                            </xforms:trigger>
                                                                                        </xforms:group>
                                                                                        <xforms:group ref="xforms:select[@appearance = 'compact']">
                                                                                            <xforms:select appearance="compact" ref="$instance-holder" id="fb-edit-select-compact-control">
                                                                                                <xforms:label class="fb-xforms-disabled"/>
                                                                                                <xforms:itemset nodeset="$resource-holder/item">
                                                                                                    <xforms:label ref="label"/>
                                                                                                    <xforms:value ref="value"/>
                                                                                                </xforms:itemset>
                                                                                            </xforms:select>
                                                                                            <xforms:trigger appearance="minimal">
                                                                                                <xforms:label>Edit</xforms:label>
                                                                                                <xforms:action ev:event="DOMActivate">
                                                                                                    <xforms:setvalue ref="$variables/itemset-resource-id" value="name($resource-holder)"/>
                                                                                                    <xxforms:show dialog="fb-itemset-editor-dialog" neighbor="fb-edit-select-compact-control"/>
                                                                                                </xforms:action>
                                                                                            </xforms:trigger>
                                                                                        </xforms:group>
                                                                                        <xforms:group ref="xforms:output[not(@mediatype)]">
                                                                                            <xforms:output ref="$instance-holder" id="fb-edit-output-control">
                                                                                                <xforms:label class="fb-xforms-disabled"/>
                                                                                            </xforms:output>
                                                                                            <xforms:trigger appearance="minimal">
                                                                                                <xforms:label>Edit</xforms:label>
                                                                                                <xforms:action ev:event="DOMActivate">
                                                                                                    <!--<xforms:setvalue ref="$variables/itemset-resource-id" value="name($resource-holder)"/>-->
                                                                                                    <!--<xxforms:show dialog="fb-itemset-editor-dialog" neighbor="fb-edit-select1-minimal-control"/>-->
                                                                                                </xforms:action>
                                                                                            </xforms:trigger>
                                                                                        </xforms:group>
                                                                                        <xforms:group ref="xforms:trigger">
                                                                                            <xforms:trigger ref="$instance-holder" id="fb-edit-trigger-control">
                                                                                                <!-- Trigger shows its label -->
                                                                                                <xforms:label ref="$resource-holder/label"/>
                                                                                            </xforms:trigger>
                                                                                        </xforms:group>
                                                                                        <xforms:group ref="xforms:output[@mediatype = 'image/*']">
                                                                                            <!-- Image -->
                                                                                            <xforms:group ref="$instance-holder[normalize-space() != '']">
                                                                                                <xforms:output ref="." mediatype="image/*" id="fb-edit-output-image-control">
                                                                                                    <xforms:label class="fb-xforms-disabled"/>
                                                                                                </xforms:output>
                                                                                            </xforms:group>
                                                                                            <!-- File chooser -->
                                                                                            <!--<xhtml:img width="16" height="16" src="../../../../forms/orbeon/builder/images/image.png"/>-->
                                                                                            <xforms:upload ref="$instance-holder">
                                                                                                <xforms:label class="fb-xforms-disabled"/>
                                                                                                <xforms:filename ref="@filename"/>
                                                                                                <xforms:mediatype ref="@mediatype"/>
                                                                                                <xxforms:size ref="@size"/>
                                                                                            </xforms:upload>
                                                                                        </xforms:group>
                                                                                        <xforms:group ref="xforms:upload">
                                                                                            <xforms:upload ref="$instance-holder" id="fb-edit-upload-control">
                                                                                                <xforms:label class="fb-xforms-disabled"/>
                                                                                                <xforms:filename ref="@filename"/>
                                                                                                <xforms:mediatype ref="@mediatype"/>
                                                                                                <xxforms:size ref="@size"/>
                                                                                            </xforms:upload>
                                                                                        </xforms:group>
                                                                                    </xhtml:div>

                                                                                    <!-- Edit hint for any control -->
                                                                                    <xhtml:span>
                                                                                        <xforms:input id="fb-control-hint-control" ref="$resource-holder/hint"
                                                                                                      appearance="fr:in-place" class="fb-control-hint">
                                                                                            <xforms:label class="fb-xforms-disabled"/>
                                                                                        </xforms:input>
                                                                                    </xhtml:span>
                                                                                </xforms:group>
                                                                            </xhtml:div>
                                                                        </xhtml:td>
                                                                    </xforms:repeat>
                                                                </xhtml:tr>
                                                            </xforms:repeat>
                                                            <!-- IE hack so that the bottom border shows up -->
                                                            <xhtml:tr>
                                                                <xhtml:td/>
                                                            </xhtml:tr>
                                                        </xhtml:tbody>
                                                    </xhtml:table>
                                                </xhtml:div>
                                            </xforms:group>
                                            <!-- Repeat within top-level section -->
                                            <xforms:group ref=".[local-name() = 'repeat']">

                                                <!-- TODO: Handle nested repeat -->

                                            </xforms:group>
                                            <!-- Section within top-level section -->
                                            <xforms:group ref=".[local-name() = 'section']">

                                                <!-- TODO: Handle nested section-->

                                            </xforms:group>
                                        </xhtml:div>
                                    </xforms:repeat>

                                </xforms:group>

                                <!-- Top-level grid -->
                                <xforms:group ref=".[local-name() = 'grid']">
                                    <xforms:label ref="."/>

                                    <!-- TODO: Handle top-level grid -->

                                </xforms:group>

                                <!-- Top-level repeat -->
                                <xforms:group ref=".[local-name() = 'repeat']">

                                    <!-- TODO: Handle top-level repeat -->

                                </xforms:group>
                            </xhtml:div>
                        </xforms:repeat>
                    </xhtml:div>
                </fr:section>

                <xhtml:div class="fb-toolbar fb-form-toolbar">

                    <!-- Show XML -->
                    <xforms:trigger>
                        <xforms:label>
                            <xhtml:img src="../../../../apps/fr/style/view-xml.gif" alt="Show XML" title="Show XML"/>
                            <xhtml:span>Show XML</xhtml:span>
                        </xforms:label>
                        <xxforms:show ev:event="DOMActivate" dialog="fb-xml-dialog"/>
                    </xforms:trigger>

                    <!-- Edit Source -->
                    <xforms:trigger>
                        <xforms:label>
                            <xhtml:img src="../../../../apps/fr/style/edit.gif" alt="Edit Source" title="Edit Source"/>
                            <xhtml:span>Edit Source</xhtml:span>
                        </xforms:label>
                        <xxforms:show ev:event="DOMActivate" dialog="fb-edit-source-dialog"/>
                    </xforms:trigger>

                    <!-- Upload XML Schema -->
                    <xforms:trigger>
                        <xforms:label>
                            <xhtml:img src="../../../../forms/orbeon/builder/images/upload.png" alt="Upload XML Schema" title="Upload XML Schema"/>
                            <xhtml:span>XML Schema</xhtml:span>
                        </xforms:label>
                        <xxforms:show ev:event="DOMActivate" dialog="fb-schema-upload-dialog"/>
                    </xforms:trigger>

                    <!-- Upload CSS -->
                    <xforms:trigger>
                        <xforms:label>
                            <xhtml:img src="../../../../apps/fr/style/pdf.png" alt="Upload PDF" title="Upload PDF"/>
                            <xhtml:span>Upload CSS</xhtml:span>
                        </xforms:label>
                        <xxforms:show ev:event="DOMActivate" dialog="fb-css-upload-dialog"/>
                    </xforms:trigger>

                    <!-- Upload PDF Template -->
                    <xforms:trigger>
                        <xforms:label>
                            <xhtml:img src="../../../../apps/fr/style/pdf.png" alt="Upload PDF" title="Upload PDF"/>
                            <xhtml:span>Upload PDF</xhtml:span>
                        </xforms:label>
                        <!-- TODO -->
                        <!--<xxforms:show ev:event="DOMActivate" dialog="fb-xml-dialog"/>-->
                    </xforms:trigger>
                </xhtml:div>

                <!-- Edit help -->
                <xxforms:dialog id="fb-edit-help-dialog" appearance="minimal">
                    <xforms:label>Edit Help</xforms:label>
                    <xhtml:div>
                        <xforms:group class="fb-hide-alert">
                            <xforms:textarea ref="$variables/new-text">
                                <xforms:label>Help Message</xforms:label>
                            </xforms:textarea>
                            <xhtml:div class="dialog-buttons">
                                <xforms:trigger class="fr-inplace-rename">
                                    <xforms:label>Change</xforms:label>
                                    <xforms:setvalue ev:event="DOMActivate" ref="$form-instance/root()/saxon:evaluate($variables/result-node)" value="$variables/new-text"/>
                                </xforms:trigger>
                                or
                                <xforms:trigger appearance="minimal" class="fr-inplace-cancel">
                                    <xforms:label>Cancel</xforms:label>
                                </xforms:trigger>
                            </xhtml:div>
                        </xforms:group>
                    </xhtml:div>
                    <!-- Hide dialog -->
                    <xxforms:hide ev:event="DOMActivate" dialog="fb-edit-help-dialog"/>
                    <!-- Copy help value when the dialog opens -->
                    <xforms:setvalue ev:event="xxforms-dialog-open" ref="$variables/new-text" value="$form-instance/root()/saxon:evaluate($variables/result-node)"/>
                </xxforms:dialog>

                <!-- Dialog to show the XML -->
                <xxforms:dialog id="fb-xml-dialog" level="modeless" close="true" draggable="true">
                    <xforms:label>View XML</xforms:label>
                    <xhtml:div class="fb-xml-dialog-view">
                        <xforms:output mediatype="text/html" value="$variables/xml-view"/>
                    </xhtml:div>
                    <xhtml:div class="dialog-buttons">
                        <xforms:trigger>
                            <xforms:label><xhtml:img src="/apps/fr/style/close.gif" alt=""/> <xhtml:span>Close</xhtml:span></xforms:label>
                            <!-- Hide dialog -->
                            <xxforms:hide ev:event="DOMActivate" dialog="fb-xml-dialog"/>
                        </xforms:trigger>
                    </xhtml:div>
                    <!-- Serialize XML when the dialog opens-->
                    <xforms:setvalue ev:event="xxforms-dialog-open" ref="$variables/xml-view"
                                     value="xxforms:serialize(xxforms:call-xpl(
                                         'oxf:/ops/utils/formatting/format.xpl', 'data', instance('fr-form-instance'), 'data')/*, 'html')"/>
                    <!-- Clear XML when the dialog closes-->
                    <xforms:setvalue ev:event="xxforms-dialog-close" ref="$variables/xml-view"/>
                </xxforms:dialog>

                <!-- Dialog to edit the source -->
                <xxforms:dialog id="fb-edit-source-dialog" level="modeless" close="true" draggable="true">
                    <xforms:label>Edit source</xforms:label>
                    <xhtml:div class="fb-xml-dialog-view">
                        <xforms:textarea ref="$variables/new-source"/>
                    </xhtml:div>
                    <xhtml:div class="dialog-buttons">
                        <xhtml:span class="fr-inplace-buttons">
                            <xforms:trigger class="fr-inplace-rename" ref="$variables/new-source-trigger">
                                <xforms:label>Save</xforms:label>
                                <!-- TODO: At the very least, should make sure the XML is well-formed. Even better would be to validate it. -->
                                <xforms:action ev:event="DOMActivate">

                                    <!-- Parse the XML and insert it -->

                                    <!-- TODO: extra line breaks are added as you edit and save the XML -->
                                    <!--<xforms:message level="xxforms:log-debug">-->
                                        <!--<xforms:output value="replace($variables/new-source, '&#x0d;', '&#x0d;')"/>-->
                                    <!--</xforms:message>-->

                                    <xforms:insert nodeset="instance('fr-form-instance')" origin="saxon:parse($variables/new-source)"/>
                                    <!-- Saxon serialization adds an extra meta element -->
                                    <xforms:delete nodeset="instance('fr-form-instance')/xhtml:head/meta[@http-equiv = 'Content-Type']"/>

                                </xforms:action>
                            </xforms:trigger>
                            or
                            <xforms:trigger appearance="minimal" class="fr-inplace-cancel">
                                <xforms:label>Cancel</xforms:label>
                            </xforms:trigger>
                        </xhtml:span>
                    </xhtml:div>
                    <!-- Hide dialog -->
                    <xxforms:hide ev:event="DOMActivate" dialog="fb-edit-source-dialog"/>
                    <!-- Serialize XML when the dialog opens -->
                    <xforms:setvalue ev:event="xxforms-dialog-open" ref="$variables/new-source"
                                     value="saxon:serialize(instance('fr-form-instance'), xxforms:instance('fb-xsl-output-instance'))"/>
                </xxforms:dialog>

                <!-- Add language dialog -->
                <xxforms:dialog id="fb-add-language-dialog" appearance="minimal">
                    <xforms:label>Add Language</xforms:label>
                    <xhtml:div>
                        <xforms:group>
                            <xforms:group class="fb-hide-alert">
                                <xforms:select1 ref="$variables/new-language" id="fb-add-language-select1">
                                    <xforms:label>Add the following language:</xforms:label>
                                    <xforms:item>
                                        <xforms:label>[Select...]</xforms:label>
                                        <xforms:value/>
                                    </xforms:item>
                                    <xforms:itemset model="fr-resources-model"
                                                    nodeset="instance('fr-languages-instance')/language[not(@exclude = 'true') and not(@code = $resources/resource/@xml:lang)]">
                                        <xforms:label value="if (@native-name != @english-name) then concat(@native-name, ' (', @english-name, ')') else @native-name"/>
                                        <xforms:value ref="@code"/>
                                    </xforms:itemset>
                                </xforms:select1>
                            </xforms:group>
                            <xhtml:span class="fr-inplace-buttons">
                                <xforms:trigger class="fr-inplace-rename" ref="$variables/new-language-trigger">
                                    <xforms:label>Add</xforms:label>
                                    <xforms:action ev:event="DOMActivate">
                                        <xforms:insert context="$resources" nodeset="resource" origin="resource[1]"/>
                                        <xforms:setvalue ref="$resources/resource[last()]/@xml:lang" value="$variables/new-language"/>
                                        <xforms:setvalue ref="$lang" value="$variables/new-language"/>
                                    </xforms:action>
                                </xforms:trigger>
                                or
                                <xforms:trigger appearance="minimal" class="fr-inplace-cancel">
                                    <xforms:label>Cancel</xforms:label>
                                </xforms:trigger>
                            </xhtml:span>
                        </xforms:group>
                    </xhtml:div>
                    <!-- Hide dialog -->
                    <xxforms:hide ev:event="DOMActivate" dialog="fb-add-language-dialog"/>
                    <!-- Clear selection list when the dialog opens -->
                    <xforms:action ev:event="xxforms-dialog-open">
                        <xforms:setvalue ref="$variables/new-language"/>
                        <xforms:setfocus control="fb-add-language-select1"/>
                    </xforms:action>
                </xxforms:dialog>

                <!-- Generic confirmation dialog -->
                <xxforms:dialog id="fb-confirmation-dialog" level="modal" close="false" draggable="true">
                    <xforms:label>Confirm</xforms:label>
                    <xhtml:div>
                        <xhtml:img src="/apps/fr/style/question-large.gif" alt="Question" class="dialog-icon"/>
                        <xhtml:div class="dialog-message">
                            <xforms:output value="$variables/confirmation-message"/>
                        </xhtml:div>
                    </xhtml:div>
                    <xhtml:div class="dialog-buttons">
                        <xforms:group>
                            <xforms:trigger>
                                <xforms:label><xhtml:img src="/apps/fr/style/clear.gif" alt=""/> <xhtml:span>Delete</xhtml:span></xforms:label>
                                <xforms:dispatch ev:event="DOMActivate" name="fb-confirmation-yes" target="{$variables/confirmation-target}"/>
                            </xforms:trigger>
                            <xforms:trigger id="fb-confirmation-dialog-cancel-trigger">
                                <xforms:label><xhtml:img src="/apps/fr/style/close.gif" alt=""/> <xhtml:span>Cancel</xhtml:span></xforms:label>
                                <xforms:dispatch ev:event="DOMActivate" name="fb-confirmation-no" target="{$variables/confirmation-target}"/>
                            </xforms:trigger>
                        </xforms:group>
                    </xhtml:div>
                    <!-- Hide dialog -->
                    <xxforms:hide ev:event="DOMActivate" dialog="fb-confirmation-dialog"/>
                    <!-- Set focus when the dialog open  -->
                    <xforms:setfocus ev:event="xxforms-dialog-open" control="fb-confirmation-dialog-cancel-trigger"/>
                </xxforms:dialog>

                <!-- CSS upload dialog -->
                <!--<xi:include href="oxf:/forms/orbeon/builder/form/dialog-css.xml" xxi:omit-xml-base="true"/>-->
                <!-- NOTE: For now don't XInclude, otherwise the Form Runner can't see the fr-attachment -->
                <xxforms:dialog id="fb-css-upload-dialog" level="modal" close="true" draggable="true">

                    <xforms:label>Upload CSS</xforms:label>
                    <xxforms:variable name="attachments-instance" select="$model/xforms:instance[@id = 'fr-form-attachments']/*"/>
                    <xhtml:div>
                        <xhtml:div class="dialog-message">

                            <!-- Upload a CSS file -->
                            <xforms:upload bind="css-attachment-bind" class="fr-attachment">
                                <xforms:label>CSS File</xforms:label>
                                <xforms:filename ref="@filename"/>
                                <xforms:mediatype ref="@mediatype"/>
                                <xxforms:size ref="@size"/>

                                <!-- Clear information when deselected -->
                                <xforms:action ev:event="xforms-deselect">
                                    <!-- Clear uploaded content -->
                                    <xforms:setvalue ref="."/>
                                    <xforms:setvalue ref="@filename"/>
                                    <xforms:setvalue ref="@mediatype"/>
                                    <xforms:setvalue ref="@size"/>
                                </xforms:action>
                            </xforms:upload>

                            <!--<xforms:group context="$attachments-instance/attachment[1]" appearance="xxforms:internal">-->
                                <!--<xhtml:ul>-->
                                    <!--<xhtml:li>-->
                                        <!--<xhtml:p>-->
                                            <!--<xhtml:b>File Name:</xhtml:b>-->
                                            <!--<xforms:output value="@filename"/>-->
                                        <!--</xhtml:p>-->
                                    <!--</xhtml:li>-->
                                    <!--<xhtml:li>-->
                                        <!--<xhtml:p>-->
                                            <!--<xhtml:b>Mediatype:</xhtml:b>-->
                                            <!--<xforms:output value="@mediatype"/>-->
                                        <!--</xhtml:p>-->
                                    <!--</xhtml:li>-->
                                    <!--<xhtml:li>-->
                                        <!--<xhtml:p>-->
                                            <!--<xhtml:b>Size:</xhtml:b>-->
                                            <!--<xforms:output value="@size"/>-->
                                        <!--</xhtml:p>-->
                                    <!--</xhtml:li>-->
                                <!--</xhtml:ul>-->
                            <!--</xforms:group>-->

                        </xhtml:div>
                    </xhtml:div>
                    <xhtml:div class="dialog-buttons">
                        <xforms:group>
                            <xforms:trigger class="xforms-trigger-appearance-modal">
                                <xforms:label>
                                    <!--<xhtml:img src="../../../../forms/orbeon/builder/images/upload.png" alt="Publish" title="Publish"/>-->
                                    <xhtml:span>Done</xhtml:span>
                                </xforms:label>
                            </xforms:trigger>
                        </xforms:group>
                    </xhtml:div>
                    <!-- Hide dialog -->
                    <xxforms:hide ev:event="DOMActivate" dialog="fb-css-upload-dialog"/>
                </xxforms:dialog>

                <!-- Publish dialog -->
                <xi:include href="oxf:/forms/orbeon/builder/form/dialog-publish.xml" xxi:omit-xml-base="true"/>

                <!-- Toolbox dialog -->
                <xi:include href="oxf:/forms/orbeon/builder/form/dialog-toolbox.xml" xxi:omit-xml-base="true"/>

                <!-- Dialog to edit itemsets -->
                <xi:include href="oxf:/forms/orbeon/builder/form/dialog-itemsets.xml" xxi:omit-xml-base="true"/>

                <!-- Edit details -->
                <xi:include href="oxf:/forms/orbeon/builder/form/dialog-details.xml" xxi:omit-xml-base="true"/>

                <!-- Validation dialog -->
                <xi:include href="oxf:/forms/orbeon/builder/form/dialog-validation.xml" xxi:omit-xml-base="true"/>

                <!-- Schema upload -->
                <xi:include href="oxf:/forms/orbeon/builder/form/dialog-schema.xml" xxi:omit-xml-base="true"/>

            </fr:body>
            <fr:buttons>
                <fr:back-button/>
                <fr:clear-button/>

                <!-- Test form -->
                <xforms:trigger>
                    <xforms:label>
                        <xhtml:img src="../../../../forms/orbeon/builder/images/play.png" alt="Test Form" title="Test Form"/>
                        <xhtml:span>Test</xhtml:span>
                    </xforms:label>
                    <xforms:send ev:event="DOMActivate" submission="fb-test-form-submission"/>
                </xforms:trigger>

                <!-- Publish form -->
                <xforms:trigger id="fb-publish-button">
                    <xforms:label>
                        <xhtml:img src="../../../../forms/orbeon/builder/images/upload.png" alt="Publish" title="Publish"/>
                        <xhtml:span>Publish</xhtml:span>
                    </xforms:label>
                    <xforms:action ev:event="DOMActivate">
                        <xxforms:show dialog="fb-publish-dialog"/>
                    </xforms:action>
                </xforms:trigger>

                <!--<fr:print-button/>-->
                <!--<fr:save-locally-button/>-->
                <fr:save-button/>
            </fr:buttons>
        </fr:view>

        <!--<widget:xforms-instance-inspector xmlns:widget="http://orbeon.org/oxf/xml/widget"/>-->
    </xhtml:body>
</xhtml:html>
