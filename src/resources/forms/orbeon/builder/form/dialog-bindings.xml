<?xml version="1.0" encoding="UTF-8"?>
<!--
    Copyright (C) 2008 Orbeon, Inc.

    This program is free software; you can redistribute it and/or modify it under the terms of the
    GNU Lesser General Public License as published by the Free Software Foundation; either version
    2.1 of the License, or (at your option) any later version.

    This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
    without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
    See the GNU Lesser General Public License for more details.

    The full text of the license is available at http://www.gnu.org/copyleft/lesser.html
-->
<xxforms:dialog xmlns:xhtml="http://www.w3.org/1999/xhtml"
      xmlns:xforms="http://www.w3.org/2002/xforms"
      xmlns:xs="http://www.w3.org/2001/XMLSchema"
      xmlns:ev="http://www.w3.org/2001/xml-events"
      xmlns:xi="http://www.w3.org/2001/XInclude"
      xmlns:xxi="http://orbeon.org/oxf/xml/xinclude"
      xmlns:xxforms="http://orbeon.org/oxf/xml/xforms"
      xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
      xmlns:saxon="http://saxon.sf.net/"

      id="fb-bindings-dialog" level="modal" close="true" draggable="true" class="fr-dialog" model="fb-bindings-model">

    <xforms:label>Actions Editor</xforms:label>

    <xxforms:variable name="instance" select="instance('fb-bindings-editor-instance')"/>
    <xhtml:div class="fr-grid">
        <xhtml:div class="fr-grid-content">
            <xforms:group ref="$instance">
                <xforms:input ref="xforms:action[1]/@id" id="fb-binding-id-input" incremental="true">
                    <xforms:label>Action Id</xforms:label>
                    <xforms:hint>Choose a unique id for this action</xforms:hint>
                </xforms:input>
                <xforms:select1 ref="xforms:action[1]/@ev:event">
                    <xforms:label>React to</xforms:label>
                    <xforms:item>
                        <xforms:label>[Select...]</xforms:label>
                        <xforms:value/>
                    </xforms:item>
                    <xforms:item>
                        <xforms:label>Value Change</xforms:label>
                        <xforms:value>xforms-value-changed</xforms:value>
                    </xforms:item>
                    <xforms:item>
                        <xforms:label>Activation</xforms:label>
                        <xforms:value>DOMActivate</xforms:value>
                    </xforms:item>
                    <xforms:item>
                        <xforms:label>Form Load</xforms:label>
                        <xforms:value>xforms-ready</xforms:value>
                    </xforms:item>
                </xforms:select1>
                <!-- TODO: for xforms-ready, must have observer on the model, or no observer attr -->
                <xforms:select1 ref="xforms:action[1]/@ev:observer">
                    <xforms:label>Control</xforms:label>
                    <xforms:item>
                        <xforms:label>[Select...]</xforms:label>
                        <xforms:value/>
                    </xforms:item>
                    <xforms:itemset nodeset="$body//(xforms:*[@ref or @bind or self::xforms:trigger])[ends-with(@id, '-control')]">
                        <!-- TODO: user-friendly control label if non-emtpy -->
                        <xforms:label value="substring-before(@id, '-control')"/>
                        <xforms:value value="@id"/>
                    </xforms:itemset>
                </xforms:select1>
                <xforms:select1 ref="xforms:action[1]/xforms:send/@submission" id="fb-bindings-submission-select">
                    <xforms:label>Service to Call</xforms:label>
                    <xforms:item>
                        <xforms:label>[Select...]</xforms:label>
                        <xforms:value/>
                    </xforms:item>
                    <xforms:itemset nodeset="$model/xforms:submission[ends-with(@id, '-submission')]">
                        <xforms:label value="substring-before(@id, '-submission')"/>
                        <xforms:value value="@id"/>
                    </xforms:itemset>
                </xforms:select1>
                <xforms:group ref="xforms:action[@ev:event = 'xforms-submit']">
                    <xforms:label>Values to Pass to Service</xforms:label>
                    <fr:repeat nodeset="xforms:setvalue" id="fb-bindings-request-repeat" origin="instance('fb-bindings-editor-setvalue-template')" columns="2" appearance="xxforms:table">
                        <xhtml:tr>
                            <xhtml:td>
                                <xforms:select1 ref="@value">
                                    <xforms:label>Source Control</xforms:label>
                                    <xforms:item>
                                        <xforms:label>[Select...]</xforms:label>
                                        <xforms:value/>
                                    </xforms:item>
                                    <xforms:itemset nodeset="$body//xforms:*[(@ref or @bind) and ends-with(@id, '-control')]">
                                        <!-- TODO: user-friendly control label if non-emtpy -->
                                        <xforms:label value="substring-before(@id, '-control')"/>
                                        <xforms:value value="concat('/*/*/*[name() = ''', substring-before(@id, '-control'), ''']')"/>
                                    </xforms:itemset>
                                </xforms:select1>
                            </xhtml:td>
                            <xhtml:td>
                                <xforms:input ref="@ref">
                                    <xforms:label>Destination XPath Expression</xforms:label>
                                </xforms:input>
                            </xhtml:td>
                        </xhtml:tr>
                    </fr:repeat>
                </xforms:group>
                <xforms:group ref="xforms:action[@ev:event = 'xforms-submit-done']">
                    <xforms:label>Actions in Response to Service</xforms:label>
                    <fr:repeat nodeset="xforms:*" id="fb-bindings-response-repeat" origin="instance('fb-bindings-editor-setvalue-template')" columns="2" appearance="xxforms:table">
                        <xhtml:tr>
                            <xhtml:td>
                                <xforms:select1 ref="@name">
                                    <xforms:label>Action</xforms:label>
                                    <xforms:item>
                                        <xforms:label>[Select...]</xforms:label>
                                        <xforms:value/>
                                    </xforms:item>
                                    <xforms:item>
                                        <xforms:label>Set Control Value</xforms:label>
                                        <xforms:value>setvalue</xforms:value>
                                    </xforms:item>
                                    <xforms:item>
                                        <xforms:label>Validate</xforms:label>
                                        <xforms:value>validate</xforms:value>
                                    </xforms:item>
                                    <xforms:item>
                                        <xforms:label>Set Items</xforms:label>
                                        <xforms:value>itemset</xforms:value>
                                    </xforms:item>
                                </xforms:select1>
                            </xhtml:td>
                            <xhtml:td>
                                <xforms:group class="fb-parameters">
                                    <xforms:label>Parameters</xforms:label>
                                    <xforms:group ref=".[self::xforms:setvalue]">
                                        <xforms:input ref="@value">
                                            <xforms:label>Source XPath Expression</xforms:label>
                                        </xforms:input>
                                        <xforms:select1 ref="@ref">
                                            <xforms:label>Destination Control</xforms:label>
                                            <xforms:item>
                                                <xforms:label>[Select...]</xforms:label>
                                                <xforms:value/>
                                            </xforms:item>
                                            <xforms:itemset nodeset="$body//xforms:*[(@ref or @bind) and ends-with(@id, '-control')]">
                                                <xforms:label value="substring-before(@id, '-control')"/>
                                                <xforms:value value="concat('/*/*/*[name() = ''', substring-before(@id, '-control'), ''']')"/>
                                            </xforms:itemset>
                                        </xforms:select1>
                                    </xforms:group>
                                    <xforms:select1 ref="@control-name[../@name = ('setvalue', 'validate', 'itemset')]">
                                        <xforms:label>Destination Control</xforms:label>
                                        <xforms:item>
                                            <xforms:label>[Select...]</xforms:label>
                                            <xforms:value/>
                                        </xforms:item>
                                        <xforms:itemset nodeset="$body//xforms:*[(@ref or @bind) and ends-with(@id, '-control')]">
                                            <xforms:label value="substring-before(@id, '-control')"/>
                                            <xforms:value value="substring-before(@id, '-control')"/>
                                        </xforms:itemset>
                                    </xforms:select1>
                                    <xforms:input ref="@xpath[../@name = ('setvalue', 'validate', 'itemset')]">
                                        <xforms:label>XPath Expression</xforms:label>
                                    </xforms:input>
                                    <xforms:input ref="@label[../@name = 'itemset']">
                                        <xforms:label>Label</xforms:label>
                                    </xforms:input>
                                    <xforms:input ref="@value[../@name = 'itemset']">
                                        <xforms:label>Value</xforms:label>
                                    </xforms:input>
                                </xforms:group>
                            </xhtml:td>
                        </xhtml:tr>
                    </fr:repeat>
                </xforms:group>
                
            </xforms:group>
        </xhtml:div>
    </xhtml:div>

    <xhtml:div class="fr-dialog-buttons">
        <xforms:group>
            <!-- Test button -->
            <xforms:trigger ref="instance('fb-bindings-editor-triggers')/save-test-trigger[false()]">
                <xforms:label>
                    <xhtml:img src="/forms/orbeon/builder/images/play.png" alt="Publish" title="Publish"/>
                    <xhtml:span>Test</xhtml:span>
                </xforms:label>

                <!-- Test submission -->
                <xforms:action ev:event="DOMActivate">
                    <!-- TODO-->
                </xforms:action>
            </xforms:trigger>
            <!-- Save button -->
            <xforms:trigger ref="instance('fb-bindings-editor-triggers')/save-test-trigger">

                <xforms:label>
                    <xhtml:img src="/apps/fr/style/images/silk/disk.png" alt="Publish" title="Publish"/>
                    <xhtml:span>Save</xhtml:span>
                </xforms:label>
                <!-- Save changes to form -->
                <xforms:action ev:event="DOMActivate">

                    <!-- Delete existing binding if any -->
                    <xxforms:variable name="binding-id" select="concat($instance/xforms:action[1]/@id, '-binding')"/>
                    <xforms:action if="$model/xforms:action[@id = $binding-id]">
                        <xforms:delete context="$model" xxforms:iterate="for $action in $model/xforms:action[@id = $binding-id] return ($action, subsequence($action/following-sibling::xforms:action, 1, 2))" nodeset="."/>
                    </xforms:action>

                    <!-- Insert new submission -->
                    <xforms:setvalue ref="$instance/xforms:action[1]/@id" value="$binding-id"/>
                    <xforms:insert context="$model" nodeset="*" origin="$instance/xforms:action"/>

                    <!-- Hide dialog -->
                    <xxforms:hide dialog="fb-bindings-dialog"/>
                </xforms:action>
            </xforms:trigger>
            <xforms:trigger>
                <xforms:label><xhtml:img src="/apps/fr/style/close.gif" alt=""/> <xhtml:span>Cancel</xhtml:span></xforms:label>
                <!-- Hide dialog -->
                <xxforms:hide ev:event="DOMActivate" dialog="fb-bindings-dialog"/>
            </xforms:trigger>
        </xforms:group>
    </xhtml:div>

    <xforms:action ev:event="xxforms-dialog-open">
        <xxforms:variable name="instance" select="instance('fb-bindings-editor-instance')"/>
        <xxforms:variable name="binding-name" select="event('binding-name')"/>

        <!-- Clear instance -->
        <xforms:delete while="$instance/*" nodeset="$instance/*"/>

        <!-- Empty binding if no binding id passed -->
        <xforms:action if="not($binding-name)">
            <xforms:insert context="$instance" origin="instance('fb-binding-template')/*"/>
        </xforms:action>
        <!-- Otherwise copy binding -->
        <xforms:action if="$binding-name">
            <xxforms:variable name="binding-id" select="concat($binding-name, '-binding')"/>
            <!-- Insert action and the two following ones -->
            <xforms:insert context="$instance" origin="for $action in $model/xforms:action[@id = $binding-id] return ($action, subsequence($action/following-sibling::xforms:action, 1, 2))"/>
            <!-- Show the user a name rather than id -->
            <xforms:setvalue ref="$instance/xforms:action[1]/@id" value="$binding-name"/>
            <!--<xforms:message><xforms:output value="$binding-name"/></xforms:message>-->
        </xforms:action>

        <!-- Set focus to first input -->
        <xforms:setfocus control="fb-binding-id-input"/>
    </xforms:action>

    <!-- Model for the bindings editor -->
    <xforms:model id="fb-bindings-model">

        <xxforms:variable name="model" select="xxforms:instance('fr-form-instance')/xhtml:head/xforms:model[@id = 'fr-form-model']"/>

        <xforms:instance id="fb-bindings-editor-instance">
            <!-- Dummy content by default -->
            <binding/>
        </xforms:instance>

        <xforms:instance id="fb-bindings-editor-triggers">
            <triggers>
                <save-test-trigger/>
            </triggers>
        </xforms:instance>

        <!-- Enable/disable trigger -->
        <xforms:setvalue ev:event="xxforms-invalid" ev:observer="fb-bindings-editor-instance" ref="instance('fb-bindings-editor-triggers')/save-test-trigger">disabled</xforms:setvalue>
        <xforms:setvalue ev:event="xxforms-valid" ev:observer="fb-bindings-editor-instance" ref="instance('fb-bindings-editor-triggers')/save-test-trigger">enabled</xforms:setvalue>

        <xforms:bind nodeset="instance('fb-bindings-editor-instance')">
            <xforms:bind nodeset="xforms:action[1]/(@ev:event, xforms:send/@submission)" required="true()"/>
            <xforms:bind nodeset="xforms:action[1]/@ev:observer"
                         required="../@ev:event = ('DOMActivate', 'xforms-value-changed')"
                        relevant="../@ev:event = ('DOMActivate', 'xforms-value-changed')"/>
            <xforms:bind nodeset="xforms:action[position() > 1]/@ev:observer"
                         calculate="../../xforms:action[1]/xforms:send/@submission"/>
        </xforms:bind>

        <xforms:bind nodeset="instance('fb-bindings-editor-triggers')">
            <xforms:bind nodeset="save-test-trigger" readonly=". = 'disabled'"/>
        </xforms:bind>

        <!-- Template for a given binding -->
        <xforms:instance id="fb-binding-template" xxforms:readonly="true">
            <binding>
                <xforms:action id="" ev:event="" ev:observer=""><!-- react to... on control... -->
                    <xforms:send submission=""/><!-- service to call -->
                </xforms:action>
                <xforms:action ev:event="xforms-submit" ev:observer=""><!-- values to set here -->
                    <xforms:setvalue ref="" value=""/><!-- other xforms:setvalue ... -->
                </xforms:action>
                <xforms:action ev:event="xforms-submit-done" ev:observer=""><!-- actions here -->
                    <xforms:setvalue ref="" value=""/><!-- other actions -->
                </xforms:action>
            </binding>
        </xforms:instance>

        <xforms:instance id="fb-bindings-editor-setvalue-template">
            <xforms:setvalue ref="" value=""/>
        </xforms:instance>

        <!--<xforms:instance id="fb-bindings-editor-response-template">-->
            <!--<action name="" xpath="" control-name="" nodeset="" label="" value=""/>-->
        <!--</xforms:instance>-->

    </xforms:model>

</xxforms:dialog>
