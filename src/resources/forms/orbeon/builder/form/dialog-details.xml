<?xml version="1.0" encoding="UTF-8"?>
<!--
    Copyright (C) 2008 Orbeon, Inc.

    This program is free software; you can redistribute it and/or modify it under the terms of the
    GNU Lesser General Public License as published by the Free Software Foundation; either version
    2.1 of the License, or (at your option) any later version.

    This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
    without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
    See the GNU Lesser General Public License for more details.

    The full text of the license is available at http://www.gnu.org/copyleft/lesser.html
-->
<xxforms:dialog xmlns:xhtml="http://www.w3.org/1999/xhtml"
      xmlns:xforms="http://www.w3.org/2002/xforms"
      xmlns:xs="http://www.w3.org/2001/XMLSchema"
      xmlns:ev="http://www.w3.org/2001/xml-events"
      xmlns:xi="http://www.w3.org/2001/XInclude"
      xmlns:xxi="http://orbeon.org/oxf/xml/xinclude"
      xmlns:xxforms="http://orbeon.org/oxf/xml/xforms"
      xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
      xmlns:fb="http://orbeon.org/oxf/xml/form-builder"
      xmlns:saxon="http://saxon.sf.net/"

      id="fb-edit-details-dialog" appearance="minimal" model="fb-details-editor-model">

    <xforms:label>Edit Control Details</xforms:label>

    <xhtml:div>
        <xforms:input ref="control-name" incremental="true" id="fb-edit-details-control-name-input">
            <xforms:label>Control Name</xforms:label>
            <xforms:alert>Name is already in use or incorrect</xforms:alert>
            <!-- Close and save upon DOMActivate -->
            <xforms:dispatch ev:event="DOMActivate" name="xxforms-dialog-close" target="fb-edit-details-dialog"/>
        </xforms:input>
        <xforms:select ref="classes" appearance="full">
            <xforms:label>Summary Page</xforms:label>
            <xforms:item>
                <xforms:label>Show in Summary</xforms:label>
                <xforms:value>fr-summary</xforms:value>
            </xforms:item>
            <xforms:item>
                <xforms:label>Show in Search</xforms:label>
                <xforms:value>fr-search</xforms:value>
            </xforms:item>
        </xforms:select>

        <xhtml:div class="fr-dialog-buttons">
            <xforms:trigger class="fr-inplace-rename" ref="change-trigger">
                <xforms:label>Apply</xforms:label>
                <!-- Close and save upon DOMActivate -->
                <xforms:dispatch ev:event="DOMActivate" name="xxforms-dialog-close" target="fb-edit-details-dialog"/>
            </xforms:trigger>
            or
            <xforms:trigger appearance="minimal" class="fr-inplace-cancel">
                <xforms:label>Cancel</xforms:label>
                <!-- Close and cancel upon DOMActivate -->
                <xforms:dispatch ev:event="DOMActivate" name="xxforms-dialog-close" target="fb-edit-details-dialog">
                    <xxforms:context name="fb:save" select="false()"/>
                </xforms:dispatch>
            </xforms:trigger>
        </xhtml:div>
    </xhtml:div>

    <!-- Save data upon close, unless explicitly prevented -->
    <xforms:action ev:event="xxforms-dialog-close" if="not(event('fb:save') = false())">

        <xxforms:variable name="instance" select="instance('fb-details-editor-instance')"/>

        <xxforms:variable name="instance-holder" select="$form-instance/root()/saxon:evaluate($instance/instance-holder)"/>

        <xxforms:variable name="old-name" select="name($instance-holder)"/>
        <xxforms:variable name="new-name" select="$instance/control-name"/>

        <!-- Find reference to control -->
        <xxforms:variable name="control" select="$body//*[@id = concat($old-name, '-control')]"/>

        <!-- Rename if needed -->
        <xforms:action if="$old-name != $new-name">

            <!-- Rename instance holder and all resources -->
            <xforms:dispatch name="fb-rename-holders" target="fr-form-model">
                <xxforms:context name="holders" select="($instance-holder, $resources/resource/*[name() = $old-name])"/>
                <xxforms:context name="new-name" select="$new-name"/>
            </xforms:dispatch>

            <!-- Update control id and bindings -->
            <xforms:dispatch name="fb-rename-control" target="fr-form-model">
                <xxforms:context name="control" select="$control"/>
                <xxforms:context name="new-name" select="$new-name"/>
            </xforms:dispatch>

            <!-- Rename bind if existing -->
            <xforms:dispatch name="fb-rename-bind" target="fr-form-model">
                <xxforms:context name="old-name" select="$old-name"/>
                <xxforms:context name="new-name" select="$new-name"/>
            </xforms:dispatch>
        </xforms:action>

        <!-- Set proper classes -->
        <xxforms:variable name="classes" select="tokenize($instance/classes, ' ')"/>
        <xforms:delete if="count($classes) = 0" nodeset="$control/@class"/>
        <xforms:insert if="count($classes) > 0" context="$control" origin="xxforms:attribute('class', $instance/classes)"/>

    </xforms:action>

    <!-- Show dialog -->
    <xforms:action ev:event="xxforms-dialog-open">
        <!-- Remember values -->

        <xxforms:variable name="control" select="event('control')"/>

        <xforms:setvalue ref="control-name" value="event('control-name')"/>
        <xforms:setvalue ref="original-control-name" value="event('control-name')"/>
        <xforms:setvalue ref="instance-holder" value="event('instance-holder')/saxon:path()"/>

        <xxforms:variable name="control" select="$body//*[@id = concat(event('control-name'), '-control')]"/>
        <xforms:setvalue ref="classes" value="$control/@class"/>

        <!-- Set focus when the dialog open  -->
        <xforms:setfocus control="fb-edit-details-control-name-input"/>
    </xforms:action>

    <!-- Local model -->
    <xforms:model id="fb-details-editor-model">

        <xxforms:variable name="body" select="xxforms:instance('fr-form-instance')/xhtml:body/fr:view/fr:body"/>
        
        <xforms:instance id="fb-details-editor-instance">
            <details>
                <original-control-name/>
                <control-name/>
                <classes/>
                <instance-holder/>
                <change-trigger/>
            </details>
        </xforms:instance>

        <xforms:bind nodeset="instance('fb-details-editor-instance')">
            <xforms:bind nodeset="control-name"
                             constraint=". = ../original-control-name
                                            or not(concat(normalize-space(), '-section') = $body//fr:section/@id)
                                                and not(concat(normalize-space(), '-control') = $body//*/@id)" type="xs:NCName"/>
            <!-- Annoying that we need to repeat the expression here, but we can't use xxforms:valid().
                 Should use variables once available in binds. -->
            <xforms:bind nodeset="change-trigger"
                            readonly="for $control-name in ../control-name return
                                        not($control-name = ../original-control-name
                                            or not(concat(normalize-space($control-name), '-section') = $body//fr:section/@id)
                                                and not(concat(normalize-space($control-name), '-control') = $body//*/@id))"/>

        </xforms:bind>
    </xforms:model>

</xxforms:dialog>
