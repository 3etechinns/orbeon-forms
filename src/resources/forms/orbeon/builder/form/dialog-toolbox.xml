<?xml version="1.0" encoding="UTF-8"?>
<!--
    Copyright (C) 2008 Orbeon, Inc.

    This program is free software; you can redistribute it and/or modify it under the terms of the
    GNU Lesser General Public License as published by the Free Software Foundation; either version
    2.1 of the License, or (at your option) any later version.

    This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
    without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
    See the GNU Lesser General Public License for more details.

    The full text of the license is available at http://www.gnu.org/copyleft/lesser.html
-->
<xhtml:div xmlns:xhtml="http://www.w3.org/1999/xhtml"
      xmlns:xforms="http://www.w3.org/2002/xforms"
      xmlns:xs="http://www.w3.org/2001/XMLSchema"
      xmlns:ev="http://www.w3.org/2001/xml-events"
      xmlns:xi="http://www.w3.org/2001/XInclude"
      xmlns:xxi="http://orbeon.org/oxf/xml/xinclude"
      xmlns:xxforms="http://orbeon.org/oxf/xml/xforms"
      xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
      xmlns:saxon="http://saxon.sf.net/"
      xmlns:fb="http://orbeon.org/oxf/xml/form-builder"

      id="fb-toolbox">

    <!-- TODO: i18n -->

    <xhtml:div class="fb-toolbox-inside">

        <xhtml:dl id="fb-toolbox-dl" class="accordion-menu">
            <xhtml:dt id="fb-toolbox-controls-dt" class="a-m-t a-m-d-expand">Controls</xhtml:dt>
            <xhtml:dd class="a-m-d a-m-d-expand">
                <xhtml:div class="bd">
                    <!-- XVC toolbox -->
                    <xhtml:div class="fb-tools fb-xvc">
                        <xforms:trigger appearance="minimal" ref="$xcv/cut-trigger">
                            <xforms:label>
                                <xhtml:img src="/apps/fr/style/images/silk/cut.png" alt="Cut" title="Cut"/>
                                <!--<xhtml:span>Cut</xhtml:span>-->
                            </xforms:label>
                            <xforms:action ev:event="DOMActivate">
                                <!-- Copy control -->
                                <xforms:dispatch name="fb-copy-control" target="fr-form-model">
                                    <xxforms:context name="current-td" select="$current-td"/>
                                </xforms:dispatch>
                                <!-- Then delete the source -->
                                <xforms:dispatch name="fb-delete-control" target="fr-form-model">
                                    <xxforms:context name="control" select="$current-td/*[1]"/>
                                </xforms:dispatch>
                            </xforms:action>
                        </xforms:trigger>
                        <xforms:trigger appearance="minimal" ref="$xcv/copy-trigger">
                            <xforms:label>
                                <xhtml:img src="/forms/orbeon/builder/images/copy.gif" alt="Copy" title="Copy"/>
                                <!--<xhtml:span>Copy</xhtml:span>-->
                            </xforms:label>
                            <xforms:action ev:event="DOMActivate">
                                <!-- Copy control -->
                                <xforms:dispatch name="fb-copy-control" target="fr-form-model">
                                    <xxforms:context name="current-td" select="$current-td"/>
                                </xforms:dispatch>
                            </xforms:action>
                        </xforms:trigger>
                        <xforms:trigger appearance="minimal" ref="$xcv/paste-trigger">
                            <xforms:label>
                                <xhtml:img src="/apps/fr/style/images/silk/paste_plain.png" alt="Paste" title="Paste"/>
                                <!--<xhtml:span>Paste</xhtml:span>-->
                            </xforms:label>
                            <xforms:action ev:event="DOMActivate">
                                <!-- Paste control -->
                                <xforms:dispatch name="fb-paste-control" target="fr-form-model"/>
                            </xforms:action>
                        </xforms:trigger>
                    </xhtml:div>
                    <!-- Sections, grids, etc. toolbox -->
                    <xhtml:div class="fb-tools">
                        <!-- Add new section -->
                        <xhtml:div class="fb-tool">
                            <xforms:trigger>
                                <xforms:label>
                                    <xhtml:img src="/apps/fr/style/images/silk/layout_add.png" alt="New Section" title="New Section"/>
                                    <xhtml:span>New Section</xhtml:span>
                                </xforms:label>
                                <xforms:action ev:event="DOMActivate" context="$body">
                                    <!-- Insert section -->

                                    <!-- Insert section template in the UI -->
                                    <xforms:insert context="." nodeset="fr:section | fr:repeat | fr:grid"
                                                   at="index('fb-top-level-repeat')" position="after"
                                                   origin="instance('fb-section-template')"/>

                                    <xxforms:variable name="new-section" select="*[index('fb-top-level-repeat')]" as="element(fr:section)"/>

                                    <!-- Compute next section id -->
                                    <xforms:dispatch target="fr-form-model" name="fb-compute-section-id"/>
                                    <xxforms:variable name="new-section-name" select="concat('section-', $next-section-id)"/>

                                    <!-- Set xforms:label and xforms:help @ref values -->
                                    <xforms:setvalue ref="$new-section/xforms:label/@ref" value="concat('$form-resources/section-', $next-section-id, '/label')"/>
                                    <xforms:setvalue ref="$new-section/xforms:help/@ref" value="concat('$form-resources/section-', $next-section-id, '/help')"/>

                                    <!-- Set @id value -->
                                    <xforms:setvalue ref="$new-section/@id" value="concat($new-section-name, '-section')"/>

                                    <!-- Set @context value if @context present -->
                                    <xforms:setvalue ref="$new-section/@context" value="$new-section-name"/>

                                    <!-- Set @bind value if @bind present -->
                                    <xforms:setvalue ref="$new-section/@bind" value="concat($new-section-name, '-bind')"/>

                                    <!-- Insert container in the instance -->
                                    <xforms:action context="$form-instance">
                                        <!-- TODO: for now assume a top-level section containing a grid -->
                                        <xforms:insert context="." nodeset="*"
                                                       at="index('fb-top-level-repeat')" position="after"
                                                       origin="xxforms:element($new-section-name)"/>

                                    </xforms:action>

                                    <!-- Insert resources placeholders for all languages -->
                                    <xforms:action xxforms:iterate="$resources/resource">
                                        <xforms:insert context="." nodeset="*"
                                                       origin="xxforms:element($new-section-name)"/>

                                        <xforms:insert context="*[last()]" origin="instance('fb-resource-template')/(label | help)"/>
                                    </xforms:action>

                                    <!-- Make sure the bind is created -->
                                    <xforms:dispatch name="fb-ensure-bind" target="fr-form-model">
                                        <xxforms:context name="section-name" select="$new-section-name"/>
                                    </xforms:dispatch>

                                    <!-- Open label editor for newly inserted section -->
                                    <xforms:toggle case="fr-inplace-fb-top-level-section-input-open-edit"/>
                                    <xforms:setfocus control="fr-inplace-fb-top-level-section-input-open-input"/>

                                </xforms:action>
                            </xforms:trigger>
                        </xhtml:div>
                        <!-- Add grids -->
                        <xforms:group context="$current-top-level-block" appearance="xxforms:internal">
                            <xhtml:div class="fb-tool">
                                <xforms:trigger appearance="full">
                                    <xforms:label>
                                        <xhtml:img src="/apps/fr/style/images/silk/table_add.png" alt="New 1-Column Grid" title="New 1-Column Grid"/>
                                        <xhtml:span>New Grid</xhtml:span>
                                    </xforms:label>
                                    <xforms:action ev:event="DOMActivate">
                                        <xforms:insert context="." nodeset="fr:section | fr:repeat | fr:grid"
                                                       at="index('fb-section-content-repeat')" position="after"
                                                       origin="instance('fb-grid-1-template')"/>
                                    </xforms:action>
                                </xforms:trigger>
                            </xhtml:div>
                        </xforms:group>
                    </xhtml:div>
                    <!-- Controls toolbox -->
                    <xhtml:div class="fb-tools">
                        <xforms:repeat nodeset="instance('fb-controls-template')/template" id="fb-controls-template-repeat">

                            <xxforms:variable name="template" select="."/>
                            <xxforms:variable name="control-template" select="xhtml:div/xforms:*"/>

                            <xhtml:div class="fb-tool">
                                <xforms:trigger id="fb-add-control-trigger" ref="instance('fb-variables')/controls-triggers">
                                    <xforms:label>
                                        <xhtml:img src="{if ($template/@image) then $template/@image else concat('/forms/orbeon/builder/images/', $template/xhtml:div/@class, '.png')}" alt="" width="16" height="16"/>
                                        <xforms:output ref="$template/@label"/>
                                    </xforms:label>
                                    <xforms:action ev:event="DOMActivate">
                                        <!-- Insert a new control -->

                                        <!-- Compute next control id -->
                                        <xforms:dispatch target="fr-form-model" name="fb-compute-control-id"/>
                                        <xxforms:variable name="new-control-name" select="concat('control-', $next-control-id)"/>
                                        <xxforms:variable name="section-name" select="$current-td/ancestor::fr:section[1]/(if (@context) then @context else substring-before(@bind, '-bind'))"/>

                                        <!-- Try to find empty td -->
                                        <xforms:dispatch name="fb-ensure-empty-td" target="fr-form-model"/>

                                        <!-- This ensures the context is recomputed -->
                                        <xxforms:variable name="new-td" select="$current-section-content-block/
                                            xhtml:tr[index('fb-section-content-grid-tr-repeat')]/
                                            xhtml:td[index('fb-section-content-grid-td-repeat')]"/>
                                        <xforms:action context="$new-td" if="not(exists(*))">
                                            <!-- Context is now on td and there is room for insertion -->

                                            <!-- Insert control into td -->
                                            <xforms:insert context="." origin="$control-template"/>
                                            <xxforms:variable name="control" select="*[1]"/>
                                            <xxforms:variable name="control-type" select="$control-template/../@class"/>

                                            <!-- Adjust bindings on newly inserted control -->
                                            <xforms:dispatch name="fb-rename-control" target="fr-form-model">
                                                <xxforms:context name="control" select="$control"/>
                                                <xxforms:context name="new-name" select="$new-control-name"/>
                                            </xforms:dispatch>

                                            <!-- Insert instance and resource holders -->
                                            <xforms:dispatch name="fb-insert-holders" target="fr-form-model">
                                                <xxforms:context name="current-td" select="$new-td"/>
                                                <xxforms:context name="section-name" select="$section-name"/>
                                                <!-- Instance holder, with extra attributes if needed -->
                                                <xxforms:context name="instance-holder"
                                                                 select="xxforms:element($new-control-name,
                                                                            if ($control-type = ('upload', 'image'))
                                                                            then (xxforms:attribute('filename'), xxforms:attribute('mediatype'), xxforms:attribute('size'))
                                                                            else ())"/>
                                                <xxforms:context name="resource-holders" select="for $r in $resources/resource return xxforms:element($new-control-name)"/>
                                            </xforms:dispatch>

                                            <!-- Insert bind element -->
                                            <xforms:dispatch name="fb-ensure-bind" target="fr-form-model">
                                                <xxforms:context name="control-name" select="$new-control-name"/>
                                            </xforms:dispatch>
                                            <xxforms:variable name="bind" select="$model//xforms:bind[@nodeset = $new-control-name]"/>

                                            <!-- Use @bind instead of @ref -->
                                            <xforms:delete nodeset="$control/@ref"/>
                                            <xforms:insert context="$control" origin="xxforms:attribute('bind', $bind/@id)"/>

                                            <!-- Set bind type if needed -->
                                            <xforms:insert if="$control-type = 'date-input'" context="$bind" origin="xxforms:attribute('type', 'xs:date')"/>
                                            <xforms:insert if="$control-type = 'time-input'" context="$bind" origin="xxforms:attribute('type', 'xs:time')"/>
                                            <xforms:insert if="$control-type = 'dateTime-input'" context="$bind" origin="xxforms:attribute('type', 'xs:dateTime')"/>
                                            <xforms:insert if="$control-type = ('upload', 'image')" context="$bind" origin="xxforms:attribute('type', 'xs:anyURI')"/>

                                            <!-- Open label editor for newly inserted control -->
                                            <xforms:toggle case="fr-inplace-fb-control-label-control-edit"/>
                                            <xforms:setfocus control="fr-inplace-fb-control-label-control-input"/>

                                        </xforms:action>

                                    </xforms:action>
                                </xforms:trigger>
                            </xhtml:div>
                        </xforms:repeat>
                    </xhtml:div>
                    <!-- Custom components -->
                    <xhtml:div class="fb-tools">
                        <xforms:group ref=".[instance('fb-components-instance')//xbl:binding]">
                            <xforms:label>Component Library</xforms:label>
                            <xforms:repeat nodeset="instance('fb-components-instance')//xbl:binding" id="fb-components-template-repeat">

                                <xxforms:variable name="binding" select="." as="element(xbl:binding)"/>

                                <xhtml:div class="fb-tool">
                                    <xforms:trigger id="fb-add-component-trigger" ref="instance('fb-variables')/controls-triggers">
                                        <xforms:label>
                                            <xhtml:img src="{if ($binding/fb:metadata/fb:icon/fb:small-icon) then $binding/fb:metadata/fb:icon/fb:small-icon else '/apps/fr/style/images/silk/plugin.png'}" alt="" width="16" height="16"/>
                                            <!-- TODO: resolve title using current language instead of taking first one -->
                                            <xforms:output value="$binding/fb:metadata/fb:display-name"/>
                                        </xforms:label>
                                        <xforms:action ev:event="DOMActivate">
                                            <!-- Insert a new control -->

                                            <!-- Compute next control id -->
                                            <xforms:dispatch target="fr-form-model" name="fb-compute-control-id"/>
                                            <xxforms:variable name="new-control-name" select="concat('control-', $next-control-id)"/>
                                            <xxforms:variable name="section-name" select="$current-td/ancestor::fr:section[1]/(if (@context) then @context else substring-before(@bind, '-bind'))"/>

                                            <!-- Try to find empty td -->
                                            <xforms:dispatch name="fb-ensure-empty-td" target="fr-form-model"/>

                                            <!-- This ensures the context is recomputed -->
                                            <xxforms:variable name="new-td" select="$current-section-content-block/
                                                xhtml:tr[index('fb-section-content-grid-tr-repeat')]/
                                                xhtml:td[index('fb-section-content-grid-td-repeat')]"/>
                                            <xforms:action context="$new-td" if="not(exists(*))">
                                                <!-- Context is now on td and there is room for insertion -->

                                                <!-- Insert control into td -->
                                                <xforms:action if="$binding/fb:metadata/fb:template/*">
                                                    <xforms:insert context="." origin="$binding/fb:metadata/fb:template/*[1]"/>
                                                </xforms:action>
                                                <xforms:action if="not($binding/fb:metadata/fb:template/*)">
                                                    <!-- Try to find the binding QName (for now takes the first CSS rule and assume the form foo|bar) -->
                                                    <xxforms:variable name="element-qname" select="replace(normalize-space(tokenize($binding/@element, ',')[1]), '\|', ':')" as="xs:string"/>
                                                    <xforms:insert context="." origin="xxforms:element(resolve-QName($element-qname, $binding))"/>
                                                    <!-- Insert control content (label, hint, help, alert) -->
                                                    <xxforms:variable name="control" select="*[1]"/>
                                                    <xforms:insert context="$control" origin="instance('fb-lhha-template')/*"/>
                                                </xforms:action>

                                                <xxforms:variable name="control" select="*[1]"/>

                                                <!-- Set default pointer to resources if there is an xforms:alert -->
                                                <xforms:setvalue ref="$control/xforms:alert/@ref" value="'$fr-resources/detail/labels/alert'"/>

                                                <!-- Get control type -->
                                                <!-- TODO: for now assume a literal 'xs:' prefix (should resolve namespace) -->
                                                <!--<xxforms:variable name="control-type" select="$binding/xhtml:meta[resolve-QName(@property, .) = xs:QName('xforms:type')]/@content"/>-->
                                                <xxforms:variable name="control-type" select="$binding/fb:metadata/fb:datatype"/>

                                                <!-- Adjust bindings on newly inserted control -->
                                                <xforms:dispatch name="fb-rename-control" target="fr-form-model">
                                                    <xxforms:context name="control" select="$control"/>
                                                    <xxforms:context name="new-name" select="$new-control-name"/>
                                                </xforms:dispatch>

                                                <!-- Insert instance and resource holders -->
                                                <xforms:dispatch name="fb-insert-holders" target="fr-form-model">
                                                    <xxforms:context name="current-td" select="$new-td"/>
                                                    <xxforms:context name="section-name" select="$section-name"/>
                                                    <!-- Instance holder, with extra attributes if needed -->
                                                    <xxforms:context name="instance-holder"
                                                                     select="xxforms:element($new-control-name,
                                                                                if ($control-type = 'xs:anyURI')
                                                                                then (xxforms:attribute('filename'), xxforms:attribute('mediatype'), xxforms:attribute('size'))
                                                                                else ())"/>
                                                    <xxforms:context name="resource-holders" select="for $r in $resources/resource return xxforms:element($new-control-name)"/>
                                                </xforms:dispatch>

                                                <!-- Insert the bind element -->
                                                <xforms:dispatch name="fb-ensure-bind" target="fr-form-model">
                                                    <xxforms:context name="control-name" select="$new-control-name"/>
                                                </xforms:dispatch>
                                                <xxforms:variable name="bind" select="$model//xforms:bind[@nodeset = $new-control-name]"/>

                                                <!-- Make sure there is a @bind instead of a @ref -->
                                                <xforms:delete nodeset="$control/@ref"/>
                                                <xforms:insert context="$control" origin="xxforms:attribute('bind', $bind/@id)"/>

                                                <!-- Set bind type if needed -->
                                                <xforms:insert if="$control-type and not($control-type = 'xs:string')" context="$bind" origin="xxforms:attribute('type', $control-type)"/>

                                                <!-- Open label editor for newly inserted control -->
                                                <xforms:toggle case="fr-inplace-fb-control-label-control-edit"/>
                                                <xforms:setfocus control="fr-inplace-fb-control-label-control-input"/>

                                            </xforms:action>

                                        </xforms:action>
                                    </xforms:trigger>
                                </xhtml:div>
                            </xforms:repeat>
                        </xforms:group>
                    </xhtml:div>
                </xhtml:div>
            </xhtml:dd>
            <xhtml:dt id="fb-toolbox-i18n-dt" class="a-m-t">Internationalization</xhtml:dt>
            <xhtml:dd class="a-m-d">
                <xhtml:div class="bd">
                    <!-- Languages toolbox -->
                    <xhtml:div class="fb-tools">
                        <xforms:group class="fb-language-choice fb-hide-alert">
                            <xforms:select1 appearance="minimal" ref="$fb-lang" id="fb-resources-language-select">
                                <xforms:label>Language</xforms:label>
                                <xforms:itemset nodeset="$resources/resource">
                                    <xforms:label value="xxforms:instance('fr-languages-instance')/language[@code = context()/@xml:lang]/(if (@native-name != @english-name) then concat(@native-name, ' (', @english-name, ')') else @native-name)"/>
                                    <xforms:value ref="@xml:lang"/>
                                </xforms:itemset>
                                <!-- Force RRR when the value changes. The value change doesn't cause a rebuild, therefore the binds don't update. -->
                                <xforms:action ev:event="xforms-value-changed">
                                    <xforms:rebuild model="fr-form-model"/>
                                    <xforms:recalculate model="fr-form-model"/>
                                    <xforms:revalidate model="fr-form-model"/>
                                    <xforms:refresh model="fr-form-model"/>
                                </xforms:action>
                            </xforms:select1>
                            <xforms:group class="fb-language-triggers">
                                <xforms:trigger appearance="minimal">
                                    <xforms:label>
                                        <xhtml:img src="/apps/fr/style/images/silk/add.png" alt="Add Language" title="Add Language"/>
                                        <xhtml:span>Add</xhtml:span>
                                    </xforms:label>
                                    <xxforms:show ev:event="DOMActivate" dialog="fb-add-language-dialog" neighbor="fb-resources-language-select"/>
                                </xforms:trigger>
                                <xforms:trigger appearance="minimal" id="fb-language-remove" ref=".[count($resources/resource) gt 1]">
                                    <xforms:label>
                                        <xhtml:img src="/apps/fr/style/images/silk/delete.png" alt="Remove Language" title="Remove Language"/>
                                        <xhtml:span>Remove</xhtml:span>
                                    </xforms:label>
                                    <xforms:action ev:event="DOMActivate">
                                        <!-- Ask confirmation -->
                                        <xxforms:show dialog="fb-confirmation-dialog">
                                            <xxforms:context name="fr:message"
                                                             select="concat('Are you sure you want to delete all resources for language ''',
                                                                         xxforms:instance('fr-languages-instance')/language[@code = $fb-lang]/(if (@native-name != @english-name) then concat(@native-name, ' (', @english-name, ')') else @native-name),
                                                                         '''?')"/>

                                            <xxforms:context name="fr:confirmation-target" select="'fb-language-remove'"/>
                                        </xxforms:show>
                                    </xforms:action>
                                    <xforms:action ev:event="fb-confirmation-yes">
                                        <!-- Delete resources for this language -->
                                        <xforms:delete nodeset="$resources/resource[@xml:lang = $fb-lang]"/>
                                        <xforms:delete nodeset="$metadata-instance/title[@xml:lang = $fb-lang]"/>
                                        <xforms:delete nodeset="$metadata-instance/description[@xml:lang = $fb-lang]"/>
                                        <xforms:setvalue ref="$fb-lang" value="$resources/resource[1]/@xml:lang"/>

                                        <!-- Force RRR when the value changes. The value change doesn't cause a rebuild, therefore the binds don't update. -->
                                        <xforms:rebuild model="fr-form-model"/>
                                        <xforms:recalculate model="fr-form-model"/>
                                        <xforms:revalidate model="fr-form-model"/>
                                    </xforms:action>
                                </xforms:trigger>
                            </xforms:group>
                        </xforms:group>
                    </xhtml:div>
                </xhtml:div>
            </xhtml:dd>
            <xhtml:dt class="a-m-t">Advanced</xhtml:dt>
            <xhtml:dd class="a-m-d">
                <xhtml:div class="bd">
                    <!-- Actions toolbox -->
                    <xhtml:div class="fb-tools">

                        <xforms:group ref=".[xxforms:property('oxf.fb.menu.schema')]" class="fb-tool">
                            <!-- Upload XML Schema -->
                            <xforms:trigger>
                                <xforms:label>
                                    <xhtml:img src="/forms/orbeon/builder/images/schema.gif" alt="Upload XML Schema" title="Upload XML Schema"/>
                                    <xhtml:span>
                                        <xforms:output value="if (exists($model/xs:schema)) then 'Change Schema' else 'Upload Schema'"/>
                                    </xhtml:span>
                                </xforms:label>
                                <xxforms:show ev:event="DOMActivate" dialog="fb-schema-upload-dialog"/>
                            </xforms:trigger>
                        </xforms:group>
                        <xforms:group ref=".[xxforms:property('oxf.fb.menu.css')]" class="fb-tool">
                            <!--<xhtml:div class="fb-tool">-->
                                <!-- Upload CSS -->
                                <xforms:trigger>
                                    <xforms:label>
                                        <xhtml:img src="/apps/fr/style/images/silk/css.png" alt="Upload CSS" title="Upload CSS"/>
                                        <xhtml:span>
                                            <xforms:output value="if (xxforms:bind('css-attachment-bind') = '') then 'Upload CSS' else 'Change CSS'"/>
                                        </xhtml:span>
                                    </xforms:label>
                                    <xxforms:show ev:event="DOMActivate" dialog="fb-css-upload-dialog"/>
                                </xforms:trigger>
                            <!--</xhtml:div>-->
                        </xforms:group>
                        <xforms:group ref=".[xxforms:property('oxf.fb.menu.pdf')]" class="fb-tool">
                            <!-- Upload PDF Template -->
                            <xforms:trigger>
                                <xforms:label>
                                    <xhtml:img src="/apps/fr/style/pdf.png" alt="Upload PDF" title="Upload PDF"/>
                                    <xhtml:span>
                                        <xforms:output value="if (xxforms:bind('pdf-attachment-bind') = '') then 'Upload PDF' else 'Change PDF'"/>
                                    </xhtml:span>
                                </xforms:label>
                                <xxforms:show ev:event="DOMActivate" dialog="fb-pdf-upload-dialog"/>
                            </xforms:trigger>
                        </xforms:group>
                        <xforms:group ref=".[xxforms:property('oxf.fb.menu.view-source')]" class="fb-tool">
                            <!-- Show XML -->
                            <xforms:trigger>
                                <xforms:label>
                                    <xhtml:img src="/apps/fr/style/view-xml.gif" alt="Show XML" title="Show XML"/>
                                    <xhtml:span>Show Source</xhtml:span>
                                </xforms:label>
                                <xxforms:show ev:event="DOMActivate" dialog="fb-xml-dialog"/>
                            </xforms:trigger>
                        </xforms:group>
                        <xforms:group ref=".[xxforms:property('oxf.fb.menu.edit-source')]" class="fb-tool">
                            <!-- Edit Source -->
                            <xforms:trigger>
                                <xforms:label>
                                    <xhtml:img src="/apps/fr/style/images/silk/xhtml.png" alt="Edit Source" title="Edit Source"/>
                                    <xhtml:span>Edit Source</xhtml:span>
                                </xforms:label>
                                <xxforms:show ev:event="DOMActivate" dialog="fb-source-editor-dialog"/>
                            </xforms:trigger>
                        </xforms:group>
                    </xhtml:div>
                </xhtml:div>
            </xhtml:dd>
            <xhtml:dt class="a-m-t">Services &amp; Actions</xhtml:dt>
            <xhtml:dd class="a-m-d">
                <xhtml:div class="bd">

                    <!-- Services -->
                    <xhtml:div class="fb-tools">
                        <xforms:group class="fb-hide-alert">
                            <xforms:label>HTTP Services</xforms:label>
                            <!-- Repeat over existing services -->
                            <xhtml:ul>
                                <xforms:repeat nodeset="$model/xforms:submission[ends-with(@id, '-submission') and tokenize(@class, ' ') = 'fr-service']">
                                    <xhtml:li>
                                        <xxforms:variable name="submission-name" select="substring-before(@id, '-submission')"/>
                                        <xforms:trigger appearance="minimal">
                                            <xforms:label>
                                                <xhtml:img src="/apps/fr/style/edit.gif" alt="Edit" title="Edit"/>
                                            </xforms:label>
                                            <xxforms:show ev:event="DOMActivate" dialog="fb-service-dialog">
                                                <xxforms:context name="submission-name" select="$submission-name"/>
                                            </xxforms:show>
                                        </xforms:trigger>
                                        <xforms:trigger appearance="minimal" id="fb-submission-remove">
                                            <xforms:label>
                                                <xforms:label><xhtml:img src="/apps/fr/style/images/silk/bin.png" alt="Delete" title="Delete"/></xforms:label>
                                            </xforms:label>
                                            <xforms:action ev:event="DOMActivate">
                                                <!-- Ask confirmation -->
                                                <xxforms:show dialog="fb-confirmation-dialog">
                                                    <xxforms:context name="fr:message"
                                                                     select="concat('Are you sure you want to delete service ''',
                                                                                 $submission-name,
                                                                                 '''?')"/>
                                                    <xxforms:context name="fr:confirmation-target" select="'fb-submission-remove'"/>
                                                </xxforms:show>
                                            </xforms:action>
                                            <xforms:action ev:event="fb-confirmation-yes">
                                                <!-- Delete stuff -->
                                                <xforms:delete nodeset="$model/xforms:submission[@id = context()/@id]"/>
                                                <xforms:delete nodeset="$model/xforms:instance[@id = concat($submission-name, '-instance')]"/>
                                            </xforms:action>
                                        </xforms:trigger>
                                        <xforms:output value="$submission-name"/>
                                    </xhtml:li>
                                </xforms:repeat>
                            </xhtml:ul>
                            <xforms:group>
                                <xforms:trigger appearance="minimal">
                                    <xforms:label>
                                        <xhtml:img src="/apps/fr/style/images/silk/add.png" alt="Add Service" title="Add Service"/>
                                        <xhtml:span>Add</xhtml:span>
                                    </xforms:label>
                                    <xxforms:show ev:event="DOMActivate" dialog="fb-service-dialog"/>
                                </xforms:trigger>
                            </xforms:group>
                        </xforms:group>
                    </xhtml:div>

                    <!-- Database services -->
                    <xhtml:div class="fb-tools">
                        <xforms:group class="fb-hide-alert">
                            <xforms:label>Database Services</xforms:label>
                            <!-- Repeat over existing services -->
                            <xhtml:ul>
                                <xforms:repeat nodeset="$model/xforms:submission[ends-with(@id, '-submission') and tokenize(@class, ' ') = 'fr-database-service']">
                                    <xhtml:li>
                                        <xxforms:variable name="submission-name" select="substring-before(@id, '-submission')"/>
                                        <xforms:trigger appearance="minimal">
                                            <xforms:label>
                                                <xhtml:img src="/apps/fr/style/edit.gif" alt="Edit" title="Edit"/>
                                            </xforms:label>
                                            <xxforms:show ev:event="DOMActivate" dialog="fb-database-service-dialog">
                                                <xxforms:context name="submission-name" select="$submission-name"/>
                                            </xxforms:show>
                                        </xforms:trigger>
                                        <xforms:trigger appearance="minimal" id="fb-database-service-remove">
                                            <xforms:label>
                                                <xforms:label><xhtml:img src="/apps/fr/style/images/silk/bin.png" alt="Delete" title="Delete"/></xforms:label>
                                            </xforms:label>
                                            <xforms:action ev:event="DOMActivate">
                                                <!-- Ask confirmation -->
                                                <xxforms:show dialog="fb-confirmation-dialog">
                                                    <xxforms:context name="fr:message"
                                                                     select="concat('Are you sure you want to delete service ''',
                                                                                 $submission-name,
                                                                                 '''?')"/>
                                                    <xxforms:context name="fr:confirmation-target" select="'fb-database-service-remove'"/>
                                                </xxforms:show>
                                            </xforms:action>
                                            <xforms:action ev:event="fb-confirmation-yes">
                                                <!-- Delete stuff -->
                                                <xforms:delete nodeset="$model/xforms:submission[@id = context()/@id]"/>
                                                <xforms:delete nodeset="$model/xforms:instance[@id = concat($submission-name, '-instance')]"/>
                                            </xforms:action>
                                        </xforms:trigger>
                                        <xforms:output value="$submission-name"/>
                                    </xhtml:li>
                                </xforms:repeat>
                            </xhtml:ul>
                            <xforms:group>
                                <xforms:trigger appearance="minimal">
                                    <xforms:label>
                                        <xhtml:img src="/apps/fr/style/images/silk/add.png" alt="Add Service" title="Add Service"/>
                                        <xhtml:span>Add</xhtml:span>
                                    </xforms:label>
                                    <xxforms:show ev:event="DOMActivate" dialog="fb-database-service-dialog"/>
                                </xforms:trigger>
                            </xforms:group>
                        </xforms:group>
                    </xhtml:div>

                    <!-- Actions -->
                    <xhtml:div class="fb-tools">
                        <xforms:group class="fb-hide-alert">
                            <xforms:label>Actions</xforms:label>
                            <!-- Repeat over existing bindings -->
                            <xhtml:ul>
                                <xforms:repeat nodeset="$model/xforms:action[ends-with(@id, '-binding')]">
                                    <xhtml:li>
                                        <xxforms:variable name="binding-name" select="substring-before(@id, '-binding')"/>
                                        <xforms:trigger appearance="minimal">
                                            <xforms:label>
                                                <xhtml:img src="/apps/fr/style/edit.gif" alt="Edit" title="Edit"/>
                                            </xforms:label>
                                            <xxforms:show ev:event="DOMActivate" dialog="fb-action-dialog">
                                                <xxforms:context name="binding-name" select="$binding-name"/>
                                            </xxforms:show>
                                        </xforms:trigger>
                                        <xforms:trigger appearance="minimal" id="fb-binding-remove">
                                            <xforms:label>
                                                <xforms:label><xhtml:img src="/apps/fr/style/images/silk/bin.png" alt="Delete" title="Delete"/></xforms:label>
                                            </xforms:label>
                                            <xforms:action ev:event="DOMActivate">
                                                <!-- Ask confirmation -->
                                                <xxforms:show dialog="fb-confirmation-dialog">
                                                    <xxforms:context name="fr:message"
                                                                     select="concat('Are you sure you want to delete action ''',
                                                                                 $binding-name,
                                                                                 '''?')"/>
                                                    <xxforms:context name="fr:confirmation-target" select="'fb-binding-remove'"/>
                                                </xxforms:show>
                                            </xforms:action>
                                            <xforms:action ev:event="fb-confirmation-yes">
                                                <!-- Delete stuff -->
                                                <xforms:delete nodeset="$model/xforms:action[@id = context()/@id]"/>
                                            </xforms:action>
                                        </xforms:trigger>
                                        <xforms:output value="$binding-name"/>
                                    </xhtml:li>
                                </xforms:repeat>
                            </xhtml:ul>
                            <xforms:group>
                                <xforms:trigger appearance="minimal">
                                    <xforms:label>
                                        <xhtml:img src="/apps/fr/style/images/silk/add.png" alt="Add Action" title="Add Action"/>
                                        <xhtml:span>Add</xhtml:span>
                                    </xforms:label>
                                    <xxforms:show ev:event="DOMActivate" dialog="fb-action-dialog"/>
                                </xforms:trigger>
                            </xforms:group>
                        </xforms:group>
                    </xhtml:div>
                </xhtml:div>
            </xhtml:dd>
        </xhtml:dl>
    </xhtml:div>

</xhtml:div>
