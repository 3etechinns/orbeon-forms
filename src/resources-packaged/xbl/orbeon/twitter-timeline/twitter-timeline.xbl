<!--
  Copyright (C) 2009 Orbeon, Inc.

  This program is free software; you can redistribute it and/or modify it under the terms of the
  GNU Lesser General Public License as published by the Free Software Foundation; either version
  2.1 of the License, or (at your option) any later version.

  This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
  without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
  See the GNU Lesser General Public License for more details.

  The full text of the license is available at http://www.gnu.org/copyleft/lesser.html
  -->
<xbl:xbl xmlns:xh="http://www.w3.org/1999/xhtml"
         xmlns:xf="http://www.w3.org/2002/xforms"
         xmlns:xs="http://www.w3.org/2001/XMLSchema"
         xmlns:ev="http://www.w3.org/2001/xml-events"
         xmlns:xi="http://www.w3.org/2001/XInclude"
         xmlns:xxi="http://orbeon.org/oxf/xml/xinclude"
         xmlns:xxf="http://orbeon.org/oxf/xml/xforms"
         xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
         xmlns:saxon="http://saxon.sf.net/"
         xmlns:xbl="http://www.w3.org/ns/xbl"
         xmlns:xxbl="http://orbeon.org/oxf/xml/xbl"

         script-type="application/xhtml+xml">

    <xbl:binding id="fr-twitter-timeline-binding" element="fr|twitter-timeline">
        <xbl:resources>
            <!-- CSS style -->
            <xbl:style src="/xbl/orbeon/twitter-timeline/twitter-timeline.css"/>
        </xbl:resources>
        <xbl:template>
            <!-- Local model -->
            <xf:model id="model">
                <!-- Local instance -->
                <xf:instance id="instance">
                    <!-- Copy configuration parameters -->
                    <parameters>
                        <id xbl:attr="xbl:text=username"/>
                        <count xbl:attr="xbl:text=count">5</count>
                    </parameters>
                </xf:instance>

                <xf:instance id="twitter-user-timeline-instance">
                    <statuses>
                        <!-- Example status:
                        <status>
                            <created_at>Fri Oct 24 22:25:01 +0000 2008</created_at>
                            <id>974296158</id>
                            <text>Bummer: &quot;New MacBook Pro Does Not Support 8GB RAM (for now)&quot; http://tinyurl.com/6egzsr</text>
                            <source>&lt;a href=&quot;http://www.twhirl.org/&quot;&gt;twhirl&lt;/a&gt;</source>
                            <truncated>false</truncated>
                            <in_reply_to_status_id/>
                            <in_reply_to_user_id/>
                            <favorited>false</favorited>
                            <user>
                                <id>6087842</id>
                                <name>Erik Bruchez</name>
                                <screen_name>ebruchez</screen_name>
                                <location>Hillsdale, California</location>
                                <description/>
                                <profile_image_url>
                                    http://s3.amazonaws.com/twitter_production/profile_images/59072394/MangaErik_normal.jpg
                                </profile_image_url>
                                <url/>
                                <protected>false</protected>
                                <followers_count>69</followers_count>
                            </user>
                        </status>
                        -->
                    </statuses>
                </xf:instance>

                <!-- Submission to call the twitter API -->
                <xf:submission id="user-timeline-submission"
                       serialization="none"
                       resource="http://twitter.com/statuses/user_timeline/{id}.xml?count={count}"
                       method="get"
                       replace="instance"
                       targetref="instance('twitter-user-timeline-instance')"
                       xxf:username="orbeon_test"
                       xxf:password="orbeon">
                </xf:submission>

                <!-- Load timeline upon initialization -->
                <xf:send submission="user-timeline-submission" ev:event="xforms-model-construct-done"/>

            </xf:model>
            <!-- Local controls -->
            <xf:group>
                <!-- DIV to help styling -->
                <xh:div class="fr-top-shadow"/>
                <xh:div class="fr-container">

                    <!--<xf:submit submission="user-timeline-submission">-->
                        <!--<xf:label>-->
                            <!--Update Timeline for <xf:output value="id"/>-->
                        <!--</xf:label>-->
                    <!--</xf:submit>-->
                    <fr:button class="button">
                        <xf:label>
                            Update Timeline for <xf:output value="id"/>
                        </xf:label>
                        <xf:send ev:event="DOMActivate" submission="user-timeline-submission"/>
                    </fr:button>

                    <!-- Repeat over status -->
                    <xh:div class="statuses">
                        <xf:repeat ref="instance('twitter-user-timeline-instance')/status">
                            <!-- DIV around one status -->
                            <xh:div class="status">
                                <!-- User info -->
                                <xh:div class="user">
                                    <xh:a title="{user/name}" href="http://twitter.com/{user/screen_name}">
                                        <xh:img src="{user/profile_image_url}" alt="{user/name}"/>
                                        <xf:output value="user/screen_name"/>
                                    </xh:a>
                                </xh:div>
                                <!-- Entry -->
                                <xh:div class="entry">
                                    <xh:div>
                                        <!-- Message -->
                                        <xh:span class="message">
                                            <!-- Bunch of regexps to escape, parse links, users, and hash tags with the message -->
                                            <xf:var name="markup-replaced" as="xs:string"
                                                              select="replace(replace(text, '&lt;', '&amp;lt;'), '&quot;', '&amp;quot;')"/>
                                            <xf:var name="url-replaced" as="xs:string"
                                                              select="replace($markup-replaced, '([A-Za-z]+://[A-Za-z0-9\-_]+\.[A-Za-z0-9\-_:%&amp;\?/.=]+)',
                                                                        '&lt;a href=''$1''>$1&lt;/a>')"/>
                                            <xf:var name="user-replaced" as="xs:string"
                                                              select="replace($url-replaced, '[@]+([A-Za-z0-9\-_]+)',
                                                                        '&lt;a href=''http://twitter.com/$1'' rel=''nofollow''>@$1&lt;/a>')"/>
                                            <xf:var name="hash-replaced" as="xs:string"
                                                              select="replace($user-replaced, '[##]+([A-Za-z0-9\-_]+)',
                                                                        '&lt;a href=''http://search.twitter.com/search?q=%23$1'' rel=''nofollow''>#$1&lt;/a>')"/>

                                            <!-- Output the resulting HTML -->
                                            <xf:output mediatype="text/html" value="$hash-replaced"/>
                                        </xh:span>
                                        <!-- Link to tweet -->
                                        <xh:a class="link" rel="bookmark" href="http://twitter.com/{user/screen_name}/status/{id}">
                                            <xh:img src="/apps/fr/style/images/silk/link.png" alt="Link to this tweet"/>
                                        </xh:a>
                                        <!-- Source of the tweet -->
                                        <xh:span class="meta">
                                            <xh:span>posted  from <xf:output mediatype="text/html" value="source"/></xh:span>
                                        </xh:span>
                                    </xh:div>
                                </xh:div>
                                <xh:div class="clear"/>
                            </xh:div>
                        </xf:repeat>
                    </xh:div>
                </xh:div>
                <xh:div class="fr-bottom-shadow"/>
            </xf:group>
        </xbl:template>
    </xbl:binding>
</xbl:xbl>