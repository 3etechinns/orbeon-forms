<!--
    Copyright (C) 2006 Orbeon, Inc.

    This program is free software; you can redistribute it and/or modify it under the terms of the
    GNU Lesser General Public License as published by the Free Software Foundation; either version
    2.1 of the License, or (at your option) any later version.

    This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
    without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
    See the GNU Lesser General Public License for more details.

    The full text of the license is available at http://www.gnu.org/copyleft/lesser.html
-->
<html xmlns:xs="http://www.w3.org/2001/XMLSchema"
      xmlns:xforms="http://www.w3.org/2002/xforms"
      xmlns:ev="http://www.w3.org/2001/xml-events"
      xmlns:xxforms="http://orbeon.org/oxf/xml/xforms"
      xmlns:xi="http://www.w3.org/2001/XInclude"
      xmlns:f="http://orbeon.org/oxf/xml/formatting"
      xmlns:xhtml="http://www.w3.org/1999/xhtml"
      xmlns:dmv="http://orbeon.org/oxf/examples/dmv"
      xmlns:exist="http://exist.sourceforge.net/NS/exist"
      xmlns="http://www.w3.org/1999/xhtml">

    <head>
        <title>OPS DMV Forms Example - Forms List</title>
        <link rel="stylesheet" type="text/css" href="/examples/forms/style.css"/>
        <!-- Main XForms model -->
        <xforms:model id="main-model">

            <xforms:action ev:event="xforms-ready">
                <xforms:send submission="list-documents-submission"/>
                <xforms:setindex repeat="documents-repeat" index="1"/>
            </xforms:action>

            <xforms:instance id="documents-instance">
                <document/>
            </xforms:instance>

            <xforms:instance id="delete-request-instance">
                <request xmlns="">
                    <document-id/>
                </request>
            </xforms:instance>

            <xforms:instance id="list-request-instance">
                <request xmlns=""/>
            </xforms:instance>

            <xforms:instance id="import-request-instance">
                <request xmlns=""/>
            </xforms:instance>

            <xforms:instance id="control-instance">
                <control xmlns="">
                    <detail-uri/>
                    <readonly-uri/>
                    <xml-detail-uri/>
                    <pdf-detail-uri/>
                    <non-empty-triggers/>
                    <empty-triggers/>
                    <non-empty/>
                    <empty/>
                    <error/>
                </control>
            </xforms:instance>

            <xforms:bind nodeset="instance('documents-instance')">
                <xforms:bind nodeset="document-infos/document-info/document-date" type="xs:dateTime"/>
                <xforms:bind nodeset="//dmv:birth-date" type="xs:date"/>
            </xforms:bind>

            <xforms:bind nodeset="instance('control-instance')">
                <xforms:bind nodeset="detail-uri"
                             calculate="concat('/forms/detail?document-id=', instance('documents-instance')/document-infos/document-info[index('documents-repeat')]/document-id)"/>
                <xforms:bind nodeset="readonly-uri"
                             calculate="concat('/forms/detail?document-id=', instance('documents-instance')/document-infos/document-info[index('documents-repeat')]/document-id, '&amp;readonly=true')"/>
                <xforms:bind nodeset="xml-detail-uri"
                             calculate="concat('/exist/rest/db/ops/dmv-example/', instance('documents-instance')/document-infos/document-info[index('documents-repeat')]/document-id)"/>
                <xforms:bind nodeset="pdf-detail-uri"
                             calculate="concat('/direct/forms/pdf-detail?document-id=', instance('documents-instance')/document-infos/document-info[index('documents-repeat')]/document-id)"/>

                <xforms:bind nodeset="non-empty" relevant="count(instance('documents-instance')/document-infos/document-info) > 0"/>
                <xforms:bind nodeset="empty" relevant="count(instance('documents-instance')/document-infos/document-info) = 0"/>

                <xforms:bind nodeset="non-empty-triggers" readonly="not(count(instance('documents-instance')/document-infos/document-info) > 0)"/>
                <xforms:bind nodeset="empty-triggers" readonly="not(count(instance('documents-instance')/document-infos/document-info) = 0)"/>
            </xforms:bind>

            <xforms:submission id="import-documents-submission" ref="instance('import-request-instance')"
                               method="post" action="/forms/service/import-documents" replace="none"/>

            <xforms:instance id="list-documents-query">
                <exist:query>
                    <exist:text>
                        xquery version "1.0";
                        declare namespace dmv="http://orbeon.org/oxf/examples/dmv";
                        declare namespace xmldb="http://exist-db.org/xquery/xmldb";
                        &lt;document-infos>
                            {
                                let $collection-name := '/db/ops/dmv-example/'
                                for $resource-name in xmldb:get-child-resources($collection-name)
                                    let $resource-date := xmldb:last-modified($collection-name, $resource-name)
                                    let $resource := doc(concat($collection-name, $resource-name))
                                    order by $resource-date descending
                                    return
                                    &lt;document-info>
                                        &lt;document-id>{$resource-name}&lt;/document-id>
                                        &lt;document-date>{$resource-date}&lt;/document-date>
                                        &lt;document>
                                            {$resource//dmv:personal-information}
                                            {$resource//dmv:vehicle[1]}
                                        &lt;/document>
                                    &lt;/document-info>
                            }
                        &lt;/document-infos>
                    </exist:text>
                </exist:query>
            </xforms:instance>

            <xforms:submission id="list-documents-submission" ref="instance('list-documents-query')"
                               method="post" action="/exist/rest/db/ops/dmv-example/" replace="instance" instance="documents-instance" f:url-type="resource">
                <xforms:setvalue ev:event="xforms-submit-error" ref="instance('control-instance')/error" value="event('body')"/>
            </xforms:submission>

            <xforms:submission id="delete-document-submission" ref="instance('delete-request-instance')"
                               method="delete" action="/exist/rest/db/ops/dmv-example/{instance('delete-request-instance')/document-id}" replace="none" f:url-type="resource"/>

        </xforms:model>
    </head>
    <body>

        <xhtml:div>
            <xforms:output ref="instance('control-instance')/error" mediatype="text/html"/>
        </xhtml:div>

        <table class="dmv-title-table">
            <tr>
                <td>
                    <img src="/examples/forms/images/dmv-logo.png" alt="DMV"/>
                </td>
                <td>
                    Forms List
                </td>
            </tr>
        </table>

        <table class="dmv-main-table">
            <tr>
                <td>
                    <table class="dmv-action-table">
                        <tr>
                            <td>
                                <xforms:group>
                                    <xforms:load ev:event="DOMActivate" resource="/forms/detail"/>
                                    <xforms:trigger appearance="xxforms:image">
                                        <xforms:label>New Form</xforms:label>
                                        <xxforms:img src="/images/add.gif"/>
                                    </xforms:trigger>
                                    <xforms:trigger appearance="xxforms:link">
                                        <xforms:label>New Form</xforms:label>
                                    </xforms:trigger>
                                </xforms:group>
                            </td>
                            <td>
                                <xforms:group ref="instance('control-instance')/empty-triggers">
                                    <xforms:action ev:event="DOMActivate">
                                        <xforms:send submission="import-documents-submission"/>
                                        <xforms:send submission="list-documents-submission"/>
                                    </xforms:action>
                                    <xforms:trigger appearance="xxforms:image">
                                        <xforms:label>Import Documents</xforms:label>
                                        <xxforms:img src="/images/add-all.gif"/>
                                    </xforms:trigger>
                                    <xforms:trigger appearance="xxforms:link">
                                        <xforms:label>Import Documents</xforms:label>
                                    </xforms:trigger>
                                </xforms:group>
                            </td>
                            <td>
                                <xforms:group ref="instance('control-instance')/non-empty-triggers">
                                    <xforms:action ev:event="DOMActivate">
                                        <xforms:recalculate/>
                                        <xforms:load ref="instance('control-instance')/detail-uri"/>
                                    </xforms:action>
                                    <xforms:trigger appearance="xxforms:image">
                                        <xforms:label>Edit Selected</xforms:label>
                                        <xxforms:img src="/images/edit.gif"/>
                                    </xforms:trigger>
                                    <xforms:trigger appearance="xxforms:link">
                                        <xforms:label>Edit Selected</xforms:label>
                                    </xforms:trigger>
                                </xforms:group>
                            </td>
                            <td>
                                <xforms:group ref="instance('control-instance')/non-empty-triggers">
                                    <xforms:action ev:event="DOMActivate">
                                        <xforms:setvalue ref="instance('delete-request-instance')/document-id" value="instance('documents-instance')/document-infos/document-info[index('documents-repeat')]/document-id"/>
                                        <xforms:send submission="delete-document-submission"/>
                                        <xforms:send submission="list-documents-submission"/>
                                    </xforms:action>
                                    <xforms:trigger appearance="xxforms:image">
                                        <xforms:label>Delete Selected</xforms:label>
                                        <xxforms:img src="/images/remove.gif"/>
                                    </xforms:trigger>
                                    <xforms:trigger appearance="xxforms:link">
                                        <xforms:label>Delete Selected</xforms:label>
                                    </xforms:trigger>
                                </xforms:group>
                            </td>
                            <td>
                                <xforms:group ref="instance('control-instance')/non-empty-triggers">
                                    <xforms:action ev:event="DOMActivate">
                                        <xforms:recalculate/>
                                        <xforms:load ref="instance('control-instance')/readonly-uri"/>
                                    </xforms:action>
                                    <xforms:trigger appearance="xxforms:image">
                                        <xforms:label>View Read-Only</xforms:label>
                                        <xxforms:img src="/images/lockedstate.gif"/>
                                    </xforms:trigger>
                                    <xforms:trigger appearance="xxforms:link">
                                        <xforms:label>View Read-Only</xforms:label>
                                    </xforms:trigger>
                                </xforms:group>
                            </td>
                            <td>
                                <xforms:group ref="instance('control-instance')/non-empty-triggers">
                                    <xforms:action ev:event="DOMActivate">
                                        <xforms:recalculate/>
                                        <xforms:load ref="instance('control-instance')/xml-detail-uri" f:url-type="resource"/>
                                    </xforms:action>
                                    <xforms:trigger appearance="xxforms:image">
                                        <xforms:label>View XML</xforms:label>
                                        <xxforms:img src="/images/view-xml.gif"/>
                                    </xforms:trigger>
                                    <xforms:trigger appearance="xxforms:link">
                                        <xforms:label>View XML</xforms:label>
                                    </xforms:trigger>
                                </xforms:group>
                            </td>
                            <td>
                                <xforms:group ref="instance('control-instance')/non-empty-triggers">
                                    <xforms:action ev:event="DOMActivate">
                                        <xforms:recalculate/>
                                        <xforms:load ref="instance('control-instance')/pdf-detail-uri" f:url-type="resource"/>
                                    </xforms:action>
                                    <xforms:trigger appearance="xxforms:image">
                                        <xforms:label>View PDF</xforms:label>
                                        <xxforms:img src="/images/pdf.png"/>
                                    </xforms:trigger>
                                    <xforms:trigger appearance="xxforms:link">
                                        <xforms:label>View PDF</xforms:label>
                                    </xforms:trigger>
                                </xforms:group>
                            </td>
                        </tr>
                    </table>

                    <xforms:group ref="instance('control-instance')/non-empty">
                        <p>
                            <i>Please select a form in order to perform an operation, or select
                            "New Form" to create a new blank form.</i>
                        </p>
                        <table class="dmv-gridtable">
                            <tr>
                                <th>No.</th>
                                <th>Date Saved</th>
                                <th>Name</th>
                                <th>Birth Date</th>
                                <th>ID No.</th>
                                <th>Vehicle</th>
                            </tr>
                            <xforms:repeat nodeset="instance('documents-instance')/document-infos/document-info/document" id="documents-repeat">
                                <tr>
                                    <td>
                                        <xforms:output value="count(../preceding-sibling::*) + 1"/>
                                    </td>
                                    <td>
                                        <xforms:output ref="../document-date"/>
                                    </td>
                                    <td>
                                        <xforms:output value="concat(dmv:personal-information/dmv:name/dmv:first-name, ' ', dmv:personal-information/dmv:name/dmv:initial, ' ', dmv:personal-information/dmv:name/dmv:last-name)"/>
                                    </td>
                                    <td>
                                        <xforms:output ref="dmv:personal-information/dmv:birth-date"/>
                                    </td>
                                    <td>
                                        <xforms:output value="dmv:personal-information/dmv:driver-license-number"/>
                                    </td>
                                    <td>
                                        <xforms:output value="vehicle/plate-number"/>
                                        <!-- eXist bug, the following should work -->
                                        <!--<xforms:output value="dmv:vehicle/dmv:plate-number"/>-->
                                    </td>
                                </tr>
                            </xforms:repeat>
                            <tr/><!-- This is to work around a bug in IE -->
                        </table>

                        <p>
                            Selected: <xforms:output value="index('documents-repeat')"/> of
                            <xforms:output value="count(instance('documents-instance')/document-infos/document-info)"/>
                        </p>

                    </xforms:group>

                    <xforms:group ref="instance('control-instance')/empty">
                        <table class="dmv-gridtable">
                            <tr>
                                <th>No.</th>
                                <th>Date Saved</th>
                                <th>Name</th>
                                <th>Birth Date</th>
                                <th>DL / ID Card No.</th>
                                <th>Vehicle Information</th>
                            </tr>
                            <tr>
                                <td colspan="6">
                                    <i>
                                        No form found.<br/>Please press the "Import Test Documents"
                                        button to get started.
                                    </i>
                                </td>
                            </tr>
                        </table>
                    </xforms:group>

                </td>
            </tr>
        </table>
    </body>
</html>
