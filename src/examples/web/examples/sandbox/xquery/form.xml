<!--
    Copyright (C) 2004 Orbeon, Inc.
  
    This program is free software; you can redistribute it and/or modify it under the terms of the
    GNU Lesser General Public License as published by the Free Software Foundation; either version
    2.1 of the License, or (at your option) any later version.
  
    This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
    without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
    See the GNU Lesser General Public License for more details.
  
    The full text of the license is available at http://www.gnu.org/copyleft/lesser.html
-->
<xforms:model xmlns:xforms="http://www.w3.org/2002/xforms" >
    <xforms:instance>
        <form>
            <xquery>declare namespace String = "class:java.lang.String"

(: Returns the employees of a given department :)
define function employees($data, $name) {
    $data/company/department[@name = $name]/employee
}

(: Recursive function counting the number of &lt;employee/> elements :)
define function countEmployees($e) {
    typeswitch($e)
        case element(employee,*) return 1
        default return for $i in $e/* return sum(countEmployees($i))
}

(: Call Java code :)
define function maxLastnameLength($employees) {
    let $lengths :=
        for $e in $employees
        return String:length(String:new(string($e/@lastname)))
    return max($lengths)
}

let $company := doc("#data")
let $hrEmployees := employees($company, "HR")
let $engineeringEmployees := employees($company, "Engineering")
return
    &lt;mixed-up-company employee-count="{countEmployees($company)}"
            max-lastname-length="{maxLastnameLength($company/company/department/employee)}">
        {
            for $first in $hrEmployees
            for $second in $engineeringEmployees
            return &lt;employee firstname="{$first/@firstname}" lastname="{$second/@lastname}"/>
        }
    &lt;/mixed-up-company>
</xquery>
        </form>
    </xforms:instance>
</xforms:model>
