<!--
    Copyright (C) 2004 Orbeon, Inc.
  
    This program is free software; you can redistribute it and/or modify it under the terms of the
    GNU Lesser General Public License as published by the Free Software Foundation; either version
    2.1 of the License, or (at your option) any later version.
  
    This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
    without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
    See the GNU Lesser General Public License for more details.
  
    The full text of the license is available at http://www.gnu.org/copyleft/lesser.html
-->
<xforms:model xmlns:xforms="http://www.w3.org/2002/xforms" xmlns:xs="http://www.w3.org/2001/XMLSchema">

    <xforms:instance>
        <credit-card>
            <type>visa</type>
            <number/>
            <expiration-month/>
            <expiration-year/>
            <verification-code/>
            <valid/>
            <gaga/>
        </credit-card>
    </xforms:instance>

    <xforms:bind nodeset="/credit-card/number" type="xs:integer"/>

    <!-- Check expiration month/year -->
    <xforms:bind nodeset="/credit-card/expiration-month"
        constraint="../number = '' or (. castable as xs:integer and . >= 1 and 12 >= .)"/>
    <xforms:bind nodeset="/credit-card/expiration-year"
        constraint="../number = '' or (. castable as xs:integer and string-length(.) = 4)"/>

    <!-- Only display verification code for Visa and MasterCard -->
    <xforms:bind nodeset="/credit-card/verification-code" relevant="../type = 'visa' or ../type = 'mastercard'"/>

    <!-- Formula checking the validity of credit card number -->
    <xforms:bind nodeset="/credit-card/valid" calculate="
        (
            (/credit-card/type = 'visa'
                and (string-length(/credit-card/number) = 13 or string-length(/credit-card/number) = 16)
                and starts-with(/credit-card/number, '4'))
            or (/credit-card/type = 'mastercard'
                and string-length(/credit-card/number) = 16
                and (starts-with(/credit-card/number, '51') or starts-with(/credit-card/number, '52')
                    or starts-with(/credit-card/number, '53') or starts-with(/credit-card/number, '54')
                    or starts-with(/credit-card/number, '55')))
            or (/credit-card/type = 'amex'
                and string-length(/credit-card/number) = 15
                and (starts-with(/credit-card/number, '34') or starts-with(/credit-card/number, '37')))
        )
        and
            (for $mult-number in
                string-join(
                    for $i in 1 to string-length(/credit-card/number) return
                    for $digit in substring(/credit-card/number, $i, 1) return
                    if ($i mod 2 = 1) then xs:string(xs:integer($digit) * 2) else $digit,
                    ''
                )
            return
                for $sum in
                    sum(
                        for $i in 1 to string-length($mult-number)
                        return xs:integer(substring($mult-number, $i, 1))
                    )
                return $sum mod 10 = 0)
        and /credit-card/expiration-month castable as xs:integer
        and /credit-card/expiration-year castable as xs:integer
        and (
            /credit-card/expiration-year > get-year-from-date(current-date())
            or (/credit-card/expiration-year = get-year-from-date(current-date())
                and /credit-card/expiration-month >= get-month-from-date(current-date()))
        )
        "/>
</xforms:model>
