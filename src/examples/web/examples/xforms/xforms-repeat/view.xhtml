<!--
    Copyright (C) 2004 Orbeon, Inc.
  
    This program is free software; you can redistribute it and/or modify it under the terms of the
    GNU Lesser General Public License as published by the Free Software Foundation; either version
    2.1 of the License, or (at your option) any later version.
  
    This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
    without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
    See the GNU Lesser General Public License for more details.
  
    The full text of the license is available at http://www.gnu.org/copyleft/lesser.html
-->
<xhtml:html xmlns:xforms="http://www.w3.org/2002/xforms"
        xmlns:xxforms="http://orbeon.org/oxf/xml/xforms"
        xmlns:ev="http://www.w3.org/2001/xml-events"
        xmlns:f="http://orbeon.org/oxf/xml/formatting" xmlns:xhtml="http://www.w3.org/1999/xhtml">
    <xhtml:head>
        <xhtml:title>XForms Repeating Elements</xhtml:title>
        <xforms:model>
            <xforms:instance id="todo-list">
                <todo-list>
                    <todo description="Bills to pay">
                        <task description="Mobile phone" done=""/>
                        <task description="Internet service provider" done=""/>
                        <task description="Lease" done="true"/>
                        <task description="" done=""/>
                    </todo>
                    <todo description="Buy groceries">
                        <task description="Milk" done=""/>
                        <task description="Bread" done=""/>
                        <task description="Watermelon" done=""/>
                        <task description="Cereals" done=""/>
                        <task description="Jam" done=""/>
                        <task description="" done=""/>
                    </todo>
                    <todo description="">
                        <task description="" done=""/>
                    </todo>
                </todo-list>
            </xforms:instance>
            <xforms:instance id="triggers">
                <triggers>
                    <remove-todo/>
                    <remove-todo-item/>
                </triggers>
            </xforms:instance>
            <xforms:submission method="post"/>
            <xforms:bind nodeset="/todo-list/todo" relevant="count(following-sibling::todo) > 0"/>
            <xforms:bind nodeset="/todo-list/todo/@description" readonly="count(../task) > 1 and count(../task[@done = '']) = 1"/>
            <xforms:bind nodeset="/todo-list/todo/task" relevant="count(following-sibling::task) > 0"/>
            <xforms:bind nodeset="/todo-list/todo/task/@description" readonly="../@done = 'true'"/>
            <xforms:bind nodeset="instance('triggers')/remove-todo" readonly="count(instance('todo-list')/todo) = 1"/>
            <xforms:bind nodeset="instance('triggers')/remove-todo-item" readonly="count(instance('todo-list')/todo[index('todoSet')]/task) = 1"/>
        </xforms:model>
    </xhtml:head>
    <xhtml:body>
        <xforms:group ref="/todo-list">
            <xforms:recalculate ev:event="DOMFocusIn"/> <!-- Doesn't seem to have an effect -->
            <table border="0" cellpadding="0" cellspacing="0">
                <tr>
                    <td>
                        <!-- Actions on to-dos and tasks-->
                        <xhtml:fieldset>
                            <xhtml:legend>To-do List Actions</xhtml:legend>
                            <!-- Add/remove current to-do -->
                            <xhtml:p>
                                <xhtml:span class="fixed-width">Todo:</xhtml:span>
                                <xforms:trigger>
                                    <xforms:label>Add</xforms:label>
                                    <xforms:insert ev:event="DOMActivate" nodeset="/todo-list/todo"
                                        at="min((last(), index('todoSet') + 1))" position="before"/>
                                </xforms:trigger>
                                <xforms:trigger ref="instance('triggers')/remove-todo">
                                    <xforms:label>Remove</xforms:label>
                                    <xforms:action ev:event="DOMActivate">
                                        <xforms:delete nodeset="/todo-list/todo"
                                            at="index('todoSet')"/>
                                        <xforms:setindex repeat="todoSet"
                                            index="max((min((index('todoSet'), count(/todo-list/todo) - 1)), 1))"/>
                                    </xforms:action>
                                </xforms:trigger>
                            </xhtml:p>
                            <!-- Add/remove current task -->
                            <xhtml:p>
                                <xhtml:span class="fixed-width">Todo item:</xhtml:span>
                                <xforms:trigger>
                                    <xforms:label>Add</xforms:label>
                                    <xforms:insert ev:event="DOMActivate" nodeset="/todo-list/todo[index('todoSet')]/task"
                                        at="min((last(), index('taskSet') + 1))" position="before"/>
                                </xforms:trigger>
                                <xforms:trigger ref="instance('triggers')/remove-todo-item">
                                    <xforms:label>Remove</xforms:label>
                                    <xforms:action ev:event="DOMActivate">
                                        <xforms:delete nodeset="/todo-list/todo[index('todoSet')]/task"
                                            at="index('taskSet')"/>
                                        <xforms:setindex repeat="taskSet"
                                            index="max((min((index('taskSet'), count(/todo-list/todo[index('todoSet')]/task) - 1)), 1))"/>
                                    </xforms:action>
                                </xforms:trigger>
                            </xhtml:p>
                        </xhtml:fieldset>
                        <xhtml:div style="margin-top: 3em; padding-left: 1em">
                            <!-- Iterate over todos -->
                            <xforms:repeat nodeset="todo" id="todoSet">
                                <xhtml:div style="padding: .5em 1em .5em 1em">
                                    <xhtml:p>
                                        <xforms:input ref="@description" xhtml:size="30"/>
                                        <xforms:output value="if (count(task) = 1) then ''
                                            else if (count(task[@done = '']) = 1) then 'Done'
                                            else concat(count(task[@done = '']) - 1, ' left')"/>
                                    </xhtml:p>
                                    <!-- Iterate over tasks -->
                                    <xforms:repeat nodeset="task" id="taskSet">
                                        <xhtml:p>
                                            <xforms:output value="if (@done = '') then
                                                concat(count(preceding-sibling::task[@done = '']) + 1, '.') else '-'"
                                                style="width: 2em; display: -moz-inline-box"/>
                                            <xforms:input ref="@description" xhtml:size="30"/>
                                            <xforms:select ref="@done" appearance="full">
                                                <xforms:item>
                                                    <xforms:label>Done</xforms:label>
                                                    <xforms:value>true</xforms:value>
                                                </xforms:item>
                                            </xforms:select>
                                        </xhtml:p>
                                    </xforms:repeat>
                                </xhtml:div>
                            </xforms:repeat>
                        </xhtml:div>
                    </td>
                </tr>
            </table>
        </xforms:group>
    </xhtml:body>
</xhtml:html>
