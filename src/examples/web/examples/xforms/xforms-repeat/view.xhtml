<!--
    Copyright (C) 2004 Orbeon, Inc.
  
    This program is free software; you can redistribute it and/or modify it under the terms of the
    GNU Lesser General Public License as published by the Free Software Foundation; either version
    2.1 of the License, or (at your option) any later version.
  
    This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
    without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
    See the GNU Lesser General Public License for more details.
  
    The full text of the license is available at http://www.gnu.org/copyleft/lesser.html
-->
<xhtml:html xmlns:xforms="http://www.w3.org/2002/xforms"
        xmlns:xxforms="http://orbeon.org/oxf/xml/xforms"
        xmlns:ev="http://www.w3.org/2001/xml-events"
        xmlns:f="http://orbeon.org/oxf/xml/formatting"
        xmlns:xhtml="http://www.w3.org/1999/xhtml"
        xmlns:xs="http://www.w3.org/2001/XMLSchema"
        xmlns:ui="http://www.example.com/ui"
        xmlns:xi="http://www.w3.org/2001/XInclude">
    <xhtml:head>
        <xhtml:title>XForms Repeating Elements</xhtml:title>
        <xforms:model>
            <!-- Data entered by the user -->
            <xforms:instance id="lists">
                <lists initialized="false">
                    <list description="Buy groceries" ui:mode="view" ui:output="" ui:input="" ui:edit-trigger="" ui:save-trigger="">
                        <task description="Milk" due="" done="" ui:mode="view" ui:output="" ui:input="" ui:edit-trigger="" ui:save-trigger=""/>
                        <task description="Bread" due="" done="" ui:mode="view" ui:output="" ui:input="" ui:edit-trigger="" ui:save-trigger=""/>
                        <task description="Watermelon" due="" done="" ui:mode="view" ui:output="" ui:input="" ui:edit-trigger="" ui:save-trigger=""/>
                        <task description="Cereals" due="" done="" ui:mode="view" ui:output="" ui:input="" ui:edit-trigger="" ui:save-trigger=""/>
                        <task description="Jam" due="" done="" ui:mode="view" ui:output="" ui:input="" ui:edit-trigger="" ui:save-trigger=""/>
                        <task description="" due="" done="" ui:mode="edit" ui:output="" ui:input="" ui:edit-trigger="" ui:save-trigger=""/>
                    </list>
                    <list description="Bills to pay" ui:mode="view" ui:output="" ui:input="" ui:edit-trigger="" ui:save-trigger="">
                        <task description="Mobile phone" due="2005-10-24" done="" ui:mode="view" ui:output="" ui:input="" ui:edit-trigger="" ui:save-trigger=""/>
                        <task description="Internet service provider" due="2005-10-29" done="" ui:mode="view" ui:output="" ui:input="" ui:edit-trigger="" ui:save-trigger=""/>
                        <task description="Lease" due="2005-11-01" done="true" ui:mode="view" ui:output="" ui:input="" ui:edit-trigger="" ui:save-trigger=""/>
                        <task description="" due="" done="" ui:mode="edit" ui:output="" ui:input="" ui:edit-trigger="" ui:save-trigger=""/>
                    </list>
                    <list description="" ui:mode="edit" ui:output="" ui:input="" ui:edit-trigger="" ui:save-trigger="">
                        <task description="" due="" done="" ui:mode="edit" ui:output="" ui:input="" ui:edit-trigger="" ui:save-trigger=""/>
                    </list>
                </lists>
            </xforms:instance>
            <xforms:instance id="triggers">
                <triggers>
                    <remove-todo/>
                    <remove-todo-item/>
                </triggers>
            </xforms:instance>
            <xforms:submission method="post"/>
            <!-- Rules that apply to the data entered by the user -->
            <xforms:bind nodeset="/lists/list" relevant="count(following-sibling::list) > 0">
                <xforms:bind nodeset="@description" readonly="count(../task) > 1 and count(../task[@done = '']) = 1"/>
                <xforms:bind nodeset="task" relevant="count(following-sibling::task) > 0">
                    <xforms:bind nodeset="@description" readonly="../@done = 'true'"/>
                    <xforms:bind nodeset="@due" readonly="../@done = 'true'" relevant=". != ''" type="xs:date"/>
                </xforms:bind>
            </xforms:bind>
            <!-- Rules that apply to the UI -->
            <xforms:bind nodeset="/lists/list">
                <xforms:bind nodeset="@ui:output" relevant="../@ui:mode = 'view'"/>
                <xforms:bind nodeset="@ui:input" relevant="../@ui:mode = 'edit'"/>
                <xforms:bind nodeset="@ui:edit-trigger" relevant="../@ui:mode = 'view'"/>
                <xforms:bind nodeset="@ui:save-trigger" relevant="../@ui:mode = 'edit'"/>
                <xforms:bind nodeset="task">
                    <xforms:bind nodeset="@ui:output" relevant="../@ui:mode = 'view'"/>
                    <xforms:bind nodeset="@ui:input" relevant="../@ui:mode = 'edit'"/>
                    <xforms:bind nodeset="@ui:edit-trigger" relevant="../@ui:mode = 'view'"/>
                    <xforms:bind nodeset="@ui:save-trigger" relevant="../@ui:mode = 'edit'"/>
                </xforms:bind>
            </xforms:bind>
            <xforms:bind nodeset="instance('triggers')">
                <xforms:bind nodeset="remove-list" readonly="count(instance('lists')/list) = 1"/>
                <xforms:bind nodeset="remove-list-item" readonly="count(instance('lists')/list[index('listSet')]/task) = 1"/>
            </xforms:bind>
        </xforms:model>
    </xhtml:head>
    <xhtml:body>
        <!-- Styles used just for this example -->
        <xhtml:style type="text/css">
            .actions-label { margin-top: 1em; margin-bottom: .5em; }
            .actions-list { margin-left: 2em; }
            .actions-action { margin-left: 1em; }
            .lists-container   { margin-top: 2em; }
            .list-container   { padding: 5px; margin-top:1em; margin-bottom: 5px; }
            .todo-conatiner   { padding: 4px; }
        </xhtml:style>

        <!-- Actions on list -->
        <xhtml:div class="actions-label">Actions on selected todo list:</xhtml:div>
        <xhtml:div class="actions-list">
            <!-- Edit description -->
            <xforms:group class="actions-action">
                <xforms:setvalue ev:event="DOMActivate" ref="../@ui:mode" value="'edit'"/>
                <xforms:trigger appearance="xxforms:image">
                    <xxforms:img src="/images/edit.gif"/>
                </xforms:trigger>
                <xforms:trigger appearance="xxforms:link">
                    <xforms:label>Edit description</xforms:label>
                </xforms:trigger>
            </xforms:group>
            <!-- Create new list -->
            <xforms:group class="actions-action">
                <xforms:insert ev:event="DOMActivate" nodeset="/lists/list"
                    at="min((last(), index('listSet') + 1))" position="before"/>
                <xforms:trigger appearance="xxforms:image">
                    <xxforms:img src="/images/add.gif"/>
                </xforms:trigger>
                <xforms:trigger appearance="xxforms:link">
                    <xforms:label>Create new list</xforms:label>
                </xforms:trigger>
            </xforms:group>
            <!-- Delete current list -->
            <xforms:group class="actions-action">
                <xforms:action ev:event="DOMActivate">
                    <xforms:delete nodeset="/lists/list"
                        at="index('listSet')"/>
                    <xforms:setindex repeat="listSet"
                        index="max((min((index('listSet'), count(/lists/list) - 1)), 1))"/>
                </xforms:action>
                <xforms:trigger appearance="xxforms:image">
                    <xxforms:img src="/images/remove.gif"/>
                </xforms:trigger>
                <xforms:trigger appearance="xxforms:link">
                    <xforms:label>Delete current list</xforms:label>
                </xforms:trigger>
            </xforms:group>
        </xhtml:div>

        <!-- Actions on to-do -->
        <xhtml:div class="actions-label">Actions on selected todo:</xhtml:div>
        <xhtml:div class="actions-list">
            <!-- Edit description -->
            <xforms:group class="actions-action">
                <xforms:setvalue ev:event="DOMActivate" ref="../@ui:mode" value="'edit'"/>
                <xforms:trigger appearance="xxforms:image">
                    <xxforms:img src="/images/edit.gif"/>
                </xforms:trigger>
                <xforms:trigger appearance="xxforms:link">
                    <xforms:label>Edit description</xforms:label>
                </xforms:trigger>
            </xforms:group>
            <!-- Create new to-do -->
            <xforms:group class="actions-action">
                <xforms:insert ev:event="DOMActivate" nodeset="/lists/list[index('listSet')]/task"
                    at="min((last(), index('taskSet') + 1))" position="before"/>
                <xforms:trigger appearance="xxforms:image">
                    <xxforms:img src="/images/add.gif"/>
                </xforms:trigger>
                <xforms:trigger appearance="xxforms:link">
                    <xforms:label>Add new todo</xforms:label>
                </xforms:trigger>
            </xforms:group>
            <!-- Delete current to-do -->
            <xforms:group class="actions-action">
                <xforms:action ev:event="DOMActivate">
                    <xforms:delete nodeset="/lists/list[index('listSet')]/task"
                        at="index('taskSet')"/>
                    <xforms:setindex repeat="taskSet"
                        index="max((min((index('taskSet'), count(/lists/list[index('listSet')]/task) - 1)), 1))"/>
                </xforms:action>
                <xforms:trigger appearance="xxforms:image">
                    <xxforms:img src="/images/remove.gif"/>
                </xforms:trigger>
                <xforms:trigger appearance="xxforms:link">
                    <xforms:label>Delete current todo</xforms:label>
                </xforms:trigger>
            </xforms:group>
            <!-- Add due date -->
            <xforms:group class="actions-action">
                <xforms:insert ev:event="DOMActivate" nodeset="/lists/list[index('listSet')]/task"
                    at="min((last(), index('taskSet') + 1))" position="before"/>
                <xforms:trigger appearance="xxforms:image">
                    <xxforms:img src="/images/date-add.gif"/>
                </xforms:trigger>
                <xforms:trigger appearance="xxforms:link">
                    <xforms:label>Add due date</xforms:label>
                </xforms:trigger>
            </xforms:group>
        </xhtml:div>

        <!-- Iterate over lists -->
        <xhtml:div class="lists-container">
            <xforms:repeat nodeset="list" id="list">
                <xhtml:div class="list-container">
                    <xhtml:div>
                        <!-- Description -->
                        <xi:include href="view-description.xhtml"/>
                        <!-- How many to-do are left -->
                        <xforms:output value="if (count(task) = 1) then ''
                            else if (count(task[@done = '']) = 1) then '(Done)'
                            else concat('(', count(task[@done = '']) - 1, ' left)')"/>
                    </xhtml:div>
                    <xhtml:div style="padding: 5px">
                        <!-- Iterate over to-dos -->
                        <xforms:repeat nodeset="task" id="task">
                            <xhtml:div class="todo-container">
                                <!-- Icon signaling the status of this to-do -->
                                <xforms:output value="concat('../images/status-',
                                    if (@done = 'true') then 'done' else 'in-progress', '.gif')" mediatype="image/*"/>
                                <!-- Position of current to-do -->
                                <xforms:output value="if (@done = '') then
                                    concat(count(preceding-sibling::task[@done = '']) + 1, '.') else '-'"
                                    style="width: 15px; display: -moz-inline-box"/>
                                <!-- Description -->
                                <xi:include href="view-description.xhtml"/>
                                <xforms:group ref="@due">
                                    -- due on:
                                    <xforms:input ref="."/>
                                </xforms:group>
                            </xhtml:div>
                        </xforms:repeat>
                    </xhtml:div>
                </xhtml:div>
            </xforms:repeat>
        </xhtml:div>
    </xhtml:body>
</xhtml:html>
