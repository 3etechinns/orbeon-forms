<?xml version="1.0" encoding="ISO-8859-1"?>
<!--
    Copyright (C) 2004 Orbeon, Inc.

    This program is free software; you can redistribute it and/or modify it under the terms of the
    GNU Lesser General Public License as published by the Free Software Foundation; either version
    2.1 of the License, or (at your option) any later version.

    This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
    without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
    See the GNU Lesser General Public License for more details.

    The full text of the license is available at http://www.gnu.org/copyleft/lesser.html
-->
<group description="Cache" xmlns:p="http://www.orbeon.com/oxf/pipeline" 
    xmlns:oxf="http://www.orbeon.com/oxf/processors">

    <test description="Simple URL Generator" name="oxf:test">
        <input name="config">
            <script>
                <processor name="oxf:url-generator" xmlns:oxf="http://www.orbeon.com/oxf/processors">
                    <input name="config">
                        <config>
                            <url>cache/document1.xml</url>
                        </config>
                    </input>
                </processor>
                <touch url="cache/document1.xml"/>
                <wait delay="2090"/>
                <cache-value output-name="data" value="v1"/>
                <assert output-name="data" condition="cached-value-equal" value="v1"/>
                <touch url="cache/document1.xml"/>
                <wait delay="2090"/><!-- Do this for now because last modified values are cached for 2 seconds -->
                <assert output-name="data" condition="output-not-cached"/>
                <cache-value output-name="data" value="v2"/>
                <assert output-name="data" condition="output-cached"/>
                <assert output-name="data" condition="cached-value-equal" value="v2"/>
                <assert output-name="data" condition="cached-value-equal" value="v2"/>
            </script>
        </input>
    </test>

    <test description="URL Generator With XInclude" name="oxf:test">
        <input name="config">
            <script>
                <processor name="oxf:url-generator" xmlns:oxf="http://www.orbeon.com/oxf/processors">
                    <input name="config">
                        <config>
                            <url>cache/document3.xml</url>
                        </config>
                    </input>
                </processor>
                <touch url="cache/document3.xml"/>
                <wait delay="2090"/>
                <cache-value output-name="data" value="v1"/>
                <assert output-name="data" condition="cached-value-equal" value="v1"/>
                <touch url="cache/document3.xml"/>
                <wait delay="2090"/>
                <assert output-name="data" condition="output-not-cached"/>
                <cache-value output-name="data" value="v2"/>
                <assert output-name="data" condition="cached-value-equal" value="v2"/>
                <touch url="cache/document2.xml"/>
                <wait delay="2090"/>
                <assert output-name="data" condition="output-not-cached"/>
                <cache-value output-name="data" value="v3"/>
                <assert output-name="data" condition="cached-value-equal" value="v3"/>
                <touch url="cache/document1.xml"/>
                <wait delay="2090"/>
                <assert output-name="data" condition="output-not-cached"/>
                <cache-value output-name="data" value="v4"/>
                <assert output-name="data" condition="cached-value-equal" value="v4"/>
            </script>
        </input>
    </test>

    <test description="Simple XSLT" name="oxf:test">
        <input name="config">
            <script>
                <processor name="oxf:xslt" xmlns:oxf="http://www.orbeon.com/oxf/processors">
                    <input name="config" href="cache/stylesheet1.xsl"/>
                    <input name="data" href="cache/document1.xml"/>
                </processor>
                <touch url="cache/document1.xml"/>
                <wait delay="2090"/>
                <cache-value output-name="data" value="v1"/>
                <assert output-name="data" condition="cached-value-equal" value="v1"/>
                <touch url="cache/document1.xml"/>
                <wait delay="2090"/>
                <assert output-name="data" condition="output-not-cached"/>
                <cache-value output-name="data" value="v2"/>
                <assert output-name="data" condition="output-cached"/>
                <assert output-name="data" condition="cached-value-equal" value="v2"/>
                <touch url="cache/stylesheet1.xsl"/>
                <wait delay="2090"/>
                <assert output-name="data" condition="output-not-cached"/>
                <cache-value output-name="data" value="v3"/>
                <assert output-name="data" condition="output-cached"/>
                <assert output-name="data" condition="cached-value-equal" value="v3"/>
            </script>
        </input>
    </test>

    <!-- TODO: XSLT with imports, doc(), document(), what about doc() w/ XInclude? -->
    <!-- TODO: URL gen: modify config -->
    <!-- TODO: Request gen when supported -->
    <!-- TODO: Scope gen when supported -->
</group>
