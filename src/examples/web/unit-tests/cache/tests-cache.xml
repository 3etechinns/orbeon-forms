<?xml version="1.0" encoding="ISO-8859-1"?>
<!--
    Copyright (C) 2004 Orbeon, Inc.

    This program is free software; you can redistribute it and/or modify it under the terms of the
    GNU Lesser General Public License as published by the Free Software Foundation; either version
    2.1 of the License, or (at your option) any later version.

    This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
    without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
    See the GNU Lesser General Public License for more details.

    The full text of the license is available at http://www.gnu.org/copyleft/lesser.html
-->
<group description="Cache" xmlns:p="http://www.orbeon.com/oxf/pipeline"
    xmlns:oxf="http://www.orbeon.com/oxf/processors">

    <test description="Simple URL Generator" name="oxf:test">
        <input name="config">
            <script>
                <processor name="oxf:url-generator" xmlns:oxf="http://www.orbeon.com/oxf/processors">
                    <input name="config">
                        <config>
                            <url>cache/document1.xml</url>
                        </config>
                    </input>
                </processor>
                <touch url="cache/document1.xml"/>
                <wait delay="2090"/>
                <cache-value output-name="data" value="v1"/>
                <assert output-name="data" condition="cached-value-equal" value="v1"/>
                <touch url="cache/document1.xml"/>
                <wait delay="2090"/><!-- Do this for now because last modified values are cached for 2 seconds -->
                <assert output-name="data" condition="output-not-cached"/>
                <cache-value output-name="data" value="v2"/>
                <assert output-name="data" condition="output-cached"/>
                <assert output-name="data" condition="cached-value-equal" value="v2"/>
                <assert output-name="data" condition="cached-value-equal" value="v2"/>
            </script>
        </input>
    </test>

    <test description="URL Generator With XInclude" name="oxf:test">
        <input name="config">
            <script>
                <processor name="oxf:url-generator" xmlns:oxf="http://www.orbeon.com/oxf/processors">
                    <input name="config">
                        <config>
                            <url>cache/document3.xml</url>
                        </config>
                    </input>
                </processor>
                <touch url="cache/document3.xml"/>
                <wait delay="2090"/>
                <cache-value output-name="data" value="v1"/>
                <assert output-name="data" condition="cached-value-equal" value="v1"/>
                <touch url="cache/document3.xml"/>
                <wait delay="2090"/>
                <assert output-name="data" condition="output-not-cached"/>
                <cache-value output-name="data" value="v2"/>
                <assert output-name="data" condition="cached-value-equal" value="v2"/>
                <touch url="cache/document2.xml"/>
                <wait delay="2090"/>
                <assert output-name="data" condition="output-not-cached"/>
                <cache-value output-name="data" value="v3"/>
                <assert output-name="data" condition="cached-value-equal" value="v3"/>
                <touch url="cache/document1.xml"/>
                <wait delay="2090"/>
                <assert output-name="data" condition="output-not-cached"/>
                <cache-value output-name="data" value="v4"/>
                <assert output-name="data" condition="cached-value-equal" value="v4"/>
            </script>
        </input>
    </test>

    <test description="Simple XSLT" name="oxf:test">
        <input name="config">
            <script>
                <processor name="oxf:xslt" xmlns:oxf="http://www.orbeon.com/oxf/processors">
                    <input name="config" href="cache/stylesheet1.xsl"/>
                    <input name="data" href="cache/document1.xml"/>
                </processor>
                <touch url="cache/document1.xml"/>
                <wait delay="2090"/>
                <cache-value output-name="data" value="v1"/>
                <assert output-name="data" condition="cached-value-equal" value="v1"/>
                <touch url="cache/document1.xml"/>
                <wait delay="2090"/>
                <assert output-name="data" condition="output-not-cached"/>
                <cache-value output-name="data" value="v2"/>
                <assert output-name="data" condition="output-cached"/>
                <assert output-name="data" condition="cached-value-equal" value="v2"/>
                <touch url="cache/stylesheet1.xsl"/>
                <wait delay="2090"/>
                <assert output-name="data" condition="output-not-cached"/>
                <cache-value output-name="data" value="v3"/>
                <assert output-name="data" condition="output-cached"/>
                <assert output-name="data" condition="cached-value-equal" value="v3"/>
            </script>
        </input>
    </test>

    <test description="Simple Request" name="oxf:test">
        <input name="config">
            <script>
                <processor name="oxf:request" xmlns:oxf="http://www.orbeon.com/oxf/processors">
                    <input name="config">
                        <config>
                            <include>/request/path-info</include>
                        </config>
                    </input>
                </processor>
                <set-request href="cache/request1.xml"/>
                <assert output-name="data" condition="output-not-cached"/>
                <cache-value output-name="data" value="v1"/>
                <assert output-name="data" condition="output-cached"/>
                <set-request href="cache/request1.xml"/>
                <assert output-name="data" condition="output-cached"/>
                <set-request href="cache/request2.xml"/>
                <assert output-name="data" condition="output-not-cached"/>
            </script>
        </input>
    </test>

    <test description="Request with Parameters" name="oxf:test">
        <input name="config">
            <script>
                <processor name="oxf:request" xmlns:oxf="http://www.orbeon.com/oxf/processors">
                    <input name="config">
                        <config>
                            <include>/request/path-info</include>
                            <include>/request/parameters</include>
                        </config>
                    </input>
                </processor>
                <set-request href="cache/request1.xml"/>
                <assert output-name="data" condition="output-not-cached"/>
                <cache-value output-name="data" value="v1"/>
                <assert output-name="data" condition="output-cached"/>
                <set-request href="cache/request1.xml"/>
                <assert output-name="data" condition="output-cached"/>
                <assert output-name="data" condition="cached-value-equal" value="v1"/>
                <set-request href="cache/request3.xml"/>
                <assert output-name="data" condition="output-not-cached"/>
                <!-- Test different request -->
                <assert output-name="data" condition="output-equals">
                    <request>
                        <parameters>
                            <parameter>
                                <name>print</name>
                                <value>false</value>
                            </parameter>
                            <parameter>
                                <name>id</name>
                                <value>13</value>
                            </parameter>
                        </parameters>
                        <path-info>/doc/home-welcome</path-info>
                    </request>
                </assert>
                <assert output-name="data" condition="output-not-cached"/>
                <cache-value output-name="data" value="v2"/>
                <assert output-name="data" condition="output-cached"/>
                <assert output-name="data" condition="cached-value-equal" value="v2"/>
                <!-- Test different config -->
                <processor name="oxf:request" xmlns:oxf="http://www.orbeon.com/oxf/processors">
                    <input name="config">
                        <config>
                            <include>/request/parameters</include>
                        </config>
                    </input>
                </processor>
                <assert output-name="data" condition="output-not-cached"/>
                <cache-value output-name="data" value="v1"/>
                <assert output-name="data" condition="cached-value-equal" value="v1"/>
                <assert output-name="data" condition="output-equals">
                    <request>
                        <parameters>
                            <parameter>
                                <name>print</name>
                                <value>false</value>
                            </parameter>
                            <parameter>
                                <name>id</name>
                                <value>13</value>
                            </parameter>
                        </parameters>
                    </request>
                </assert>
            </script>
        </input>
    </test>

    <test description="Simple Scope" name="oxf:test">
        <input name="config">
            <script>
                <!-- Set a request because the Scope processors need an external context -->
                <set-request href="cache/request1.xml"/>

                <!-- First, store a document into the application scope -->
                <processor name="oxf:scope-serializer" xmlns:oxf="http://www.orbeon.com/oxf/processors">
                    <input name="config">
                        <config>
                            <key>k1</key>
                            <scope>application</scope>
                        </config>
                    </input>
                    <input name="data">
                        <test-document>
                            <element1 attribute1="value1"/>
                            <element2 attribute2="value2"/>
                            Some Text!
                        </test-document>
                    </input>
                </processor>
                <run-processor/>
                <!-- Setup generator without using key/validity -->
                <processor name="oxf:scope-generator" xmlns:oxf="http://www.orbeon.com/oxf/processors">
                    <input name="config">
                        <config>
                            <key>k1</key>
                            <scope>application</scope>
                            <test-ignore-stored-key-validity>true</test-ignore-stored-key-validity>
                        </config>
                    </input>
                </processor>
                <assert output-name="data" condition="output-not-cached"/>
                <cache-value output-name="data" value="v1"/>
                <assert output-name="data" condition="output-cached"/>
                <assert output-name="data" condition="output-equals">
                    <test-document>
                        <element1 attribute1="value1"/>
                        <element2 attribute2="value2"/>
                        Some Text!
                    </test-document>
                </assert>

                <!-- Check with same document -->
                <processor name="oxf:scope-serializer" xmlns:oxf="http://www.orbeon.com/oxf/processors">
                    <input name="config">
                        <config>
                            <key>k1</key>
                            <scope>application</scope>
                        </config>
                    </input>
                    <input name="data">
                        <test-document>
                            <element1 attribute1="value1"/>
                            <element2 attribute2="value2"/>
                            Some Text!
                        </test-document>
                    </input>
                </processor>
                <run-processor/>
                <processor name="oxf:scope-generator" xmlns:oxf="http://www.orbeon.com/oxf/processors">
                    <input name="config">
                        <config>
                            <key>k1</key>
                            <scope>application</scope>
                            <test-ignore-stored-key-validity>true</test-ignore-stored-key-validity>
                        </config>
                    </input>
                </processor>
                <assert output-name="data" condition="output-cached"/>
                <assert output-name="data" condition="output-equals">
                    <test-document>
                        <element1 attribute1="value1"/>
                        <element2 attribute2="value2"/>
                        Some Text!
                    </test-document>
                </assert>
                <assert output-name="data" condition="cached-value-equal" value="v1"/>

                <!-- Check with different document -->
                <processor name="oxf:scope-serializer" xmlns:oxf="http://www.orbeon.com/oxf/processors">
                    <input name="config">
                        <config>
                            <key>k1</key>
                            <scope>application</scope>
                        </config>
                    </input>
                    <input name="data">
                        <test-document>
                            <element1 attribute1="value1"/>
                            <element2 attribute2="value2"/>
                            Some Different Text!
                        </test-document>
                    </input>
                </processor>
                <run-processor/>
                <processor name="oxf:scope-generator" xmlns:oxf="http://www.orbeon.com/oxf/processors">
                    <input name="config">
                        <config>
                            <key>k1</key>
                            <scope>application</scope>
                            <test-ignore-stored-key-validity>true</test-ignore-stored-key-validity>
                        </config>
                    </input>
                </processor>
                <assert output-name="data" condition="output-not-cached"/>
                <assert output-name="data" condition="output-equals">
                    <test-document>
                        <element1 attribute1="value1"/>
                        <element2 attribute2="value2"/>
                        Some Different Text!
                    </test-document>
                </assert>
                <assert output-name="data" condition="output-not-cached"/>
                <cache-value output-name="data" value="v2"/>
                <assert output-name="data" condition="output-cached"/>

                <!-- Check with different scope -->
                <processor name="oxf:scope-generator" xmlns:oxf="http://www.orbeon.com/oxf/processors">
                    <input name="config">
                        <config>
                            <key>k1</key>
                            <scope>request</scope>
                            <test-ignore-stored-key-validity>true</test-ignore-stored-key-validity>
                        </config>
                    </input>
                </processor>
                <assert output-name="data" condition="output-not-cached"/>
                <!-- The following doesn't work because one is <null/> and the other <null></null> -->
<!--                <assert output-name="data" condition="output-equals">-->
<!--                    <null xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:nil="true"/>-->
<!--                </assert>-->
                <processor name="oxf:scope-serializer" xmlns:oxf="http://www.orbeon.com/oxf/processors">
                    <input name="config">
                        <config>
                            <key>k1</key>
                            <scope>request</scope>
                        </config>
                    </input>
                    <input name="data">
                        <test-document>
                            <element1 attribute1="value1"/>
                            <element2 attribute2="value2"/>
                            Some Request Text!
                        </test-document>
                    </input>
                </processor>
                <run-processor/>
                <processor name="oxf:scope-generator" xmlns:oxf="http://www.orbeon.com/oxf/processors">
                    <input name="config">
                        <config>
                            <key>k1</key>
                            <scope>application</scope>
                            <test-ignore-stored-key-validity>true</test-ignore-stored-key-validity>
                        </config>
                    </input>
                </processor>
                <assert output-name="data" condition="output-cached"/>
                <assert output-name="data" condition="cached-value-equal" value="v2"/>
                <assert output-name="data" condition="output-equals">
                    <test-document>
                        <element1 attribute1="value1"/>
                        <element2 attribute2="value2"/>
                        Some Different Text!
                    </test-document>
                </assert>
                <processor name="oxf:scope-generator" xmlns:oxf="http://www.orbeon.com/oxf/processors">
                    <input name="config">
                        <config>
                            <key>k1</key>
                            <scope>request</scope>
                            <test-ignore-stored-key-validity>true</test-ignore-stored-key-validity>
                        </config>
                    </input>
                </processor>
                <assert output-name="data" condition="output-equals">
                    <test-document>
                        <element1 attribute1="value1"/>
                        <element2 attribute2="value2"/>
                        Some Request Text!
                    </test-document>
                </assert>

                <!-- Try different key -->
                <processor name="oxf:scope-generator" xmlns:oxf="http://www.orbeon.com/oxf/processors">
                    <input name="config">
                        <config>
                            <key>k2</key>
                            <scope>request</scope>
                            <test-ignore-stored-key-validity>true</test-ignore-stored-key-validity>
                        </config>
                    </input>
                </processor>
                <assert output-name="data" condition="output-not-cached"/>
                <processor name="oxf:scope-serializer" xmlns:oxf="http://www.orbeon.com/oxf/processors">
                    <input name="config">
                        <config>
                            <key>k2</key>
                            <scope>request</scope>
                        </config>
                    </input>
                    <input name="data">
                        <test-document>
                            <element1 attribute1="value1"/>
                            <element2 attribute2="value2"/>
                            Some Request Text #2!
                        </test-document>
                    </input>
                </processor>
                <run-processor/>
                <processor name="oxf:scope-generator" xmlns:oxf="http://www.orbeon.com/oxf/processors">
                    <input name="config">
                        <config>
                            <key>k1</key>
                            <scope>request</scope>
                            <test-ignore-stored-key-validity>true</test-ignore-stored-key-validity>
                        </config>
                    </input>
                </processor>
                <assert output-name="data" condition="output-equals">
                    <test-document>
                        <element1 attribute1="value1"/>
                        <element2 attribute2="value2"/>
                        Some Request Text!
                    </test-document>
                </assert>
                <processor name="oxf:scope-generator" xmlns:oxf="http://www.orbeon.com/oxf/processors">
                    <input name="config">
                        <config>
                            <key>k2</key>
                            <scope>request</scope>
                            <test-ignore-stored-key-validity>true</test-ignore-stored-key-validity>
                        </config>
                    </input>
                </processor>
                <assert output-name="data" condition="output-equals">
                    <test-document>
                        <element1 attribute1="value1"/>
                        <element2 attribute2="value2"/>
                        Some Request Text #2!
                    </test-document>
                </assert>

            </script>
        </input>
    </test>

    <!-- TODO: XSLT with imports, doc(), document(), what about doc() w/ XInclude? -->
    <!-- TODO: URL gen: modify config -->
    <!-- TODO: Request gen: upload + body -->
    <!-- TODO: Bean gen -->
</group>
